<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>تحليل نتائج مادة</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88;
  --moe2:#0aa38b;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;
  --soft:#f7fafb;

  --ex:#35b46f;
  --vg:#2fb1ab;
  --gd:#3f94e6;
  --ac:#f08b2f;
  --wk:#ff5a5f;

  --pageW:210mm;
  --pageH:297mm;
  --pageMargin:6mm;
  --padX:7.5mm;
  --padY:6.5mm;

  --r:16px;
  --shadow:0 10px 22px rgba(15,23,42,.14);

  --fs-kpi:12px;
  --fs-val:12.6px;
  --fs-table:11.4px;
  --fs-foot:12.4px;

  --donutSize:74px;
  --barH:132px;

  --overlay:rgba(15,23,42,.35);
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;}
body{font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--ink);}

.paper{width:var(--pageW); margin:0 auto; background:#fff;}
.page{min-height:var(--pageH); padding:var(--padY) var(--padX); position:relative;}
.fitRoot{transform-origin:top center; transform:scale(var(--fitScale,1));}

/* ===== Header banner (no background, no distortion, no cropping) =====
   - الصورة بعرض 100% وارتفاع تلقائي => لا تشوه ولا اجتزاء
   - النص داخل الهيدر لا يُقص (يتقلص تلقائياً إذا طال)
*/
.headerWrap{
  margin:0;
  padding:0;
  width:100%;
  border-radius:18px;
  overflow:hidden;
  /* لا خلفية إطلاقاً */
  background:transparent;
  box-shadow:none;
  position:relative;
}
.headerWrap img{
  display:block;
  width:100%;
  height:auto;          /* مهم: لا تشوه */
  object-fit:fill;      /* غير مؤثر مع height:auto */
}
.headerOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:10px 14px;
  pointer-events:none;
}
.headerText{
  width:min(92%, 920px);
  color:#fff;
  text-shadow:0 2px 10px rgba(0,0,0,.35);
  font-weight:900;
  line-height:1.18;
  /* بدون ellipsis/قص */
  white-space:normal;
  overflow:visible;
  word-break:break-word;
}
.headerText .edu,
.headerText .school,
.headerText .title{
  white-space:normal;   /* يسمح بالالتفاف عند الحاجة بدل الاجتزاء */
  overflow:visible;
  text-overflow:clip;
}
.headerText .edu{font-size:16px;}
.headerText .school{font-size:15px;}
.headerText .title{font-size:14.5px;}

.afterHeaderTight{margin-top:8px;}

.metaRow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.metaBox{
  border:2px solid #2f80ed33;
  border-radius:14px;
  background:#fff;
  padding:8px 10px;
  min-height:48px;
  box-shadow:var(--shadow);
}
.metaBox.green{border-color:#0aa38b55;}
.metaLabel{
  color:var(--moe);
  font-weight:900;
  font-size:var(--fs-kpi);
  margin-bottom:6px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.metaVal{
  font-weight:900;
  font-size:var(--fs-val);
  color:#111827;
  text-align:center;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.card{
  margin-top:10px;
  border:2px solid #dfe7ea;
  border-radius:18px;
  background:#fff;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.cardInner{padding:10px 10px 10px;}
.sectionTitle{
  text-align:center;
  color:var(--moe);
  font-weight:900;
  font-size:14.2px;
  margin:2px 0 8px;
  white-space:nowrap;
}
.gridMain{display:grid;grid-template-columns:1.35fr 1fr;gap:10px;}

.detailTable{border:1px solid var(--line);border-radius:14px;overflow:hidden;}
.dtHead{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  background:var(--soft);
  border-bottom:1px solid var(--line);
  padding:8px 8px;
  font-weight:900;color:#111827;font-size:var(--fs-table);
}
.dtRow{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  gap:8px;padding:7px 8px;align-items:center;
  border-bottom:1px solid #f0f3f5;font-size:var(--fs-table);
}
.dtRow:last-child{border-bottom:none;}
.dtRow:nth-child(even){background:#fbfdfe;}

.pillLvl{border-radius:12px;padding:8px 8px;color:#fff;font-weight:900;text-align:center;font-size:12.2px;white-space:nowrap;}
.pEx{background:var(--ex);} .pVg{background:var(--vg);} .pGd{background:var(--gd);} .pAc{background:var(--ac);} .pWk{background:var(--wk);}
.boxVal{border:2px solid #cfd8dc;border-radius:12px;padding:7px 8px;font-weight:900;text-align:center;background:#fff;font-size:12.5px;white-space:nowrap;}

.sideKPIs{display:grid;gap:8px;}
.sideRow{display:grid;grid-template-columns:1fr 1.02fr;gap:8px;align-items:stretch;}
.sideLabel{
  border:2px solid #0aa38b55;border-radius:12px;
  padding:7px 8px;color:var(--moe);font-weight:900;font-size:12.2px;
  display:flex;align-items:center;justify-content:flex-end;text-align:right;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.sideValue{
  border:2px solid #cfd8dc;border-radius:12px;
  padding:7px 8px;font-weight:900;font-size:12.5px;
  display:flex;align-items:center;justify-content:center;background:#fff;white-space:nowrap;
}

.chartCard{margin-top:8px;border:2px solid #0aa38b55;border-radius:18px;padding:8px 8px 9px;}
.chartTitle{text-align:center;color:var(--moe);font-weight:900;font-size:12.8px;margin:2px 0 8px;white-space:nowrap;}
.donutsRow{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;align-items:start;}
.donutItem{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:0;}
.donutCanvas{width:var(--donutSize) !important;height:var(--donutSize) !important;}
.donutLabel,.donutPct{font-weight:900;font-size:12.2px;white-space:nowrap;}

.barCard{margin-top:8px;border:2px solid #0aa38b55;border-radius:18px;padding:8px 8px 9px;}
.barCanvas{width:100% !important;height:var(--barH) !important;}

.footer{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-weight:900;font-size:var(--fs-foot);color:#111827;}
.footer .fBox{border-top:2px solid #d1d5db;padding-top:8px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* weak */
.hidden{display:none !important;}
.pageBreak{page-break-before:always;}
.weakCard{margin-top:10px;border:2px solid #0aa38b55;border-radius:18px;overflow:hidden;box-shadow:var(--shadow);}
.weakHead{
  padding:9px 10px;background:#f4fffb;border-bottom:1px solid #d7efe7;
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  font-size:12.2px;font-weight:900;
}
.badgeInfo{border:2px solid #0aa38b55;background:#fff;border-radius:999px;padding:6px 10px;white-space:nowrap;}
.badgeInfo.red{border-color:#fecaca;background:#fff1f2;color:#991b1b;}
.tblWrap{padding:9px 9px 10px;}
.tbl{width:100%;border-collapse:collapse;font-size:11.2px;table-layout:fixed;}
.tbl th,.tbl td{border:1px solid #d1d5db;padding:7px 6px;vertical-align:top;}
.tbl th{background:#f3f4f6;font-weight:900;white-space:nowrap;}
.tbl td.center{text-align:center;font-weight:900;white-space:nowrap;}
.tbl td.nameCell{white-space:nowrap;overflow:visible;} /* اسم بدون اجتزاء */
.plan{line-height:1.6;}

/* buttons */
.fab{position:fixed;left:14px;bottom:14px;z-index:50;display:flex;gap:8px;flex-wrap:wrap;}
.btn{
  border:none;border-radius:14px;background:linear-gradient(135deg,var(--moe2),var(--moe));
  color:#fff;font-weight:900;font-family:inherit;padding:10px 14px;cursor:pointer;
  box-shadow:0 10px 22px rgba(15,23,42,.18);white-space:nowrap;font-size:12.5px;
}
.btn.secondary{background:#fff;color:var(--moe);border:2px solid #0aa38b55;box-shadow:none;}
.btn:active{transform:translateY(1px);}

/* modal */
.overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:flex-start;justify-content:center;padding:14px;z-index:80;}
.overlay.open{display:flex;}
.modal{
  width:min(980px,96vw);
  margin-top:12mm;
  background:#fff;border-radius:18px;
  box-shadow:0 18px 40px rgba(15,23,42,.22);
  border:1px solid #dfe7ea;overflow:hidden;
}
.modalHead{
  padding:10px 12px;background:linear-gradient(135deg,#f4fffb,#fff);
  border-bottom:1px solid #d7efe7;display:flex;justify-content:space-between;align-items:center;gap:10px;
}
.modalHead .t{font-weight:900;color:var(--moe);font-size:14px;white-space:nowrap;}
.modalHead .x{border:none;background:transparent;font-size:18px;cursor:pointer;width:34px;height:34px;border-radius:10px;}
.modalHead .x:hover{background:#f3f4f6;}
.modalBody{padding:10px 12px 12px;}
.formGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px 10px;}
.field{display:flex;flex-direction:column;gap:6px;min-width:0;}
.field label{font-weight:900;color:#334155;font-size:11.8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.field input,.field select{
  border:2px solid #cfd8dc;border-radius:12px;padding:9px 9px;font-family:inherit;
  font-weight:900;background:#fff;font-size:12px;outline:none;
}
.req{color:#b91c1c;font-weight:900;}
.invalid{border-color:#ef4444 !important;background:#fff1f2 !important;}
.actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;}
.badge{margin-right:auto;border:2px solid #0aa38b55;color:var(--moe);background:#fff;font-weight:900;font-size:12px;padding:6px 10px;border-radius:999px;white-space:nowrap;}
.badge.bad{border-color:#fecaca;background:#fff1f2;color:#991b1b;}
.note{
  margin-top:10px;border-radius:14px;border:1px solid #fed7aa;background:#fff7ed;
  padding:9px 10px;font-weight:800;color:#7c2d12;line-height:1.7;font-size:12px;
}
.note strong{font-weight:900;}

/* print: منع صفحات فارغة */
@media print{
  @page{ size:A4 portrait; margin:var(--pageMargin); }
  html,body{background:#fff;}
  body{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
  .fab,.overlay{display:none !important;}
  .paper{width:var(--pageW) !important;}
  .page{min-height:auto !important; height:auto !important; padding:var(--padY) var(--padX) !important;}
  .pageBreak{break-before:page;}
  .headerWrap,.metaBox,.card,.chartCard,.barCard,.footer,.weakCard{break-inside:avoid; page-break-inside:avoid;}
}

@media (max-width:1100px){
  .formGrid{grid-template-columns:repeat(2,1fr);}
  .donutsRow{grid-template-columns:repeat(3,1fr);}
}
@media (max-width:700px){
  .formGrid{grid-template-columns:1fr;}
  .donutsRow{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>

<body>
<div class="paper">

  <!-- ===== PAGE 1 ===== -->
  <div class="page" id="page1">
    <div class="fitRoot" id="fitRoot">

      <div class="headerWrap">
        <!-- ضع الصورة في نفس المجلد بنفس الاسم تمامًا -->
        <img src="هيدر التحليل .png" alt="هيدر التحليل" id="headerImg1" />
        <div class="headerOverlay">
          <div class="headerText" id="headerTextFit">
            <div class="edu" id="hEdu">—</div>
            <div class="school" id="hSchool">—</div>
            <div class="title">تحليل درجات مادة <span id="hSubject">—</span></div>
          </div>
        </div>
      </div>

      <div class="afterHeaderTight">
        <div class="metaRow">
          <div class="metaBox green"><div class="metaLabel">المرحلة الدراسية / الصف</div><div class="metaVal" id="tStage">—</div></div>
          <div class="metaBox"><div class="metaLabel">السنة / الفصل الدراسي</div><div class="metaVal" id="tTerm">—</div></div>
          <div class="metaBox green"><div class="metaLabel">درجة القياس (الاختبار)</div><div class="metaVal" id="tFull">—</div></div>
        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <div class="sectionTitle">الإحصائيات التفصيلية</div>

          <div class="gridMain">
            <div class="detailTable">
              <div class="dtHead"><div style="text-align:center">عدد الطلاب</div><div style="text-align:center">النطاق</div><div style="text-align:center">المستوى</div></div>
              <div class="dtRow"><div class="boxVal" id="cEx">0</div><div class="boxVal" id="rEx">—</div><div class="pillLvl pEx">ممتاز</div></div>
              <div class="dtRow"><div class="boxVal" id="cVg">0</div><div class="boxVal" id="rVg">—</div><div class="pillLvl pVg">جيد جداً</div></div>
              <div class="dtRow"><div class="boxVal" id="cGd">0</div><div class="boxVal" id="rGd">—</div><div class="pillLvl pGd">جيد</div></div>
              <div class="dtRow"><div class="boxVal" id="cAc">0</div><div class="boxVal" id="rAc">—</div><div class="pillLvl pAc">مقبول</div></div>
              <div class="dtRow"><div class="boxVal" id="cWk">0</div><div class="boxVal" id="rWk">—</div><div class="pillLvl pWk">ضعيف</div></div>
            </div>

            <div class="sideKPIs">
              <div class="sideRow"><div class="sideValue" id="kN">0</div><div class="sideLabel">عدد الطلاب</div></div>
              <div class="sideRow"><div class="sideValue" id="kMax">0</div><div class="sideLabel">أعلى درجة</div></div>
              <div class="sideRow"><div class="sideValue" id="kMin">0</div><div class="sideLabel">أقل درجة</div></div>
              <div class="sideRow"><div class="sideValue" id="kAvg">0</div><div class="sideLabel">متوسط الدرجات</div></div>
              <div class="sideRow"><div class="sideValue" id="kRate">0%</div><div class="sideLabel">نسبة التحصيل</div></div>
              <div class="sideRow"><div class="sideValue" id="kSum">0</div><div class="sideLabel">مجموع الدرجات</div></div>
            </div>
          </div>

          <div class="chartCard">
            <div class="chartTitle">رسم بياني (نِسب الطلاب لكل تقدير)</div>
            <div class="donutsRow">
              <div class="donutItem"><canvas id="dWk" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--wk)">ضعيف</div><div class="donutPct" id="pWk">0%</div></div>
              <div class="donutItem"><canvas id="dAc" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--ac)">مقبول</div><div class="donutPct" id="pAc">0%</div></div>
              <div class="donutItem"><canvas id="dGd" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--gd)">جيد</div><div class="donutPct" id="pGd">0%</div></div>
              <div class="donutItem"><canvas id="dVg" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--vg)">جيد جداً</div><div class="donutPct" id="pVg">0%</div></div>
              <div class="donutItem"><canvas id="dEx" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--ex)">ممتاز</div><div class="donutPct" id="pEx">0%</div></div>
            </div>
          </div>

          <div class="barCard">
            <div class="chartTitle">رسم بياني (عدد الطلاب لكل تقدير)</div>
            <canvas id="bar" class="barCanvas"></canvas>
          </div>

          <div class="footer">
            <div class="fBox">معلم المادة / <span id="fTeacher">—</span></div>
            <div class="fBox">مدير المدرسة / <span id="fPrincipal">—</span></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ===== PAGE 2 ===== -->
  <div class="page hidden pageBreak" id="page2">
    <div class="fitRoot" id="fitRoot2">

      <div class="headerWrap">
        <img src="هيدر التحليل .png" alt="هيدر التحليل" id="headerImg2" />
        <div class="headerOverlay">
          <div class="headerText" id="headerTextFit2">
            <div class="edu" id="hEdu2">—</div>
            <div class="school" id="hSchool2">—</div>
            <div class="title">خطة علاجية — مادة <span id="hSubject2">—</span></div>
          </div>
        </div>
      </div>

      <div class="afterHeaderTight">
        <div class="metaRow">
          <div class="metaBox green"><div class="metaLabel">المرحلة الدراسية / الصف</div><div class="metaVal" id="tStage2">—</div></div>
          <div class="metaBox"><div class="metaLabel">السنة / الفصل الدراسي</div><div class="metaVal" id="tTerm2">—</div></div>
          <div class="metaBox green"><div class="metaLabel">درجة القياس (الاختبار)</div><div class="metaVal" id="tFull2">—</div></div>
        </div>
      </div>

      <div class="weakCard">
        <div class="weakHead">
          <div class="badgeInfo" id="weakRule">قاعدة الضعفاء: —</div>
          <div class="badgeInfo red" id="weakCount">عدد الضعفاء: 0</div>
        </div>

        <div class="tblWrap">
          <table class="tbl">
            <thead>
              <tr>
                <th style="width:28%">اسم الطالب</th>
                <th style="width:10%">الشعبة</th>
                <th style="width:10%">الدرجة</th>
                <th style="width:10%">النسبة</th>
                <th style="width:10%">الفجوة</th>
                <th style="width:32%">خطة علاجية متنوعة</th>
              </tr>
            </thead>
            <tbody id="weakBody">
              <tr><td colspan="6" style="text-align:center;font-weight:900;color:#6b7280;">لا توجد بيانات بعد.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="footer" style="padding:0 10px 10px;">
          <div class="fBox">معلم المادة / <span id="fTeacher2">—</span></div>
          <div class="fBox">مدير المدرسة / <span id="fPrincipal2">—</span></div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Buttons -->
<div class="fab">
  <button class="btn" id="openModal">تحليل</button>
  <button class="btn secondary" id="printSave">حفظ / طباعة</button>
</div>

<!-- Modal -->
<div class="overlay" id="ov">
  <div class="modal">
    <div class="modalHead">
      <div class="t">إدخال البيانات واستيراد الدرجات</div>
      <button class="x" id="closeOv" title="إغلاق">✕</button>
    </div>
    <div class="modalBody">

      <div class="formGrid">
        <div class="field">
          <label>إدارة التعليم <span class="req">*</span></label>
          <input id="inEdu" placeholder="مثال: الإدارة العامة للتعليم بالمنطقة الشرقية" value="الإدارة العامة للتعليم بالمنطقة الشرقية" />
        </div>
        <div class="field">
          <label>اسم المدرسة <span class="req">*</span></label>
          <input id="inSchool" placeholder="مثال: ثانوية اليعقوبي بالخبر" value="ثانوية اليعقوبي بالخبر" />
        </div>
        <div class="field">
          <label>اسم مدير المدرسة <span class="req">*</span></label>
          <input id="inPrincipal" placeholder="مثال: فهد حامد الزهراني" value="فهد حامد الزهراني" />
        </div>
        <div class="field">
          <label>معلم المادة <span class="req">*</span></label>
          <input id="inTeacher" placeholder="مثال: أحمد محمد ..." />
        </div>

        <div class="field">
          <label>المادة <span class="req">*</span></label>
          <input id="inSubject" placeholder="مثال: الرياضيات" />
        </div>
        <div class="field">
          <label>المرحلة / الصف <span class="req">*</span></label>
          <input id="inStage" placeholder="مثال: سادس ابتدائي" />
        </div>
        <div class="field">
          <label>السنة / الفصل الدراسي (اختياري)</label>
          <input id="inTerm" placeholder="مثال: الفصل الأول / 1447هـ" />
        </div>
        <div class="field">
          <label>درجة الاختبار (اختياري)</label>
          <select id="inFullMode">
            <option value="auto">آلي (ذكي)</option>
            <option value="40">40</option>
            <option value="60">60</option>
            <option value="100">100</option>
          </select>
        </div>

        <div class="field">
          <label>رفع ملف الدرجات (Excel/CSV) <span class="req">*</span></label>
          <input type="file" id="file" accept=".xlsx,.xls,.csv" />
        </div>
        <div class="field">
          <label>تصفية الشُعب (اختياري: 1 أو 1,2,3)</label>
          <input id="inSections" placeholder="مثال: 1,2,3" />
        </div>
      </div>

      <div class="actions">
        <div class="badge" id="statusPill">جاهز</div>
        <button class="btn secondary" id="dlTemplate">تنزيل قالب تعبئة (Excel)</button>
        <button class="btn" id="doAnalyze">بدء التحليل</button>
      </div>

      <div class="note">
        <strong>طريقة استخراج ملف الدرجات من «نور» (جميع المراحل):</strong><br>
        نور → <b>التقارير</b> → <b>تقارير الدرجات/رصد الدرجات</b> → <b>كشف رصد درجات مادة</b> → <b>تصدير إلى Excel</b>.<br>
        <strong>للثانوي (إن وُجد نظام المسارات):</strong> نور → التقارير → <b>تقارير نظام المسارات</b> → كشف رصد درجات مادة → تصدير إلى Excel.
      </div>

    </div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
const $ = (id)=>document.getElementById(id);
const clean = (s)=> (s??"").toString().replace(/\s+/g," ").trim();
const normalizeDigits = (str)=>{
  if(str == null) return "";
  str = String(str);
  const map = {'٠':0,'١':1,'٢':2,'٣':3,'٤':4,'٥':5,'٦':6,'٧':7,'٨':8,'٩':9};
  return str.replace(/[٠-٩]/g,d=>map[d]).replace(/,/g,".");
};
const isNumeric = (v)=>{
  if(v===null||v===undefined) return false;
  if(typeof v==="number") return Number.isFinite(v);
  const n = Number(normalizeDigits(v).replace(/[^\d.-]/g,""));
  return Number.isFinite(n);
};
const toNumber = (v)=>{
  if(typeof v==="number") return v;
  const n = Number(normalizeDigits(v).replace(/[^\d.-]/g,""));
  return Number.isFinite(n) ? n : NaN;
};
const pct = (a,b)=> b ? (a/b)*100 : 0;

/* ========= Modal ========= */
const ov = $("ov");
$("openModal").onclick = ()=> ov.classList.add("open");
$("closeOv").onclick = ()=> ov.classList.remove("open");
ov.addEventListener("click",(e)=>{ if(e.target===ov) ov.classList.remove("open"); });

/* ========= Inputs ========= */
const inEdu = $("inEdu");
const inSchool = $("inSchool");
const inPrincipal = $("inPrincipal");
const inTeacher = $("inTeacher");
const inSubject = $("inSubject");
const inStage = $("inStage");
const inTerm = $("inTerm");
const inFullMode = $("inFullMode");
const inSections = $("inSections");
const fileEl = $("file");
const statusPill = $("statusPill");

let selectedFile = null;
fileEl.addEventListener("change",(e)=>{ selectedFile = e.target.files?.[0] || null; validateInputs(); });

const required = [inEdu,inSchool,inPrincipal,inTeacher,inSubject,inStage];

function setStatus(text, ok=true){
  statusPill.textContent = text;
  statusPill.classList.toggle("bad", !ok);
  statusPill.style.borderColor = ok ? "#0aa38b55" : "#fecaca";
  statusPill.style.background = ok ? "#fff" : "#fff1f2";
  statusPill.style.color = ok ? "var(--moe)" : "#991b1b";
}
function validateInputs(){
  let ok = true;
  required.forEach(el=>{
    if(!clean(el.value)){ el.classList.add("invalid"); ok=false; }
    else el.classList.remove("invalid");
  });
  if(!selectedFile){ fileEl.classList.add("invalid"); ok=false; }
  else fileEl.classList.remove("invalid");
  setStatus(ok ? "جاهز للتحليل" : "أكمل الحقول الإلزامية", ok);
  return ok;
}

/* ========= Header binding ========= */
const hEdu = $("hEdu"), hSchool = $("hSchool"), hSubject = $("hSubject");
const hEdu2 = $("hEdu2"), hSchool2 = $("hSchool2"), hSubject2 = $("hSubject2");
const tStage = $("tStage"), tTerm = $("tTerm"), tFull = $("tFull");
const tStage2 = $("tStage2"), tTerm2 = $("tTerm2"), tFull2 = $("tFull2");
const fTeacher = $("fTeacher"), fPrincipal = $("fPrincipal");
const fTeacher2 = $("fTeacher2"), fPrincipal2 = $("fPrincipal2");

function syncHeader(){
  const edu = clean(inEdu.value) || "—";
  const school = clean(inSchool.value) || "—";
  const subject = clean(inSubject.value) || "—";
  const stage = clean(inStage.value) || "—";
  const term = clean(inTerm.value) || "—";
  const teacher = clean(inTeacher.value) || "—";
  const principal = clean(inPrincipal.value) || "—";

  hEdu.textContent = edu; hSchool.textContent = school; hSubject.textContent = subject;
  hEdu2.textContent = edu; hSchool2.textContent = school; hSubject2.textContent = subject;

  tStage.textContent = stage; tTerm.textContent = term;
  tStage2.textContent = stage; tTerm2.textContent = term;

  fTeacher.textContent = teacher; fPrincipal.textContent = principal;
  fTeacher2.textContent = teacher; fPrincipal2.textContent = principal;
}

/* ========= Fit header text (NO truncation) =========
   يقلص الخط تدريجياً إذا زاد النص عن مساحة الهيدر (عرض/ارتفاع)
*/
function fitHeaderText(boxId, overlaySelector){
  const box = $(boxId);
  if(!box) return;
  const overlay = box.closest(".headerOverlay");
  if(!overlay) return;

  // إعادة أحجام افتراضية
  const edu = box.querySelector(".edu");
  const school = box.querySelector(".school");
  const title = box.querySelector(".title");
  const base = {edu:16, school:15, title:14.5};

  edu.style.fontSize = base.edu + "px";
  school.style.fontSize = base.school + "px";
  title.style.fontSize = base.title + "px";
  box.style.transform = "none";

  // قلّص حتى لا يتجاوز المساحة
  const maxW = overlay.clientWidth - 24;
  const maxH = overlay.clientHeight - 18;

  let guard = 0;
  while(guard < 30 && (box.scrollWidth > maxW || box.scrollHeight > maxH)){
    guard++;
    edu.style.fontSize = (parseFloat(getComputedStyle(edu).fontSize) - 0.6) + "px";
    school.style.fontSize = (parseFloat(getComputedStyle(school).fontSize) - 0.6) + "px";
    title.style.fontSize = (parseFloat(getComputedStyle(title).fontSize) - 0.6) + "px";
  }
}

function fitAllHeaderText(){
  fitHeaderText("headerTextFit");
  fitHeaderText("headerTextFit2");
}

["input","change"].forEach(evt=>{
  [inEdu,inSchool,inPrincipal,inTeacher,inSubject,inStage,inTerm,inFullMode,inSections].forEach(el=>{
    el.addEventListener(evt, ()=>{ validateInputs(); syncHeader(); fitAllHeaderText(); });
  });
});
window.addEventListener("resize", ()=> fitAllHeaderText());

/* عند تحميل صورة الهيدر (لتصبح أبعاد overlay صحيحة) */
[$("headerImg1"), $("headerImg2")].forEach(img=>{
  if(!img) return;
  img.addEventListener("load", ()=> setTimeout(fitAllHeaderText, 50));
});

syncHeader();
setTimeout(fitAllHeaderText, 120);
validateInputs();

/* ========= Sections ========= */
function parseSections(v){
  const s = normalizeDigits(v||"").trim();
  if(!s) return [];
  return s.split(/[,،/|]+/).map(x=>x.trim()).filter(Boolean);
}
function inferSectionFromSheet(name){
  const s = normalizeDigits(name||"").trim();
  const m = s.match(/(?:شعبة|شعبه|ش|قسم|ق)\s*([0-9]+)/) || s.match(/([0-9]{1,2})/);
  return m ? String(m[1]) : clean(name||"");
}

/* ========= Column detection ========= */
function normToken(t){
  return clean(normalizeDigits(String(t||"")).toLowerCase())
    .replace(/[()（）【】\[\]{}]/g," ")
    .replace(/[:：]/g," ")
    .replace(/\s+/g," ")
    .trim();
}
const P = {
  name:[/اسم\s*الطالب/,/اسم\s*المتعلم/,/\bالطالب\b/,/\bname\b/],
  id:[/هوية/,/السجل\s*المدني/,/رقم\s*الهوية/,/\bid\b/],
  gradeFinal:[/نهاية\s*فصل/,/نهائي/,/final/,/الدرجة\s*النهائية/],
  gradeSum:[/المجموع/,/مجموع/,/الدرجة/,/total/,/score/],
  section:[/الشعبة/,/الشعبه/,/القسم/]
};
function detectHeaderRow(rows){
  let bestI=-1, bestS=-1;
  const scan=Math.min(rows.length, 250);
  for(let i=0;i<scan;i++){
    const row=rows[i]||[];
    const toks=row.map(normToken).filter(Boolean);
    if(!toks.length) continue;
    const joined=" "+toks.join(" ")+" ";
    let s=0;
    if(P.name.some(rx=>rx.test(joined))) s+=5;
    if(P.id.some(rx=>rx.test(joined))) s+=4;
    if(P.gradeFinal.some(rx=>rx.test(joined))) s+=6;
    if(P.gradeSum.some(rx=>rx.test(joined))) s+=4;
    if(P.section.some(rx=>rx.test(joined))) s+=2;
    if(toks.length>=4) s+=1;
    if(s>bestS){bestS=s; bestI=i;}
  }
  return bestI;
}
function pickCol(tokens, rxList){
  for(let i=0;i<tokens.length;i++){
    const t=" "+tokens[i]+" ";
    if(rxList.some(rx=>rx.test(t))) return i;
  }
  return -1;
}
function buildRecordsFromSheet(rows, sheetName){
  const h = detectHeaderRow(rows);
  if(h<0) return [];
  const header=rows[h]||[];
  const tokens=header.map(normToken);

  const nameCol = pickCol(tokens, P.name);
  const idCol   = pickCol(tokens, P.id);
  const sectionCol = pickCol(tokens, P.section);

  let gradeCol = pickCol(tokens, P.gradeFinal);
  if(gradeCol<0) gradeCol = pickCol(tokens, P.gradeSum);

  if(gradeCol<0){
    let best=-1, bestCnt=-1, bestVar=-1;
    for(let c=0;c<tokens.length;c++){
      let cnt=0, vals=[];
      for(let r=h+1;r<rows.length;r++){
        const v=(rows[r]||[])[c];
        if(isNumeric(v)){
          const n=toNumber(v);
          if(n>=0 && n<=200){cnt++; vals.push(n);}
        }
      }
      if(cnt>=6){
        const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
        const vari = vals.reduce((a,b)=>a+(b-mean)*(b-mean),0)/vals.length;
        if(cnt>bestCnt || (cnt===bestCnt && vari>bestVar)){
          bestCnt=cnt; bestVar=vari; best=c;
        }
      }
    }
    gradeCol=best;
  }

  const sectionFromSheet = inferSectionFromSheet(sheetName);
  const out=[];
  for(let r=h+1;r<rows.length;r++){
    const row=rows[r]||[];
    const name = nameCol>=0 ? clean(row[nameCol]) : "";
    const id   = idCol>=0 ? normalizeDigits(row[idCol]).replace(/[^\d]/g,"") : "";
    const gRaw = gradeCol>=0 ? row[gradeCol] : null;
    const grade = isNumeric(gRaw) ? toNumber(gRaw) : NaN;

    if(!name && !id) continue;
    if(!Number.isFinite(grade) || grade<0 || grade>200) continue;

    const sec = sectionCol>=0 ? clean(row[sectionCol]) : "";
    out.push({
      student: name || "—",
      id: id || "—",
      grade,
      section: clean(sec) ? normalizeDigits(sec) : sectionFromSheet
    });
  }
  return out;
}

/* ========= Full score + weak rule ========= */
function inferFullScoreSmart(list, mode){
  if(mode!=="auto") return Number(mode);
  const mx = Math.max(...list.map(r=>r.grade));
  const common=[40,60,100,50,30,20];
  let best=Infinity, pick=mx;
  for(const c of common){
    if(c>=mx && Math.abs(c-mx)<=10){
      const d=Math.abs(c-mx);
      if(d<best){best=d; pick=c;}
    }
  }
  if(!common.includes(pick)) pick = Math.ceil(mx);
  return Math.max(1, Math.round(pick));
}
function weakCutoff(full){
  if(full===100) return 49;
  if(full===60) return 19;
  if(full===40) return 9;
  return Math.max(0, Math.floor(full*0.5)-1);
}
function band(score, full){
  const p = pct(score,full);
  if(p>=90) return "ex";
  if(p>=80) return "vg";
  if(p>=70) return "gd";
  if(p>=50) return "ac";
  return "wk";
}
function ranges(full){
  const ex0 = Math.ceil(full*0.90);
  const vg0 = Math.ceil(full*0.80);
  const gd0 = Math.ceil(full*0.70);
  const ac0 = Math.ceil(full*0.50);
  const fmt = (x)=> (Math.round(x*100)/100).toString().replace(/\.0+$/,"");
  return {
    ex:`${fmt(ex0)} - ${fmt(full)}`,
    vg:`${fmt(vg0)} - ${fmt(ex0-0.01)}`,
    gd:`${fmt(gd0)} - ${fmt(vg0-0.01)}`,
    ac:`${fmt(ac0)} - ${fmt(gd0-0.01)}`,
    wk:`0 - ${fmt(ac0-0.01)}`
  };
}
function stats(list, full){
  const n=list.length;
  const grades=list.map(x=>x.grade);
  const sum=grades.reduce((a,b)=>a+b,0);
  const mx=Math.max(...grades);
  const mn=Math.min(...grades);
  const avg=n? sum/n : 0;
  const rate = pct(avg, full);
  const c={ex:0,vg:0,gd:0,ac:0,wk:0};
  list.forEach(r=> c[band(r.grade,full)]++ );
  return {n,sum,mx,mn,avg,rate,c};
}

/* ========= Plans ========= */
const planBank = [
  "تعزيز المهارات الأساسية: تدريب يومي قصير (10 دقائق) + ورقة عمل علاجية + تقويم أسبوعي وتوثيق التحسن.",
  "تصحيح الأخطاء الشائعة: تشخيص نوع الخطأ + شرح مصغر + تدريب موجه + إعادة قياس بعد أسبوع.",
  "دعم بمجموعات صغيرة: تعلم تعاوني + بنك أسئلة متدرج (سهل→متوسط) + واجب علاجي منزلي.",
  "خطة مشتركة مع ولي الأمر: مهام منزلية محددة + متابعة أسبوعية مختصرة + اختبار محاكاة بعد كل محور.",
  "أهداف قصيرة قابلة للقياس: مهارة واحدة/أسبوع + تغذية راجعة فردية + رصد تقدم حتى الوصول للمستوى المطلوب."
];
function pickPlanByGap(gap, full){
  const p = pct(full-gap, full);
  if(p < 20) return planBank[0];
  if(p < 35) return planBank[1];
  if(p < 50) return planBank[2];
  if(p < 65) return planBank[3];
  return planBank[4];
}

/* ========= Charts ========= */
const centerText = {
  id:"centerText",
  afterDraw(chart, args, opts){
    const t = opts && opts.text;
    if(!t) return;
    const {ctx, chartArea:{left,right,top,bottom}} = chart;
    const x=(left+right)/2, y=(top+bottom)/2;
    ctx.save();
    ctx.font="900 16px Tajawal, system-ui";
    ctx.fillStyle="#111827";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(t, x, y);
    ctx.restore();
  }
};
Chart.register(centerText);

function donut(el, color){
  const ctx=$(el).getContext("2d");
  return new Chart(ctx,{
    type:"doughnut",
    data:{datasets:[{data:[0,100],backgroundColor:[color,"#e5e7eb"],borderWidth:0}]},
    options:{
      responsive:true, maintainAspectRatio:true, aspectRatio:1,
      animation:false,
      plugins:{legend:{display:false},tooltip:{enabled:false},centerText:{text:"0%"}},
      cutout:"80%"
    }
  });
}
function setDonut(ch, percent){
  const p=Math.max(0,Math.min(100,percent));
  ch.data.datasets[0].data=[p,100-p];
  ch.options.plugins.centerText.text = `${Math.round(p)}%`;
  ch.update();
}
const css = getComputedStyle(document.documentElement);
const chWk = donut("dWk", css.getPropertyValue("--wk").trim());
const chAc = donut("dAc", css.getPropertyValue("--ac").trim());
const chGd = donut("dGd", css.getPropertyValue("--gd").trim());
const chVg = donut("dVg", css.getPropertyValue("--vg").trim());
const chEx = donut("dEx", css.getPropertyValue("--ex").trim());

const barChart = new Chart($("bar").getContext("2d"),{
  type:"bar",
  data:{
    labels:["ضعيف","مقبول","جيد","جيد جداً","ممتاز"],
    datasets:[{
      data:[0,0,0,0,0],
      backgroundColor:["#ff5a5f","#f08b2f","#3f94e6","#2fb1ab","#35b46f"],
      borderRadius:14,
      maxBarThickness:80
    }]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    animation:false,
    plugins:{legend:{display:false}},
    scales:{
      y:{beginAtZero:true, ticks:{font:{family:"Tajawal",weight:"900"}}},
      x:{ticks:{font:{family:"Tajawal",weight:"900"}}}
    }
  }
});

/* ========= Fit printing ========= */
const fitRoot = $("fitRoot");
const fitRoot2 = $("fitRoot2");
const page2 = $("page2");

function computeFitScale(rootEl, pageEl){
  const pageRect = pageEl.getBoundingClientRect();
  const rootRect = rootEl.getBoundingClientRect();
  const availH = pageRect.height;
  const usedH  = rootRect.height;
  if(usedH <= availH) return 1;
  const safe = 0.985;
  return Math.max(0.84, (availH / usedH) * safe);
}
function applyFit(rootEl, pageEl){
  rootEl.style.setProperty("--fitScale", 1);
  requestAnimationFrame(()=> requestAnimationFrame(()=>{
    const s = computeFitScale(rootEl, pageEl);
    rootEl.style.setProperty("--fitScale", s.toFixed(4));
  }));
}
function fitAllPages(){
  applyFit(fitRoot, $("page1"));
  if(!page2.classList.contains("hidden")) applyFit(fitRoot2, $("page2"));
}

/* ========= Read files ========= */
function readWorkbook(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=(e)=>{
      try{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const sheets = wb.SheetNames.map(name=>{
          const ws=wb.Sheets[name];
          const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:null,raw:true});
          return {name, rows};
        });
        resolve({sheets});
      }catch(err){reject(err);}
    };
    fr.onerror=reject;
    fr.readAsArrayBuffer(file);
  });
}
function readCSV(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>{
      const text = String(fr.result||"");
      const rows = text.split(/\r?\n/).filter(Boolean).map(line=> line.split(/[,;\t]/).map(x=>x.trim()));
      resolve({sheets:[{name:"CSV", rows}]});
    };
    fr.onerror=reject;
    fr.readAsText(file,"utf-8");
  });
}

/* ========= Outputs ========= */
const rEx = $("rEx"), rVg = $("rVg"), rGd = $("rGd"), rAc = $("rAc"), rWk = $("rWk");
const cEx = $("cEx"), cVg = $("cVg"), cGd = $("cGd"), cAc = $("cAc"), cWk = $("cWk");
const kN = $("kN"), kMax = $("kMax"), kMin = $("kMin"), kAvg = $("kAvg"), kRate = $("kRate"), kSum = $("kSum");
const pEx = $("pEx"), pVg = $("pVg"), pGd = $("pGd"), pAc = $("pAc"), pWk = $("pWk");
const weakRuleEl = $("weakRule"), weakCountEl = $("weakCount"), weakBody = $("weakBody");

let __fullScore = 0;

function renderWeak(list, full){
  const cutoff = weakCutoff(full);
  const weak = list.filter(r=> r.grade <= cutoff).sort((a,b)=> a.grade-b.grade);

  if(!weak.length){
    page2.classList.add("hidden");
    weakBody.innerHTML = `<tr><td colspan="6" style="text-align:center;font-weight:900;color:#6b7280;">لا يوجد طلاب ضمن فئة الضعفاء.</td></tr>`;
    return;
  }

  page2.classList.remove("hidden");
  weakRuleEl.textContent = `قاعدة الضعفاء: من 0 إلى ${cutoff} (من أصل ${full})`;
  weakCountEl.textContent = `عدد الضعفاء: ${weak.length}`;

  weakBody.innerHTML = weak.map(r=>{
    const p = pct(r.grade,full);
    const gap = Math.max(0, full - r.grade);
    const plan = pickPlanByGap(gap, full);
    return `
      <tr>
        <td class="nameCell">${clean(r.student)||"—"}</td>
        <td class="center">${clean(r.section)||"—"}</td>
        <td class="center">${Number(r.grade).toFixed(0)}</td>
        <td class="center">${p.toFixed(1)}%</td>
        <td class="center" style="color:#991b1b;">${gap.toFixed(0)}</td>
        <td class="plan">${plan}</td>
      </tr>
    `;
  }).join("");
}

/* ========= Download template (Excel) ========= */
$("dlTemplate").addEventListener("click", ()=>{
  // قالب بسيط للتعبئة ثم الاستيراد مرة أخرى
  const edu = clean(inEdu.value) || "الإدارة العامة للتعليم بالمنطقة الشرقية";
  const school = clean(inSchool.value) || "ثانوية اليعقوبي بالخبر";
  const subject = clean(inSubject.value) || "المادة";
  const stage = clean(inStage.value) || "الصف";
  const fullMode = clean(inFullMode.value || "auto");

  const rows = [
    ["معلومات (لا تعدل إلا عند الحاجة)"],
    ["إدارة التعليم", edu],
    ["اسم المدرسة", school],
    ["المادة", subject],
    ["المرحلة/الصف", stage],
    ["درجة الاختبار (auto/40/60/100)", fullMode],
    [],
    ["بيانات الطلاب"],
    ["اسم الطالب","الشعبة","الدرجة"]
  ];
  // صفوف فارغة لتعبئة المستخدم
  for(let i=0;i<20;i++) rows.push(["","",""]);

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws["!cols"] = [{wch:28},{wch:10},{wch:10}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Template");
  const filename = `قالب-درجات-${subject}-${stage}.xlsx`.replace(/\s+/g,"-");
  XLSX.writeFile(wb, filename);
});

/* ========= Analyze ========= */
$("doAnalyze").addEventListener("click", async ()=>{
  try{
    if(!validateInputs()){
      alert("فضلاً أكمل الحقول الإلزامية (بالأحمر) ثم ارفع ملف الدرجات.");
      return;
    }

    setStatus("جارٍ التحليل...", true);
    syncHeader();
    fitAllHeaderText();

    const f = selectedFile;
    const name = (f?.name||"").toLowerCase();
    const result = name.endsWith(".csv") ? await readCSV(f) : await readWorkbook(f);

    let list=[];
    (result.sheets||[]).forEach(sh=>{ list = list.concat(buildRecordsFromSheet(sh.rows, sh.name)); });

    const want = parseSections(inSections.value);
    if(want.length){
      const set = new Set(want.map(String));
      list = list.filter(r=> set.has(String(clean(r.section))) );
    }

    const seen=new Set();
    list = list.filter(r=>{
      const k = `${clean(r.id)}|${clean(r.section)}|${r.grade}|${clean(r.student)}`;
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    if(!list.length){
      setStatus("لم تُكتشف بيانات", false);
      alert("لم يتم العثور على بيانات صالحة داخل الملف. الأفضل تصدير Excel مباشرة من نور أو استخدام قالب التعبئة.");
      return;
    }

    const full = inferFullScoreSmart(list, inFullMode.value);
    __fullScore = full;
    tFull.textContent = String(full);
    tFull2.textContent = String(full);

    const rr = ranges(full);
    rEx.textContent = rr.ex; rVg.textContent = rr.vg; rGd.textContent = rr.gd; rAc.textContent = rr.ac; rWk.textContent = rr.wk;

    const st = stats(list, full);
    cEx.textContent = st.c.ex; cVg.textContent = st.c.vg; cGd.textContent = st.c.gd; cAc.textContent = st.c.ac; cWk.textContent = st.c.wk;

    kN.textContent = st.n;
    kMax.textContent = st.mx.toFixed(0);
    kMin.textContent = st.mn.toFixed(0);
    kAvg.textContent = st.avg.toFixed(1);
    kRate.textContent = `${st.rate.toFixed(2)}%`;
    kSum.textContent = st.sum.toFixed(0);

    const n = st.n || 1;
    const pc = (x)=> pct(x,n);
    setDonut(chWk, pc(st.c.wk));
    setDonut(chAc, pc(st.c.ac));
    setDonut(chGd, pc(st.c.gd));
    setDonut(chVg, pc(st.c.vg));
    setDonut(chEx, pc(st.c.ex));

    pWk.textContent = `${pc(st.c.wk).toFixed(0)}%`;
    pAc.textContent = `${pc(st.c.ac).toFixed(0)}%`;
    pGd.textContent = `${pc(st.c.gd).toFixed(0)}%`;
    pVg.textContent = `${pc(st.c.vg).toFixed(0)}%`;
    pEx.textContent = `${pc(st.c.ex).toFixed(0)}%`;

    barChart.data.datasets[0].data = [st.c.wk, st.c.ac, st.c.gd, st.c.vg, st.c.ex];
    barChart.update();

    renderWeak(list, full);

    ov.classList.remove("open");

    setTimeout(()=>{ fitAllPages(); setTimeout(fitAllPages,120); }, 180);
    setStatus("تم التحليل بنجاح", true);
  }catch(err){
    console.error(err);
    setStatus("حدث خطأ", false);
    alert("حدث خطأ أثناء التحليل. تأكد من الملف ثم أعد المحاولة.");
  }
});

/* ========= Print/save ========= */
$("printSave").addEventListener("click", ()=>{
  fitAllPages();
  fitAllHeaderText();
  setTimeout(()=> window.print(), 150);
});

window.addEventListener("beforeprint", ()=>{ fitAllPages(); fitAllHeaderText(); });
window.addEventListener("afterprint", ()=>{ fitAllPages(); fitAllHeaderText(); });
</script>

</body>
</html>
