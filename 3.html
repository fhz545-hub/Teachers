<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ù…Ø§Ø¯Ø©</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88;
  --moe2:#0aa38b;
  --ink:#0f172a;
  --line:#e5e7eb;
  --soft:#f7fafb;

  --ex:#35b46f;
  --vg:#2fb1ab;
  --gd:#3f94e6;
  --ac:#f08b2f;
  --wk:#ff5a5f;

  --pageW:210mm;
  --pageH:297mm;

  /* Ù‡ÙˆØ§Ù…Ø´ A4 */
  --pageMargin:6mm;

  /* Ù…Ø³Ø§Ø­Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
  --padX:7mm;
  --padY:6mm;

  --shadow:0 10px 22px rgba(15,23,42,.14);

  --fs-kpi:12px;
  --fs-val:12.8px;
  --fs-table:11.6px;
  --fs-foot:12.6px;

  --donutSize:74px;
  --barH:235px;

  --overlay:rgba(15,23,42,.35);

  --danger:#ef4444;
  --dangerBg:#fff1f2;
  --dangerSoft:#fecaca;
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;}
/* âœ… ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± (Ø­Ù„ Ø§Ù„Ø¬Ù…ÙˆØ¯) */
html,body{overflow:auto;}

body{
  font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--ink);
}

.paper{width:var(--pageW); margin:0 auto; background:#fff;}
.page{
  padding:var(--padY) var(--padX);
  position:relative;
}
.fitRoot{transform-origin:top center; transform:scale(var(--fitScale,1));}

/* ===== Header banner ===== */
.headerWrap{
  margin:0;
  padding:0;
  width:100%;
  border-radius:18px;
  overflow:hidden;
  background:transparent;
  box-shadow:none;
  position:relative;
}
.headerWrap img{
  display:block;
  width:100%;
  height:auto;
  object-fit:fill;
}
.headerOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:10px 14px;
  pointer-events:none;
}
.headerText{
  width:min(92%, 980px);
  color:#fff;
  text-shadow:0 2px 12px rgba(0,0,0,.38);
  font-weight:900;
  line-height:1.2;
  white-space:normal;
}
.headerText .edu{font-size:18px;}
.headerText .school{font-size:17px;}
.headerText .title{font-size:16px; margin-top:2px;}

.afterHeaderTight{margin-top:8px;}

.metaRow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.metaBox{
  border:2px solid #2f80ed33;
  border-radius:14px;
  background:#fff;
  padding:8px 10px;
  min-height:48px;
  box-shadow:var(--shadow);
}
.metaBox.green{border-color:#0aa38b55;}
.metaLabel{
  color:var(--moe);
  font-weight:900;
  font-size:var(--fs-kpi);
  margin-bottom:6px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.metaVal{
  font-weight:900;
  font-size:var(--fs-val);
  color:#111827;
  text-align:center;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.card{
  margin-top:10px;
  border:2px solid #dfe7ea;
  border-radius:18px;
  background:#fff;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.cardInner{padding:10px 10px 10px;}
.sectionTitle{
  text-align:center;
  color:var(--moe);
  font-weight:900;
  font-size:14.2px;
  margin:2px 0 8px;
  white-space:nowrap;
}
.gridMain{display:grid;grid-template-columns:1.35fr 1fr;gap:10px;}

.detailTable{border:1px solid var(--line);border-radius:14px;overflow:hidden;}
.dtHead{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  background:var(--soft);
  border-bottom:1px solid var(--line);
  padding:8px 8px;
  font-weight:900;color:#111827;font-size:var(--fs-table);
}
.dtRow{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  gap:8px;padding:7px 8px;align-items:center;
  border-bottom:1px solid #f0f3f5;font-size:var(--fs-table);
}
.dtRow:last-child{border-bottom:none;}
.dtRow:nth-child(even){background:#fbfdfe;}

.pillLvl{border-radius:12px;padding:8px 8px;color:#fff;font-weight:900;text-align:center;font-size:12.2px;white-space:nowrap;}
.pEx{background:var(--ex);} .pVg{background:var(--vg);} .pGd{background:var(--gd);} .pAc{background:var(--ac);} .pWk{background:var(--wk);}
.boxVal{border:2px solid #cfd8dc;border-radius:12px;padding:7px 8px;font-weight:900;text-align:center;background:#fff;font-size:12.5px;white-space:nowrap;}

.sideKPIs{display:grid;gap:8px;}
.sideRow{display:grid;grid-template-columns:1fr 1.02fr;gap:8px;align-items:stretch;}
.sideLabel{
  border:2px solid #0aa38b55;border-radius:12px;
  padding:7px 8px;color:var(--moe);font-weight:900;font-size:12.2px;
  display:flex;align-items:center;justify-content:flex-end;text-align:right;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.sideValue{
  border:2px solid #cfd8dc;border-radius:12px;
  padding:7px 8px;font-weight:900;font-size:12.5px;
  display:flex;align-items:center;justify-content:center;background:#fff;white-space:nowrap;
}

.chartCard{margin-top:8px;border:2px solid #0aa38b55;border-radius:18px;padding:8px 8px 9px;}
.chartTitle{text-align:center;color:var(--moe);font-weight:900;font-size:12.8px;margin:2px 0 8px;white-space:nowrap;}

/* donuts row */
.donutsRow{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px;
  align-items:start;
}
.donutItem{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:0;}
.donutCanvas{width:var(--donutSize) !important;height:var(--donutSize) !important;}
.donutLabel,.donutPct{font-weight:900;font-size:12.2px;white-space:nowrap;}
.donutLabel,.donutPct{max-width:100%;overflow:hidden;text-overflow:ellipsis;}

.barCard{margin-top:8px;border:2px solid #0aa38b55;border-radius:18px;padding:8px 8px 10px;}
.barCanvas{width:100% !important;height:var(--barH) !important;}

.footer{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-weight:900;font-size:var(--fs-foot);color:#111827;}
.footer .fBox{border-top:2px solid #d1d5db;padding-top:8px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* weak */
.hidden{display:none !important;}
.pageBreak{page-break-before:always;}
.weakCard{margin-top:10px;border:2px solid #0aa38b55;border-radius:18px;overflow:hidden;box-shadow:var(--shadow);}
.weakHead{
  padding:9px 10px;background:#f4fffb;border-bottom:1px solid #d7efe7;
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  font-size:12.2px;font-weight:900;
}
.badgeInfo{border:2px solid #0aa38b55;background:#fff;border-radius:999px;padding:6px 10px;white-space:nowrap;}
.badgeInfo.red{border-color:#fecaca;background:#fff1f2;color:#991b1b;}
.tblWrap{padding:9px 9px 10px;}
.tbl{width:100%;border-collapse:collapse;font-size:11.2px;table-layout:fixed;}
.tbl th,.tbl td{border:1px solid #d1d5db;padding:7px 6px;vertical-align:top;}
.tbl th{background:#f3f4f6;font-weight:900;white-space:nowrap;}
.tbl td.center{text-align:center;font-weight:900;white-space:nowrap;}
.tbl td.nameCell{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.plan{line-height:1.6;}

/* buttons */
.fab{position:fixed;left:14px;bottom:14px;z-index:50;display:flex;gap:8px;flex-wrap:wrap;}
.btn{
  border:none;border-radius:14px;background:linear-gradient(135deg,var(--moe2),var(--moe));
  color:#fff;font-weight:900;font-family:inherit;padding:10px 14px;cursor:pointer;
  box-shadow:0 10px 22px rgba(15,23,42,.18);white-space:nowrap;font-size:12.5px;
}
.btn.secondary{background:#fff;color:var(--moe);border:2px solid #0aa38b55;box-shadow:none;}

/* modal */
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:flex-start;justify-content:center;padding:14px;z-index:80; overflow:auto;}
.overlay.open{display:flex;}
.modal{
  width:min(980px,96vw);
  margin-top:12mm;
  background:#fff;border-radius:18px;
  box-shadow:0 18px 40px rgba(15,23,42,.22);
  border:1px solid #dfe7ea;overflow:hidden;
}
.modalHead{
  padding:10px 12px;background:linear-gradient(135deg,#f4fffb,#fff);
  border-bottom:1px solid #d7efe7;display:flex;justify-content:space-between;align-items:center;gap:10px;
}
.modalHead .t{font-weight:900;color:var(--moe);font-size:14px;white-space:nowrap;}
.modalHead .x{border:none;background:transparent;font-size:18px;cursor:pointer;width:34px;height:34px;border-radius:10px;}
.modalHead .x:hover{background:#f3f4f6;}
.modalBody{padding:10px 12px 10px;}

.formGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px 10px;}
.field{display:flex;flex-direction:column;gap:6px;min-width:0;}
.field label{font-weight:900;color:#334155;font-size:11.8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.field input,.field select{
  border:2px solid var(--dangerSoft);
  background:#fff1f2;
  border-radius:12px;
  padding:9px 9px;
  font-family:inherit;
  font-weight:900;
  font-size:12px;
  outline:none;
}
.field input::placeholder{color:#991b1b; opacity:.9; font-weight:900;}
.field select{color:#111827; background:#fff; border-color:#cfd8dc;}
.req{color:#b91c1c;font-weight:900;}
.invalid{border-color:#ef4444 !important;background:#fff1f2 !important;}
.valid{border-color:#22c55e55 !important; background:#f0fdf4 !important;}

.actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;}
.badge{margin-right:auto;border:2px solid #0aa38b55;color:var(--moe);background:#fff;font-weight:900;font-size:12px;padding:6px 10px;border-radius:999px;white-space:nowrap;}
.badge.bad{border-color:#fecaca;background:#fff1f2;color:#991b1b;}
.note{margin-top:10px;border-radius:14px;border:1px solid #fed7aa;background:#fff7ed;padding:9px 10px;font-weight:800;color:#7c2d12;line-height:1.7;font-size:12px;}
.modalFooterTiny{margin-top:10px;text-align:center;color:#94a3b8;font-weight:800;font-size:11px;}

/* ===== Print ===== */
@media print{
  @page{ size:A4 portrait; margin:var(--pageMargin); }
  html,body{overflow:visible !important;}
  body{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
  .fab,.overlay{display:none !important;}
  .paper{width:100% !important;}
  .page{margin:0 !important;}
  .headerWrap,.metaBox,.card,.chartCard,.barCard,.footer,.weakCard{break-inside:avoid; page-break-inside:avoid;}
  /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¯ÙˆÙ†Ø§Øª ØµÙ ÙˆØ§Ø­Ø¯ */
  .donutsRow{grid-template-columns:repeat(5,1fr) !important; gap:6px !important;}
  .donutCanvas{width:72px !important;height:72px !important;}
  .donutLabel,.donutPct{font-size:12px !important;}
}
@media (max-width:1100px){
  .formGrid{grid-template-columns:repeat(2,1fr);}
  .donutsRow{grid-template-columns:repeat(3,1fr);}
  .paper{width:100%;}
}
@media (max-width:700px){
  .paper{width:100%;}
  .page{padding:12px 12px;}
  .gridMain{grid-template-columns:1fr;gap:8px;}
  .metaRow{grid-template-columns:1fr;gap:8px;}
  .donutsRow{grid-template-columns:repeat(2,1fr);}
  .headerText .edu{font-size:16px;}
  .headerText .school{font-size:15px;}
  .headerText .title{font-size:14px;}
}
</style>
</head>

<body>
<div class="paper">

  <!-- PAGE 1 -->
  <div class="page" id="page1">
    <div class="fitRoot" id="fitRoot">

      <div class="headerWrap">
        <img src="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ .png" alt="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„" id="headerImg1" />
        <div class="headerOverlay">
          <div class="headerText" id="headerTextFit">
            <div class="edu" id="hEdu">â€”</div>
            <div class="school" id="hSchool">â€”</div>
            <div class="title">ØªØ­Ù„ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ù…Ø§Ø¯Ø© <span id="hSubject">â€”</span></div>
          </div>
        </div>
      </div>

      <div class="afterHeaderTight">
        <div class="metaRow">
          <div class="metaBox green"><div class="metaLabel">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© / Ø§Ù„ØµÙ</div><div class="metaVal" id="tStage">â€”</div></div>
          <div class="metaBox"><div class="metaLabel">Ø§Ù„Ø³Ù†Ø© / Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div><div class="metaVal" id="tTerm">â€”</div></div>
          <div class="metaBox green"><div class="metaLabel">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)</div><div class="metaVal" id="tFull">â€”</div></div>
        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <div class="sectionTitle">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>

          <div class="gridMain">
            <div class="detailTable">
              <div class="dtHead"><div style="text-align:center">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</div><div style="text-align:center">Ø§Ù„Ù†Ø·Ø§Ù‚</div><div style="text-align:center">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div></div>
              <div class="dtRow"><div class="boxVal" id="cEx">0</div><div class="boxVal" id="rEx">â€”</div><div class="pillLvl" style="background:var(--ex)">Ù…Ù…ØªØ§Ø²</div></div>
              <div class="dtRow"><div class="boxVal" id="cVg">0</div><div class="boxVal" id="rVg">â€”</div><div class="pillLvl" style="background:var(--vg)">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</div></div>
              <div class="dtRow"><div class="boxVal" id="cGd">0</div><div class="boxVal" id="rGd">â€”</div><div class="pillLvl" style="background:var(--gd)">Ø¬ÙŠØ¯</div></div>
              <div class="dtRow"><div class="boxVal" id="cAc">0</div><div class="boxVal" id="rAc">â€”</div><div class="pillLvl" style="background:var(--ac)">Ù…Ù‚Ø¨ÙˆÙ„</div></div>
              <div class="dtRow"><div class="boxVal" id="cWk">0</div><div class="boxVal" id="rWk">â€”</div><div class="pillLvl" style="background:var(--wk)">Ø¶Ø¹ÙŠÙ</div></div>
            </div>

            <div class="sideKPIs">
              <div class="sideRow"><div class="sideValue" id="kN">0</div><div class="sideLabel">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
              <div class="sideRow"><div class="sideValue" id="kMax">0</div><div class="sideLabel">Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</div></div>
              <div class="sideRow"><div class="sideValue" id="kMin">0</div><div class="sideLabel">Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©</div></div>
              <div class="sideRow"><div class="sideValue" id="kAvg">0</div><div class="sideLabel">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div></div>
              <div class="sideRow"><div class="sideValue" id="kRate">0%</div><div class="sideLabel">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</div></div>
              <div class="sideRow"><div class="sideValue" id="kSum">0</div><div class="sideLabel">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div></div>
            </div>
          </div>

          <div class="chartCard">
            <div class="chartTitle">Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ (Ù†ÙØ³Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±)</div>
            <div class="donutsRow">
              <div class="donutItem"><canvas id="dWk" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--wk)">Ø¶Ø¹ÙŠÙ</div><div class="donutPct" id="pWk">0%</div></div>
              <div class="donutItem"><canvas id="dAc" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--ac)">Ù…Ù‚Ø¨ÙˆÙ„</div><div class="donutPct" id="pAc">0%</div></div>
              <div class="donutItem"><canvas id="dGd" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--gd)">Ø¬ÙŠØ¯</div><div class="donutPct" id="pGd">0%</div></div>
              <div class="donutItem"><canvas id="dVg" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--vg)">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</div><div class="donutPct" id="pVg">0%</div></div>
              <div class="donutItem"><canvas id="dEx" class="donutCanvas"></canvas><div class="donutLabel" style="color:var(--ex)">Ù…Ù…ØªØ§Ø²</div><div class="donutPct" id="pEx">0%</div></div>
            </div>
          </div>

          <div class="barCard">
            <div class="chartTitle">Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ (Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±)</div>
            <canvas id="bar" class="barCanvas"></canvas>
          </div>

          <div class="footer">
            <div class="fBox">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / <span id="fTeacher">â€”</span></div>
            <div class="fBox">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / <span id="fPrincipal">â€”</span></div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- PAGE 2 -->
  <div class="page hidden pageBreak" id="page2">
    <div class="fitRoot" id="fitRoot2">

      <div class="headerWrap">
        <img src="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ .png" alt="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„" id="headerImg2" />
        <div class="headerOverlay">
          <div class="headerText" id="headerTextFit2">
            <div class="edu" id="hEdu2">â€”</div>
            <div class="school" id="hSchool2">â€”</div>
            <div class="title">Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ÙŠØ© â€” Ù…Ø§Ø¯Ø© <span id="hSubject2">â€”</span></div>
          </div>
        </div>
      </div>

      <div class="afterHeaderTight">
        <div class="metaRow">
          <div class="metaBox green"><div class="metaLabel">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© / Ø§Ù„ØµÙ</div><div class="metaVal" id="tStage2">â€”</div></div>
          <div class="metaBox"><div class="metaLabel">Ø§Ù„Ø³Ù†Ø© / Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div><div class="metaVal" id="tTerm2">â€”</div></div>
          <div class="metaBox green"><div class="metaLabel">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)</div><div class="metaVal" id="tFull2">â€”</div></div>
        </div>
      </div>

      <div class="weakCard">
        <div class="weakHead">
          <div class="badgeInfo" id="weakRule">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: â€”</div>
          <div class="badgeInfo red" id="weakCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: 0</div>
        </div>

        <div class="tblWrap">
          <table class="tbl">
            <thead>
              <tr>
                <th style="width:28%">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th style="width:10%">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                <th style="width:10%">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                <th style="width:10%">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                <th style="width:10%">Ø§Ù„ÙØ¬ÙˆØ©</th>
                <th style="width:32%">Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø©</th>
              </tr>
            </thead>
            <tbody id="weakBody">
              <tr><td colspan="6" style="text-align:center;font-weight:900;color:#6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="footer" style="padding:0 10px 10px;">
          <div class="fBox">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / <span id="fTeacher2">â€”</span></div>
          <div class="fBox">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / <span id="fPrincipal2">â€”</span></div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Buttons -->
<div class="fab">
  <button class="btn" id="openModal">ØªØ­Ù„ÙŠÙ„</button>
  <button class="btn secondary" id="printSave">Ø­ÙØ¸ / Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<!-- Modal -->
<div class="overlay" id="ov">
  <div class="modal">
    <div class="modalHead">
      <div class="t">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
      <button class="x" id="closeOv" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>
    <div class="modalBody">

      <div class="formGrid">
        <div class="field">
          <label>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… <span class="req">*</span></label>
          <input id="inEdu" class="invalid" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" value="" />
        </div>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© <span class="req">*</span></label>
          <input id="inSchool" class="invalid" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" value="" />
        </div>
        <div class="field">
          <label>Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© <span class="req">*</span></label>
          <input id="inPrincipal" class="invalid" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" value="" />
        </div>
        <div class="field">
          <label>Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© <span class="req">*</span></label>
          <input id="inTeacher" class="invalid" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ø³Ù… Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" value="" />
        </div>

        <div class="field">
          <label>Ø§Ù„Ù…Ø§Ø¯Ø© <span class="req">*</span></label>
          <input id="inSubject" class="invalid" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" value="" />
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© / Ø§Ù„ØµÙ <span class="req">*</span></label>
          <input id="inStage" class="invalid" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ù„Ù…Ø±Ø­Ù„Ø©/Ø§Ù„ØµÙ" value="" />
        </div>
        <div class="field">
          <label>Ø§Ù„Ø³Ù†Ø© / Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="inTerm" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ù„Ø³Ù†Ø©/Ø§Ù„ÙØµÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" value="" style="border-color:#cfd8dc;background:#fff;" />
        </div>
        <div class="field">
          <label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="inFullMode">
            <option value="auto">Ø¢Ù„ÙŠ (Ø°ÙƒÙŠ)</option>
            <option value="40">40</option>
            <option value="60">60</option>
            <option value="100">100</option>
          </select>
        </div>

        <div class="field">
          <label>Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Excel/CSV) <span class="req">*</span></label>
          <input type="file" id="file" class="invalid" accept=".xlsx,.xls,.csv" />
        </div>
        <div class="field">
          <label>ØªØµÙÙŠØ© Ø§Ù„Ø´ÙØ¹Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="inSections" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø´ÙØ¹Ø¨ Ø¥Ù† Ø±ØºØ¨Øª (Ù…Ø«Ø§Ù„: 1,2,3)" value="" style="border-color:#cfd8dc;background:#fff;" />
        </div>
      </div>

      <div class="actions">
        <div class="badge bad" id="statusPill">Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©</div>
        <button class="btn secondary" id="dlTemplate" type="button">ØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ù„Ø¨ ØªØ¹Ø¨Ø¦Ø© (Excel)</button>
        <button class="btn" id="doAnalyze" type="button" disabled style="opacity:.55; cursor:not-allowed;">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
      </div>

      <div class="note">
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± Ù…Ù„Ù Ø¬Ø§Ù‡Ø²ØŒ Ù†Ø²Ù‘Ù„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø«Ù… Ø¹Ø¨Ù‘Ø¦ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ£Ø¹Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡.
      </div>

      <div class="modalFooterTiny">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø© Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
    </div>
  </div>
</div>

<script>
/* =========================
   ğŸ”’ ØªØ¹Ø·ÙŠÙ„ Ø£ÙŠ Datalabels Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ù„Ùˆ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ù† Ø¨ÙŠØ¦Ø© Ø£Ø®Ø±Ù‰)
========================= */
(function hardDisableDataLabels(){
  try{
    if (Chart?.defaults?.plugins){
      // Ù…Ù†Ø¹ Ø£ÙŠ Ø¨Ù„Ø¬Ù† datalabels Ù…Ù† Ø§Ù„Ø±Ø³Ù… Ù„Ùˆ ÙƒØ§Ù† Ù…Ø­Ù…Ù‘Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹
      Chart.defaults.plugins.datalabels = Chart.defaults.plugins.datalabels || {};
      Chart.defaults.plugins.datalabels.display = false;

      // ØªØ¹Ø·ÙŠÙ„ tooltip Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ (ÙˆØ³Ù†ÙØ¹Ù‘Ù„Ù‡ Ù„Ù„Ø¨Ø§Ø± ÙÙ‚Ø·)
      Chart.defaults.plugins.tooltip = Chart.defaults.plugins.tooltip || {};
    }
  }catch(e){}
})();

/* Helpers */
const $ = (id)=>document.getElementById(id);
const clean = (s)=> (s??"").toString().replace(/\s+/g," ").trim();
const normalizeDigits = (str)=>{
  if(str == null) return "";
  str = String(str);
  const map = {'Ù ':0,'Ù¡':1,'Ù¢':2,'Ù£':3,'Ù¤':4,'Ù¥':5,'Ù¦':6,'Ù§':7,'Ù¨':8,'Ù©':9};
  return str.replace(/[Ù -Ù©]/g,d=>map[d]).replace(/,/g,".");
};
const isNumeric = (v)=>{
  if(v===null||v===undefined) return false;
  if(typeof v==="number") return Number.isFinite(v);
  const n = Number(normalizeDigits(v).replace(/[^\d.-]/g,""));
  return Number.isFinite(n);
};
const toNumber = (v)=>{
  if(typeof v==="number") return v;
  const n = Number(normalizeDigits(v).replace(/[^\d.-]/g,""));
  return Number.isFinite(n) ? n : NaN;
};
const pct = (a,b)=> b ? (a/b)*100 : 0;

/* Modal */
const ov = $("ov");
$("openModal").onclick = ()=> ov.classList.add("open");
$("closeOv").onclick = ()=> ov.classList.remove("open");
ov.addEventListener("click",(e)=>{ if(e.target===ov) ov.classList.remove("open"); });

/* Inputs */
const inEdu = $("inEdu");
const inSchool = $("inSchool");
const inPrincipal = $("inPrincipal");
const inTeacher = $("inTeacher");
const inSubject = $("inSubject");
const inStage = $("inStage");
const inTerm = $("inTerm");
const inFullMode = $("inFullMode");
const inSections = $("inSections");
const fileEl = $("file");
const statusPill = $("statusPill");
const analyzeBtn = $("doAnalyze");

let selectedFile = null;
fileEl.addEventListener("change",(e)=>{ selectedFile = e.target.files?.[0] || null; validateInputs(); });

const required = [inEdu,inSchool,inPrincipal,inTeacher,inSubject,inStage];

function setStatus(text, ok=true){
  statusPill.textContent = text;
  statusPill.classList.toggle("bad", !ok);
  statusPill.style.borderColor = ok ? "#0aa38b55" : "#fecaca";
  statusPill.style.background = ok ? "#fff" : "#fff1f2";
  statusPill.style.color = ok ? "var(--moe)" : "#991b1b";
}
function markField(el, ok){
  if(ok){ el.classList.remove("invalid"); el.classList.add("valid"); }
  else{ el.classList.add("invalid"); el.classList.remove("valid"); }
}
function validateInputs(){
  let ok = true;
  required.forEach(el=>{
    const good = !!clean(el.value);
    markField(el, good);
    if(!good) ok=false;
  });
  const fileOk = !!selectedFile;
  markField(fileEl, fileOk);
  if(!fileOk) ok=false;

  setStatus(ok ? "Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù„ÙŠÙ„" : "Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©", ok);
  analyzeBtn.disabled = !ok;
  analyzeBtn.style.opacity = ok ? "1" : ".55";
  analyzeBtn.style.cursor = ok ? "pointer" : "not-allowed";

  syncHeader();
  fitAllHeaderText();
  return ok;
}

/* Header binding */
const hEdu = $("hEdu"), hSchool = $("hSchool"), hSubject = $("hSubject");
const hEdu2 = $("hEdu2"), hSchool2 = $("hSchool2"), hSubject2 = $("hSubject2");
const tStage = $("tStage"), tTerm = $("tTerm"), tFull = $("tFull");
const tStage2 = $("tStage2"), tTerm2 = $("tTerm2"), tFull2 = $("tFull2");
const fTeacher = $("fTeacher"), fPrincipal = $("fPrincipal");
const fTeacher2 = $("fTeacher2"), fPrincipal2 = $("fPrincipal2");

function syncHeader(){
  const edu = clean(inEdu.value) || "â€”";
  const school = clean(inSchool.value) || "â€”";
  const subject = clean(inSubject.value) || "â€”";
  const stage = clean(inStage.value) || "â€”";
  const term = clean(inTerm.value) || "â€”";
  const teacher = clean(inTeacher.value) || "â€”";
  const principal = clean(inPrincipal.value) || "â€”";

  hEdu.textContent = edu; hSchool.textContent = school; hSubject.textContent = subject;
  hEdu2.textContent = edu; hSchool2.textContent = school; hSubject2.textContent = subject;

  tStage.textContent = stage; tTerm.textContent = term;
  tStage2.textContent = stage; tTerm2.textContent = term;

  fTeacher.textContent = teacher; fPrincipal.textContent = principal;
  fTeacher2.textContent = teacher; fPrincipal2.textContent = principal;
}

/* Fit header text */
function fitHeaderText(boxId){
  const box = $(boxId);
  if(!box) return;
  const overlay = box.closest(".headerOverlay");
  if(!overlay) return;

  const edu = box.querySelector(".edu");
  const school = box.querySelector(".school");
  const title = box.querySelector(".title");

  edu.style.fontSize = "18px";
  school.style.fontSize = "17px";
  title.style.fontSize = "16px";

  const maxW = overlay.clientWidth - 24;
  const maxH = overlay.clientHeight - 18;

  let guard = 0;
  while(guard < 34 && (box.scrollWidth > maxW || box.scrollHeight > maxH)){
    guard++;
    edu.style.fontSize = (parseFloat(getComputedStyle(edu).fontSize) - 0.7) + "px";
    school.style.fontSize = (parseFloat(getComputedStyle(school).fontSize) - 0.7) + "px";
    title.style.fontSize = (parseFloat(getComputedStyle(title).fontSize) - 0.7) + "px";
  }
}
function fitAllHeaderText(){ fitHeaderText("headerTextFit"); fitHeaderText("headerTextFit2"); }

["input","change"].forEach(evt=>{
  [inEdu,inSchool,inPrincipal,inTeacher,inSubject,inStage,inTerm,inFullMode,inSections].forEach(el=>{
    el.addEventListener(evt, validateInputs);
  });
});
window.addEventListener("resize", ()=> fitAllHeaderText());
[$("headerImg1"), $("headerImg2")].forEach(img=>{
  if(!img) return;
  img.addEventListener("load", ()=> setTimeout(fitAllHeaderText, 50));
});
syncHeader();
setTimeout(()=>{fitAllHeaderText(); validateInputs();}, 120);

/* Sections */
function parseSections(v){
  const s = normalizeDigits(v||"").trim();
  if(!s) return [];
  return s.split(/[,ØŒ/|]+/).map(x=>x.trim()).filter(Boolean);
}
function inferSectionFromSheet(name){
  const s = normalizeDigits(name||"").trim();
  const m = s.match(/(?:Ø´Ø¹Ø¨Ø©|Ø´Ø¹Ø¨Ù‡|Ø´|Ù‚Ø³Ù…|Ù‚)\s*([0-9]+)/) || s.match(/([0-9]{1,2})/);
  return m ? String(m[1]) : clean(name||"");
}

/* Column detection */
function normToken(t){
  return clean(normalizeDigits(String(t||"")).toLowerCase())
    .replace(/[()ï¼ˆï¼‰ã€ã€‘\[\]{}]/g," ")
    .replace(/[:ï¼š]/g," ")
    .replace(/\s+/g," ")
    .trim();
}
const P = {
  name:[/Ø§Ø³Ù…\s*Ø§Ù„Ø·Ø§Ù„Ø¨/,/Ø§Ø³Ù…\s*Ø§Ù„Ù…ØªØ¹Ù„Ù…/,/\bØ§Ù„Ø·Ø§Ù„Ø¨\b/,/\bname\b/],
  gradeFinal:[/Ù†Ù‡Ø§ÙŠØ©\s*ÙØµÙ„/,/Ù†Ù‡Ø§Ø¦ÙŠ/,/final/,/Ø§Ù„Ø¯Ø±Ø¬Ø©\s*Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©/],
  gradeSum:[/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹/,/Ù…Ø¬Ù…ÙˆØ¹/,/Ø§Ù„Ø¯Ø±Ø¬Ø©/,/total/,/score/],
  section:[/Ø§Ù„Ø´Ø¹Ø¨Ø©/,/Ø§Ù„Ø´Ø¹Ø¨Ù‡/,/Ø§Ù„Ù‚Ø³Ù…/]
};
function detectHeaderRow(rows){
  let bestI=-1, bestS=-1;
  const scan=Math.min(rows.length, 250);
  for(let i=0;i<scan;i++){
    const row=rows[i]||[];
    const toks=row.map(normToken).filter(Boolean);
    if(!toks.length) continue;
    const joined=" "+toks.join(" ")+" ";
    let s=0;
    if(P.name.some(rx=>rx.test(joined))) s+=5;
    if(P.gradeFinal.some(rx=>rx.test(joined))) s+=6;
    if(P.gradeSum.some(rx=>rx.test(joined))) s+=4;
    if(P.section.some(rx=>rx.test(joined))) s+=2;
    if(toks.length>=4) s+=1;
    if(s>bestS){bestS=s; bestI=i;}
  }
  return bestI;
}
function pickCol(tokens, rxList){
  for(let i=0;i<tokens.length;i++){
    const t=" "+tokens[i]+" ";
    if(rxList.some(rx=>rx.test(t))) return i;
  }
  return -1;
}
function buildRecordsFromSheet(rows, sheetName){
  const h = detectHeaderRow(rows);
  if(h<0) return [];
  const header=rows[h]||[];
  const tokens=header.map(normToken);

  const nameCol = pickCol(tokens, P.name);
  const sectionCol = pickCol(tokens, P.section);

  let gradeCol = pickCol(tokens, P.gradeFinal);
  if(gradeCol<0) gradeCol = pickCol(tokens, P.gradeSum);

  if(gradeCol<0){
    let best=-1, bestCnt=-1, bestVar=-1;
    for(let c=0;c<tokens.length;c++){
      let cnt=0, vals=[];
      for(let r=h+1;r<rows.length;r++){
        const v=(rows[r]||[])[c];
        if(isNumeric(v)){
          const n=toNumber(v);
          if(n>=0 && n<=200){cnt++; vals.push(n);}
        }
      }
      if(cnt>=6){
        const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
        const vari = vals.reduce((a,b)=>a+(b-mean)*(b-mean),0)/vals.length;
        if(cnt>bestCnt || (cnt===bestCnt && vari>bestVar)){
          bestCnt=cnt; bestVar=vari; best=c;
        }
      }
    }
    gradeCol=best;
  }

  const sectionFromSheet = inferSectionFromSheet(sheetName);
  const out=[];
  for(let r=h+1;r<rows.length;r++){
    const row=rows[r]||[];
    const name = nameCol>=0 ? clean(row[nameCol]) : "";
    const gRaw = gradeCol>=0 ? row[gradeCol] : null;
    const grade = isNumeric(gRaw) ? toNumber(gRaw) : NaN;

    if(!name) continue;
    if(!Number.isFinite(grade) || grade<0 || grade>200) continue;

    const sec = sectionCol>=0 ? clean(row[sectionCol]) : "";
    out.push({
      student: name || "â€”",
      grade,
      section: clean(sec) ? normalizeDigits(sec) : sectionFromSheet
    });
  }
  return out;
}

/* Full score + weak rule */
function inferFullScoreSmart(list, mode){
  if(mode!=="auto") return Number(mode);
  const mx = Math.max(...list.map(r=>r.grade));
  const common=[40,60,100,50,30,20];
  let best=Infinity, pick=mx;
  for(const c of common){
    if(c>=mx && Math.abs(c-mx)<=10){
      const d=Math.abs(c-mx);
      if(d<best){best=d; pick=c;}
    }
  }
  if(!common.includes(pick)) pick = Math.ceil(mx);
  return Math.max(1, Math.round(pick));
}
function weakCutoff(full){
  if(full===100) return 49;
  if(full===60) return 19;
  if(full===40) return 9;
  return Math.max(0, Math.floor(full*0.5)-1);
}
function band(score, full){
  const p = pct(score,full);
  if(p>=90) return "ex";
  if(p>=80) return "vg";
  if(p>=70) return "gd";
  if(p>=50) return "ac";
  return "wk";
}
function ranges(full){
  const ex0 = Math.ceil(full*0.90);
  const vg0 = Math.ceil(full*0.80);
  const gd0 = Math.ceil(full*0.70);
  const ac0 = Math.ceil(full*0.50);
  const fmt = (x)=> (Math.round(x*100)/100).toString().replace(/\.0+$/,"");
  return {
    ex:`${fmt(ex0)} - ${fmt(full)}`,
    vg:`${fmt(vg0)} - ${fmt(ex0-0.01)}`,
    gd:`${fmt(gd0)} - ${fmt(vg0-0.01)}`,
    ac:`${fmt(ac0)} - ${fmt(gd0-0.01)}`,
    wk:`0 - ${fmt(ac0-0.01)}`
  };
}
function stats(list, full){
  const n=list.length;
  const grades=list.map(x=>x.grade);
  const sum=grades.reduce((a,b)=>a+b,0);
  const mx=Math.max(...grades);
  const mn=Math.min(...grades);
  const avg=n? sum/n : 0;
  const rate = pct(avg, full);
  const c={ex:0,vg:0,gd:0,ac:0,wk:0};
  list.forEach(r=> c[band(r.grade,full)]++ );
  return {n,sum,mx,mn,avg,rate,c};
}

/* Plans */
const planBank = [
  "ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ØªØ¯Ø±ÙŠØ¨ ÙŠÙˆÙ…ÙŠ Ù‚ØµÙŠØ± (10 Ø¯Ù‚Ø§Ø¦Ù‚) + ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ø¹Ù„Ø§Ø¬ÙŠØ© + ØªÙ‚ÙˆÙŠÙ… Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØªØ­Ø³Ù†.",
  "ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©: ØªØ´Ø®ÙŠØµ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£ + Ø´Ø±Ø­ Ù…ØµØºØ± + ØªØ¯Ø±ÙŠØ¨ Ù…ÙˆØ¬Ù‡ + Ø¥Ø¹Ø§Ø¯Ø© Ù‚ÙŠØ§Ø³ Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹.",
  "Ø¯Ø¹Ù… Ø¨Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØµØºÙŠØ±Ø©: ØªØ¹Ù„Ù… ØªØ¹Ø§ÙˆÙ†ÙŠ + Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ¯Ø±Ø¬ (Ø³Ù‡Ù„â†’Ù…ØªÙˆØ³Ø·) + ÙˆØ§Ø¬Ø¨ Ø¹Ù„Ø§Ø¬ÙŠ Ù…Ù†Ø²Ù„ÙŠ.",
  "Ø®Ø·Ø© Ù…Ø´ØªØ±ÙƒØ© Ù…Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: Ù…Ù‡Ø§Ù… Ù…Ù†Ø²Ù„ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© + Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù…Ø®ØªØµØ±Ø© + Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¹Ø¯ ÙƒÙ„ Ù…Ø­ÙˆØ±.",
  "Ø£Ù‡Ø¯Ø§Ù Ù‚ØµÙŠØ±Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³: Ù…Ù‡Ø§Ø±Ø© ÙˆØ§Ø­Ø¯Ø©/Ø£Ø³Ø¨ÙˆØ¹ + ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© ÙØ±Ø¯ÙŠØ© + Ø±ØµØ¯ ØªÙ‚Ø¯Ù… Ø­ØªÙ‰ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨."
];
function pickPlanByGap(gap, full){
  const p = pct(full-gap, full);
  if(p < 20) return planBank[0];
  if(p < 35) return planBank[1];
  if(p < 50) return planBank[2];
  if(p < 65) return planBank[3];
  return planBank[4];
}

/* =========================
   âœ… Ø§Ù„Ø¯ÙˆÙ†Ø§Øª: Ù„Ø§ tooltips ÙˆÙ„Ø§ events ÙˆÙ„Ø§ datalabels
   âœ… Ù…Ø±ÙƒØ² Ø§Ù„Ø¯ÙˆÙ†Ø§Øª ÙÙ‚Ø· Ù†Ø³Ø¨Ø© ØµØ­ÙŠØ­Ø© (Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù… Ø·ÙˆÙŠÙ„Ø©)
========================= */
const centerText = {
  id:"centerText",
  afterDraw(chart, args, opts){
    const t = opts && opts.text;
    if(!t) return;
    const {ctx, chartArea:{left,right,top,bottom}} = chart;
    const x=(left+right)/2, y=(top+bottom)/2;
    ctx.save();
    ctx.font="900 16px Tajawal, system-ui";
    ctx.fillStyle="#111827";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(t, x, y);
    ctx.restore();
  }
};
Chart.register(centerText);

function donut(el, color){
  const ctx=$(el).getContext("2d");
  return new Chart(ctx,{
    type:"doughnut",
    data:{datasets:[{data:[0,100],backgroundColor:[color,"#e5e7eb"],borderWidth:0}]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      aspectRatio:1,
      animation:false,
      events: [],                 // âœ… ÙŠÙ…Ù†Ø¹ hover
      plugins:{
        legend:{display:false},
        tooltip:{enabled:false},  // âœ… Ù„Ø§ ØªÙ„Ù…ÙŠØ­Ø§Øª
        datalabels:{display:false},// âœ… Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
        centerText:{text:"0%"}
      },
      cutout:"80%"
    }
  });
}
function setDonut(ch, percent){
  const p=Math.max(0,Math.min(100, Math.round(percent))); // âœ… Ù…Ù†Ø¹ ÙƒØ³ÙˆØ± Ø·ÙˆÙŠÙ„Ø©
  ch.data.datasets[0].data=[p,100-p];
  ch.options.plugins.centerText.text = `${p}%`;
  ch.update();
}

const css = getComputedStyle(document.documentElement);
const chWk = donut("dWk", css.getPropertyValue("--wk").trim());
const chAc = donut("dAc", css.getPropertyValue("--ac").trim());
const chGd = donut("dGd", css.getPropertyValue("--gd").trim());
const chVg = donut("dVg", css.getPropertyValue("--vg").trim());
const chEx = donut("dEx", css.getPropertyValue("--ex").trim());

/* bar labels (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©) */
const barValueLabels = {
  id:"barValueLabels",
  afterDatasetsDraw(chart){
    const {ctx} = chart;
    const meta = chart.getDatasetMeta(0);
    if(!meta || !meta.data) return;
    ctx.save();
    ctx.font = "900 14px Tajawal, system-ui";
    ctx.fillStyle = "#0f172a";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    meta.data.forEach((bar, i)=>{
      const v = chart.data.datasets[0].data[i];
      const p = bar.tooltipPosition();
      ctx.fillText(String(v ?? 0), p.x, p.y - 6);
    });
    ctx.restore();
  }
};
Chart.register(barValueLabels);

const barChart = new Chart($("bar").getContext("2d"),{
  type:"bar",
  data:{
    labels:["Ø¶Ø¹ÙŠÙ","Ù…Ù‚Ø¨ÙˆÙ„","Ø¬ÙŠØ¯","Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹","Ù…Ù…ØªØ§Ø²"],
    datasets:[{
      data:[0,0,0,0,0],
      backgroundColor:["#ff5a5f","#f08b2f","#3f94e6","#2fb1ab","#35b46f"],
      borderRadius:16,
      maxBarThickness:90
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    animation:false,
    plugins:{
      legend:{display:false},
      tooltip:{enabled:true},
      datalabels:{display:false}
    },
    layout:{padding:{top:18}},
    scales:{
      y:{beginAtZero:true,ticks:{font:{family:"Tajawal",weight:"900",size:13}},grid:{color:"#e5e7eb"}},
      x:{ticks:{font:{family:"Tajawal",weight:"900",size:13}},grid:{display:false}}
    }
  }
});

/* Read files */
function readWorkbook(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=(e)=>{
      try{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const sheets = wb.SheetNames.map(name=>{
          const ws=wb.Sheets[name];
          const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:null,raw:true});
          return {name, rows};
        });
        resolve({sheets});
      }catch(err){reject(err);}
    };
    fr.onerror=reject;
    fr.readAsArrayBuffer(file);
  });
}
function readCSV(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>{
      const text = String(fr.result||"");
      const rows = text.split(/\r?\n/).filter(Boolean).map(line=> line.split(/[,;\t]/).map(x=>x.trim()));
      resolve({sheets:[{name:"CSV", rows}]});
    };
    fr.onerror=reject;
    fr.readAsText(file,"utf-8");
  });
}

/* Outputs */
const rEx = $("rEx"), rVg = $("rVg"), rGd = $("rGd"), rAc = $("rAc"), rWk = $("rWk");
const cEx = $("cEx"), cVg = $("cVg"), cGd = $("cGd"), cAc = $("cAc"), cWk = $("cWk");
const kN = $("kN"), kMax = $("kMax"), kMin = $("kMin"), kAvg = $("kAvg"), kRate = $("kRate"), kSum = $("kSum");
const pEx = $("pEx"), pVg = $("pVg"), pGd = $("pGd"), pAc = $("pAc"), pWk = $("pWk");
const weakRuleEl = $("weakRule"), weakCountEl = $("weakCount"), weakBody = $("weakBody");
const page2 = $("page2");

function renderWeak(list, full){
  const cutoff = weakCutoff(full);
  const weak = list.filter(r=> r.grade <= cutoff).sort((a,b)=> a.grade-b.grade);
  if(!weak.length){
    page2.classList.add("hidden");
    weakBody.innerHTML = `<tr><td colspan="6" style="text-align:center;font-weight:900;color:#6b7280;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¶Ù…Ù† ÙØ¦Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡.</td></tr>`;
    return;
  }
  page2.classList.remove("hidden");
  weakRuleEl.textContent = `Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: Ù…Ù† 0 Ø¥Ù„Ù‰ ${cutoff} (Ù…Ù† Ø£ØµÙ„ ${full})`;
  weakCountEl.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: ${weak.length}`;
  weakBody.innerHTML = weak.map(r=>{
    const per = pct(r.grade,full);
    const gap = Math.max(0, full - r.grade);
    const plan = pickPlanByGap(gap, full);
    return `
      <tr>
        <td class="nameCell">${clean(r.student)||"â€”"}</td>
        <td class="center">${clean(r.section)||"â€”"}</td>
        <td class="center">${Number(r.grade).toFixed(0)}</td>
        <td class="center">${per.toFixed(1)}%</td>
        <td class="center" style="color:#991b1b;">${gap.toFixed(0)}</td>
        <td class="plan">${plan}</td>
      </tr>
    `;
  }).join("");
}

/* Template download */
$("dlTemplate").addEventListener("click", ()=>{
  const rows = [["Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨"],["Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨","Ø§Ù„Ø´Ø¹Ø¨Ø©","Ø§Ù„Ø¯Ø±Ø¬Ø©"]];
  for(let i=0;i<25;i++) rows.push(["","",""]);
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws["!cols"] = [{wch:28},{wch:10},{wch:10}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ø¯Ø±Ø¬Ø§Øª");
  XLSX.writeFile(wb, "Ù‚Ø§Ù„Ø¨-ØªØ¹Ø¨Ø¦Ø©-Ø§Ù„Ø¯Ø±Ø¬Ø§Øª.xlsx");
});

/* Analyze */
$("doAnalyze").addEventListener("click", async ()=>{
  try{
    if(!validateInputs()){
      alert("ÙØ¶Ù„Ø§Ù‹ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (Ø¨Ø§Ù„Ø£Ø­Ù…Ø±) Ø«Ù… Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª.");
      return;
    }
    setStatus("Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„...", true);

    const f = selectedFile;
    const name = (f?.name||"").toLowerCase();
    const result = name.endsWith(".csv") ? await readCSV(f) : await readWorkbook(f);

    let list=[];
    (result.sheets||[]).forEach(sh=>{ list = list.concat(buildRecordsFromSheet(sh.rows, sh.name)); });

    const want = parseSections(inSections.value);
    if(want.length){
      const set = new Set(want.map(String));
      list = list.filter(r=> set.has(String(clean(r.section))) );
    }

    if(!list.length){
      setStatus("Ù„Ù… ØªÙÙƒØªØ´Ù Ø¨ÙŠØ§Ù†Ø§Øª", false);
      alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù. Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø£Ùˆ ØªØµØ¯ÙŠØ± Excel Ù…Ù† Ù†ÙˆØ±.");
      return;
    }

    const full = inferFullScoreSmart(list, inFullMode.value);
    tFull.textContent = String(full);
    tFull2.textContent = String(full);

    const rr = ranges(full);
    rEx.textContent = rr.ex; rVg.textContent = rr.vg; rGd.textContent = rr.gd; rAc.textContent = rr.ac; rWk.textContent = rr.wk;

    const st = stats(list, full);
    cEx.textContent = st.c.ex; cVg.textContent = st.c.vg; cGd.textContent = st.c.gd; cAc.textContent = st.c.ac; cWk.textContent = st.c.wk;

    kN.textContent = st.n;
    kMax.textContent = st.mx.toFixed(0);
    kMin.textContent = st.mn.toFixed(0);
    kAvg.textContent = st.avg.toFixed(1);
    kRate.textContent = `${st.rate.toFixed(2)}%`;
    kSum.textContent = st.sum.toFixed(0);

    const n = st.n || 1;
    const pc = (x)=> pct(x,n);

    // âœ… Ø§Ù„Ø¢Ù† Ø§Ù„Ø¯ÙˆÙ†Ø§Øª ØªØ¹ØªÙ…Ø¯ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø±Ù‚Ù… ØµØ­ÙŠØ­ (Ø¨Ø¯ÙˆÙ† ÙƒØ³ÙˆØ± Ø·ÙˆÙŠÙ„Ø©)
    setDonut(chWk, pc(st.c.wk));
    setDonut(chAc, pc(st.c.ac));
    setDonut(chGd, pc(st.c.gd));
    setDonut(chVg, pc(st.c.vg));
    setDonut(chEx, pc(st.c.ex));

    // âœ… Ø§Ù„Ù†Øµ Ø£Ø³ÙÙ„ Ø§Ù„Ø¯ÙˆÙ†Ø§Øª ÙƒØ°Ù„Ùƒ Ø£Ø±Ù‚Ø§Ù… Ù‚ØµÙŠØ±Ø©
    pWk.textContent = `${Math.round(pc(st.c.wk))}%`;
    pAc.textContent = `${Math.round(pc(st.c.ac))}%`;
    pGd.textContent = `${Math.round(pc(st.c.gd))}%`;
    pVg.textContent = `${Math.round(pc(st.c.vg))}%`;
    pEx.textContent = `${Math.round(pc(st.c.ex))}%`;

    barChart.data.datasets[0].data = [st.c.wk, st.c.ac, st.c.gd, st.c.vg, st.c.ex];
    barChart.update();

    renderWeak(list, full);

    syncHeader();
    fitAllHeaderText();
    ov.classList.remove("open");

    setStatus("ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­", true);
  }catch(err){
    console.error(err);
    setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£", false);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
  }
});

/* Print/save */
$("printSave").addEventListener("click", ()=>{
  fitAllHeaderText();
  setTimeout(()=> window.print(), 120);
});
window.addEventListener("beforeprint", ()=>{ fitAllHeaderText(); });

/* Fit header on image load */
[$("headerImg1"), $("headerImg2")].forEach(img=>{
  if(!img) return;
  img.addEventListener("load", ()=> setTimeout(fitAllHeaderText, 60));
});
</script>

</body>
</html>
