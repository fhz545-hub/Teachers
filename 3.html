<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;

  --good:#22c55e;
  --vgood:#10b981;
  --good2:#3b82f6;
  --acc:#f59e0b;
  --weak:#ef4444;

  --hdrH:34mm;
  --pageW:210mm;
  --pageH:297mm;

  --cardR:18px;

  --donut:78px;
  --donutPrint:86px;

  --printScale:0.965;
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;background:transparent !important;}
body{
  font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--ink);
  background:transparent !important;
}

/* Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„ÙƒØ§Ù…Ù„ (Ù‡ÙŠØ¯Ø± + Ù…Ø­ØªÙˆÙ‰) Ù„Ø¶Ù…Ø§Ù† ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© */
.sheet{
  width:var(--pageW);
  max-width:100%;
  margin:0 auto;
  background:transparent;
  position:relative;
  overflow:hidden;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header{
  position:relative;
  width:100%;
  height:var(--hdrH);
  background:transparent !important;
  overflow:hidden;
}
.header img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:block;
  object-fit:contain;
  object-position:center;
  background:transparent !important;
}
.header .txt{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  gap:2px;
  padding:0 12mm;
  z-index:3;
  background:transparent !important;
}
.header .txt .edu,
.header .txt .school{
  background:transparent !important;
  outline:none;
  border:none;
  color:#fff;
  font-weight:900;
  line-height:1.35;
  text-shadow:0 3px 10px rgba(0,0,0,.36);
}
.header .txt .edu{font-size:15px;}
.header .txt .school{font-size:14px;opacity:.98}

/* Ø²Ø± Ø§Ù„Ø¹Ø¯Ø³Ø© */
.header-tools{
  position:absolute;
  left:10mm;
  top:calc(var(--hdrH) - 18mm);
  z-index:5;
}
.tools-pill{
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.72);
  background:linear-gradient(135deg,#0b7e88,#0b5f88);
  color:#fff;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 4px 14px rgba(15,23,42,.30);
  white-space:nowrap;
}
.tools-pill span.icon{font-size:15px;}
.tools-pill:hover{background:linear-gradient(135deg,#065f64,#064f7a);}

/* Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¨Ø§Ø´Ø±Ø© */
.page{
  width:100%;
  height:calc(var(--pageH) - var(--hdrH));
  background:transparent !important;
  position:relative;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
.content{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:0;
  bottom:4mm;
  width:186mm;
  max-width:94%;
  overflow:hidden;
}

/* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.card{
  width:100%;
  height:100%;
  padding:3mm 5mm;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  font-size:11px;
  background:rgba(255,255,255,.98);
  border-radius:var(--cardR);
  box-shadow:0 10px 26px rgba(15,23,42,.18);
}

/* Ø´Ø±ÙŠØ· Ø±Ø³Ø§Ù„Ø© */
.top-strip{
  margin-bottom:4px;
  font-size:10.5px;
  color:var(--muted);
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø¯Ø³Ø© */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.16);
  display:none;
  align-items:flex-start;
  justify-content:center;
  z-index:100;
  padding:10px;
}
.overlay.open{display:flex;}
.panel{
  margin-top:12mm;
  width:min(980px,94vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(15,23,42,.18);
  border:1px solid #e1f3f1;
  padding:12px 16px;
  font-size:11px;
}
.panel-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.panel-title{font-weight:900;color:var(--moe);font-size:13px;}
.panel-close{border:none;background:transparent;font-size:18px;cursor:pointer;}

.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px 12px;
}
.field{display:flex;flex-direction:column;gap:4px;}
.field label{font-size:10px;color:var(--muted);}
.field input[type="text"], .field select{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:6px 10px;
  font-size:11px;
  font-family:inherit;
  background:#f9fafb;
}
.field input[type="file"]{font-size:11px;}
.missing{border-color:#ef4444 !important;background:#fef2f2 !important;}

.actions{
  margin-top:10px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.btn{
  border-radius:12px;
  border:1px solid var(--moe);
  background:var(--moe);
  color:#fff;
  padding:9px 18px;
  font-size:11px;
  cursor:pointer;
  font-family:inherit;
  min-width:170px;
  text-align:center;
  white-space:nowrap;
  box-shadow:0 3px 10px rgba(15,23,42,.25);
}
.btn:hover{background:#065f64;}

.hint{
  margin-top:10px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  border-radius:12px;
  border:1px solid #fecaca;
  background:#fef2f2;
  padding:8px 10px;
}
.hint .ic{font-size:18px;color:#b91c1c;margin-top:1px;}
.hint .tx{font-size:10px;color:#7f1d1d;line-height:1.7;}
.hint .tx strong{font-weight:900;color:#b91c1c;}

.credit{
  margin-top:10px;
  padding-top:8px;
  border-top:1px dashed #e5e7eb;
  font-size:10px;
  color:#475569;
  text-align:center;
  font-weight:800;
}

/* Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
.report-header{border-top:1px solid var(--line);padding-top:4px;}
.title-wrap{display:flex;justify-content:center;margin-bottom:4px;}
.title{
  border:1px solid var(--moe);
  border-radius:26px;
  padding:4px 22px;
  font-size:13px;
  font-weight:900;
  background:#fff;
}
.title span{color:var(--moe);font-weight:900;}

.header-row{
  margin-top:4px;
  padding:6px 10px;
  border-radius:999px;
  background:#f6f7f8;
  font-size:11px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  min-width:0;
}
.header-main{
  flex:1;min-width:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.header-main strong{color:var(--moe);}
.header-max{white-space:nowrap;}

/* Ø§Ù„ÙˆØ³Ø· */
.mid{
  margin-top:6px;
  border-top:1px solid var(--line);
  padding-top:4px;
  display:grid;
  grid-template-columns:2.1fr 1.3fr;
  gap:7px;
}

/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (Ù…ØªØ¬Ø§Ù†Ø³ Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª) */
.details-title{font-size:12px;font-weight:900;color:var(--moe);margin:0 0 4px;}
.table{
  border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
  overflow:hidden;
}
.thead{
  display:grid;
  grid-template-columns:2.4fr 1.1fr 0.9fr;
  gap:6px;
  padding:6px 8px;
  font-weight:900;
  font-size:10.5px;
  background:#f3f4f6;
  border-bottom:1px solid var(--line);
}
.thead div:nth-child(2), .thead div:nth-child(3){text-align:center;}
.trow{
  display:grid;
  grid-template-columns:2.4fr 1.1fr 0.9fr;
  gap:6px;
  padding:5px 8px;
  align-items:center;
  border-bottom:1px solid #f1f5f9;
}
.trow:last-child{border-bottom:none;}
.trow:nth-child(even){background:#fbfbfb;}
.trow .c2,.trow .c3{text-align:center;}

.badge{
  display:flex;
  align-items:center;
  width:100%;
  padding:6px 12px;
  min-height:24px;
  border-radius:999px;
  color:#fff;
  font-size:11px;
  font-weight:900;
  box-shadow:0 1px 4px rgba(15,23,42,.15);
}
.ex{background:var(--good);}
.vg{background:var(--vgood);}
.gd{background:var(--good2);}
.ac{background:var(--acc);}
.wk{background:var(--weak);}

/* Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª */
.stats{
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px;
  background:#fff;
}
.stat{
  border-radius:10px;
  border:1px solid #eef2f7;
  padding:4px 8px;
  background:#fafafa;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:5px;
}
.stat:last-child{margin-bottom:0;}
.stat .lab{color:var(--moe);font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.stat .val{font-size:12px;font-weight:900;white-space:nowrap;}

/* Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙŠ */
.analysis{
  margin-top:6px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px;
  background:#fafafa;
  font-size:11px;
}
.analysis-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:4px;}
.analysis-title{font-size:12px;font-weight:900;color:var(--moe);}
.tag{
  padding:2px 12px;
  border-radius:999px;
  font-size:10px;
  font-weight:900;
  border:1px solid #d1d5db;
  white-space:nowrap;
  background:#fff;
}
.tag.good{color:#16a34a;border-color:#16a34a;background:#dcfce7;}
.tag.mid{color:#ea580c;border-color:#ea580c;background:#ffedd5;}
.tag.weak{color:#b91c1c;border-color:#b91c1c;background:#fee2e2;}
.list{margin:0;padding-right:18px;}
.list li{margin-bottom:2px;}

/* Ø§Ù„Ø±Ø³ÙˆÙ… */
.charts{
  margin-top:6px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px;
  background:#fff;
}
.ch-title{font-size:11px;font-weight:900;color:var(--moe);text-align:center;margin-bottom:4px;}
.dgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;}
.dcard{
  border-radius:12px;
  border:1px solid #eef2f7;
  padding:6px 4px 7px;
  text-align:center;
  background:#fafafa;
}
.dwrap{display:grid;place-items:center;}
.donut{
  width:var(--donut) !important;
  height:var(--donut) !important;
  display:block;
}
.dlab{font-size:9px;color:#4b5563;}
.dval{font-size:9px;font-weight:900;}

.bar{
  margin-top:6px;
  border-radius:12px;
  border:1px solid #eef2f7;
  padding:5px;
}
.bar canvas{width:100%;height:84px;}

/* Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† */
.plan{
  margin-top:6px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px 5px;
  background:#fff;
  font-size:10px;
}
.plan-title{font-size:11px;font-weight:900;color:var(--moe);}
.plan-sub{font-size:9px;color:var(--muted);margin-bottom:2px;}
.plan-sum{font-size:9px;margin-top:3px;}
.tbl{width:100%;border-collapse:collapse;font-size:9px;margin-top:3px;}
.tbl th,.tbl td{border:1px solid var(--line);padding:2px 3px;}
.tbl th{background:#f3f4f6;white-space:nowrap;}
.tbl td.name,.tbl td.id{white-space:nowrap;}
.follow{text-align:center;white-space:nowrap;}
.follow label{display:inline-flex;align-items:center;gap:2px;margin-inline:2px;font-size:8px;}
.follow input{width:9px;height:9px;}

/* Ø§Ù„ÙÙˆØªØ± */
.footer{
  margin-top:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:10.5px;
  color:#4b5563;
  gap:10px;
}
.footer p{margin:0;white-space:nowrap;}
.footer strong{color:#111827;}

/* Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„ØªØ§Ø¨Ù„Øª */
@media (max-width:900px){
  .sheet{width:100%;}
  .header{height:94px;}
  .page{height:auto;min-height:calc(100vh - 94px);}
  .content{
    position:relative;
    left:auto;transform:none;
    width:min(980px,96%);
    max-width:96%;
    margin:8px auto 18px;
    overflow:visible;
    top:auto;bottom:auto;
  }
  .card{height:auto;border-radius:14px;}
  .dgrid{grid-template-columns:repeat(2,1fr);}
  .grid{grid-template-columns:1fr;}
  .header-tools{top:12px;left:12px;}
}
@media (max-width:600px){
  .card{font-size:10px;padding:2mm 3mm;}
  .header-row{font-size:10px;padding:4px 8px;}
  .donut{width:82px !important;height:82px !important;}
  .bar canvas{height:76px;}
  .tbl{font-size:8px;}
}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© */
@media print{
  @page{size:A4 portrait;margin:0;}
  html,body{height:100%;background:transparent !important;}
  body{margin:0;padding:0;overflow:hidden;}
  .overlay{display:none !important;}
  .header-tools{display:none !important;}

  .sheet{
    width:var(--pageW) !important;
    height:var(--pageH) !important;
    margin:0 !important;
    overflow:hidden !important;
    transform:scale(var(--printScale));
    transform-origin:top center;
  }
  .header{height:var(--hdrH) !important;}
  .page{
    height:calc(var(--pageH) - var(--hdrH)) !important;
    overflow:hidden !important;
  }
  .content{top:0 !important;bottom:3.5mm !important;}
  .card{
    box-shadow:none !important;
    border-radius:0 !important;
    font-size:9.8px !important;
    padding:2.6mm 4.6mm !important;
  }
  .donut{width:var(--donutPrint) !important;height:var(--donutPrint) !important;}
  .bar canvas{height:78px !important;}
  .trow:nth-child(even){background:#fff !important;}

  .card,.report-header,.mid,.analysis,.charts,.plan,.footer{
    break-inside:avoid !important;
    page-break-inside:avoid !important;
  }
}
</style>
</head>

<body>

<div class="sheet" id="sheet">
  <header class="header">
    <img src="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ .png" alt="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„" />
    <div class="txt">
      <div id="eduName" class="edu" contenteditable="true">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
      <div id="schoolName" class="school" contenteditable="true">Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</div>
    </div>
    <div class="header-tools">
      <button type="button" class="tools-pill" id="toolsBtn">
        <span class="icon">ğŸ”</span>
        <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDF</span>
      </button>
    </div>
  </header>

  <div class="page">
    <div class="content">
      <section class="card">

        <div class="top-strip">
          <span id="statusMessage">Ø§Ø¶ØºØ· Ø²Ø± Â«Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDFÂ» Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</span>
        </div>

        <!-- Ø§Ù„Ø¹Ø¯Ø³Ø© -->
        <div class="overlay" id="overlay">
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
              <button type="button" class="panel-close" id="closeOverlay">âœ•</button>
            </div>

            <div class="grid">
              <div class="field">
                <label for="excelFile">ğŸ“‚ Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Excel)</label>
                <input id="excelFile" type="file" accept=".xlsx,.xls" />
              </div>

              <div class="field">
                <label for="subjectInput">Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="subjectInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
              </div>

              <div class="field">
                <label for="stageInput">Ø§Ù„ØµÙ</label>
                <input id="stageInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ" />
              </div>

              <div class="field">
                <label for="sectionInput">Ø§Ù„Ø´Ø¹Ø¨Ø© (ÙŠÙ…ÙƒÙ† Ø¹Ø¯Ø© Ø´Ø¹Ø¨: 1,2,3)</label>
                <input id="sectionInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 1 Ø£Ùˆ 1,2,3" />
              </div>

              <div class="field">
                <label for="periodInput">Ø§Ù„ÙØªØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="periodInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰" />
              </div>

              <div class="field">
                <label for="termInput">Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…</label>
                <input id="termInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 1447Ù‡Ù€ â€“ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„" />
              </div>

              <div class="field">
                <label for="teacherInput">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù…Ù†Ø³Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="teacherInput" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯" />
              </div>

              <div class="field">
                <label for="scaleMode">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                <select id="scaleMode">
                  <option value="auto">Ø¢Ù„ÙŠ (Ø°ÙƒÙŠ)</option>
                  <option value="period40">Ø§Ø®ØªØ¨Ø§Ø± (0â€“40)</option>
                  <option value="period60">Ø§Ø®ØªØ¨Ø§Ø± (0â€“60)</option>
                  <option value="final100">Ø§Ø®ØªØ¨Ø§Ø± (0â€“100)</option>
                </select>
              </div>

              <div class="field">
                <label for="eduInput">Ù†Øµ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
                <input id="eduInput" type="text" placeholder="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©" />
              </div>

              <div class="field">
                <label for="schoolInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
                <input id="schoolInput" type="text" placeholder="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±" />
              </div>

              <div class="field">
                <label for="principalInput">Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø¥Ø¶Ø§ÙÙŠ)</label>
                <input id="principalInput" type="text" value="ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ" />
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn" id="analyzeBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
              <button type="button" class="btn" id="printBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
            </div>

            <div class="hint">
              <div class="ic">âš ï¸</div>
              <div class="tx">
                <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† Â«Ù†ÙˆØ±Â»:</strong><br/>
                Ù†Ø¸Ø§Ù… Ù†ÙˆØ± â†’ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± â†’ ØªÙ‚Ø§Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª â†’ ÙƒØ´Ù Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ø§Ø¯Ø© â†’ Â«ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ ExcelÂ».
              </div>
            </div>

            <div class="credit">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø© ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
          </div>
        </div>

        <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
        <div class="report-header">
          <div class="title-wrap">
            <div class="title">ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø© <span id="titleSubject">[Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ù…Ø±Ø­Ù„Ø©]</span></div>
          </div>

          <div class="header-row">
            <div class="header-main">
              Ø§Ù„ØµÙ: <strong id="stageField">â€”</strong>
              Â· Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="subjectField">â€”</strong>
              Â· Ø§Ù„ÙØªØ±Ø© / Ø§Ù„ÙØµÙ„: <strong id="termField">â€”</strong>
              Â· Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="teacherField">â€”</strong>
            </div>
            <div class="header-max">
              Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©: <strong id="maxScoreField">â€”</strong>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="mid">
          <div>
            <div class="details-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
            <div class="table">
              <div class="thead">
                <div>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div><div>Ø§Ù„Ù†Ø·Ø§Ù‚</div><div>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
              </div>

              <div class="trow">
                <div><span class="badge ex">Ù…Ù…ØªØ§Ø²</span></div>
                <div class="c2" id="rangeExcellent">â€”</div>
                <div class="c3" id="countExcellent">0</div>
              </div>
              <div class="trow">
                <div><span class="badge vg">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</span></div>
                <div class="c2" id="rangeVGood">â€”</div>
                <div class="c3" id="countVGood">0</div>
              </div>
              <div class="trow">
                <div><span class="badge gd">Ø¬ÙŠØ¯</span></div>
                <div class="c2" id="rangeGood">â€”</div>
                <div class="c3" id="countGood">0</div>
              </div>
              <div class="trow">
                <div><span class="badge ac">Ù…Ù‚Ø¨ÙˆÙ„</span></div>
                <div class="c2" id="rangeAcceptable">â€”</div>
                <div class="c3" id="countAcceptable">0</div>
              </div>
              <div class="trow">
                <div><span class="badge wk">Ø¶Ø¹ÙŠÙ</span></div>
                <div class="c2" id="rangeWeak">â€”</div>
                <div class="c3" id="countWeak">0</div>
              </div>
            </div>
          </div>

          <div class="stats">
            <div class="stat"><span class="lab">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨/Ø§Ù„Ø­Ø§Ù„Ø§Øª</span><span class="val" id="statN">0</span></div>
            <div class="stat"><span class="lab">Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</span><span class="val" id="statMax">0</span></div>
            <div class="stat"><span class="lab">Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©</span><span class="val" id="statMin">0</span></div>
            <div class="stat"><span class="lab">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="val" id="statAvg">0</span></div>
            <div class="stat"><span class="lab">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</span><span class="val" id="statPct">0%</span></div>
            <div class="stat"><span class="lab">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="val" id="statSum">0</span></div>
          </div>
        </div>

        <!-- Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙŠ -->
        <div class="analysis">
          <div class="analysis-head">
            <div class="analysis-title">Ù‚Ø±Ø§Ø¡Ø© ØªØ­Ù„ÙŠÙ„ÙŠØ© Ø°ÙƒÙŠØ©</div>
            <div id="tag" class="tag">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
          </div>
          <div id="analysisText">Ù„Ù… ØªÙØ­Ù…Ù‘ÙÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
          <ul id="bullets" class="list"></ul>
        </div>

        <!-- Ø§Ù„Ø±Ø³ÙˆÙ… -->
        <div class="charts">
          <div class="ch-title">Ù†ÙØ³ÙØ¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±</div>
          <div class="dgrid">
            <div class="dcard">
              <div class="dwrap"><canvas id="dWeak" class="donut"></canvas></div>
              <div class="dlab">Ø¶Ø¹ÙŠÙ</div>
              <div class="dval" id="pWeak">0% (0)</div>
            </div>
            <div class="dcard">
              <div class="dwrap"><canvas id="dAcc" class="donut"></canvas></div>
              <div class="dlab">Ù…Ù‚Ø¨ÙˆÙ„</div>
              <div class="dval" id="pAcc">0% (0)</div>
            </div>
            <div class="dcard">
              <div class="dwrap"><canvas id="dGood" class="donut"></canvas></div>
              <div class="dlab">Ø¬ÙŠØ¯</div>
              <div class="dval" id="pGood">0% (0)</div>
            </div>
            <div class="dcard">
              <div class="dwrap"><canvas id="dVGood" class="donut"></canvas></div>
              <div class="dlab">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</div>
              <div class="dval" id="pVGood">0% (0)</div>
            </div>
            <div class="dcard">
              <div class="dwrap"><canvas id="dEx" class="donut"></canvas></div>
              <div class="dlab">Ù…Ù…ØªØ§Ø²</div>
              <div class="dval" id="pEx">0% (0)</div>
            </div>
          </div>

          <div class="ch-title" style="margin-top:4px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±</div>
          <div class="bar">
            <canvas id="barLevels"></canvas>
          </div>
        </div>

        <!-- Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† -->
        <div class="plan">
          <div class="plan-title">Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡</div>
          <div class="plan-sub" id="ruleNote">Ø³ÙŠØªÙ… ÙØ±Ø² Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ ÙˆÙÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</div>

          <table class="tbl">
            <thead>
              <tr>
                <th style="width:24%">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th style="width:14%">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                <th style="width:18%">Ø§Ù„Ø¯Ø±Ø¬Ø© / Ø§Ù„ÙØ¬ÙˆØ©</th>
                <th style="width:36%">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
                <th style="width:14%">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              </tr>
            </thead>
            <tbody id="planBody">
              <tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¶Ù…Ù† ÙØ¦Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡.</td></tr>
            </tbody>
          </table>

          <div class="plan-sum" id="planSum">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
        </div>

        <!-- ÙÙˆØªØ± -->
        <div class="footer">
          <p>Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / <strong id="ftTeacher">â€”</strong></p>
          <p>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / <strong id="ftPrincipal" contenteditable="true">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</strong></p>
        </div>

      </section>
    </div>
  </div>
</div>

<script>
/* =========================
   Ø£Ø¯ÙˆØ§Øª Ø±Ù‚Ù…ÙŠØ©
   ========================= */
const normalizeDigits = (str)=>{
  if(str == null) return "";
  str = String(str);
  const map = {'Ù ':0,'Ù¡':1,'Ù¢':2,'Ù£':3,'Ù¤':4,'Ù¥':5,'Ù¦':6,'Ù§':7,'Ù¨':8,'Ù©':9};
  return str.replace(/[Ù -Ù©]/g,d=>map[d]).replace(/,/g,".");
};
const isNumeric = (val)=>{
  if(val === null || val === undefined) return false;
  if(typeof val === "number") return !isNaN(val);
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return !isNaN(n);
};
const toNumber = (val)=>{
  if(typeof val === "number") return val;
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return isNaN(n) ? NaN : n;
};
const clean = (s)=> (s||"").replace(/\s+/g," ").trim();

/* =========================
   DOM
   ========================= */
const toolsBtn = document.getElementById("toolsBtn");
const overlay = document.getElementById("overlay");
const closeOverlay = document.getElementById("closeOverlay");

const excelFile = document.getElementById("excelFile");
const subjectInput = document.getElementById("subjectInput");
const stageInput = document.getElementById("stageInput");
const sectionInput = document.getElementById("sectionInput");
const periodInput = document.getElementById("periodInput");
const termInput = document.getElementById("termInput");
const teacherInput = document.getElementById("teacherInput");
const scaleMode = document.getElementById("scaleMode");

const eduName = document.getElementById("eduName");
const schoolName = document.getElementById("schoolName");
const eduInput = document.getElementById("eduInput");
const schoolInput = document.getElementById("schoolInput");

const principalInput = document.getElementById("principalInput");
const ftPrincipal = document.getElementById("ftPrincipal");

const analyzeBtn = document.getElementById("analyzeBtn");
const printBtn = document.getElementById("printBtn");
const statusMessage = document.getElementById("statusMessage");

const titleSubject = document.getElementById("titleSubject");
const stageField = document.getElementById("stageField");
const subjectField = document.getElementById("subjectField");
const termField = document.getElementById("termField");
const teacherField = document.getElementById("teacherField");
const maxScoreField = document.getElementById("maxScoreField");

const rangeExcellent = document.getElementById("rangeExcellent");
const rangeVGood = document.getElementById("rangeVGood");
const rangeGood = document.getElementById("rangeGood");
const rangeAcceptable = document.getElementById("rangeAcceptable");
const rangeWeak = document.getElementById("rangeWeak");

const countExcellent = document.getElementById("countExcellent");
const countVGood = document.getElementById("countVGood");
const countGood = document.getElementById("countGood");
const countAcceptable = document.getElementById("countAcceptable");
const countWeak = document.getElementById("countWeak");

const statN = document.getElementById("statN");
const statMax = document.getElementById("statMax");
const statMin = document.getElementById("statMin");
const statAvg = document.getElementById("statAvg");
const statPct = document.getElementById("statPct");
const statSum = document.getElementById("statSum");

const tag = document.getElementById("tag");
const analysisText = document.getElementById("analysisText");
const bullets = document.getElementById("bullets");

const pWeak = document.getElementById("pWeak");
const pAcc = document.getElementById("pAcc");
const pGood = document.getElementById("pGood");
const pVGood = document.getElementById("pVGood");
const pEx = document.getElementById("pEx");

const ruleNote = document.getElementById("ruleNote");
const planBody = document.getElementById("planBody");
const planSum = document.getElementById("planSum");

/* =========================
   Ø­Ø§Ù„Ø©
   ========================= */
let selected = null;
let records = [];
let donuts = {};
let bar = null;

function setStatus(t){ statusMessage.textContent = t; }

/* =========================
   Ø±Ø¨Ø· Ø§Ù„Ù‡ÙŠØ¯Ø±/Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª
   ========================= */
function syncInputsFromHeader(){
  eduInput.value = clean(eduName.textContent);
  schoolInput.value = clean(schoolName.textContent);
}
function syncHeaderFromInputs(){
  if(clean(eduInput.value)) eduName.textContent = clean(eduInput.value);
  if(clean(schoolInput.value)) schoolName.textContent = clean(schoolInput.value);
}
eduName.addEventListener("input", syncInputsFromHeader);
schoolName.addEventListener("input", syncInputsFromHeader);
eduInput.addEventListener("input", syncHeaderFromInputs);
schoolInput.addEventListener("input", syncHeaderFromInputs);
syncInputsFromHeader();

/* Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± (Ø®ÙˆØ§Ø±Ø²Ù…ÙŠ) */
function syncPrincipalFromInput(){
  const v = clean(principalInput.value) || "ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ";
  ftPrincipal.textContent = v;
}
function syncPrincipalToInput(){
  principalInput.value = clean(ftPrincipal.textContent) || "ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ";
}
principalInput.addEventListener("input", syncPrincipalFromInput);
ftPrincipal.addEventListener("input", syncPrincipalToInput);
syncPrincipalToInput();

/* =========================
   Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø¯Ø³Ø©
   ========================= */
toolsBtn.addEventListener("click", ()=>{
  syncInputsFromHeader();
  syncPrincipalToInput();
  overlay.classList.add("open");
});
closeOverlay.addEventListener("click", ()=> overlay.classList.remove("open"));

excelFile.addEventListener("change", (e)=>{ selected = e.target.files[0] || null; });

/* =========================
   Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø³Ù… Ø°ÙƒÙŠ + ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
   ========================= */
let originalTitle = document.title;

function buildPrintTitle(){
  const subj = clean(subjectInput.value) || "Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©";
  const stage = clean(stageInput.value) || "";
  const sec = clean(sectionInput.value);
  const secLabel = sec ? ` ${sec}` : "";
  // Ø¥Ø°Ø§ Ù„Ù… ØªÙØ­Ø¯Ø¯ Ù…Ø§Ø¯Ø© Ù†ÙƒØªØ¨ "ØªØ­Ù„ÙŠÙ„ Ù…Ø±Ø­Ù„Ø© ..."
  if(!clean(subjectInput.value)){
    return `ØªØ­Ù„ÙŠÙ„ Ù…Ø±Ø­Ù„Ø© ${stage}${secLabel}`.replace(/\s+/g," ").trim();
  }
  return `ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ø¯Ø© ${subj} ${stage}${secLabel}`.replace(/\s+/g," ").trim();
}
function printSmart(){
  const t = buildPrintTitle();
  originalTitle = document.title;
  document.title = t;
  window.print();
  setTimeout(()=>{ document.title = originalTitle; }, 400);
}
printBtn.addEventListener("click", printSmart);

/* =========================
   Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ø¯Ù‚Ø©
   ========================= */
function parseExcel(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data,{type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:null,raw:true});
        resolve(rows);
      }catch(err){reject(err);}
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

/* Ø¨Ù†Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª (Ø£ÙƒØ«Ø± ØµÙ„Ø§Ø¨Ø© Ù„Ù†ÙˆØ±) */
function buildRecords(rows){
  if(!rows || !rows.length) return [];

  // Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"
  let h=-1;
  for(let i=0;i<Math.min(rows.length,100);i++){
    const row = rows[i];
    if(!row) continue;
    const joined = row.map(c=>c==null?"":String(c)).join(" ");
    if(/Ø§Ø³Ù…\s*Ø§Ù„Ø·Ø§Ù„Ø¨/.test(joined)){ h=i; break; }
  }

  // fallback Ø±Ù‚Ù…ÙŠ
  if(h===-1){
    const g=[];
    for(const row of rows){
      if(!row) continue;
      for(const cell of row){
        if(isNumeric(cell)){
          const n=toNumber(cell);
          if(n>=0 && n<=200) g.push(n);
        }
      }
    }
    return g.map(v=>({student:"â€”",id:"â€”",grade:v,subject:"",section:""}));
  }

  const headers = rows[h] || [];
  let nameCol=-1,idCol=-1,subCol=-1,secCol=-1,gradeCol=-1;

  headers.forEach((cell,idx)=>{
    if(cell==null) return;
    const s=String(cell);
    if(nameCol===-1 && /Ø§Ø³Ù…/.test(s) && /Ø·Ø§Ù„Ø¨/.test(s)) nameCol=idx;
    if(idCol===-1 && /Ù‡ÙˆÙŠØ©|Ø§Ù„Ø³Ø¬Ù„|Ø§Ù„Ù…Ø¯Ù†ÙŠ/.test(s)) idCol=idx;
    if(subCol===-1 && /Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„Ù…Ù‚Ø±Ø±/.test(s)) subCol=idx;
    if(secCol===-1 && /Ø§Ù„Ø´Ø¹Ø¨Ø©|Ø§Ù„Ù‚Ø³Ù…|Ø´Ø¹Ø¨Ø©/.test(s)) secCol=idx;
  });

  // ØµÙ Ø«Ø§Ù†ÙŠ ØºØ§Ù„Ø¨Ù‹Ø§ ÙÙŠÙ‡ "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹/Ø§Ù„Ø¯Ø±Ø¬Ø©"
  const r2 = rows[h+1] || [];
  r2.forEach((cell,idx)=>{
    if(cell==null) return;
    const s=String(cell);
    if(gradeCol===-1 && /Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ø¯Ø±Ø¬Ø©|Ø§Ù„Ø¯Ø±Ø¬Ù‡/.test(s)) gradeCol=idx;
  });

  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ­Ø¯Ø¯: Ø§Ø³ØªÙ†Ø¨Ø· Ø£ÙØ¶Ù„ Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù…ÙŠ
  if(gradeCol===-1){
    let best=-1,bMean=-1;
    const maxCols = Math.max(...rows.map(r=>r? r.length:0));
    for(let c=0;c<maxCols;c++){
      const vals=[];
      for(let r=h+1;r<rows.length;r++){
        const row=rows[r];
        if(!row || c>=row.length) continue;
        const v=row[c];
        if(isNumeric(v)){
          const n=toNumber(v);
          if(n>=0 && n<=200) vals.push(n);
        }
      }
      if(vals.length>=6){
        const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
        if(mean>bMean){bMean=mean;best=c;}
      }
    }
    gradeCol=best;
  }

  const out=[];
  for(let r=h+1;r<rows.length;r++){
    const row=rows[r];
    if(!row) continue;

    const nameRaw = nameCol>=0 ? row[nameCol] : null;
    const idRaw   = idCol>=0 ? row[idCol] : null;
    const gRaw    = gradeCol>=0 ? row[gradeCol] : null;
    const sRaw    = subCol>=0 ? row[subCol] : null;
    const secRaw  = secCol>=0 ? row[secCol] : null;

    const name = nameRaw ? String(nameRaw).trim() : "";
    const id   = idRaw ? normalizeDigits(idRaw).replace(/[^\d]/g,"") : "";
    const grade = isNumeric(gRaw) ? toNumber(gRaw) : NaN;
    const subject = sRaw ? String(sRaw).trim() : "";
    const section = secRaw ? normalizeDigits(String(secRaw)).trim() : "";

    if(!name && !id) continue;
    if(!isFinite(grade) || grade<0 || grade>200) continue;
    if(/Ø§Ù„ÙØµÙ„|Ø§Ù„Ø´Ø¹Ø¨Ø©|Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„ØµÙ|ÙƒØ´Ù Ø±ØµØ¯|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ù…ØªÙˆØ³Ø·|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰/i.test(name)) continue;

    out.push({student:name||"Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…", id:id||"â€”", grade, subject, section});
  }
  return out;
}

/* ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø´Ø¹Ø¨ */
function parseSectionsInput(v){
  const s = normalizeDigits(v||"").trim();
  if(!s) return [];
  return s.split(/[,ØŒ/|]+/).map(x=>x.trim()).filter(Boolean);
}
function applyFilters(list){
  let arr = list.slice();

  const subj = clean(subjectInput.value);
  const secs = parseSectionsInput(sectionInput.value);

  if(subj){
    const hasSub = arr.some(r=>clean(r.subject));
    if(hasSub){
      const key = subj.replace(/\s+/g,"").toLowerCase();
      arr = arr.filter(r => (r.subject||"").replace(/\s+/g,"").toLowerCase().includes(key));
    }
  }

  if(secs.length){
    const hasSec = arr.some(r=>clean(r.section));
    if(hasSec){
      const set = new Set(secs.map(String));
      arr = arr.filter(r => set.has(String(clean(r.section))));
    }
  }

  return arr;
}

/* Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© */
function inferFullScore(list){
  const maxGrade = Math.max(...list.map(r=>r.grade));
  const candidates = [40,60,100,50,30,20];
  let inferred = maxGrade, best = Infinity;
  for(const c of candidates){
    if(c>=maxGrade && Math.abs(c-maxGrade)<=5){
      const d = Math.abs(c-maxGrade);
      if(d<best){best=d; inferred=c;}
    }
  }
  return inferred;
}
function getFullScore(list){
  if(scaleMode.value==="period40") return 40;
  if(scaleMode.value==="period60") return 60;
  if(scaleMode.value==="final100") return 100;
  return inferFullScore(list);
}

/* Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ (Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø¯Ù‚Ø©) */
const DEFAULT_WEAK_PERCENT = 25;
function weakRule(fullScore){
  if(fullScore === 40){
    return {thr:20, note:"Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: Ø£Ù‚Ù„ Ù…Ù† 20 Ù…Ù† 40 (50%)."};
  }
  const thr = fullScore * (DEFAULT_WEAK_PERCENT/100);
  return {thr, note:`Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: Ø£Ù‚Ù„ Ù…Ù† ${DEFAULT_WEAK_PERCENT}% Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø£ÙŠ Ø£Ù‚Ù„ Ù…Ù† ${thr.toFixed(1)}).`};
}

/* Ù…Ø³ØªÙˆÙŠØ§Øª */
function level(score, fullScore){
  const p = (score/fullScore)*100;
  if(p>=90) return "ex";
  if(p>=80) return "vg";
  if(p>=70) return "gd";
  if(p>=60) return "ac";
  return "wk";
}

/* Ø¨Ù†Ùƒ Ø®Ø·Ø· Ø¹Ù„Ø§Ø¬ÙŠØ© */
const bankSevere = [
  "Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ ÙØ±Ø¯ÙŠØ©: Ù…Ù‡Ø§Ø±Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© + Ø­ØµØªØ§Ù† Ø¹Ù„Ø§Ø¬ÙŠÙ‘ØªØ§Ù† Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ‹Ø§ + Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ.",
  "Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù„Ø§Ø¬ÙŠ Ù…ÙƒØ«Ù: ØªØ¯Ø±ÙŠØ¨ Ù…ÙˆØ¬Ù‡ + ÙˆØ§Ø¬Ø¨Ø§Øª Ø¹Ù„Ø§Ø¬ÙŠØ© Ù‚ØµÙŠØ±Ø© + Ù…ØªØ§Ø¨Ø¹Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ‹Ø§.",
  "Ø¯Ø¹Ù… ÙØ±Ø¯ÙŠ: ØªØ­Ù„ÙŠÙ„ Ø£Ø®Ø·Ø§Ø¡ + ØªØ¯Ø±ÙŠØ¨ Ù…Ù‡Ø§Ø±ÙŠ + Ù‚ÙŠØ§Ø³ ØªÙ‚Ø¯Ù‘Ù… Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙˆØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©."
];

/* Chart plugins */
const centerLabelPlugin = {
  id:"centerLabel",
  afterDraw(chart, args, opts){
    const t = opts && opts.text;
    if(!t) return;
    const {ctx, chartArea:{left,right,top,bottom}} = chart;
    const x=(left+right)/2, y=(top+bottom)/2;
    ctx.save();
    ctx.font = "900 13px Tajawal, system-ui";
    ctx.fillStyle="#111827";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(t, x, y);
    ctx.restore();
  }
};
const barValuePlugin = {
  id:"barValue",
  afterDatasetsDraw(chart){
    if(chart.config.type!=="bar") return;
    const {ctx} = chart;
    const ds = chart.data.datasets[0];
    const meta = chart.getDatasetMeta(0);
    ctx.save();
    ctx.font="900 10px Tajawal, system-ui";
    ctx.fillStyle="#111827";
    ctx.textAlign="center";
    ds.data.forEach((v,i)=>{
      const bar = meta.data[i];
      if(!bar) return;
      const p = bar.getProps(["y","base","x"], true);
      ctx.fillText(v, p.x, (p.y+p.base)/2);
    });
    ctx.restore();
  }
};
Chart.register(centerLabelPlugin, barValuePlugin);

/* Ø§Ù„Ø±Ø³ÙˆÙ… */
function setupCharts(){
  const donutCfg = [
    {id:"dWeak",  col:"#ef4444"},
    {id:"dAcc",   col:"#f59e0b"},
    {id:"dGood",  col:"#3b82f6"},
    {id:"dVGood", col:"#10b981"},
    {id:"dEx",    col:"#22c55e"}
  ];
  donutCfg.forEach(c=>{
    donuts[c.id]=new Chart(document.getElementById(c.id).getContext("2d"),{
      type:"doughnut",
      data:{labels:["Ø§Ù„Ù†Ø³Ø¨Ø©","Ø§Ù„Ø¨Ø§Ù‚ÙŠ"],datasets:[{data:[0,100],backgroundColor:[c.col,"#e5e7eb"],borderWidth:0}]},
      options:{plugins:{legend:{display:false},tooltip:{enabled:false},centerLabel:{text:"0%"}},cutout:"72%",animation:false}
    });
  });

  bar = new Chart(document.getElementById("barLevels").getContext("2d"),{
    type:"bar",
    data:{
      labels:["Ø¶Ø¹ÙŠÙ","Ù…Ù‚Ø¨ÙˆÙ„","Ø¬ÙŠØ¯","Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§","Ù…Ù…ØªØ§Ø²"],
      datasets:[{data:[0,0,0,0,0],backgroundColor:["#ef4444","#f59e0b","#3b82f6","#10b981","#22c55e"],borderRadius:6,maxBarThickness:32}]
    },
    options:{
      plugins:{legend:{display:false},barValue:{}},
      responsive:true,maintainAspectRatio:false,animation:false,
      scales:{
        x:{ticks:{font:{family:"Tajawal",size:10}}},
        y:{beginAtZero:true,ticks:{stepSize:1,font:{family:"Tajawal",size:9}}}
      }
    }
  });
}
function updateDonut(id, pct){
  const ch = donuts[id]; if(!ch) return;
  const p = Math.max(0, Math.min(100, pct));
  ch.data.datasets[0].data=[p,100-p];
  ch.options.plugins.centerLabel.text = `${Math.round(p)}%`;
  ch.update();
}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª */
function setRanges(fullScore){
  const exMin=Math.round(fullScore*0.90);
  const vgMin=Math.round(fullScore*0.80);
  const gdMin=Math.round(fullScore*0.70);
  const acMin=Math.round(fullScore*0.60);

  rangeExcellent.textContent=`${exMin}-${fullScore}`;
  rangeVGood.textContent=`${vgMin}-${exMin-1}`;
  rangeGood.textContent=`${gdMin}-${vgMin-1}`;
  rangeAcceptable.textContent=`${acMin}-${gdMin-1}`;
  rangeWeak.textContent=`0-${acMin-1}`;
}

/* Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙŠ */
function narrative(fullScore, stats, rule){
  const {n,avg,avgPct,max,min,c} = stats;
  if(!n){
    tag.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯";
    tag.className="tag";
    analysisText.textContent="Ù„Ù… ØªÙØ­Ù…Ù‘ÙÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
    bullets.innerHTML="";
    return;
  }

  let cls="tag mid", label="ØªØ­ØµÙŠÙ„ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø²ÙŠØ²Ù‹Ø§.";
  if(avgPct>=90){cls="tag good";label="ØªØ­ØµÙŠÙ„ Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ù‹Ø§.";}
  else if(avgPct>=80){cls="tag good";label="ØªØ­ØµÙŠÙ„ Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§.";}
  else if(avgPct>=70){cls="tag mid";label="ØªØ­ØµÙŠÙ„ Ø¬ÙŠØ¯ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø²ÙŠØ²Ù‹Ø§.";}
  else if(avgPct>=60){cls="tag mid";label="ØªØ­ØµÙŠÙ„ Ù…Ù‚Ø¨ÙˆÙ„ ÙŠØ­ØªØ§Ø¬ Ø¯Ø¹Ù…Ù‹Ø§.";}
  else{cls="tag weak";label="ØªØ­ØµÙŠÙ„ Ø¶Ø¹ÙŠÙ ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ù‹Ø§ Ø¹Ù„Ø§Ø¬ÙŠÙ‹Ø§.";}

  tag.className=cls;
  tag.textContent=avgPct.toFixed(1)+"%";

  const subj = clean(subjectInput.value);
  const secs = parseSectionsInput(sectionInput.value);
  const scope =
    subj && secs.length ? `ÙÙŠ Ù…Ø§Ø¯Ø© ${subj} Ù„Ø´ÙØ¹Ø¨ (${secs.join(", ")})` :
    subj ? `ÙÙŠ Ù…Ø§Ø¯Ø© ${subj}` :
    secs.length ? `Ù„Ù„Ø´ÙØ¹Ø¨ (${secs.join(", ")})` : "Ù„Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©";

  analysisText.textContent = `Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ­ØµÙŠÙ„ ${scope} (${avg.toFixed(1)} Ù…Ù† ${fullScore.toFixed(1)}) ÙŠØ¹ÙƒØ³: ${label}`;

  const pct = (x)=> (n? (x/n*100):0);
  bullets.innerHTML="";
  const li = (t)=>{const e=document.createElement("li"); e.textContent=t; bullets.appendChild(e);};

  li(`Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${n} â€” Ø£Ø¹Ù„Ù‰: ${max.toFixed(1)} â€” Ø£Ù‚Ù„: ${min.toFixed(1)} â€” Ù…ØªÙˆØ³Ø·: ${avgPct.toFixed(1)}Ùª.`);
  li(`Ø§Ù„ØªÙˆØ²ÙŠØ¹: Ù…Ù…ØªØ§Ø² ${c.ex} (${pct(c.ex).toFixed(1)}Ùª)ØŒ Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ ${c.vg} (${pct(c.vg).toFixed(1)}Ùª)ØŒ Ø¬ÙŠØ¯ ${c.gd} (${pct(c.gd).toFixed(1)}Ùª)ØŒ Ù…Ù‚Ø¨ÙˆÙ„ ${c.ac} (${pct(c.ac).toFixed(1)}Ùª)ØŒ Ø¶Ø¹ÙŠÙ ${c.wk} (${pct(c.wk).toFixed(1)}Ùª).`);
  li(`${rule.note}`);
}

/* Ø®Ø·Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ */
function plan(fullScore, rule){
  ruleNote.textContent = rule.note;

  const weak = records.filter(r => r.grade < rule.thr).sort((a,b)=>a.grade-b.grade);
  planBody.innerHTML="";

  if(!weak.length){
    planBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¶Ù…Ù† ÙØ¦Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ ÙˆÙÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</td></tr>';
    planSum.textContent = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¹ØªØ¨Ø© (${rule.thr.toFixed(1)}).`;
    return;
  }

  const n=records.length;
  const pctWeak = (weak.length/n*100).toFixed(1);
  const subj = clean(subjectInput.value);
  const scope = subj ? `ÙÙŠ Ù…Ø§Ø¯Ø© ${subj}` : "ÙÙŠ Ø§Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©";
  planSum.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ ${scope}: ${weak.length} Ù…Ù† ${n} (${pctWeak}Ùª) â€” ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆÙˆØ¶Ø¹ Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ÙŠØ©.`;

  weak.forEach((r,i)=>{
    const gap = fullScore - r.grade;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name">${r.student}</td>
      <td class="id">${r.id}</td>
      <td style="text-align:center;">${r.grade.toFixed(1)} / ${gap.toFixed(1)}</td>
      <td>${bankSevere[i % bankSevere.length]}</td>
      <td class="follow">
        <label>Ù†ÙÙ‘ÙØ° <input type="checkbox"></label>
        <label>Ù„Ù… ÙŠÙÙ†ÙÙ‘ÙØ° <input type="checkbox"></label>
      </td>
    `;
    planBody.appendChild(tr);
  });
}

/* ØªØ­Ø¯ÙŠØ« ÙƒØ§Ù…Ù„ */
function render(fullScore){
  const n = records.length;
  if(!n){
    setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø§Øª Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±.");
    maxScoreField.textContent="â€”";
    narrative(100,{n:0}, weakRule(100));
    return;
  }

  const grades = records.map(r=>r.grade);
  const max = Math.max(...grades);
  const min = Math.min(...grades);
  const sum = grades.reduce((a,b)=>a+b,0);
  const avg = sum/n;
  const avgPct = (avg/fullScore)*100;

  statN.textContent=n;
  statMax.textContent=max.toFixed(1);
  statMin.textContent=min.toFixed(1);
  statAvg.textContent=avg.toFixed(2);
  statPct.textContent=avgPct.toFixed(1)+"%";
  statSum.textContent=sum.toFixed(1);

  const c={ex:0,vg:0,gd:0,ac:0,wk:0};
  records.forEach(r=>{
    const lv = level(r.grade, fullScore);
    if(lv==="ex") c.ex++;
    else if(lv==="vg") c.vg++;
    else if(lv==="gd") c.gd++;
    else if(lv==="ac") c.ac++;
    else c.wk++;
  });

  countExcellent.textContent=c.ex;
  countVGood.textContent=c.vg;
  countGood.textContent=c.gd;
  countAcceptable.textContent=c.ac;
  countWeak.textContent=c.wk;

  const p = (x)=> n? (x/n*100):0;
  pEx.textContent = `${p(c.ex).toFixed(1)}% (${c.ex})`;
  pVGood.textContent = `${p(c.vg).toFixed(1)}% (${c.vg})`;
  pGood.textContent = `${p(c.gd).toFixed(1)}% (${c.gd})`;
  pAcc.textContent = `${p(c.ac).toFixed(1)}% (${c.ac})`;
  pWeak.textContent = `${p(c.wk).toFixed(1)}% (${c.wk})`;

  updateDonut("dEx", p(c.ex));
  updateDonut("dVGood", p(c.vg));
  updateDonut("dGood", p(c.gd));
  updateDonut("dAcc", p(c.ac));
  updateDonut("dWeak", p(c.wk));

  if(bar){
    bar.data.datasets[0].data=[c.wk,c.ac,c.gd,c.vg,c.ex];
    bar.update();
  }

  setRanges(fullScore);

  const rule = weakRule(fullScore);
  narrative(fullScore,{n,avg,avgPct,max,min,c}, rule);
  plan(fullScore, rule);
}

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
analyzeBtn.addEventListener("click", async ()=>{
  if(!selected){
    setStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø£ÙˆÙ„Ù‹Ø§.");
    excelFile.classList.add("missing");
    return;
  }
  excelFile.classList.remove("missing");

  // Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„ØµÙ + Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…
  let ok=true;
  [stageInput, termInput].forEach(el=>{
    if(!clean(el.value)){ el.classList.add("missing"); ok=false; }
    else el.classList.remove("missing");
  });
  if(!ok){
    setStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªÙƒÙ…Ø§Ù„: Ø§Ù„ØµÙ + Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù….");
    return;
  }

  // Ø±Ø¨Ø· Ø§Ù„Ù†ØµÙˆØµ
  syncHeaderFromInputs();
  syncPrincipalFromInput();

  try{
    setStatus("Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡ Ø¨Ø¯Ù‚Ø©...");
    const rows = await parseExcel(selected);

    const raw = buildRecords(rows);
    const filtered = applyFilters(raw);

    if(!filtered.length){
      records=[];
      setStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù.");
      render(100);
      return;
    }

    records = filtered;

    const fullScore = getFullScore(records);
    maxScoreField.textContent = fullScore.toFixed(1);

    const subj = clean(subjectInput.value) || "[ØªØ­Ù„ÙŠÙ„ Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©]";
    const stage = clean(stageInput.value);
    const sec = clean(sectionInput.value);
    const pr = clean(periodInput.value);
    const term = clean(termInput.value);
    const teacher = clean(teacherInput.value) || "â€”";

    titleSubject.textContent = subj;
    stageField.textContent = stage + (sec ? ` / Ø´Ø¹Ø¨Ø© ${sec}` : "");
    subjectField.textContent = clean(subjectInput.value) ? clean(subjectInput.value) : "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ / Ù…Ø±Ø­Ù„Ø©";
    termField.textContent = (pr ? pr + " â€“ " : "") + term;
    teacherField.textContent = teacher;
    document.getElementById("ftTeacher").textContent = teacher;

    overlay.classList.remove("open");
    setStatus("ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ â€” ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ Ø­Ø³Ø¨ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¬Ø© (40/60/100/Auto).");

    render(fullScore);
  }catch(err){
    console.error(err);
    setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ù…Ù„Ù Excel Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
  }
});

/* ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø³ÙˆÙ… */
document.addEventListener("DOMContentLoaded", setupCharts);

/* Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ø±Ø³ÙˆÙ… Ù„ØªØ¬Ù†Ø¨ Ø£ÙŠ ØªØ´ÙˆÙ‡ */
window.addEventListener("afterprint", ()=>{
  Object.values(donuts).forEach(ch=>ch && ch.resize());
  if(bar) bar.resize();
});
</script>

</body>
</html>
