<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88;
  --moe-soft:#e1f3f1;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;
  --good:#22c55e;
  --vgood:#10b981;
  --good2:#3b82f6;
  --acc:#f59e0b;
  --weak:#ef4444;
}

/* Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø¹Ø§Ù…Ø© */
*{box-sizing:border-box;}
html,body{margin:0;padding:0;}
body{
  background:radial-gradient(circle at top,#e0f7f8,#d1e4f0 45%,#e5e7eb 100%);
  font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--ink);
}

/* ØµÙØ­Ø© A4 Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */
.a4-page{
  width:210mm;
  max-width:100%;
  aspect-ratio:210/297;
  margin:0 auto;
  background-image:url("A.png");
  background-size:100% 100%;
  background-repeat:no-repeat;
  background-position:top center;
  position:relative;
  overflow:hidden;
}

/* Ù‡ÙŠØ¯Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… (Ø¬Ø¯ÙŠØ¯) */
.moe-header{
  position:absolute;
  top:8mm;
  left:50%;
  transform:translateX(-50%);
  text-align:center;
  color:#ffffff;
  font-weight:700;
  line-height:1.6;
  z-index:14;
}
.moe-header div{
  font-size:14px;
}

/* Ø²Ø± Ø§Ù„Ø¹Ø¯Ø³Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header-tools{
  position:absolute;
  top:14mm;
  left:10mm;           /* Ù†Ù‚Ù„ Ø§Ù„Ø²Ø± Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† right */
  z-index:15;
}
.tools-pill{
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.7);
  background:linear-gradient(135deg,#0b7e88,#0b5f88);
  color:#ffffff;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 4px 14px rgba(15,23,42,.3);
  white-space:nowrap;
}
.tools-pill span.icon{font-size:15px;}
.tools-pill:hover{background:linear-gradient(135deg,#065f64,#064f7a);}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
.content-box{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:30mm;
  bottom:10mm;
  width:186mm;
  max-width:94%;
  overflow:hidden;
}
.main{width:100%;height:100%;}

/* Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
.card{
  width:100%;
  height:100%;
  padding:3mm 5mm;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  font-size:11px;
  background:linear-gradient(180deg,rgba(255,255,255,.98),rgba(245,249,250,.98));
  border-radius:18px;
  box-shadow:0 10px 26px rgba(15,23,42,.20);
}

/* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ */
.top-strip{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
  font-size:10.5px;
  color:var(--muted);
}

/* Ø¹Ø¯Ø³Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
.lens-overlay{
  position:absolute;
  inset:0;
  background:rgba(15,23,42,.16);
  display:none;
  align-items:flex-start;
  justify-content:center;
  z-index:20;
}
.lens-overlay.open{display:flex;}
.lens-panel{
  margin-top:22mm;
  width:78%;
  max-width:920px;
  background:#ffffff;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(15,23,42,.18);
  border:1px solid var(--moe-soft);
  padding:12px 16px;
  font-size:11px;
}
.lens-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.lens-title{
  font-weight:700;
  color:var(--moe);
  font-size:13px;
}
.lens-close{
  border:none;
  background:transparent;
  font-size:18px;
  cursor:pointer;
}
.lens-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px 12px;
}
.lens-field{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.lens-field label{
  font-size:10px;
  color:var(--muted);
}
.lens-field input[type="text"],
.lens-field select{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:5px 10px;
  font-size:11px;
  font-family:inherit;
  background:#f9fafb;
}
.lens-field input[type="file"]{font-size:11px;}

/* ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙˆØ± */
.lens-actions{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:nowrap;
}
.hint-box{
  flex:1;
  display:flex;
  gap:8px;
  align-items:flex-start;
  border-radius:10px;
  border:1px solid #fecaca;
  background:#fef2f2;
  padding:6px 10px;
}
.hint-icon{
  font-size:16px;
  color:#b91c1c;
  margin-top:2px;
}
.hint-text{
  font-size:10px;
  color:#7f1d1d;
  line-height:1.6;
}
.hint-text strong{font-weight:800;color:#b91c1c;}
.btn-main{
  border-radius:10px;
  border:1px solid var(--moe);
  background:var(--moe);
  color:#ffffff;
  padding:8px 20px;
  font-size:11px;
  cursor:pointer;
  font-family:inherit;
  min-width:170px;
  text-align:center;
  white-space:nowrap;
  box-shadow:0 3px 10px rgba(15,23,42,.25);
}
.btn-main:hover{background:#065f64;}
.missing{
  border-color:#ef4444 !important;
  background:#fef2f2 !important;
}

/* Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
.report-header{
  border-top:1px solid #e5e7eb;
  padding-top:4px;
}
.report-title-wrap{
  display:flex;
  justify-content:center;
  margin-bottom:4px;
}
.report-title{
  border:1px solid var(--moe);
  border-radius:26px;
  padding:4px 26px;
  font-size:13px;
  font-weight:700;
  background:linear-gradient(90deg,#f0fdfa,#ecfeff);
}
.report-title span{font-weight:800;color:var(--moe);}

/* ØµÙ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
.header-row{
  margin-top:4px;
  padding:6px 10px;
  border-radius:999px;
  background:#f3f7f7;
  font-size:11px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.header-main-line{
  flex:1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.header-main-line strong{color:var(--moe);}
.header-maxscore{white-space:nowrap;}

/* Ø§Ù„ÙˆØ³Ø· (Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª) */
.middle-section{
  margin-top:6px;
  border-top:1px solid #e5e7eb;
  padding-top:4px;
  display:grid;
  grid-template-columns:2.1fr 1.3fr;
  gap:7px;
}
.details-title{
  font-size:12px;
  font-weight:700;
  color:var(--moe);
  margin-bottom:4px;
}

/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© â€“ ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆØ¶ÙˆØ­ ÙˆØ§Ù„Ø·ÙˆÙ„ */
.details-table{
  border-radius:14px;
  border:1px solid #e5e7eb;
  padding:6px 8px;
  font-size:11px;
  background:#ffffff;
}
.details-header,
.details-row{
  display:grid;
  grid-template-columns:2.4fr 1.1fr 0.9fr;
  align-items:center;
  column-gap:6px;
}
.details-header{
  font-weight:700;
  margin-bottom:4px;
}
.details-row{
  padding:4px 4px;
  border-radius:10px;
  margin-bottom:2px;
}
.details-row:nth-child(odd){
  background:#f9fafb;
}
.details-header div:nth-child(2),
.details-header div:nth-child(3),
.details-row   div:nth-child(2),
.details-row   div:nth-child(3){
  text-align:center;
}

/* Ù…Ø³ØªØ·ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª â€“ ØªØ·ÙˆÙŠÙ„ ÙˆØªØµÙÙŠØ© Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
.level-badge{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  width:100%;
  padding:6px 12px;
  min-height:24px;
  border-radius:999px;
  color:#ffffff;
  font-size:11px;
  font-weight:700;
  box-shadow:0 1px 4px rgba(15,23,42,.15);
}
.l-ex{background:var(--good);}
.l-vg{background:var(--vgood);}
.l-g{background:var(--good2);}
.l-ac{background:var(--acc);}
.l-w{background:var(--weak);}

/* Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
.stats-box{
  border-radius:14px;
  border:1px solid #e5e7eb;
  padding:5px 8px;
  font-size:11px;
  background:#ffffff;
}
.stats-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:4px;
}
.stat-item{
  border-radius:10px;
  border:1px solid #e5e7eb;
  padding:3px 8px;
  background:#f9fafb;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.stat-label{
  color:var(--moe);
  font-size:10px;
}
.stat-value{
  font-size:12px;
  font-weight:700;
}

/* ØªØ­Ù„ÙŠÙ„ Ù†ØµÙŠ */
.analysis-section{
  margin-top:6px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  padding:5px 8px;
  font-size:11px;
  background:#f9fafb;
}
.analysis-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}
.analysis-title{
  font-size:12px;
  font-weight:700;
  color:var(--moe);
}
.analysis-tag{
  padding:2px 12px;
  border-radius:999px;
  font-size:10px;
  font-weight:600;
  border:1px solid #d1d5db;
}
.analysis-tag.good{color:#16a34a;border-color:#16a34a;background:#dcfce7;}
.analysis-tag.mid{color:#ea580c;border-color:#ea580c;background:#ffedd5;}
.analysis-tag.weak{color:#b91c1c;border-color:#b91c1c;background:#fee2e2;}
.analysis-text{margin-bottom:3px;}
.analysis-list{
  margin:0;
  padding-right:18px;
}
.analysis-list li{margin-bottom:2px;}

/* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
.charts-section{
  margin-top:6px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  padding:5px 8px;
  background:#ffffff;
}
.charts-title{
  font-size:11px;
  font-weight:700;
  color:var(--moe);
  text-align:center;
  margin-bottom:4px;
}
.donuts-grid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:4px;
}
.donut-card{
  border-radius:10px;
  border:1px solid #e5e7eb;
  padding:2px 2px 4px;
  text-align:center;
  background:#f9fafb;
}
.donut-canvas{height:48px;}
.donut-label{
  font-size:9px;
  color:#4b5563;
}
.donut-value{
  font-size:9px;
  font-weight:700;
}
.bar-wrapper{
  margin-top:6px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  padding:4px;
}
.bar-wrapper canvas{
  width:100%;
  height:80px; /* Ø«Ø§Ø¨Øª Ù„Ø¶ØºØ· Ø§Ù„Ø±Ø³Ù… ÙˆØ¹Ø¯Ù… Ø§Ù„ØªÙ…Ø¯Ø¯ */
}

/* Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† */
.improv-section{
  margin-top:6px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  padding:5px 8px 4px;
  font-size:10px;
  background:#ffffff;
}
.improv-title{
  font-size:11px;
  font-weight:700;
  color:var(--moe);
}
.improv-sub{
  font-size:9px;
  color:var(--muted);
  margin-bottom:2px;
}
.improv-summary{
  font-size:9px;
  margin-top:3px;
}
.improv-table{
  width:100%;
  border-collapse:collapse;
  font-size:9px;
  margin-top:3px;
}
.improv-table th,
.improv-table td{
  border:1px solid #e5e7eb;
  padding:2px 3px;
}
.improv-table th{
  background:#f3f4f6;
  white-space:nowrap;
}
.improv-table th.col-name{width:24%;}
improv-table th.col-id{width:14%;}
.improv-table th.col-grade{width:18%;}
.improv-table th.col-actions{width:36%;}
.improv-table th.col-follow{width:14%;}
.improv-table td.name-cell{white-space:nowrap;}
.improv-table td.id-cell{white-space:nowrap;}

.follow-cell{
  text-align:center;
  white-space:nowrap;
}
.follow-cell label{
  display:inline-flex;
  align-items:center;
  gap:2px;
  margin-inline:2px;
  font-size:8px;
}
.follow-cell input[type="checkbox"]{
  width:9px;
  height:9px;
}

/* Ø§Ù„ÙÙˆØªØ± */
.footer{
  margin-top:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:10.5px;
  color:#4b5563;
}
.footer-line{margin:0;}
.footer strong{color:#111827;}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width:900px){
  .a4-page{
    width:100%;
    max-width:100%;
    aspect-ratio:auto;
    min-height:100vh;
    padding:12px 0;
    background-size:cover;
  }
  .content-box{
    position:relative;
    top:auto;
    bottom:auto;
    width:96%;
    max-width:96%;
    margin:72px auto 24px;
    overflow:visible;
    transform:none;
    left:auto;
  }
  .card{
    border-radius:14px;
    box-shadow:0 4px 16px rgba(15,23,42,.18);
    height:auto;
  }
}

/* Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
@media (max-width:600px){
  .card{
    font-size:10px;
    padding:2mm 3mm;
  }
  .header-row{
    font-size:10px;
    padding:4px 8px;
  }
  .details-table{
    font-size:10px;
    padding:4px 6px;
  }
  .details-header,
  .details-row{
    grid-template-columns:2.2fr 1.1fr 0.9fr;
  }
  .donuts-grid{
    grid-template-columns:repeat(2,1fr);
  }
  .bar-wrapper canvas{
    height:70px;
  }
  .improv-table{
    font-size:8px;
  }
}

/* Ø·Ø¨Ø§Ø¹Ø©: ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¶ØºÙˆØ·Ø© Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª Ø£Ùˆ ØªØ¯Ø§Ø®Ù„ */
@media print{
  @page{
    size:A4 portrait;
    margin:0;
  }
  html,body{
    margin:0;
    padding:0;
    height:100%;
    background:#ffffff !important;
  }

  body{
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  .a4-page{
    width:210mm;
    height:297mm;
    margin:0;
    padding:0;
    background:#ffffff;
    background-image:url("A.png");
    background-size:100% 100%;
    background-repeat:no-repeat;
    background-position:top center;
    position:relative;
    overflow:hidden;
    transform:scale(0.9);       /* Ø¶ØºØ· Ø£ÙƒØ¨Ø± Ø­ØªÙ‰ Ù„Ø§ ØªÙ†Ù‚Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ø®Ø§ØµØ© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    transform-origin:top center;
  }

  .content-box{
    position:absolute;
    top:28mm;
    bottom:8mm;
    left:50%;
    transform:translateX(-50%);
    width:186mm;
    max-width:94%;
    margin:0;
    overflow:hidden;
  }

  .main{
    width:100%;
    height:100%;
  }

  .card{
    width:100%;
    height:100%;
    min-height:0;
    box-shadow:none;
    border-radius:0;
    background:transparent;
    font-size:9.5px;
  }

  /* Ø¥Ø²Ø§Ù„Ø© ØªØ¸Ù„ÙŠÙ„ Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ØªÙ‚Ù„ÙŠÙ„ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
  .details-row:nth-child(odd){
    background:#ffffff !important;
  }

  .improv-section,
  .analysis-section,
  .charts-section,
  .middle-section,
  .report-header{
    margin-top:4px;
  }
  .improv-table{
    font-size:8px;
  }
  .analysis-list li{
    margin-bottom:1px;
  }

  .header-tools,
  .lens-overlay{
    display:none !important;
  }
}
</style>
</head>
<body>

<div class="a4-page">

  <!-- Ù‡ÙŠØ¯Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… -->
  <div class="moe-header">
    <div contenteditable="true">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù€ â€¦</div>
    <div contenteditable="true">Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù€ â€¦</div>
    <div contenteditable="true">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø³Ù‡</div>
  </div>

  <!-- Ø²Ø± Ø§Ù„Ø¹Ø¯Ø³Ø© -->
  <div class="header-tools">
    <button type="button" class="tools-pill" id="toolsBtn">
      <span class="icon">ğŸ”</span>
      <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDF</span>
    </button>
  </div>

  <div class="content-box">
    <main class="main">
      <section class="card">

        <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
        <div class="top-strip">
          <span id="statusMessage">
            Ø§Ø¶ØºØ· Ø²Ø± Â«Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDFÂ» ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.
          </span>
        </div>

        <!-- Ø¹Ø¯Ø³Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="lens-overlay" id="lensOverlay">
          <div class="lens-panel">
            <div class="lens-header">
              <div class="lens-title">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
              <button type="button" class="lens-close" id="lensClose">âœ•</button>
            </div>
            <div class="lens-grid">
              <div class="lens-field">
                <label for="excelFile">ğŸ“‚ Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ù…Ù„Ù Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©)</label>
                <input id="excelFile" type="file" accept=".xlsx,.xls" />
              </div>
              <div class="lens-field">
                <label for="subjectInput">Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©)</label>
                <input id="subjectInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
              </div>
              <div class="lens-field">
                <label for="stageInput">Ø§Ù„ØµÙ</label>
                <input id="stageInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ" />
              </div>
              <div class="lens-field">
                <label for="sectionInput">Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
                <input id="sectionInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 1" />
              </div>
              <div class="lens-field">
                <label for="periodInput">Ø§Ù„ÙØªØ±Ø©</label>
                <input id="periodInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰" />
              </div>
              <div class="lens-field">
                <label for="termInput">Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…</label>
                <input id="termInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 1447Ù‡Ù€ â€“ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„" />
              </div>
              <div class="lens-field">
                <label for="teacherInput">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù…Ù†Ø³Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="teacherInput" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ " />
              </div>
              <div class="lens-field">
                <label for="scaleMode">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                <select id="scaleMode">
                  <option value="auto">Ø¢Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ù„Ù</option>
                  <option value="period60">Ø§Ø®ØªØ¨Ø§Ø± ÙØªØ±Ø© (0â€“60)</option>
                  <option value="final100">Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ (0â€“100)</option>
                </select>
              </div>
            </div>

            <div class="lens-actions">
              <div class="hint-box">
                <div class="hint-icon">âš ï¸</div>
                <div class="hint-text">
                  <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† Ù†Ø¸Ø§Ù… Â«Ù†ÙˆØ±Â» Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ø¯Ø© Ù…Ø¹ÙŠÙ‘Ù†Ø©:</strong><br/>
                  Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ <strong>Ù†Ø¸Ø§Ù… Ù†ÙˆØ±</strong> â†’ Ù‚Ø§Ø¦Ù…Ø© <strong>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</strong> â†’
                  <strong>ØªÙ‚Ø§Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</strong> â†’ <strong>ÙƒØ´Ù Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ø§Ø¯Ø©</strong>ØŒ Ø«Ù… Ø§Ø®ØªÙŠØ§Ø±
                  <strong>Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©ØŒ Ø§Ù„ÙØµÙ„ØŒ Ø§Ù„ØµÙØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø§Ù„ÙØªØ±Ø©</strong>ØŒ ÙˆØ¨Ø¹Ø¯ Ø°Ù„Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰
                  Â«<strong>ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</strong>Â». Ø¨Ø¹Ø¯ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹Ù‡ Ù…Ù† Ù‡Ù†Ø§ Ù„ÙŠØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„
                  ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØ¥Ù†ØªØ§Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ®Ø·Ø· Ø§Ù„ØªØ­Ø³ÙŠÙ†.
                </div>
              </div>

              <div style="display:flex;gap:8px;align-items:center;flex-wrap:nowrap;">
                <button type="button" class="btn-main" id="analyzeBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
                <button type="button" class="btn-main" id="printBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
        <div class="report-header">
          <div class="report-title-wrap">
            <div class="report-title">
              ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø© <span id="titleSubject">[Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ù…Ø±Ø­Ù„Ø©]</span>
            </div>
          </div>

          <div class="header-row">
            <div class="header-main-line">
              Ø§Ù„ØµÙ: <strong id="stageField">â€”</strong>
              Â· Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="headerSubjectField">â€”</strong>
              Â· Ø§Ù„ÙØªØ±Ø© / Ø§Ù„ÙØµÙ„: <strong id="termField">â€”</strong>
              Â· Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù…Ù†Ø³Ù‚: <strong id="headerTeacherField">â€”</strong>
            </div>
            <div class="header-maxscore">
              Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©: <strong id="maxScoreField">â€”</strong>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="middle-section">
          <div>
            <div class="details-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
            <div class="details-table">
              <div class="details-header">
                <div>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
                <div>Ø§Ù„Ù†Ø·Ø§Ù‚</div>
                <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
              </div>
              <div class="details-row">
                <div><span class="level-badge l-ex">Ù…Ù…ØªØ§Ø²</span></div>
                <div id="rangeExcellent">â€”</div>
                <div id="countExcellent">0</div>
              </div>
              <div class="details-row">
                <div><span class="level-badge l-vg">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</span></div>
                <div id="rangeVGood">â€”</div>
                <div id="countVGood">0</div>
              </div>
              <div class="details-row">
                <div><span class="level-badge l-g">Ø¬ÙŠØ¯</span></div>
                <div id="rangeGood">â€”</div>
                <div id="countGood">0</div>
              </div>
              <div class="details-row">
                <div><span class="level-badge l-ac">Ù…Ù‚Ø¨ÙˆÙ„</span></div>
                <div id="rangeAcceptable">â€”</div>
                <div id="countAcceptable">0</div>
              </div>
              <div class="details-row">
                <div><span class="level-badge l-w">Ø¶Ø¹ÙŠÙ</span></div>
                <div id="rangeWeak">â€”</div>
                <div id="countWeak">0</div>
              </div>
            </div>
          </div>

          <div class="stats-box">
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨/Ø§Ù„Ø­Ø§Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø¹ÙŠÙ†Ø©</span>
                <span class="stat-value" id="statStudents">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© ÙØ¹Ù„ÙŠØ©</span>
                <span class="stat-value" id="statMax">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø© ÙØ¹Ù„ÙŠØ©</span>
                <span class="stat-value" id="statMin">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span>
                <span class="stat-value" id="statAvg">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ø©</span>
                <span class="stat-value" id="statSuccess">0%</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span>
                <span class="stat-value" id="statSum">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ØªØ­Ù„ÙŠÙ„ Ù†ØµÙŠ -->
        <div class="analysis-section">
          <div class="analysis-header">
            <div class="analysis-title">Ù‚Ø±Ø§Ø¡Ø© ØªØ­Ù„ÙŠÙ„ÙŠØ© Ø°ÙƒÙŠØ© Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØµÙ / Ø§Ù„Ø¹ÙŠÙ†Ø©</div>
            <div id="analysisTag" class="analysis-tag">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
          </div>
          <div id="analysisText" class="analysis-text">Ù„Ù… ØªÙØ­Ù…Ù‘ÙÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
          <ul id="analysisBullets" class="analysis-list"></ul>
        </div>

        <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
        <div class="charts-section">
          <div class="charts-title">Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ (Ù†ÙØ³ÙØ¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±)</div>
          <div class="donuts-grid">
            <div class="donut-card">
              <canvas id="donutWeak" class="donut-canvas"></canvas>
              <div class="donut-label">Ø¶Ø¹ÙŠÙ</div>
              <div class="donut-value" id="percWeak">0% (0)</div>
            </div>
            <div class="donut-card">
              <canvas id="donutAcceptable" class="donut-canvas"></canvas>
              <div class="donut-label">Ù…Ù‚Ø¨ÙˆÙ„</div>
              <div class="donut-value" id="percAcceptable">0% (0)</div>
            </div>
            <div class="donut-card">
              <canvas id="donutGood" class="donut-canvas"></canvas>
              <div class="donut-label">Ø¬ÙŠØ¯</div>
              <div class="donut-value" id="percGood">0% (0)</div>
            </div>
            <div class="donut-card">
              <canvas id="donutVGood" class="donut-canvas"></canvas>
              <div class="donut-label">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</div>
              <div class="donut-value" id="percVGood">0% (0)</div>
            </div>
            <div class="donut-card">
              <canvas id="donutExcellent" class="donut-canvas"></canvas>
              <div class="donut-label">Ù…Ù…ØªØ§Ø²</div>
              <div class="donut-value" id="percExcellent">0% (0)</div>
            </div>
          </div>

          <div class="charts-title" style="margin-top:4px;">Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ (Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±)</div>
          <div class="bar-wrapper">
            <canvas id="barLevels"></canvas>
          </div>
        </div>

        <!-- Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† -->
        <div class="improv-section">
          <div class="improv-title">Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø°ÙˆÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ù†ÙŠ</div>
          <div class="improv-sub">
            Ø¹Ù†Ø¯ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© ØªÙØ¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø© ÙƒÙ…Ø¤Ø´Ø±Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ§Ø¯ØŒ ÙˆØ¹Ù†Ø¯ ØªØ­Ù„ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ØªÙØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§ØµÙ„ÙŠÙ† Ø¹Ù„Ù‰ Ø£Ù‚Ù„ Ù…Ù† Ù¢Ù¥Ùª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©.
          </div>
          <table class="improv-table">
            <thead>
              <tr>
                <th class="col-name">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th class="col-id">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                <th class="col-grade">Ø§Ù„Ø¯Ø±Ø¬Ø© / ÙØ¬ÙˆØ© Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                <th class="col-actions">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
                <th class="col-follow">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ†ÙÙŠØ°<br/>Ù†ÙÙ‘ÙØ° / Ù„Ù… ÙŠÙÙ†ÙÙ‘ÙØ°</th>
              </tr>
            </thead>
            <tbody id="improvBody">
              <tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¶Ù…Ù† ÙØ¦Ø© Ø§Ù„Ø¶Ø¹ÙŠÙ ÙˆÙÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</td></tr>
            </tbody>
          </table>
          <div class="improv-summary" id="improvSummary">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
        </div>

        <!-- Ø§Ù„ÙÙˆØªØ± -->
        <div class="footer">
          <p class="footer-line">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / <strong id="footerTeacher">â€”</strong></p>
          <p class="footer-line">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / <strong id="footerPrincipal" contenteditable="true">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ </strong></p>
        </div>

      </section>
    </main>
  </div>
</div>

<script>
let records = [];
let donutCharts = {};
let barChart = null;
let selectedFile = null;
let fullScoreAuto = null;
let levelBoundaries = null;
let hasSubjectSpecific = false;
const PLAN_THRESHOLD_PERCENT = 25;

/* Ø¹Ù†Ø§ØµØ± DOM */
const lensOverlay = document.getElementById("lensOverlay");
const toolsBtn    = document.getElementById("toolsBtn");
const lensClose   = document.getElementById("lensClose");
const analyzeBtn  = document.getElementById("analyzeBtn");
const printBtn    = document.getElementById("printBtn");

const excelInput   = document.getElementById("excelFile");
const subjectInput = document.getElementById("subjectInput");
const stageInput   = document.getElementById("stageInput");
const sectionInput = document.getElementById("sectionInput");
const periodInput  = document.getElementById("periodInput");
const termInput    = document.getElementById("termInput");
const teacherInput = document.getElementById("teacherInput");
const scaleMode    = document.getElementById("scaleMode");

const titleSubjectEl  = document.getElementById("titleSubject");
const stageFieldEl    = document.getElementById("stageField");
const termFieldEl     = document.getElementById("termField");
const maxScoreFieldEl = document.getElementById("maxScoreField");
const headerSubjectEl = document.getElementById("headerSubjectField");
const headerTeacherEl = document.getElementById("headerTeacherField");
const footerTeacherEl = document.getElementById("footerTeacher");
const statusEl        = document.getElementById("statusMessage");

const rangeExcellentEl  = document.getElementById("rangeExcellent");
const rangeVGoodEl      = document.getElementById("rangeVGood");
const rangeGoodEl       = document.getElementById("rangeGood");
const rangeAcceptableEl = document.getElementById("rangeAcceptable");
const rangeWeakEl       = document.getElementById("rangeWeak");

const countExcellentEl   = document.getElementById("countExcellent");
const countVGoodEl       = document.getElementById("countVGood");
const countGoodEl        = document.getElementById("countGood");
const countAcceptableEl  = document.getElementById("countAcceptable");
const countWeakEl        = document.getElementById("countWeak");

const statStudentsEl = document.getElementById("statStudents");
const statMaxEl      = document.getElementById("statMax");
const statMinEl      = document.getElementById("statMin");
const statAvgEl      = document.getElementById("statAvg");
const statSuccessEl  = document.getElementById("statSuccess");
const statSumEl      = document.getElementById("statSum");

const analysisTagEl     = document.getElementById("analysisTag");
const analysisTextEl    = document.getElementById("analysisText");
const analysisBulletsEl = document.getElementById("analysisBullets");

const percWeakEl        = document.getElementById("percWeak");
const percAcceptableEl  = document.getElementById("percAcceptable");
const percGoodEl        = document.getElementById("percGood");
const percVGoodEl       = document.getElementById("percVGood");
const percExcellentEl   = document.getElementById("percExcellent");

const improvSummaryEl = document.getElementById("improvSummary");
const improvBodyEl    = document.getElementById("improvBody");

function setStatus(msg){ statusEl.textContent = msg; }

/* Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© */
function normalizeDigits(str){
  if(str == null) return "";
  str = String(str);
  const map = {'Ù ':0,'Ù¡':1,'Ù¢':2,'Ù£':3,'Ù¤':4,'Ù¥':5,'Ù¦':6,'Ù§':7,'Ù¨':8,'Ù©':9};
  return str.replace(/[Ù -Ù©]/g,d=>map[d]).replace(/,/g,".");
}
function isNumeric(val){
  if(val === null || val === undefined) return false;
  if(typeof val === "number") return !isNaN(val);
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return !isNaN(n);
}
function toNumber(val){
  if(typeof val === "number") return val;
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return isNaN(n) ? NaN : n;
}

/* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† */
function setPlanHeadersForStudents(){
  const thName = document.querySelector(".improv-table th.col-name");
  const thId   = document.querySelector(".improv-table th.col-id");
  const thGrad = document.querySelector(".improv-table th.col-grade");
  const thAct  = document.querySelector(".improv-table th.col-actions");
  const thFol  = document.querySelector(".improv-table th.col-follow");
  if(thName) thName.textContent = "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨";
  if(thId)   thId.textContent   = "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©";
  if(thGrad) thGrad.textContent = "Ø§Ù„Ø¯Ø±Ø¬Ø© / ÙØ¬ÙˆØ© Ø§Ù„ØªØ­ØµÙŠÙ„";
  if(thAct)  thAct.textContent  = "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©";
  if(thFol)  thFol.innerHTML    = "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ†ÙÙŠØ°<br/>Ù†ÙÙ‘ÙØ° / Ù„Ù… ÙŠÙÙ†ÙÙ‘ÙØ°";
}
function setPlanHeadersForSubjects(){
  const thName = document.querySelector(".improv-table th.col-name");
  const thId   = document.querySelector(".improv-table th.col-id");
  const thGrad = document.querySelector(".improv-table th.col-grade");
  const thAct  = document.querySelector(".improv-table th.col-actions");
  const thFol  = document.querySelector(".improv-table th.col-follow");
  if(thName) thName.textContent = "Ø§Ù„Ù…Ø§Ø¯Ø©";
  if(thId)   thId.textContent   = "Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨";
  if(thGrad) thGrad.textContent = "Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ…ÙŠÙ‘Ø² (Ù…Ù…ØªØ§Ø² + Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§)";
  if(thAct)  thAct.textContent  = "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ù…Ù…ØªØ§Ø² / Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ / Ø¬ÙŠØ¯ / Ù…Ù‚Ø¨ÙˆÙ„ / Ø¶Ø¹ÙŠÙ)";
  if(thFol)  thFol.textContent  = "Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø§Ù…Ø©";
}

/* Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ Ù…Ù† Ø§Ù„ÙƒØ¹Ø¨ */
function extractBoundariesFromRows(rows){
  for(let i = rows.length-1, checked=0; i>=0 && checked<30; i--,checked++){
    const row = rows[i];
    if(!row) continue;
    const nums = row
      .filter(v => isNumeric(v))
      .map(v => Math.round(toNumber(v)))
      .filter(v => v >= 0);
    if(!nums.length) continue;
    const uniq = [...new Set(nums)].sort((a,b)=>a-b);
    if(uniq.length >= 5){
      const maxVal = Math.max(...uniq);
      if(maxVal <= 60) return uniq;
    }
  }
  return null;
}

/* Ù…Ù„ØµÙ‚ ÙˆØ³Ø· Ø§Ù„Ø¯ÙˆÙ†Ø§Øª */
const centerLabelPlugin = {
  id:"centerLabel",
  afterDraw(chart, args, opts){
    const text = opts && opts.text;
    if(!text) return;
    const {ctx, chartArea:{left,right,top,bottom}} = chart;
    const x = (left+right)/2;
    const y = (top+bottom)/2;
    ctx.save();
    ctx.font = "bold 11px Tajawal, system-ui";
    ctx.fillStyle = "#111827";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
    ctx.restore();
  }
};

/* Ø£Ø±Ù‚Ø§Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ */
const barValuePlugin = {
  id:"barValue",
  afterDatasetsDraw(chart){
    if(chart.config.type !== "bar") return;
    const {ctx} = chart;
    const dataset = chart.data.datasets[0];
    const meta = chart.getDatasetMeta(0);
    ctx.save();
    ctx.font = "bold 10px Tajawal, system-ui";
    ctx.fillStyle = "#111827";
    ctx.textAlign = "center";
    dataset.data.forEach((value, index)=>{
      const bar = meta.data[index];
      if(!bar) return;
      const props = bar.getProps(['y','base','x'], true);
      const centerY = (props.y + props.base) / 2;
      ctx.fillText(value, props.x, centerY);
    });
    ctx.restore();
  }
};

Chart.register(centerLabelPlugin, barValuePlugin);

/* Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³ÙˆÙ… */
function setupCharts(){
  const configs = [
    {id:"donutWeak",      color:"#ef4444"},
    {id:"donutAcceptable",color:"#f59e0b"},
    {id:"donutGood",      color:"#3b82f6"},
    {id:"donutVGood",     color:"#10b981"},
    {id:"donutExcellent", color:"#22c55e"}
  ];
  configs.forEach(cfg=>{
    const ctx = document.getElementById(cfg.id).getContext("2d");
    const chart = new Chart(ctx,{
      type:"doughnut",
      data:{
        labels:["Ø§Ù„Ù†Ø³Ø¨Ø©","Ø§Ù„Ø¨Ø§Ù‚ÙŠ"],
        datasets:[{
          data:[0,100],
          backgroundColor:[cfg.color,"#e5e7eb"],
          borderWidth:0
        }]
      },
      options:{
        plugins:{
          legend:{display:false},
          tooltip:{enabled:false},
          centerLabel:{text:"0%"}
        },
        cutout:"78%"
      }
    });
    donutCharts[cfg.id] = chart;
  });

  const barCtx = document.getElementById("barLevels").getContext("2d");
  barChart = new Chart(barCtx,{
    type:"bar",
    data:{
      labels:["Ø¶Ø¹ÙŠÙ","Ù…Ù‚Ø¨ÙˆÙ„","Ø¬ÙŠØ¯","Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§","Ù…Ù…ØªØ§Ø²"],
      datasets:[{
        data:[0,0,0,0,0],
        backgroundColor:["#ef4444","#f59e0b","#3b82f6","#10b981","#22c55e"],
        borderRadius:6,
        maxBarThickness:32
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        barValue:{}
      },
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ticks:{font:{family:"Tajawal",size:10}}},
        y:{
          beginAtZero:true,
          precision:0,
          ticks:{stepSize:1,font:{family:"Tajawal",size:9}}
        }
      }
    }
  });
}

function updateDonut(id, percent){
  const chart = donutCharts[id];
  if(!chart) return;
  const p = Math.max(0,Math.min(100,percent));
  chart.data.datasets[0].data = [p,100-p];
  if(!chart.options.plugins) chart.options.plugins = {};
  if(!chart.options.plugins.centerLabel) chart.options.plugins.centerLabel = {};
  chart.options.plugins.centerLabel.text = `${Math.round(p)}%`;
  chart.update();
}

/* Ø¨Ù†Ùƒ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
const bankSevere = [
  "Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ ÙØ±Ø¯ÙŠØ© Ù…ÙƒØªÙˆØ¨Ø©ØŒ ÙˆØ¯Ø±ÙˆØ³ ØªÙ‚ÙˆÙŠØ© Ù…Ù†ØªØ¸Ù…Ø©ØŒ ÙˆØªÙˆØ§ØµÙ„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…Ù†Ø³Ù‚ Ù…Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.",
  "Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù„Ø§Ø¬ÙŠ Ù…ÙƒØ«Ù ÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ£Ø«ÙŠØ±Ù‹Ø§ ÙÙŠ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ø§Ù„Ø¨.",
  "Ø¬Ù„Ø³Ø§Øª Ø¯Ø¹Ù… ÙØ±Ø¯ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆØ§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ Ù„ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©."
];
const bankModerate = [
  "Ø¯Ø±ÙˆØ³ ØªÙ‚ÙˆÙŠØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŒ Ù…Ø¹ ÙˆØ§Ø¬Ø¨Ø§Øª Ø¹Ù„Ø§Ø¬ÙŠØ© Ù‚ØµÙŠØ±Ø© ØªÙ‚ÙŠØ³ Ø§Ù„ØªØ­Ø³Ù† ÙÙŠ ÙƒÙ„ Ù…Ù‡Ø§Ø±Ø©.",
  "Ø¥Ø´Ø±Ø§Ùƒ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØªØ¹Ù„Ù… ØªØ¹Ø§ÙˆÙ†ÙŠ Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¡ Ù…ØªÙÙˆÙ‚ÙŠÙ† Ù„Ø¯Ø¹Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ.",
  "Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙØªØ± Ø§Ù„ÙˆØ§Ø¬Ø¨ ÙˆØ§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØµÙÙŠØ©ØŒ Ù…Ø¹ ØªØ¹Ø²ÙŠØ² ÙˆØªØ´Ø¬ÙŠØ¹ Ù…Ø³ØªÙ…Ø± Ø¹Ù†Ø¯ ØªØ­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡."
];
const bankMild = [
  "Ø¥Ø«Ø±Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø£Ù†Ø´Ø·Ø© Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØªÙƒÙ„ÙŠÙÙ‡ Ø¨Ù…Ù‡Ù…Ø§Øª Ù‚ÙŠØ§Ø¯ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ.",
  "Ø±Ø¨Ø· Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ø§ÙØ¹ÙŠØªÙ‡.",
  "ØªÙ‚Ø¯ÙŠÙ… ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø§Ø¡Ø© ØªØ´Ø¬Ù‘Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„ØªÙ…ÙŠØ² ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰."
];
function generateServices(percent, index){
  const p = Number(percent);
  let bank;
  if(p < 40)      bank = bankSevere;
  else if(p < 60) bank = bankModerate;
  else            bank = bankMild;
  return bank[index % bank.length];
}

/* Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ */
function buildRecordsFromSheet(rows){
  if(!rows || !rows.length) return [];

  let headerIndex = -1;
  for(let i=0; i<Math.min(rows.length,60); i++){
    const row = rows[i];
    if(!row) continue;
    const joined = row.map(c=>c==null?"":String(c)).join(" ");
    if(/Ø§Ø³Ù…\s*Ø§Ù„Ø·Ø§Ù„Ø¨/.test(joined)){
      headerIndex = i;
      break;
    }
  }

  if(headerIndex === -1){
    const grades = [];
    for(let r=0;r<rows.length;r++){
      const row=rows[r];
      if(!row) continue;
      row.forEach(cell=>{
        if(isNumeric(cell)){
          const n = toNumber(cell);
          if(n>=0 && n<=200) grades.push(n);
        }
      });
    }
    return grades.map(g=>({student:"â€”",id:"â€”",grade:g,subject:""}));
  }

  const headers = rows[headerIndex] || [];
  let nameCol=-1,idCol=-1,gradeCol=-1,subjectCol=-1;

  headers.forEach((cell,idx)=>{
    if(cell==null) return;
    const s = String(cell);
    if(nameCol===-1 && /Ø§Ø³Ù…/.test(s) && /Ø·Ø§Ù„Ø¨/.test(s)) nameCol=idx;
    if(idCol===-1   && /Ù‡ÙˆÙŠØ©|Ø§Ù„Ø³Ø¬Ù„|Ø§Ù„Ù…Ø¯Ù†ÙŠ/.test(s))      idCol=idx;
    if(subjectCol===-1 && /Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„Ù…Ù‚Ø±Ø±/.test(s)) subjectCol = idx;
  });

  const secondRow = rows[headerIndex+1] || [];
  secondRow.forEach((cell,idx)=>{
    if(cell==null) return;
    const s = String(cell);
    if(/Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ø¯Ø±Ø¬Ø©|Ø§Ù„Ø¯Ø±Ø¬Ù‡/.test(s) && gradeCol===-1) gradeCol=idx;
  });

  if(gradeCol===-1){
    let bestCol=-1,bestMean=-1;
    const maxCols = Math.max(...rows.map(r=>r ? r.length : 0));
    for(let c=0;c<maxCols;c++){
      const vals=[];
      for(let r=headerIndex+1;r<rows.length;r++){
        const row=rows[r];
        if(!row || c>=row.length) continue;
        const v=row[c];
        if(isNumeric(v)){
          const n=toNumber(v);
          if(n>=0 && n<=200) vals.push(n);
        }
      }
      if(vals.length>=3){
        const mean=vals.reduce((a,b)=>a+b,0)/vals.length;
        if(mean>bestMean){bestMean=mean;bestCol=c;}
      }
    }
    gradeCol=bestCol;
  }

  const result=[];
  for(let r=headerIndex+1;r<rows.length;r++){
    const row=rows[r];
    if(!row) continue;

    const nameRaw  = nameCol>=0 ? row[nameCol]  : null;
    const idRaw    = idCol>=0   ? row[idCol]    : null;
    const gradeRaw = gradeCol>=0? row[gradeCol] : null;
    const subRaw   = subjectCol>=0 ? row[subjectCol] : null;

    const name     = nameRaw ? String(nameRaw).trim() : "";
    const idDigits = idRaw ? normalizeDigits(idRaw).replace(/[^\d]/g,"") : "";
    const gradeNum = isNumeric(gradeRaw) ? toNumber(gradeRaw) : NaN;
    const subject  = subRaw ? String(subRaw).trim() : "";

    if(!name && !idDigits) continue;
    if(!isFinite(gradeNum) || gradeNum<0 || gradeNum>200) continue;
    if(/Ø§Ù„ÙØµÙ„|Ø§Ù„Ø´Ø¹Ø¨Ø©|Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„ØµÙ|ÙƒØ´Ù Ø±ØµØ¯|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ù…ØªÙˆØ³Ø·|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰/i.test(name)) continue;
    if(!name && (!idDigits || idDigits.length<7)) continue;

    result.push({
      student:name || "Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
      id:idDigits || "â€”",
      grade:gradeNum,
      subject:subject
    });
  }
  return result;
}

/* Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† */
function updateImprovementPlan(fullScore){
  const n = records.length;

  if(hasSubjectSpecific){
    setPlanHeadersForStudents();

    const weakStudents = records.filter(r => (r.grade/fullScore)*100 < PLAN_THRESHOLD_PERCENT);
    improvBodyEl.innerHTML = "";

    if(!weakStudents.length){
      improvBodyEl.innerHTML =
        '<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¶Ù…Ù† ÙØ¦Ø© Ø£Ù‚Ù„ Ù…Ù† Ù¢Ù¥Ùª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</td></tr>';
      improvSummaryEl.textContent =
        "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ ÙØ±Ø¯ÙŠØ© (Ø£Ù‚Ù„ Ù…Ù† Ù¢Ù¥Ùª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©) ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.";
      return;
    }

    const percentWeak = ((weakStudents.length/n)*100).toFixed(1);
    improvSummaryEl.textContent =
      `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£Ø´Ø¯ Ø§Ø­ØªÙŠØ§Ø¬Ù‹Ø§ Ù„Ù„Ø¯Ø¹Ù…: ${weakStudents.length} Ù…Ù† ${n} Ø·Ø§Ù„Ø¨ (${percentWeak}Ùª Ù…Ù† Ø§Ù„Ø¹ÙŠÙ†Ø©)ØŒ ÙˆÙŠÙˆØµÙ‰ Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙ‡Ù… Ø¨Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ ÙØ±Ø¯ÙŠØ© Ø¨Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø¨ÙŠÙ† Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ ÙˆÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.`;

    weakStudents
      .sort((a,b)=>a.grade-b.grade)
      .forEach((rec,idx)=>{
        const gap = fullScore - rec.grade;
        const percent = ((rec.grade/fullScore)*100).toFixed(1);
        const services = generateServices(percent, idx);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="name-cell">${rec.student}</td>
          <td class="id-cell">${rec.id}</td>
          <td style="text-align:center;">${rec.grade.toFixed(1)} / ${gap.toFixed(1)}</td>
          <td>${services}</td>
          <td class="follow-cell">
            <label>Ù†ÙÙ‘ÙØ° <input type="checkbox"></label>
            <label>Ù„Ù… ÙŠÙÙ†ÙÙ‘ÙØ° <input type="checkbox"></label>
          </td>`;
        improvBodyEl.appendChild(tr);
      });
    return;
  }

  const hasAnySubject = records.some(r=>r.subject && r.subject !== "â€”");

  if(hasAnySubject){
    setPlanHeadersForSubjects();
    improvBodyEl.innerHTML = "";

    const bySubject = new Map();
    records.forEach(r=>{
      const s = r.subject || "Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
      if(!bySubject.has(s)) bySubject.set(s,[]);
      bySubject.get(s).push(r.grade);
    });

    bySubject.forEach((grades,subject)=>{
      const total = grades.length;
      let cEx=0,cVG=0,cG=0,cAc=0,cW=0;
      grades.forEach(g=>{
        const p = (g/fullScore)*100;
        if(p>=90) cEx++;
        else if(p>=80) cVG++;
        else if(p>=70) cG++;
        else if(p>=60) cAc++;
        else cW++;
      });
      const high = cEx + cVG;
      const highPerc = total ? (high/total*100).toFixed(1) : "0.0";
      const dist = `Ù…Ù…ØªØ§Ø²: ${cEx}ØŒ Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§: ${cVG}ØŒ Ø¬ÙŠØ¯: ${cG}ØŒ Ù…Ù‚Ø¨ÙˆÙ„: ${cAc}ØŒ Ø¶Ø¹ÙŠÙ: ${cW}`;
      const weakPerc = total ? (cW/total*100) : 0;
      const note = weakPerc >= 20
        ? "ØªØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ Ù…Ø±ÙƒØ²Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¶Ø¹Ø§Ù Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ."
        : "Ù…Ø³ØªÙˆÙ‰ Ù…ØªÙˆØ§Ø²Ù†ØŒ ÙŠÙÙˆØµÙ‰ Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„ÙØ§Ø¹Ù„Ø© ÙˆØªØ¹Ø²ÙŠØ² Ø§Ù„Ø¯Ø¹Ù… Ù„Ù„ÙØ¦Ø§Øª Ø§Ù„Ø£Ù‚Ù„ ØªØ­ØµÙŠÙ„Ù‹Ø§.";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="name-cell">${subject}</td>
        <td class="id-cell" style="text-align:center;">${total}</td>
        <td style="text-align:center;">${highPerc}%</td>
        <td>${dist}</td>
        <td>${note}</td>`;
      improvBodyEl.appendChild(tr);
    });

    improvSummaryEl.textContent =
      "ØªÙ… ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø§Ø¯Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŒ ÙˆÙŠÙˆØ¶Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙˆØ²ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ ÙÙŠ ÙƒÙ„ Ù…Ø§Ø¯Ø© Ù„Ø¯Ø¹Ù… Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ®Ø·Ø· Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯.";
  } else {
    setPlanHeadersForStudents();
    improvBodyEl.innerHTML =
      '<tr><td colspan="5" style="text-align:center;">ØªÙ… ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©Ø› ØªÙØ¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø© ÙƒÙ…Ø¤Ø´Ø±Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ.</td></tr>';

    const weakStudents = records.filter(r => (r.grade/fullScore)*100 < PLAN_THRESHOLD_PERCENT);
    const percentWeak = n ? ((weakStudents.length/n)*100).toFixed(1) : 0;
    improvSummaryEl.textContent =
      `Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø´Ø¯ Ø§Ø­ØªÙŠØ§Ø¬Ù‹Ø§ (Ø£Ù‚Ù„ Ù…Ù† ${PLAN_THRESHOLD_PERCENT}Ùª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©): ${weakStudents.length} Ù…Ù† ${n} (${percentWeak}Ùª Ù…Ù† Ø§Ù„Ø¹ÙŠÙ†Ø©). ÙŠÙÙˆØµÙ‰ Ø¨ØªÙ†Ø¸ÙŠÙ… Ø¨Ø±Ø§Ù…Ø¬ Ø¹Ù„Ø§Ø¬ÙŠØ© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ù†ØªØ§Ø¦Ø¬ ÙƒÙ„ Ø§Ø®ØªØ¨Ø§Ø±.`;
  }
}

/* ØªØ­Ù„ÙŠÙ„ Ù†ØµÙŠ */
function updateNarrative(fullScore, stats){
  const {
    n, avg, avgPercent, max, min,
    cEx, cVG, cG, cAc, cW,
    pEx, pVG, pG, pAc, pW
  } = stats;

  if(!n){
    analysisTagEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯";
    analysisTagEl.className = "analysis-tag";
    analysisTextEl.textContent = "Ù„Ù… ØªÙØ­Ù…Ù‘ÙÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
    analysisBulletsEl.innerHTML = "";
    return;
  }

  let levelLabel="", tagClass="analysis-tag mid";
  if(avgPercent>=90){levelLabel="ØªØ­ØµÙŠÙ„ Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ù‹Ø§ ÙˆÙ…Ø³ØªÙˆÙ‰ Ù…ØªÙ‚Ø¯Ù….";tagClass="analysis-tag good";}
  else if(avgPercent>=80){levelLabel="ØªØ­ØµÙŠÙ„ Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ Ù…Ø¹ Ù…Ø¤Ø´Ø±Ø§Øª Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©.";tagClass="analysis-tag good";}
  else if(avgPercent>=70){levelLabel="ØªØ­ØµÙŠÙ„ Ø¬ÙŠØ¯ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ¹Ø²ÙŠØ².";tagClass="analysis-tag mid";}
  else if(avgPercent>=60){levelLabel="ØªØ­ØµÙŠÙ„ Ù…Ù‚Ø¨ÙˆÙ„ ÙŠØªØ·Ù„Ø¨ Ø¯Ø¹Ù…Ù‹Ø§ Ù…Ø±ÙƒØ²Ù‹Ø§.";tagClass="analysis-tag mid";}
  else{levelLabel="ØªØ­ØµÙŠÙ„ Ø¶Ø¹ÙŠÙ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¯Ø®Ù„ Ø¹Ù„Ø§Ø¬ÙŠ Ù…Ù†Ø¸Ù‘Ù….";tagClass="analysis-tag weak";}

  analysisTagEl.textContent = avgPercent.toFixed(1) + "%";
  analysisTagEl.className = tagClass;

  const subject = subjectInput.value.trim();
  const scopeLabel = subject ? `ÙÙŠ Ù…Ø§Ø¯Ø© ${subject}` : "Ù„Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©";
  analysisTextEl.textContent =
    `Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ­ØµÙŠÙ„ ${scopeLabel} (${avg.toFixed(1)} Ù…Ù† ${fullScore.toFixed(1)}) ÙŠØ¹ÙƒØ³: ${levelLabel}`;

  analysisBulletsEl.innerHTML = "";
  const bullets = [];

  bullets.push(
    `Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${n}ØŒ Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©: ${max.toFixed(1)}ØŒ Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©: ${min.toFixed(1)}ØŒ ÙˆÙ…ØªÙˆØ³Ø· Ø§Ù„ØªØ­ØµÙŠÙ„ ÙŠØ¹Ø§Ø¯Ù„ ${avgPercent.toFixed(1)}Ùª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©.`
  );

  const highCount = cEx + cVG;
  const highPercent = pEx + pVG;
  bullets.push(
    `Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ØªÙÙˆÙ‚ (Ù…Ù…ØªØ§Ø² + Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§) = ${highCount} Ø­Ø§Ù„Ø© (${highPercent.toFixed(1)}Ùª)ØŒ Ù…Ù‚Ø§Ø¨Ù„ ÙØ¦Ø© Ø§Ù„Ø¶Ø¹ÙŠÙ = ${cW} Ø­Ø§Ù„Ø© (${pW.toFixed(1)}Ùª).`
  );

  if(pW >= 20){
    bullets.push(
      "ØªÙˆØµÙŠØ© Ù…Ø±ÙƒØ²Ø©: ØªÙØ¹ÙŠÙ„ Ø­ØµØµ Ø¹Ù„Ø§Ø¬ÙŠØ© Ù…Ù†ØªØ¸Ù…Ø© Ù„Ù„ÙØ¦Ø© Ø§Ù„Ø£Ø¶Ø¹ÙØŒ ÙˆØ±Ø¨Ø· Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø®Ø·Ø· Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© ÙˆØªÙˆØ§ØµÙ„ Ù…Ù†Ø¸Ù… Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±."
    );
  }else if(highPercent >= 60){
    bullets.push(
      "ØªÙˆØµÙŠØ© Ù…Ø±ÙƒØ²Ø©: Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ† ÙÙŠ Ù‚ÙŠØ§Ø¯Ø© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØªØ¹Ù„Ù… ØªØ¹Ø§ÙˆÙ†ÙŠ ÙˆÙ†Ù‚Ù„ Ø§Ù„Ø®Ø¨Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ."
    );
  }else{
    bullets.push(
      "ØªÙˆØµÙŠØ© Ù…Ø±ÙƒØ²Ø©: ØªÙ†ÙˆÙŠØ¹ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³ ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ…ØŒ Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚ØµÙŠØ±Ø© Ù…ØªÙƒØ±Ø±Ø© ÙˆÙˆØ§Ø¬Ø¨Ø§Øª Ø¹Ù„Ø§Ø¬ÙŠØ© Ù…ÙˆØ¬Ù‡Ø©."
    );
  }

  bullets.forEach(t=>{
    const li = document.createElement("li");
    li.textContent = t;
    analysisBulletsEl.appendChild(li);
  });
}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ… */
function updateStatsAndCharts(fullScore){
  const n = records.length;
  if(!n){
    setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø§Øª Ø±Ù‚Ù…ÙŠØ© ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù.");
    updateNarrative(fullScore,{n:0});
    return;
  }

  const grades = records.map(r=>r.grade);
  const max = Math.max(...grades);
  const min = Math.min(...grades);
  const sum = grades.reduce((a,b)=>a+b,0);
  const avg = sum/n;
  const avgPercent = (avg/fullScore)*100;

  statStudentsEl.textContent = n;
  statMaxEl.textContent      = max.toFixed(1);
  statMinEl.textContent      = min.toFixed(1);
  statAvgEl.textContent      = avg.toFixed(2);
  statSuccessEl.textContent  = avgPercent.toFixed(1) + "%";
  statSumEl.textContent      = sum.toFixed(1);

  let cEx=0,cVG=0,cG=0,cAc=0,cW=0;
  records.forEach(r=>{
    const p = (r.grade/fullScore)*100;
    if(p>=90) cEx++;
    else if(p>=80) cVG++;
    else if(p>=70) cG++;
    else if(p>=60) cAc++;
    else cW++;
  });

  countExcellentEl.textContent  = cEx;
  countVGoodEl.textContent      = cVG;
  countGoodEl.textContent       = cG;
  countAcceptableEl.textContent = cAc;
  countWeakEl.textContent       = cW;

  const pEx = n?(cEx/n*100):0;
  const pVG = n?(cVG/n*100):0;
  const pG  = n?(cG/n*100):0;
  const pAc = n?(cAc/n*100):0;
  const pW  = n?(cW/n*100):0;

  percExcellentEl.textContent  = `${pEx.toFixed(1)}% (${cEx})`;
  percVGoodEl.textContent      = `${pVG.toFixed(1)}% (${cVG})`;
  percGoodEl.textContent       = `${pG.toFixed(1)}% (${cG})`;
  percAcceptableEl.textContent = `${pAc.toFixed(1)}% (${cAc})`;
  percWeakEl.textContent       = `${pW.toFixed(1)}% (${cW})`;

  updateDonut("donutExcellent",  pEx);
  updateDonut("donutVGood",      pVG);
  updateDonut("donutGood",       pG);
  updateDonut("donutAcceptable", pAc);
  updateDonut("donutWeak",       pW);

  barChart.data.datasets[0].data = [cW,cAc,cG,cVG,cEx];
  barChart.update();

  if(scaleMode.value==="auto" && levelBoundaries && levelBoundaries.length>=5){
    const uniq = [...new Set(levelBoundaries)].sort((a,b)=>a-b);
    const [b0,b1,b2,b3,b4] = uniq.slice(0,5);
    rangeWeakEl.textContent       = `${b0}-${b1-1}`;
    rangeAcceptableEl.textContent = `${b1}-${b2-1}`;
    rangeGoodEl.textContent       = `${b2}-${b3-1}`;
    rangeVGoodEl.textContent      = `${b3}-${b4-1}`;
    rangeExcellentEl.textContent  = `${b4}-${fullScore}`;
  }else{
    const exMin = Math.round(fullScore*0.90);
    const vgMin = Math.round(fullScore*0.80);
    const gMin  = Math.round(fullScore*0.70);
    const acMin = Math.round(fullScore*0.60);
    rangeExcellentEl.textContent  = `${exMin}-${fullScore}`;
    rangeVGoodEl.textContent      = `${vgMin}-${exMin-1}`;
    rangeGoodEl.textContent       = `${gMin}-${vgMin-1}`;
    rangeAcceptableEl.textContent = `${acMin}-${gMin-1}`;
    rangeWeakEl.textContent       = `0-${acMin-1}`;
  }

  updateImprovementPlan(fullScore);
  updateNarrative(fullScore,{
    n, avg, avgPercent, max, min,
    cEx, cVG, cG, cAc, cW,
    pEx, pVG, pG, pAc, pW
  });
}

/* Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ */
function parseExcelFile(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const sheetName=wb.SheetNames[0];
        const ws=wb.Sheets[sheetName];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:null,raw:true});
        resolve(rows);
      }catch(err){reject(err);}
    };
    reader.onerror=err=>reject(err);
    reader.readAsArrayBuffer(file);
  });
}

/* ØªÙØ§Ø¹Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
toolsBtn.addEventListener("click",()=>lensOverlay.classList.add("open"));
lensClose.addEventListener("click",()=>lensOverlay.classList.remove("open"));
printBtn.addEventListener("click",()=>window.print());
excelInput.addEventListener("change",e=>{
  selectedFile = e.target.files[0] || null;
});

/* Ø²Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
analyzeBtn.addEventListener("click", async ()=>{
  if(!selectedFile){
    setStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø£ÙˆÙ„Ù‹Ø§.");
    excelInput.classList.add("missing");
    return;
  }
  excelInput.classList.remove("missing");

  const subject = subjectInput.value.trim();
  hasSubjectSpecific = !!subject;

  let ok = true;
  const needForAll = [stageInput, termInput];
  const needForSubject = [periodInput, teacherInput, sectionInput];

  needForAll.forEach(inp=>{
    if(!inp.value.trim()){inp.classList.add("missing");ok=false;}
    else inp.classList.remove("missing");
  });
  if(hasSubjectSpecific){
    needForSubject.forEach(inp=>{
      if(!inp.value.trim()){inp.classList.add("missing");ok=false;}
      else inp.classList.remove("missing");
    });
  }else{
    needForSubject.forEach(inp=>inp.classList.remove("missing"));
  }

  if(!ok){
    setStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„.");
    return;
  }

  try{
    setStatus("Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡...");
    const rows = await parseExcelFile(selectedFile);

    levelBoundaries = extractBoundariesFromRows(rows);
    records = buildRecordsFromSheet(rows);

    if(!records.length){
      setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø§Øª Ø±Ù‚Ù…ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.");
      return;
    }

    const grades = records.map(r=>r.grade);
    const maxGrade = Math.max(...grades);

    const candidates = [20,30,40,50,60,100];
    let inferred = maxGrade;
    let bestDiff = Infinity;
    candidates.forEach(c=>{
      if(c>=maxGrade && Math.abs(c-maxGrade)<=5){
        const diff=Math.abs(c-maxGrade);
        if(diff<bestDiff){bestDiff=diff;inferred=c;}
      }
    });
    fullScoreAuto = inferred;

    let fullScore = fullScoreAuto;
    if(scaleMode.value==="period60") fullScore=60;
    else if(scaleMode.value==="final100") fullScore=100;

    maxScoreFieldEl.textContent = fullScore.toFixed(1);

    const stage   = stageInput.value.trim();
    const section = sectionInput.value.trim();
    const period  = periodInput.value.trim();
    const term    = termInput.value.trim();
    const teacher = teacherInput.value.trim();

    const stageText = stage + (section ? ` / Ø´Ø¹Ø¨Ø© ${section}` : "");
    stageFieldEl.textContent = stageText || "â€”";
    termFieldEl.textContent  = (period ? period+" â€“ " : "") + (term || "â€”");
    titleSubjectEl.textContent  = subject || "[ØªØ­Ù„ÙŠÙ„ Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©]";
    headerSubjectEl.textContent = subject || "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ / Ù…Ø±Ø­Ù„Ø©";
    headerTeacherEl.textContent = teacher || (hasSubjectSpecific ? "â€”" : "Ù…Ù†Ø³Ù‚ Ø§Ù„Ù…Ø±Ø­Ù„Ø©");
    footerTeacherEl.textContent = teacher || "â€”";

    lensOverlay.classList.remove("open");
    setStatus("ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");

    updateStatsAndCharts(fullScore);
  }catch(err){
    console.error(err);
    setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
  }
});

/* ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
document.addEventListener("DOMContentLoaded", setupCharts);
</script>

</body>
</html>
