<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;

  --good:#22c55e;
  --vgood:#10b981;
  --good2:#3b82f6;
  --acc:#f59e0b;
  --weak:#ef4444;

  --hdrH:32mm;
  --printScale:.965;
  --donutSize:74px;
  --donutSizePrint:80px;
}

*{box-sizing:border-box;}
html,body{margin:0;padding:0;background:transparent !important;}
body{
  font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--ink);
  background:transparent !important;
}

.print-sheet{
  width:210mm;
  max-width:100%;
  margin:0 auto;
  background:transparent;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.moe-header{
  position:relative;
  width:100%;
  height:var(--hdrH);
  background:transparent !important;
  overflow:hidden;
}
.moe-header .hdr-img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:block;
  object-fit:contain;
  object-position:center center;
  background:transparent !important;
}
.moe-header .hdr-text{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
  padding:0 14mm;
  text-align:center;
  background:transparent !important;
  pointer-events:none;
  z-index:3;
}
.moe-header .hdr-text span{
  pointer-events:auto;
  outline:none;
  background:transparent !important;
  border:none;
  color:#fff;
  font-weight:900;
  line-height:1.35;
  text-shadow:0 3px 10px rgba(0,0,0,.38);
}
.moe-header .hdr-text .edu{font-size:15px;}
.moe-header .hdr-text .school{font-size:14px;font-weight:800;opacity:.98;}

/* Ø²Ø± Ø§Ù„Ø¹Ø¯Ø³Ø© */
.header-tools{
  position:absolute;
  top:calc(var(--hdrH) - 18mm);
  left:10mm;
  z-index:4;
}
.tools-pill{
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.72);
  background:linear-gradient(135deg,#0b7e88,#0b5f88);
  color:#fff;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 4px 14px rgba(15,23,42,.30);
  white-space:nowrap;
}
.tools-pill span.icon{font-size:15px;}
.tools-pill:hover{background:linear-gradient(135deg,#065f64,#064f7a);}

/* Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© */
.a4-page{
  width:210mm;
  max-width:100%;
  height:calc(297mm - var(--hdrH));
  position:relative;
  overflow:hidden;
  background:transparent !important;
}
.content-box{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:0mm;
  bottom:4mm;
  width:186mm;
  max-width:94%;
  overflow:hidden;
}
.main{width:100%;height:100%;}

/* Ø§Ù„ÙƒØ±Øª */
.card{
  width:100%;
  height:100%;
  padding:3mm 5mm;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  font-size:11px;
  background:rgba(255,255,255,.98);
  border-radius:18px;
  box-shadow:0 10px 26px rgba(15,23,42,.18);
}

/* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ */
.top-strip{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
  font-size:10.5px;
  color:var(--muted);
}

/* Ø§Ù„Ø¹Ø¯Ø³Ø© */
.lens-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.16);
  display:none;
  align-items:flex-start;
  justify-content:center;
  z-index:60;
  padding:10px;
}
.lens-overlay.open{display:flex;}
.lens-panel{
  margin-top:12mm;
  width:min(980px,94vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(15,23,42,.18);
  border:1px solid #e1f3f1;
  padding:12px 16px;
  font-size:11px;
}
.lens-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.lens-title{font-weight:900;color:var(--moe);font-size:13px;}
.lens-close{border:none;background:transparent;font-size:18px;cursor:pointer;}
.lens-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px 12px;
}
.lens-field{display:flex;flex-direction:column;gap:4px;}
.lens-field label{font-size:10px;color:var(--muted);}
.lens-field input[type="text"],
.lens-field select{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:6px 10px;
  font-size:11px;
  font-family:inherit;
  background:#f9fafb;
}
.lens-field input[type="file"]{font-size:11px;}
.missing{border-color:#ef4444 !important;background:#fef2f2 !important;}

.lens-actions{
  margin-top:10px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.btn-main{
  border-radius:12px;
  border:1px solid var(--moe);
  background:var(--moe);
  color:#fff;
  padding:9px 18px;
  font-size:11px;
  cursor:pointer;
  font-family:inherit;
  min-width:170px;
  text-align:center;
  white-space:nowrap;
  box-shadow:0 3px 10px rgba(15,23,42,.25);
}
.btn-main:hover{background:#065f64;}

/* Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ­Ø°ÙŠØ±/Ø§Ù„ØªÙ„Ù…ÙŠØ­ (Ù…Ø·Ù„ÙˆØ¨) */
.hint-box{
  margin-top:10px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  border-radius:12px;
  border:1px solid #fecaca;
  background:#fef2f2;
  padding:8px 10px;
}
.hint-icon{
  font-size:18px;
  color:#b91c1c;
  margin-top:1px;
}
.hint-text{
  font-size:10px;
  color:#7f1d1d;
  line-height:1.7;
}
.hint-text strong{font-weight:900;color:#b91c1c;}

/* Ø³Ø·Ø± Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø³Ø© */
.lens-credit{
  margin-top:10px;
  padding-top:8px;
  border-top:1px dashed #e5e7eb;
  font-size:10px;
  color:#475569;
  text-align:center;
  font-weight:700;
}

/* Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
.report-header{border-top:1px solid var(--line);padding-top:4px;}
.report-title-wrap{display:flex;justify-content:center;margin-bottom:4px;}
.report-title{
  border:1px solid var(--moe);
  border-radius:26px;
  padding:4px 22px;
  font-size:13px;
  font-weight:900;
  background:#fff;
}
.report-title span{font-weight:900;color:var(--moe);}

/* ØµÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
.header-row{
  margin-top:4px;
  padding:6px 10px;
  border-radius:999px;
  background:#f6f7f8;
  font-size:11px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  min-width:0;
}
.header-main-line{
  flex:1; min-width:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.header-main-line strong{color:var(--moe);}
.header-maxscore{white-space:nowrap;flex:0 0 auto;}

/* Ø§Ù„ÙˆØ³Ø· */
.middle-section{
  margin-top:6px;
  border-top:1px solid var(--line);
  padding-top:4px;
  display:grid;
  grid-template-columns:2.1fr 1.3fr;
  gap:7px;
}

/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© */
.details-title{font-size:12px;font-weight:900;color:var(--moe);margin:0 0 4px;}
.details-table{
  border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
  overflow:hidden;
}
.details-header{
  display:grid;
  grid-template-columns:2.4fr 1.1fr 0.9fr;
  align-items:center;
  column-gap:6px;
  padding:6px 8px;
  font-weight:900;
  font-size:10.5px;
  background:#f3f4f6;
  border-bottom:1px solid var(--line);
}
.details-rows{display:flex;flex-direction:column;}
.details-row{
  display:grid;
  grid-template-columns:2.4fr 1.1fr 0.9fr;
  align-items:center;
  column-gap:6px;
  padding:5px 8px;
  font-size:11px;
  border-bottom:1px solid #f1f5f9;
}
.details-row:last-child{border-bottom:none;}
.details-row:nth-child(even){background:#fbfbfb;}
.details-row .c2,.details-row .c3,
.details-header .h2,.details-header .h3{ text-align:center; }

.level-badge{
  display:flex;
  align-items:center;
  width:100%;
  padding:6px 12px;
  min-height:24px;
  border-radius:999px;
  color:#fff;
  font-size:11px;
  font-weight:900;
  box-shadow:0 1px 4px rgba(15,23,42,.15);
}
.l-ex{background:var(--good);}
.l-vg{background:var(--vgood);}
.l-g{background:var(--good2);}
.l-ac{background:var(--acc);}
.l-w{background:var(--weak);}

/* Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª */
.stats-box{
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px;
  font-size:11px;
  background:#fff;
}
.stats-grid{display:grid;grid-template-columns:1fr;gap:5px;}
.stat-item{
  border-radius:10px;
  border:1px solid #eef2f7;
  padding:4px 8px;
  background:#fafafa;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  min-width:0;
}
.stat-label{
  color:var(--moe);
  font-size:10px;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.stat-value{font-size:12px;font-weight:900;white-space:nowrap;}

/* Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙŠ */
.analysis-section{
  margin-top:6px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px;
  font-size:11px;
  background:#fafafa;
}
.analysis-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
  gap:8px;
}
.analysis-title{font-size:12px;font-weight:900;color:var(--moe);}
.analysis-tag{
  padding:2px 12px;
  border-radius:999px;
  font-size:10px;
  font-weight:900;
  border:1px solid #d1d5db;
  white-space:nowrap;
  background:#fff;
}
.analysis-tag.good{color:#16a34a;border-color:#16a34a;background:#dcfce7;}
.analysis-tag.mid{color:#ea580c;border-color:#ea580c;background:#ffedd5;}
.analysis-tag.weak{color:#b91c1c;border-color:#b91c1c;background:#fee2e2;}
.analysis-text{margin-bottom:3px;}
.analysis-list{margin:0;padding-right:18px;}
.analysis-list li{margin-bottom:2px;}

/* Ø§Ù„Ø±Ø³ÙˆÙ… */
.charts-section{
  margin-top:6px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px;
  background:#fff;
}
.charts-title{
  font-size:11px;
  font-weight:900;
  color:var(--moe);
  text-align:center;
  margin-bottom:4px;
}
.donuts-grid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:6px;
}
.donut-card{
  border-radius:12px;
  border:1px solid #eef2f7;
  padding:6px 4px 7px;
  text-align:center;
  background:#fafafa;
}
.donut-wrap{width:100%;display:grid;place-items:center;}
.donut-canvas{
  width:var(--donutSize) !important;
  height:var(--donutSize) !important;
  display:block;
}
.donut-label{font-size:9px;color:#4b5563;}
.donut-value{font-size:9px;font-weight:900;}

.bar-wrapper{
  margin-top:6px;
  border-radius:12px;
  border:1px solid #eef2f7;
  padding:5px;
}
.bar-wrapper canvas{width:100%;height:84px;}

/* Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† */
.improv-section{
  margin-top:6px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:6px 8px 5px;
  font-size:10px;
  background:#fff;
}
.improv-title{font-size:11px;font-weight:900;color:var(--moe);}
.improv-sub{font-size:9px;color:var(--muted);margin-bottom:2px;}
.improv-summary{font-size:9px;margin-top:3px;}
.improv-table{width:100%;border-collapse:collapse;font-size:9px;margin-top:3px;}
.improv-table th,.improv-table td{border:1px solid var(--line);padding:2px 3px;}
.improv-table th{background:#f3f4f6;white-space:nowrap;}
.improv-table th.col-name{width:24%;}
.improv-table th.col-id{width:14%;}
.improv-table th.col-grade{width:18%;}
.improv-table th.col-actions{width:36%;}
.improv-table th.col-follow{width:14%;}
.improv-table td.name-cell,.improv-table td.id-cell{white-space:nowrap;}
.follow-cell{text-align:center;white-space:nowrap;}
.follow-cell label{display:inline-flex;align-items:center;gap:2px;margin-inline:2px;font-size:8px;}
.follow-cell input[type="checkbox"]{width:9px;height:9px;}

/* Ø§Ù„ÙÙˆØªØ± */
.footer{
  margin-top:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:10.5px;
  color:#4b5563;
  gap:10px;
}
.footer-line{margin:0;white-space:nowrap;}
.footer strong{color:#111827;}

/* Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„ØªØ§Ø¨Ù„Øª */
@media (max-width:900px){
  .print-sheet{width:100%;}
  .moe-header{height:92px;}
  .a4-page{width:100%;height:auto;min-height:calc(100vh - 92px);}
  .content-box{
    position:relative;
    top:auto; bottom:auto;
    left:auto; transform:none;
    width:min(980px,96%);
    max-width:96%;
    margin:8px auto 18px;
    overflow:visible;
  }
  .card{height:auto;border-radius:14px;}
  .donuts-grid{grid-template-columns:repeat(2,1fr);}
  .header-tools{top:12px;left:12px;}
  .lens-grid{grid-template-columns:1fr;}
}

@media (max-width:600px){
  .card{font-size:10px;padding:2mm 3mm;}
  .header-row{font-size:10px;padding:4px 8px;}
  .donut-canvas{width:78px !important;height:78px !important;}
  .bar-wrapper canvas{height:76px;}
  .improv-table{font-size:8px;}
}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© */
@media print{
  @page{size:A4 portrait;margin:0;}
  html,body{height:100%;background:transparent !important;}
  body{
    margin:0;padding:0;overflow:hidden;
    display:flex;justify-content:center;align-items:flex-start;
  }
  .lens-overlay{display:none !important;}
  .header-tools{display:none !important;}

  .print-sheet{
    width:210mm !important;
    height:297mm !important;
    margin:0 !important;
    overflow:hidden !important;
    background:transparent !important;
    transform:scale(var(--printScale));
    transform-origin:top center;
  }
  .moe-header{height:var(--hdrH) !important;overflow:hidden !important;}
  .a4-page{
    width:210mm !important;
    height:calc(297mm - var(--hdrH)) !important;
    overflow:hidden !important;
    background:transparent !important;
  }
  .content-box{top:0mm !important;bottom:3.5mm !important;}

  .card{
    box-shadow:none !important;
    border-radius:0 !important;
    font-size:9.7px !important;
    padding:2.6mm 4.6mm !important;
  }

  .donut-canvas{
    width:var(--donutSizePrint) !important;
    height:var(--donutSizePrint) !important;
  }
  .bar-wrapper canvas{height:78px !important;}
  .details-row:nth-child(even){background:#fff !important;}

  .card,.report-header,.middle-section,.analysis-section,.charts-section,.improv-section,.footer{
    break-inside:avoid !important;
    page-break-inside:avoid !important;
  }
}
</style>
</head>

<body>
<div class="print-sheet" id="printSheet">

  <header class="moe-header" aria-label="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„">
    <img class="hdr-img" src="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ .png" alt="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„" />
    <div class="hdr-text">
      <span id="eduName" class="edu" contenteditable="true">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</span>
      <span id="schoolName" class="school" contenteditable="true">Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</span>
    </div>

    <div class="header-tools">
      <button type="button" class="tools-pill" id="toolsBtn">
        <span class="icon">ğŸ”</span>
        <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDF</span>
      </button>
    </div>
  </header>

  <div class="a4-page">
    <div class="content-box">
      <main class="main">
        <section class="card">

          <div class="top-strip">
            <span id="statusMessage">
              Ø§Ø¶ØºØ· Ø²Ø± Â«Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDFÂ» ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.
            </span>
          </div>

          <!-- Ø§Ù„Ø¹Ø¯Ø³Ø© -->
          <div class="lens-overlay" id="lensOverlay">
            <div class="lens-panel">
              <div class="lens-header">
                <div class="lens-title">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                <button type="button" class="lens-close" id="lensClose">âœ•</button>
              </div>

              <div class="lens-grid">
                <div class="lens-field">
                  <label for="excelFile">ğŸ“‚ Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ù…Ù„Ù Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©)</label>
                  <input id="excelFile" type="file" accept=".xlsx,.xls" />
                </div>

                <div class="lens-field">
                  <label for="subjectInput">Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input id="subjectInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
                </div>

                <div class="lens-field">
                  <label for="stageInput">Ø§Ù„ØµÙ</label>
                  <input id="stageInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ" />
                </div>

                <div class="lens-field">
                  <label for="sectionInput">Ø§Ù„Ø´Ø¹Ø¨Ø© (ÙŠÙ…ÙƒÙ† Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ø¹Ø¨Ø©: 1,2,3)</label>
                  <input id="sectionInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 1 Ø£Ùˆ 1,2,3" />
                </div>

                <div class="lens-field">
                  <label for="periodInput">Ø§Ù„ÙØªØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input id="periodInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰" />
                </div>

                <div class="lens-field">
                  <label for="termInput">Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…</label>
                  <input id="termInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 1447Ù‡Ù€ â€“ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„" />
                </div>

                <div class="lens-field">
                  <label for="teacherInput">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù…Ù†Ø³Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input id="teacherInput" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯" />
                </div>

                <div class="lens-field">
                  <label for="scaleMode">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                  <select id="scaleMode">
                    <option value="auto">Ø¢Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ù„Ù</option>
                    <option value="period60">Ø§Ø®ØªØ¨Ø§Ø± ÙØªØ±Ø© (0â€“60)</option>
                    <option value="final100">Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ (0â€“100)</option>
                  </select>
                </div>

                <div class="lens-field">
                  <label for="eduInput">Ù†Øµ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
                  <input id="eduInput" type="text" placeholder="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©" />
                </div>

                <div class="lens-field">
                  <label for="schoolInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
                  <input id="schoolInput" type="text" placeholder="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±" />
                </div>

                <div class="lens-field">
                  <label for="principalInput">Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø¥Ø¶Ø§ÙÙŠ)</label>
                  <input id="principalInput" type="text" value="ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ" />
                </div>
              </div>

              <div class="lens-actions">
                <button type="button" class="btn-main" id="analyzeBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
                <button type="button" class="btn-main" id="printBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
              </div>

              <!-- âœ… Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ -->
              <div class="hint-box" aria-label="Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† Ù†ÙˆØ±">
                <div class="hint-icon">âš ï¸</div>
                <div class="hint-text">
                  <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† Â«Ù†ÙˆØ±Â»:</strong><br/>
                  Ù†Ø¸Ø§Ù… Ù†ÙˆØ± â†’ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± â†’ ØªÙ‚Ø§Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª â†’ ÙƒØ´Ù Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ø§Ø¯Ø© â†’ Â«ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ ExcelÂ».
                </div>
              </div>

              <div class="lens-credit">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø© ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
            </div>
          </div>

          <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
          <div class="report-header">
            <div class="report-title-wrap">
              <div class="report-title">
                ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø© <span id="titleSubject">[Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ù…Ø±Ø­Ù„Ø©]</span>
              </div>
            </div>

            <div class="header-row">
              <div class="header-main-line">
                Ø§Ù„ØµÙ: <strong id="stageField">â€”</strong>
                Â· Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="headerSubjectField">â€”</strong>
                Â· Ø§Ù„ÙØªØ±Ø© / Ø§Ù„ÙØµÙ„: <strong id="termField">â€”</strong>
                Â· Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù…Ù†Ø³Ù‚: <strong id="headerTeacherField">â€”</strong>
              </div>
              <div class="header-maxscore">
                Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©: <strong id="maxScoreField">â€”</strong>
              </div>
            </div>
          </div>

          <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
          <div class="middle-section">
            <div>
              <div class="details-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
              <div class="details-table">
                <div class="details-header">
                  <div class="h1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
                  <div class="h2">Ø§Ù„Ù†Ø·Ø§Ù‚</div>
                  <div class="h3">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
                </div>
                <div class="details-rows">
                  <div class="details-row">
                    <div class="c1"><span class="level-badge l-ex">Ù…Ù…ØªØ§Ø²</span></div>
                    <div class="c2" id="rangeExcellent">â€”</div>
                    <div class="c3" id="countExcellent">0</div>
                  </div>
                  <div class="details-row">
                    <div class="c1"><span class="level-badge l-vg">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</span></div>
                    <div class="c2" id="rangeVGood">â€”</div>
                    <div class="c3" id="countVGood">0</div>
                  </div>
                  <div class="details-row">
                    <div class="c1"><span class="level-badge l-g">Ø¬ÙŠØ¯</span></div>
                    <div class="c2" id="rangeGood">â€”</div>
                    <div class="c3" id="countGood">0</div>
                  </div>
                  <div class="details-row">
                    <div class="c1"><span class="level-badge l-ac">Ù…Ù‚Ø¨ÙˆÙ„</span></div>
                    <div class="c2" id="rangeAcceptable">â€”</div>
                    <div class="c3" id="countAcceptable">0</div>
                  </div>
                  <div class="details-row">
                    <div class="c1"><span class="level-badge l-w">Ø¶Ø¹ÙŠÙ</span></div>
                    <div class="c2" id="rangeWeak">â€”</div>
                    <div class="c3" id="countWeak">0</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="stats-box">
              <div class="stats-grid">
                <div class="stat-item"><span class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨/Ø§Ù„Ø­Ø§Ù„Ø§Øª</span><span class="stat-value" id="statStudents">0</span></div>
                <div class="stat-item"><span class="stat-label">Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</span><span class="stat-value" id="statMax">0</span></div>
                <div class="stat-item"><span class="stat-label">Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©</span><span class="stat-value" id="statMin">0</span></div>
                <div class="stat-item"><span class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="stat-value" id="statAvg">0</span></div>
                <div class="stat-item"><span class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</span><span class="stat-value" id="statSuccess">0%</span></div>
                <div class="stat-item"><span class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="stat-value" id="statSum">0</span></div>
              </div>
            </div>
          </div>

          <!-- ØªØ­Ù„ÙŠÙ„ Ù†ØµÙŠ -->
          <div class="analysis-section">
            <div class="analysis-header">
              <div class="analysis-title">Ù‚Ø±Ø§Ø¡Ø© ØªØ­Ù„ÙŠÙ„ÙŠØ© Ø°ÙƒÙŠØ©</div>
              <div id="analysisTag" class="analysis-tag">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
            </div>
            <div id="analysisText" class="analysis-text">Ù„Ù… ØªÙØ­Ù…Ù‘ÙÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
            <ul id="analysisBullets" class="analysis-list"></ul>
          </div>

          <!-- Ø§Ù„Ø±Ø³ÙˆÙ… -->
          <div class="charts-section">
            <div class="charts-title">Ù†ÙØ³ÙØ¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±</div>
            <div class="donuts-grid">
              <div class="donut-card">
                <div class="donut-wrap"><canvas id="donutWeak" class="donut-canvas"></canvas></div>
                <div class="donut-label">Ø¶Ø¹ÙŠÙ</div>
                <div class="donut-value" id="percWeak">0% (0)</div>
              </div>
              <div class="donut-card">
                <div class="donut-wrap"><canvas id="donutAcceptable" class="donut-canvas"></canvas></div>
                <div class="donut-label">Ù…Ù‚Ø¨ÙˆÙ„</div>
                <div class="donut-value" id="percAcceptable">0% (0)</div>
              </div>
              <div class="donut-card">
                <div class="donut-wrap"><canvas id="donutGood" class="donut-canvas"></canvas></div>
                <div class="donut-label">Ø¬ÙŠØ¯</div>
                <div class="donut-value" id="percGood">0% (0)</div>
              </div>
              <div class="donut-card">
                <div class="donut-wrap"><canvas id="donutVGood" class="donut-canvas"></canvas></div>
                <div class="donut-label">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</div>
                <div class="donut-value" id="percVGood">0% (0)</div>
              </div>
              <div class="donut-card">
                <div class="donut-wrap"><canvas id="donutExcellent" class="donut-canvas"></canvas></div>
                <div class="donut-label">Ù…Ù…ØªØ§Ø²</div>
                <div class="donut-value" id="percExcellent">0% (0)</div>
              </div>
            </div>

            <div class="charts-title" style="margin-top:4px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±</div>
            <div class="bar-wrapper">
              <canvas id="barLevels"></canvas>
            </div>
          </div>

          <!-- Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† -->
          <div class="improv-section">
            <div class="improv-title">Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø°ÙˆÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ù†ÙŠ</div>
            <div class="improv-sub">ØªÙØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§ØµÙ„ÙŠÙ† Ø¹Ù„Ù‰ Ø£Ù‚Ù„ Ù…Ù† Ù¢Ù¥Ùª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ¯ Ù…Ø§Ø¯Ø©.</div>
            <table class="improv-table">
              <thead>
                <tr>
                  <th class="col-name">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                  <th class="col-id">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                  <th class="col-grade">Ø§Ù„Ø¯Ø±Ø¬Ø© / ÙØ¬ÙˆØ© Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                  <th class="col-actions">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
                  <th class="col-follow">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ†ÙÙŠØ°<br/>Ù†ÙÙ‘ÙØ° / Ù„Ù… ÙŠÙÙ†ÙÙ‘ÙØ°</th>
                </tr>
              </thead>
              <tbody id="improvBody">
                <tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¶Ù…Ù† ÙØ¦Ø© Ø§Ù„Ø¶Ø¹ÙŠÙ ÙˆÙÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</td></tr>
              </tbody>
            </table>
            <div class="improv-summary" id="improvSummary">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
          </div>

          <!-- Ø§Ù„ÙÙˆØªØ± -->
          <div class="footer">
            <p class="footer-line">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / <strong id="footerTeacher">â€”</strong></p>
            <p class="footer-line">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / <strong id="footerPrincipal" contenteditable="true">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</strong></p>
          </div>

        </section>
      </main>
    </div>
  </div>

</div>

<script>
let records = [];
let donutCharts = Object.create(null);
let barChart = null;

let selectedFile = null;
let levelBoundaries = null;
let hasSubjectSpecific = false;

const PLAN_THRESHOLD_PERCENT = 25;

/* DOM */
const lensOverlay = document.getElementById("lensOverlay");
const toolsBtn    = document.getElementById("toolsBtn");
const lensClose   = document.getElementById("lensClose");
const analyzeBtn  = document.getElementById("analyzeBtn");
const printBtn    = document.getElementById("printBtn");

const excelInput   = document.getElementById("excelFile");
const subjectInput = document.getElementById("subjectInput");
const stageInput   = document.getElementById("stageInput");
const sectionInput = document.getElementById("sectionInput");
const periodInput  = document.getElementById("periodInput");
const termInput    = document.getElementById("termInput");
const teacherInput = document.getElementById("teacherInput");
const scaleMode    = document.getElementById("scaleMode");

const eduSpan     = document.getElementById("eduName");
const schoolSpan  = document.getElementById("schoolName");
const eduInput    = document.getElementById("eduInput");
const schoolInput = document.getElementById("schoolInput");

const principalInput = document.getElementById("principalInput");
const footerPrincipalEl = document.getElementById("footerPrincipal");

const titleSubjectEl  = document.getElementById("titleSubject");
const stageFieldEl    = document.getElementById("stageField");
const termFieldEl     = document.getElementById("termField");
const maxScoreFieldEl = document.getElementById("maxScoreField");
const headerSubjectEl = document.getElementById("headerSubjectField");
const headerTeacherEl = document.getElementById("headerTeacherField");
const footerTeacherEl = document.getElementById("footerTeacher");
const statusEl        = document.getElementById("statusMessage");

const rangeExcellentEl  = document.getElementById("rangeExcellent");
const rangeVGoodEl      = document.getElementById("rangeVGood");
const rangeGoodEl       = document.getElementById("rangeGood");
const rangeAcceptableEl = document.getElementById("rangeAcceptable");
const rangeWeakEl       = document.getElementById("rangeWeak");

const countExcellentEl   = document.getElementById("countExcellent");
const countVGoodEl       = document.getElementById("countVGood");
const countGoodEl        = document.getElementById("countGood");
const countAcceptableEl  = document.getElementById("countAcceptable");
const countWeakEl        = document.getElementById("countWeak");

const statStudentsEl = document.getElementById("statStudents");
const statMaxEl      = document.getElementById("statMax");
const statMinEl      = document.getElementById("statMin");
const statAvgEl      = document.getElementById("statAvg");
const statSuccessEl  = document.getElementById("statSuccess");
const statSumEl      = document.getElementById("statSum");

const analysisTagEl     = document.getElementById("analysisTag");
const analysisTextEl    = document.getElementById("analysisText");
const analysisBulletsEl = document.getElementById("analysisBullets");

const percWeakEl        = document.getElementById("percWeak");
const percAcceptableEl  = document.getElementById("percAcceptable");
const percGoodEl        = document.getElementById("percGood");
const percVGoodEl       = document.getElementById("percVGood");
const percExcellentEl   = document.getElementById("percExcellent");

const improvSummaryEl = document.getElementById("improvSummary");
const improvBodyEl    = document.getElementById("improvBody");

function setStatus(msg){ statusEl.textContent = msg; }

/* Ø±Ø¨Ø· Ø®ÙˆØ§Ø±Ø²Ù…ÙŠ Ù„Ù„Ù‡ÙŠØ¯Ø± */
function syncHeaderFromInputs(){
  const e = (eduInput.value || "").trim();
  const s = (schoolInput.value || "").trim();
  if(e) eduSpan.textContent = e;
  if(s) schoolSpan.textContent = s;
}
function syncInputsFromHeader(){
  eduInput.value = (eduSpan.textContent || "").trim();
  schoolInput.value = (schoolSpan.textContent || "").trim();
}
eduInput.addEventListener("input", syncHeaderFromInputs);
schoolInput.addEventListener("input", syncHeaderFromInputs);
eduSpan.addEventListener("input", syncInputsFromHeader);
schoolSpan.addEventListener("input", syncInputsFromHeader);
syncInputsFromHeader();

/* Ø±Ø¨Ø· Ø®ÙˆØ§Ø±Ø²Ù…ÙŠ Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± (Ù…Ù† Ø§Ù„Ø¹Ø¯Ø³Ø© â†” Ø§Ù„ÙÙˆØªØ±) */
function syncPrincipalFromInput(){
  const v = (principalInput.value || "").trim();
  if(v) footerPrincipalEl.textContent = v;
}
function syncPrincipalToInput(){
  principalInput.value = (footerPrincipalEl.textContent || "").trim() || "ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ";
}
principalInput.addEventListener("input", syncPrincipalFromInput);
footerPrincipalEl.addEventListener("input", syncPrincipalToInput);
syncPrincipalToInput();

/* Ø§Ø³Ù… Ø§Ù„Ø­ÙØ¸ */
let originalTitle = document.title;
function safeText(s){ return (s||"").replace(/\s+/g," ").trim(); }
function buildPrintTitle(){
  const subj = safeText(subjectInput.value) || "Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©";
  const stage = safeText(stageInput.value) || "â€”";
  const sec = safeText(sectionInput.value);
  const secLabel = sec ? ` ${sec}` : "";
  return `ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ø¯Ø© ${subj} ${stage}${secLabel}`.replace(/\s+/g," ").trim();
}
function printWithSmartTitle(){
  const t = buildPrintTitle();
  originalTitle = document.title;
  document.title = t;
  window.print();
  setTimeout(()=>{ document.title = originalTitle; }, 350);
}

/* Ø£Ø±Ù‚Ø§Ù… */
function normalizeDigits(str){
  if(str == null) return "";
  str = String(str);
  const map = {'Ù ':0,'Ù¡':1,'Ù¢':2,'Ù£':3,'Ù¤':4,'Ù¥':5,'Ù¦':6,'Ù§':7,'Ù¨':8,'Ù©':9};
  return str.replace(/[Ù -Ù©]/g,d=>map[d]).replace(/,/g,".");
}
function isNumeric(val){
  if(val === null || val === undefined) return false;
  if(typeof val === "number") return !isNaN(val);
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return !isNaN(n);
}
function toNumber(val){
  if(typeof val === "number") return val;
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return isNaN(n) ? NaN : n;
}

/* Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ */
function extractBoundariesFromRows(rows){
  for(let i = rows.length-1, checked=0; i>=0 && checked<30; i--,checked++){
    const row = rows[i];
    if(!row) continue;
    const nums = row.filter(isNumeric).map(v => Math.round(toNumber(v))).filter(v => v >= 0);
    if(!nums.length) continue;
    const uniq = [...new Set(nums)].sort((a,b)=>a-b);
    if(uniq.length >= 5 && Math.max(...uniq) <= 60) return uniq;
  }
  return null;
}

/* Plugins */
const centerLabelPlugin = {
  id:"centerLabel",
  afterDraw(chart, args, opts){
    const text = opts && opts.text;
    if(!text) return;
    const {ctx, chartArea:{left,right,top,bottom}} = chart;
    const x = (left+right)/2;
    const y = (top+bottom)/2;
    ctx.save();
    ctx.font = "900 13px Tajawal, system-ui";
    ctx.fillStyle = "#111827";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
    ctx.restore();
  }
};
const barValuePlugin = {
  id:"barValue",
  afterDatasetsDraw(chart){
    if(chart.config.type !== "bar") return;
    const {ctx} = chart;
    const dataset = chart.data.datasets[0];
    const meta = chart.getDatasetMeta(0);
    ctx.save();
    ctx.font = "900 10px Tajawal, system-ui";
    ctx.fillStyle = "#111827";
    ctx.textAlign = "center";
    dataset.data.forEach((value, index)=>{
      const bar = meta.data[index];
      if(!bar) return;
      const props = bar.getProps(['y','base','x'], true);
      const centerY = (props.y + props.base) / 2;
      ctx.fillText(value, props.x, centerY);
    });
    ctx.restore();
  }
};
Chart.register(centerLabelPlugin, barValuePlugin);

/* Ø§Ù„Ø±Ø³ÙˆÙ… */
function setupCharts(){
  const donuts = [
    {id:"donutWeak",      color:"#ef4444"},
    {id:"donutAcceptable",color:"#f59e0b"},
    {id:"donutGood",      color:"#3b82f6"},
    {id:"donutVGood",     color:"#10b981"},
    {id:"donutExcellent", color:"#22c55e"}
  ];
  donuts.forEach(cfg=>{
    const canvas = document.getElementById(cfg.id);
    donutCharts[cfg.id] = new Chart(canvas.getContext("2d"),{
      type:"doughnut",
      data:{ labels:["Ø§Ù„Ù†Ø³Ø¨Ø©","Ø§Ù„Ø¨Ø§Ù‚ÙŠ"], datasets:[{ data:[0,100], backgroundColor:[cfg.color,"#e5e7eb"], borderWidth:0 }] },
      options:{
        plugins:{ legend:{display:false}, tooltip:{enabled:false}, centerLabel:{text:"0%"} },
        cutout:"72%",
        animation:false
      }
    });
  });

  const barCanvas = document.getElementById("barLevels");
  barChart = new Chart(barCanvas.getContext("2d"),{
    type:"bar",
    data:{
      labels:["Ø¶Ø¹ÙŠÙ","Ù…Ù‚Ø¨ÙˆÙ„","Ø¬ÙŠØ¯","Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§","Ù…Ù…ØªØ§Ø²"],
      datasets:[{
        data:[0,0,0,0,0],
        backgroundColor:["#ef4444","#f59e0b","#3b82f6","#10b981","#22c55e"],
        borderRadius:6,
        maxBarThickness:32
      }]
    },
    options:{
      plugins:{ legend:{display:false}, barValue:{} },
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      scales:{
        x:{ticks:{font:{family:"Tajawal",size:10}}},
        y:{beginAtZero:true,ticks:{stepSize:1,font:{family:"Tajawal",size:9}}}
      }
    }
  });
}
function updateDonut(id, percent){
  const chart = donutCharts[id];
  if(!chart) return;
  const p = Math.max(0,Math.min(100,percent));
  chart.data.datasets[0].data = [p,100-p];
  chart.options.plugins.centerLabel.text = `${Math.round(p)}%`;
  chart.update();
}

/* Ø¨Ù†Ùƒ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
const bankSevere = [
  "Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ ÙØ±Ø¯ÙŠØ© Ù…ÙƒØªÙˆØ¨Ø©ØŒ ÙˆØ¯Ø±ÙˆØ³ ØªÙ‚ÙˆÙŠØ© Ù…Ù†ØªØ¸Ù…Ø©ØŒ ÙˆØªÙˆØ§ØµÙ„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…Ù†Ø³Ù‚ Ù…Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.",
  "Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù„Ø§Ø¬ÙŠ Ù…ÙƒØ«Ù ÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ£Ø«ÙŠØ±Ù‹Ø§ ÙÙŠ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ø§Ù„Ø¨.",
  "Ø¬Ù„Ø³Ø§Øª Ø¯Ø¹Ù… ÙØ±Ø¯ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆØ§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ Ù„ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©."
];
const bankModerate = [
  "Ø¯Ø±ÙˆØ³ ØªÙ‚ÙˆÙŠØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŒ Ù…Ø¹ ÙˆØ§Ø¬Ø¨Ø§Øª Ø¹Ù„Ø§Ø¬ÙŠØ© Ù‚ØµÙŠØ±Ø© ØªÙ‚ÙŠØ³ Ø§Ù„ØªØ­Ø³Ù† ÙÙŠ ÙƒÙ„ Ù…Ù‡Ø§Ø±Ø©.",
  "Ø¥Ø´Ø±Ø§Ùƒ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØªØ¹Ù„Ù… ØªØ¹Ø§ÙˆÙ†ÙŠ Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¡ Ù…ØªÙÙˆÙ‚ÙŠÙ† Ù„Ø¯Ø¹Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ.",
  "Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙØªØ± Ø§Ù„ÙˆØ§Ø¬Ø¨ ÙˆØ§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØµÙÙŠØ©ØŒ Ù…Ø¹ ØªØ¹Ø²ÙŠØ² ÙˆØªØ´Ø¬ÙŠØ¹ Ù…Ø³ØªÙ…Ø± Ø¹Ù†Ø¯ ØªØ­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡."
];
const bankMild = [
  "Ø¥Ø«Ø±Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø£Ù†Ø´Ø·Ø© Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØªÙƒÙ„ÙŠÙÙ‡ Ø¨Ù…Ù‡Ù…Ø§Øª Ù‚ÙŠØ§Ø¯ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ.",
  "Ø±Ø¨Ø· Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ø§ÙØ¹ÙŠØªÙ‡.",
  "ØªÙ‚Ø¯ÙŠÙ… ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø§Ø¡Ø© ØªØ´Ø¬Ù‘Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„ØªÙ…ÙŠØ² ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰."
];
function generateServices(percent, index){
  const p = Number(percent);
  const bank = (p < 40) ? bankSevere : (p < 60) ? bankModerate : bankMild;
  return bank[index % bank.length];
}

/* Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø´ÙØ¹Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
function parseSectionsInput(txt){
  const s = normalizeDigits(txt || "").trim();
  if(!s) return [];
  return s.split(/[,ØŒ/|]+/).map(v=>v.trim()).filter(Boolean);
}

/* Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª */
function buildRecordsFromSheet(rows){
  if(!rows || !rows.length) return [];

  let headerIndex = -1;
  for(let i=0;i<Math.min(rows.length,60);i++){
    const row = rows[i];
    if(!row) continue;
    const joined = row.map(c=>c==null?"":String(c)).join(" ");
    if(/Ø§Ø³Ù…\s*Ø§Ù„Ø·Ø§Ù„Ø¨/.test(joined)){ headerIndex=i; break; }
  }

  if(headerIndex === -1){
    const grades=[];
    for(const row of rows){
      if(!row) continue;
      for(const cell of row){
        if(isNumeric(cell)){
          const n = toNumber(cell);
          if(n>=0 && n<=200) grades.push(n);
        }
      }
    }
    return grades.map(g=>({student:"â€”",id:"â€”",grade:g,subject:"",section:""}));
  }

  const headers = rows[headerIndex] || [];
  let nameCol=-1,idCol=-1,gradeCol=-1,subjectCol=-1,sectionCol=-1;

  headers.forEach((cell,idx)=>{
    if(cell==null) return;
    const s = String(cell);
    if(nameCol===-1 && /Ø§Ø³Ù…/.test(s) && /Ø·Ø§Ù„Ø¨/.test(s)) nameCol=idx;
    if(idCol===-1   && /Ù‡ÙˆÙŠØ©|Ø§Ù„Ø³Ø¬Ù„|Ø§Ù„Ù…Ø¯Ù†ÙŠ/.test(s)) idCol=idx;
    if(subjectCol===-1 && /Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„Ù…Ù‚Ø±Ø±/.test(s)) subjectCol=idx;
    if(sectionCol===-1 && /Ø§Ù„Ø´Ø¹Ø¨Ø©|Ø§Ù„Ù‚Ø³Ù…|Ø´Ø¹Ø¨Ø©/.test(s)) sectionCol=idx;
  });

  const secondRow = rows[headerIndex+1] || [];
  secondRow.forEach((cell,idx)=>{
    if(cell==null) return;
    const s = String(cell);
    if(gradeCol===-1 && /Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ø¯Ø±Ø¬Ø©|Ø§Ù„Ø¯Ø±Ø¬Ù‡/.test(s)) gradeCol=idx;
  });

  if(gradeCol===-1){
    let bestCol=-1,bestMean=-1;
    const maxCols = Math.max(...rows.map(r=>r ? r.length : 0));
    for(let c=0;c<maxCols;c++){
      const vals=[];
      for(let r=headerIndex+1;r<rows.length;r++){
        const row=rows[r];
        if(!row || c>=row.length) continue;
        const v=row[c];
        if(isNumeric(v)){
          const n=toNumber(v);
          if(n>=0 && n<=200) vals.push(n);
        }
      }
      if(vals.length>=3){
        const mean=vals.reduce((a,b)=>a+b,0)/vals.length;
        if(mean>bestMean){bestMean=mean;bestCol=c;}
      }
    }
    gradeCol=bestCol;
  }

  const out=[];
  for(let r=headerIndex+1;r<rows.length;r++){
    const row=rows[r];
    if(!row) continue;

    const nameRaw  = nameCol>=0 ? row[nameCol] : null;
    const idRaw    = idCol>=0 ? row[idCol] : null;
    const gradeRaw = gradeCol>=0 ? row[gradeCol] : null;
    const subRaw   = subjectCol>=0 ? row[subjectCol] : null;
    const secRaw   = sectionCol>=0 ? row[sectionCol] : null;

    const name     = nameRaw ? String(nameRaw).trim() : "";
    const idDigits = idRaw ? normalizeDigits(idRaw).replace(/[^\d]/g,"") : "";
    const gradeNum = isNumeric(gradeRaw) ? toNumber(gradeRaw) : NaN;
    const subject  = subRaw ? String(subRaw).trim() : "";
    const section  = secRaw ? normalizeDigits(String(secRaw)).trim() : "";

    if(!name && !idDigits) continue;
    if(!isFinite(gradeNum) || gradeNum<0 || gradeNum>200) continue;
    if(/Ø§Ù„ÙØµÙ„|Ø§Ù„Ø´Ø¹Ø¨Ø©|Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„ØµÙ|ÙƒØ´Ù Ø±ØµØ¯|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ù…ØªÙˆØ³Ø·|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰/i.test(name)) continue;
    if(!name && (!idDigits || idDigits.length<7)) continue;

    out.push({ student:name||"Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…", id:idDigits||"â€”", grade:gradeNum, subject, section });
  }
  return out;
}

/* ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø´Ø¹Ø¨Ø© */
function applyFilters(raw){
  const subjectNeed = (subjectInput.value||"").trim();
  const sectionsNeed = parseSectionsInput(sectionInput.value);

  let arr = raw.slice();

  if(subjectNeed){
    const hasSubCol = arr.some(r => (r.subject||"").trim());
    if(hasSubCol){
      const key = subjectNeed.replace(/\s+/g,"").toLowerCase();
      arr = arr.filter(r => (r.subject||"").replace(/\s+/g,"").toLowerCase().includes(key));
    }
  }

  if(sectionsNeed.length){
    const hasSecCol = arr.some(r => (r.section||"").trim());
    if(hasSecCol){
      const set = new Set(sectionsNeed.map(s=>String(s)));
      arr = arr.filter(r => set.has(String((r.section||"").trim())));
    }
  }

  return arr;
}

/* Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† */
function updateImprovementPlan(fullScore){
  const n = records.length;
  const subjectChosen = (subjectInput.value||"").trim();

  const weakStudents = records.filter(r => (r.grade/fullScore)*100 < PLAN_THRESHOLD_PERCENT);
  improvBodyEl.innerHTML = "";

  if(!subjectChosen){
    improvBodyEl.innerHTML =
      '<tr><td colspan="5" style="text-align:center;">ØªØ­Ù„ÙŠÙ„ Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯ Ù…Ø§Ø¯Ø©Ø› ØªÙØ³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø·Ø© ÙƒÙ…Ø¤Ø´Ø± Ø¹Ø§Ù….</td></tr>';
    const percentWeak = n ? ((weakStudents.length/n)*100).toFixed(1) : "0.0";
    improvSummaryEl.textContent = `Ø£Ù‚Ù„ Ù…Ù† ${PLAN_THRESHOLD_PERCENT}Ùª: ${weakStudents.length} Ù…Ù† ${n} (${percentWeak}Ùª).`;
    return;
  }

  if(!weakStudents.length){
    improvBodyEl.innerHTML =
      '<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø£Ù‚Ù„ Ù…Ù† Ù¢Ù¥Ùª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</td></tr>';
    improvSummaryEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØªØ³ØªØ¯Ø¹ÙŠ Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ ÙØ±Ø¯ÙŠØ© ÙˆÙÙ‚ Ø¹ØªØ¨Ø© Ù¢Ù¥Ùª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.";
    return;
  }

  const percentWeak = ((weakStudents.length/n)*100).toFixed(1);
  improvSummaryEl.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£Ø´Ø¯ Ø§Ø­ØªÙŠØ§Ø¬Ù‹Ø§ Ù„Ù„Ø¯Ø¹Ù…: ${weakStudents.length} Ù…Ù† ${n} (${percentWeak}Ùª).`;

  weakStudents.sort((a,b)=>a.grade-b.grade).forEach((rec,idx)=>{
    const gap = fullScore - rec.grade;
    const percent = ((rec.grade/fullScore)*100).toFixed(1);
    const services = generateServices(percent, idx);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name-cell">${rec.student}</td>
      <td class="id-cell">${rec.id}</td>
      <td style="text-align:center;">${rec.grade.toFixed(1)} / ${gap.toFixed(1)}</td>
      <td>${services}</td>
      <td class="follow-cell">
        <label>Ù†ÙÙ‘ÙØ° <input type="checkbox"></label>
        <label>Ù„Ù… ÙŠÙÙ†ÙÙ‘ÙØ° <input type="checkbox"></label>
      </td>`;
    improvBodyEl.appendChild(tr);
  });
}

/* ØªØ­Ù„ÙŠÙ„ Ù†ØµÙŠ */
function updateNarrative(fullScore, stats){
  const { n, avg, avgPercent, max, min, cEx, cVG, cW, pEx, pVG, pW } = stats;

  if(!n){
    analysisTagEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯";
    analysisTagEl.className = "analysis-tag";
    analysisTextEl.textContent = "Ù„Ù… ØªÙØ­Ù…Ù‘ÙÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
    analysisBulletsEl.innerHTML = "";
    return;
  }

  let levelLabel="", tagClass="analysis-tag mid";
  if(avgPercent>=90){levelLabel="ØªØ­ØµÙŠÙ„ Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ù‹Ø§.";tagClass="analysis-tag good";}
  else if(avgPercent>=80){levelLabel="ØªØ­ØµÙŠÙ„ Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§.";tagClass="analysis-tag good";}
  else if(avgPercent>=70){levelLabel="ØªØ­ØµÙŠÙ„ Ø¬ÙŠØ¯ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø²ÙŠØ²Ù‹Ø§.";tagClass="analysis-tag mid";}
  else if(avgPercent>=60){levelLabel="ØªØ­ØµÙŠÙ„ Ù…Ù‚Ø¨ÙˆÙ„ ÙŠØ­ØªØ§Ø¬ Ø¯Ø¹Ù…Ù‹Ø§.";tagClass="analysis-tag mid";}
  else{levelLabel="ØªØ­ØµÙŠÙ„ Ø¶Ø¹ÙŠÙ ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ù‹Ø§ Ø¹Ù„Ø§Ø¬ÙŠÙ‹Ø§.";tagClass="analysis-tag weak";}

  analysisTagEl.textContent = avgPercent.toFixed(1) + "%";
  analysisTagEl.className = tagClass;

  const subj = (subjectInput.value||"").trim();
  const secs = parseSectionsInput(sectionInput.value);
  const scope =
    subj && secs.length ? `ÙÙŠ Ù…Ø§Ø¯Ø© ${subj} Ù„Ø´ÙØ¹Ø¨ (${secs.join(", ")})` :
    subj ? `ÙÙŠ Ù…Ø§Ø¯Ø© ${subj}` :
    secs.length ? `Ù„Ù„Ø´ÙØ¹Ø¨ (${secs.join(", ")})` : "Ù„Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©";

  analysisTextEl.textContent = `Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ­ØµÙŠÙ„ ${scope} (${avg.toFixed(1)} Ù…Ù† ${fullScore.toFixed(1)}) ÙŠØ¹ÙƒØ³: ${levelLabel}`;

  analysisBulletsEl.innerHTML = "";
  const bullets = [];
  bullets.push(`Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${n}ØŒ Ø£Ø¹Ù„Ù‰: ${max.toFixed(1)}ØŒ Ø£Ù‚Ù„: ${min.toFixed(1)}ØŒ ÙˆÙ…ØªÙˆØ³Ø· ÙŠØ¹Ø§Ø¯Ù„ ${avgPercent.toFixed(1)}Ùª.`);
  const highCount = cEx + cVG;
  const highPercent = pEx + pVG;
  bullets.push(`ØªÙÙˆÙ‚ (Ù…Ù…ØªØ§Ø² + Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§): ${highCount} (${highPercent.toFixed(1)}Ùª)ØŒ ÙˆØ§Ù„Ø¶Ø¹ÙŠÙ: ${cW} (${pW.toFixed(1)}Ùª).`);
  bullets.push(pW >= 20 ? "ØªÙˆØµÙŠØ©: Ø­ØµØµ Ø¹Ù„Ø§Ø¬ÙŠØ© + Ù…ØªØ§Ø¨Ø¹Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± + Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚ØµÙŠØ±Ø© Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØ­Ø³Ù†." : "ØªÙˆØµÙŠØ©: ØªØ¹Ø²ÙŠØ² Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©.");

  bullets.forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    analysisBulletsEl.appendChild(li);
  });
}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ… */
function updateStatsAndCharts(fullScore){
  const n = records.length;
  if(!n){
    setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø§Øª Ø±Ù‚Ù…ÙŠØ© ÙƒØ§ÙÙŠØ© Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±.");
    updateNarrative(fullScore,{n:0});
    return;
  }

  const grades = records.map(r=>r.grade);
  const max = Math.max(...grades);
  const min = Math.min(...grades);
  const sum = grades.reduce((a,b)=>a+b,0);
  const avg = sum/n;
  const avgPercent = (avg/fullScore)*100;

  statStudentsEl.textContent = n;
  statMaxEl.textContent      = max.toFixed(1);
  statMinEl.textContent      = min.toFixed(1);
  statAvgEl.textContent      = avg.toFixed(2);
  statSuccessEl.textContent  = avgPercent.toFixed(1) + "%";
  statSumEl.textContent      = sum.toFixed(1);

  let cEx=0,cVG=0,cG=0,cAc=0,cW=0;
  records.forEach(r=>{
    const p = (r.grade/fullScore)*100;
    if(p>=90) cEx++;
    else if(p>=80) cVG++;
    else if(p>=70) cG++;
    else if(p>=60) cAc++;
    else cW++;
  });

  countExcellentEl.textContent  = cEx;
  countVGoodEl.textContent      = cVG;
  countGoodEl.textContent       = cG;
  countAcceptableEl.textContent = cAc;
  countWeakEl.textContent       = cW;

  const pEx = n?(cEx/n*100):0;
  const pVG = n?(cVG/n*100):0;
  const pG  = n?(cG/n*100):0;
  const pAc = n?(cAc/n*100):0;
  const pW  = n?(cW/n*100):0;

  percExcellentEl.textContent  = `${pEx.toFixed(1)}% (${cEx})`;
  percVGoodEl.textContent      = `${pVG.toFixed(1)}% (${cVG})`;
  percGoodEl.textContent       = `${pG.toFixed(1)}% (${cG})`;
  percAcceptableEl.textContent = `${pAc.toFixed(1)}% (${cAc})`;
  percWeakEl.textContent       = `${pW.toFixed(1)}% (${cW})`;

  updateDonut("donutExcellent",  pEx);
  updateDonut("donutVGood",      pVG);
  updateDonut("donutGood",       pG);
  updateDonut("donutAcceptable", pAc);
  updateDonut("donutWeak",       pW);

  if(barChart){
    barChart.data.datasets[0].data = [cW,cAc,cG,cVG,cEx];
    barChart.update();
  }

  if(scaleMode.value==="auto" && levelBoundaries && levelBoundaries.length>=5){
    const uniq = [...new Set(levelBoundaries)].sort((a,b)=>a-b);
    const [b0,b1,b2,b3,b4] = uniq.slice(0,5);
    rangeWeakEl.textContent       = `${b0}-${b1-1}`;
    rangeAcceptableEl.textContent = `${b1}-${b2-1}`;
    rangeGoodEl.textContent       = `${b2}-${b3-1}`;
    rangeVGoodEl.textContent      = `${b3}-${b4-1}`;
    rangeExcellentEl.textContent  = `${b4}-${fullScore}`;
  }else{
    const exMin = Math.round(fullScore*0.90);
    const vgMin = Math.round(fullScore*0.80);
    const gMin  = Math.round(fullScore*0.70);
    const acMin = Math.round(fullScore*0.60);
    rangeExcellentEl.textContent  = `${exMin}-${fullScore}`;
    rangeVGoodEl.textContent      = `${vgMin}-${exMin-1}`;
    rangeGoodEl.textContent       = `${gMin}-${vgMin-1}`;
    rangeAcceptableEl.textContent = `${acMin}-${gMin-1}`;
    rangeWeakEl.textContent       = `0-${acMin-1}`;
  }

  updateImprovementPlan(fullScore);
  updateNarrative(fullScore,{ n, avg, avgPercent, max, min, cEx, cVG, cW, pEx, pVG, pW });
}

/* Ù‚Ø±Ø§Ø¡Ø© Ø¥ÙƒØ³Ù„ */
function parseExcelFile(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:null,raw:true});
        resolve(rows);
      }catch(err){reject(err);}
    };
    reader.onerror=reject;
    reader.readAsArrayBuffer(file);
  });
}

/* ØªÙØ§Ø¹Ù„ */
toolsBtn.addEventListener("click",()=>{
  syncInputsFromHeader();
  syncPrincipalToInput();
  lensOverlay.classList.add("open");
});
lensClose.addEventListener("click",()=>lensOverlay.classList.remove("open"));
printBtn.addEventListener("click",()=>printWithSmartTitle());
excelInput.addEventListener("change",e=>{ selectedFile = e.target.files[0] || null; });

/* ØªØ­Ù„ÙŠÙ„ */
analyzeBtn.addEventListener("click", async ()=>{
  if(!selectedFile){
    setStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø£ÙˆÙ„Ù‹Ø§.");
    excelInput.classList.add("missing");
    return;
  }
  excelInput.classList.remove("missing");

  syncHeaderFromInputs();
  syncPrincipalFromInput();

  let ok = true;
  [stageInput, termInput].forEach(inp=>{
    if(!inp.value.trim()){inp.classList.add("missing"); ok=false;}
    else inp.classList.remove("missing");
  });
  if(!ok){
    setStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªÙƒÙ…Ø§Ù„: Ø§Ù„ØµÙ + Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù….");
    return;
  }

  try{
    setStatus("Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡...");
    const rows = await parseExcelFile(selectedFile);

    levelBoundaries = extractBoundariesFromRows(rows);

    const raw = buildRecordsFromSheet(rows);
    const filtered = applyFilters(raw);

    if(!filtered.length){
      setStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.");
      records = [];
      updateStatsAndCharts(100);
      return;
    }

    records = filtered;

    const grades = records.map(r=>r.grade);
    const maxGrade = Math.max(...grades);

    const candidates = [20,30,40,50,60,100];
    let fullScore = maxGrade, bestDiff = Infinity;
    for(const c of candidates){
      if(c>=maxGrade && Math.abs(c-maxGrade)<=5){
        const diff = Math.abs(c-maxGrade);
        if(diff<bestDiff){bestDiff=diff; fullScore=c;}
      }
    }
    if(scaleMode.value==="period60") fullScore=60;
    else if(scaleMode.value==="final100") fullScore=100;

    maxScoreFieldEl.textContent = fullScore.toFixed(1);

    const subject = (subjectInput.value||"").trim();
    const stage   = stageInput.value.trim();
    const secTxt  = sectionInput.value.trim();
    const period  = periodInput.value.trim();
    const term    = termInput.value.trim();
    const teacher = teacherInput.value.trim();

    hasSubjectSpecific = !!subject;

    stageFieldEl.textContent = stage + (secTxt ? ` / Ø´Ø¹Ø¨Ø© ${secTxt}` : "");
    termFieldEl.textContent  = (period ? period+" â€“ " : "") + term;

    titleSubjectEl.textContent   = subject || "[ØªØ­Ù„ÙŠÙ„ Ù…Ø±Ø­Ù„Ø© ÙƒØ§Ù…Ù„Ø©]";
    headerSubjectEl.textContent  = subject || "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ / Ù…Ø±Ø­Ù„Ø©";
    headerTeacherEl.textContent  = teacher || (hasSubjectSpecific ? "â€”" : "Ù…Ù†Ø³Ù‚ Ø§Ù„Ù…Ø±Ø­Ù„Ø©");
    footerTeacherEl.textContent  = teacher || "â€”";

    lensOverlay.classList.remove("open");
    setStatus("ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");

    updateStatsAndCharts(fullScore);
  }catch(err){
    console.error(err);
    setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
  }
});

document.addEventListener("DOMContentLoaded", setupCharts);

window.addEventListener("afterprint", ()=>{
  Object.values(donutCharts).forEach(ch=>ch && ch.resize());
  if(barChart) barChart.resize();
});
</script>

</body>
</html>
