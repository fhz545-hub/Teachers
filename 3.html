<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --moe:#0b7e88;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;

  --good:#22c55e;   /* Ù…Ù…ØªØ§Ø² */
  --vgood:#10b981;  /* Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ */
  --good2:#3b82f6;  /* Ø¬ÙŠØ¯ */
  --acc:#f59e0b;    /* Ù…Ù‚Ø¨ÙˆÙ„ */
  --weak:#ef4444;   /* Ø¶Ø¹ÙŠÙ */

  --hdrH:34mm;
  --pageW:210mm;
  --pageH:297mm;

  --cardR:18px;

  /* âœ… Ø§Ù„Ø¯ÙˆÙ†Ø§Øª Ø£ØµØºØ± ÙˆÙ…ØªÙ†Ø§Ø³Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø´Ø§Ø´Ø© */
  --donut:clamp(76px, 10vw, 96px);
  --donutPrint:70px;

  /* âœ… Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (Ø£ÙˆØ¶Ø­ + Ø¨Ø¯ÙˆÙ† Ø§Ø¬ØªØ²Ø§Ø¡) */
  --barH:132px;
  --barHPrint:120px;

  --printScale:0.975;
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;}
body{
  font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--ink);
}

/* Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„ÙƒØ§Ù…Ù„ */
.sheet{
  width:var(--pageW);
  max-width:100%;
  margin:0 auto 14px;
  background:#fff;
  position:relative;
  overflow:visible;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header{
  position:relative;
  width:100%;
  height:var(--hdrH);
  overflow:hidden;
}
.header img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:block;
  object-fit:contain;
  object-position:center;
}
.header .txt{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  gap:2px;
  padding:0 12mm;
  z-index:3;
}
.header .txt .edu,
.header .txt .school{
  outline:none;border:none;
  color:#fff;
  font-weight:900;
  line-height:1.35;
  text-shadow:0 3px 10px rgba(0,0,0,.36);
}
.header .txt .edu{font-size:15px;}
.header .txt .school{font-size:14px;opacity:.98}

/* Ø²Ø± Ø§Ù„Ø¹Ø¯Ø³Ø© */
.header-tools{
  position:absolute;
  left:10mm;
  top:calc(var(--hdrH) - 18mm);
  z-index:5;
}
.tools-pill{
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.72);
  background:linear-gradient(135deg,#0b7e88,#0b5f88);
  color:#fff;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 4px 14px rgba(15,23,42,.30);
  white-space:nowrap;
}
.tools-pill span.icon{font-size:15px;}
.tools-pill:hover{background:linear-gradient(135deg,#065f64,#064f7a);}

/* Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© */
.page{
  width:100%;
  min-height:calc(var(--pageH) - var(--hdrH));
  position:relative;
  padding:8mm 0 6mm;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
.content{
  width:186mm;
  max-width:94%;
  margin:0 auto;
  overflow:visible;
}

/* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.card{
  width:100%;
  background:rgba(255,255,255,.98);
  border-radius:var(--cardR);
  box-shadow:0 10px 26px rgba(15,23,42,.18);
  padding:10px 12px 10px;
}

/* Ø´Ø±ÙŠØ· Ø±Ø³Ø§Ù„Ø© */
.top-strip{
  margin-bottom:6px;
  font-size:10.5px;
  color:var(--muted);
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø¯Ø³Ø© */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.16);
  display:none;
  align-items:flex-start;
  justify-content:center;
  z-index:100;
  padding:10px;
}
.overlay.open{display:flex;}
.panel{
  margin-top:12mm;
  width:min(980px,94vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(15,23,42,.18);
  border:1px solid #e1f3f1;
  padding:12px 16px;
  font-size:11px;
}
.panel-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.panel-title{font-weight:900;color:var(--moe);font-size:13px;}
.panel-close{border:none;background:transparent;font-size:18px;cursor:pointer;}

.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px 12px;
}
.field{display:flex;flex-direction:column;gap:4px;}
.field label{font-size:10px;color:var(--muted);}
.field input[type="text"], .field select{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:7px 10px;
  font-size:11px;
  font-family:inherit;
  background:#f9fafb;
}
.field input[type="file"]{font-size:11px;}
.missing{border-color:#ef4444 !important;background:#fef2f2 !important;}

.actions{
  margin-top:10px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.btn{
  border-radius:12px;
  border:1px solid var(--moe);
  background:var(--moe);
  color:#fff;
  padding:9px 18px;
  font-size:11px;
  cursor:pointer;
  font-family:inherit;
  min-width:170px;
  text-align:center;
  white-space:nowrap;
  box-shadow:0 3px 10px rgba(15,23,42,.25);
}
.btn:hover{background:#065f64;}
.btn.secondary{
  background:#fff;
  color:var(--moe);
}
.btn.secondary:hover{background:#f0fdfa;}

.hint{
  margin-top:10px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  border-radius:12px;
  border:1px solid #fecaca;
  background:#fef2f2;
  padding:8px 10px;
}
.hint .ic{font-size:18px;color:#b91c1c;margin-top:1px;}
.hint .tx{font-size:10px;color:#7f1d1d;line-height:1.7;}
.hint .tx strong{font-weight:900;color:#b91c1c;}

.credit{
  margin-top:10px;
  padding-top:8px;
  border-top:1px dashed #e5e7eb;
  font-size:10px;
  color:#475569;
  text-align:center;
  font-weight:800;
}

/* Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
.report-header{border-top:1px solid var(--line);padding-top:6px;}
.title-wrap{display:flex;justify-content:center;margin-bottom:6px;}
.title{
  border:1px solid var(--moe);
  border-radius:26px;
  padding:6px 22px;
  font-size:13px;
  font-weight:900;
  background:#fff;
}
.title span{color:var(--moe);font-weight:900;}

.header-row{
  margin-top:6px;
  padding:8px 12px;
  border-radius:999px;
  background:#f6f7f8;
  font-size:11px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  min-width:0;
}
.header-main{
  flex:1;min-width:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.header-main strong{color:var(--moe);}
.header-max{white-space:nowrap;}

/* Ø§Ù„ÙˆØ³Ø· */
.mid{
  margin-top:10px;
  border-top:1px solid var(--line);
  padding-top:10px;
  display:grid;
  grid-template-columns:2.1fr 1.3fr;
  gap:10px;
}

/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© */
.details-title{font-size:12px;font-weight:900;color:var(--moe);margin:0 0 6px;}
.table{
  border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
  overflow:hidden;
}
.thead{
  display:grid;
  grid-template-columns:2.4fr 1.1fr 0.9fr;
  gap:6px;
  padding:8px 10px;
  font-weight:900;
  font-size:10.5px;
  background:#f3f4f6;
  border-bottom:1px solid var(--line);
}
.thead div:nth-child(2), .thead div:nth-child(3){text-align:center;}
.trow{
  display:grid;
  grid-template-columns:2.4fr 1.1fr 0.9fr;
  gap:6px;
  padding:7px 10px;
  align-items:center;
  border-bottom:1px solid #f1f5f9;
}
.trow:last-child{border-bottom:none;}
.trow:nth-child(even){background:#fbfbfb;}
.trow .c2,.trow .c3{text-align:center;}

.badge{
  display:flex;
  align-items:center;
  width:100%;
  padding:7px 12px;
  min-height:28px;
  border-radius:999px;
  color:#fff;
  font-size:11.5px;
  font-weight:900;
  box-shadow:0 1px 4px rgba(15,23,42,.15);
}
.ex{background:var(--good);}
.vg{background:var(--vgood);}
.gd{background:var(--good2);}
.ac{background:var(--acc);}
.wk{background:var(--weak);}

/* Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª */
.stats{
  border-radius:14px;
  border:1px solid var(--line);
  padding:10px 12px;
  background:#fff;
}
.stat{
  border-radius:12px;
  border:1px solid #eef2f7;
  padding:8px 10px;
  background:#fafafa;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
.stat:last-child{margin-bottom:0;}
.stat .lab{color:var(--moe);font-size:10.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.stat .val{font-size:15px;font-weight:900;white-space:nowrap;}

/* Ø§Ù„Ø±Ø³ÙˆÙ… */
.charts{
  margin-top:10px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:10px 12px;
  background:#fff;
}
.ch-title{
  font-size:12px;
  font-weight:900;
  color:var(--moe);
  text-align:center;
  margin-bottom:8px;
}

/* âœ… ØµÙÙ‘Ø§Ù†: (Ù…Ù…ØªØ§Ø²/Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§/Ø¬ÙŠØ¯) Ø«Ù… (Ù…Ù‚Ø¨ÙˆÙ„/Ø¶Ø¹ÙŠÙ) */
.dgrid{
  display:grid;
  gap:10px;
  grid-template-columns:repeat(6,1fr);
  grid-template-areas:
    "ex ex vg vg gd gd"
    "ac ac ac wk wk wk";
}
.dcard{
  border-radius:14px;
  border:1px solid #eef2f7;
  padding:10px 6px 10px;
  text-align:center;
  background:#fafafa;
}
.dwrap{
  width:var(--donut);
  height:var(--donut);
  margin:0 auto;
  display:grid;
  place-items:center;
}
.donut{
  width:100% !important;
  height:100% !important;
  display:block;
}
.dlab{font-size:10px;color:#4b5563;font-weight:900;margin-top:4px;}
.dval{font-size:10px;font-weight:900;color:#111827;}

.dcard[data-area="ex"]{grid-area:ex;}
.dcard[data-area="vg"]{grid-area:vg;}
.dcard[data-area="gd"]{grid-area:gd;}
.dcard[data-area="ac"]{grid-area:ac;}
.dcard[data-area="wk"]{grid-area:wk;}

/* âœ… Ø¨Ø§Ø± Ø£ÙˆØ¶Ø­ + Ø£Ø¹Ù…Ø¯Ø© Ø£Ø¹Ø±Ø¶ */
.bar{
  margin-top:10px;
  border-radius:14px;
  border:1px solid #eef2f7;
  padding:10px;
}
.bar canvas{width:100%;height:var(--barH);}

/* ØµÙØ­Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ */
.weak-card .wkHead{
  display:flex;justify-content:space-between;align-items:center;gap:10px;
  margin-top:8px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#f6f7f8;
  font-size:11px;
}
.pill{
  padding:4px 10px;border-radius:999px;
  border:1px solid rgba(15,23,42,.12);
  background:#fff;
  font-weight:900;
  white-space:nowrap;
}
.pill.red{border-color:#fecaca;background:#fee2e2;color:#991b1b;}
.pill.mo{border-color:#a5f3fc;background:#ecfeff;color:#0e7490;}
.smallMuted{color:var(--muted);font-size:10px;font-weight:800}

/* âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ Ù…Ø¶ØºÙˆØ· ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
.tbl{
  width:100%;
  border-collapse:collapse;
  font-size:9.6px;
  margin-top:10px;
}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px 6px;vertical-align:top;}
.tbl th{background:#f3f4f6;white-space:nowrap;}
.tbl td.name,.tbl td.id{white-space:nowrap;}
.follow{text-align:center;white-space:nowrap;}
.follow label{display:inline-flex;align-items:center;gap:3px;margin-inline:2px;font-size:8.8px;}
.follow input{width:11px;height:11px;}

.footer{
  margin-top:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:11px;
  color:#4b5563;
  gap:10px;
}
.footer p{margin:0;white-space:nowrap;}
.footer strong{color:#111827;}

.hidden{display:none !important;}

/* Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„ØªØ§Ø¨Ù„Øª */
@media (max-width:900px){
  .sheet{width:100%;}
  .header{height:94px;}
  .page{min-height:calc(100vh - 94px);padding:10px 0 12px;}
  .content{width:min(980px,96%);max-width:96%;}
  .grid{grid-template-columns:1fr;}
  .header-tools{top:12px;left:12px;}
  .mid{grid-template-columns:1fr;}
  .dgrid{
    grid-template-columns:repeat(2,1fr);
    grid-template-areas:
      "ex vg"
      "gd ac"
      "wk wk";
  }
  .dwrap{width:92px;height:92px;}
}

/* âœ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ØµÙØ­ØªØ§Ù† (ØªØ­Ù„ÙŠÙ„ + Ø¶Ø¹ÙØ§Ø¡) Ø¨Ø¯ÙˆÙ† Ø§Ø¬ØªØ²Ø§Ø¡ */
@media print{
  @page{size:A4 portrait;margin:0;}
  html,body{height:auto;background:#fff;}
  body{margin:0;padding:0;}
  .overlay{display:none !important;}
  .header-tools{display:none !important;}

  .sheet{
    width:var(--pageW) !important;
    height:var(--pageH) !important;
    margin:0 !important;
    overflow:hidden !important;
    transform:scale(var(--printScale));
    transform-origin:top center;
    page-break-after:always;
  }
  .sheet:last-child{page-break-after:auto;}

  .page{
    min-height:calc(var(--pageH) - var(--hdrH)) !important;
    padding:6mm 0 5mm !important;
  }

  .content{overflow:hidden !important;}

  .card{
    box-shadow:none !important;
    border-radius:0 !important;
    padding:9px 10px !important;
  }

  /* âœ… ØªØ«Ø¨ÙŠØª Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¯ÙˆÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
  .dwrap{width:var(--donutPrint) !important;height:var(--donutPrint) !important;}
  .bar canvas{height:var(--barHPrint) !important;}

  .trow:nth-child(even){background:#fff !important;}

  .card,.report-header,.mid,.charts,.footer,.wkHead,.tbl{
    break-inside:avoid !important;
    page-break-inside:avoid !important;
  }
}
</style>
</head>

<body>

<!-- =========================
     Ø§Ù„ØµÙØ­Ø© 1: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
     ========================= -->
<div class="sheet" id="sheet1">
  <header class="header">
    <img src="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ .png" alt="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„" />
    <div class="txt">
      <div id="eduName" class="edu" contenteditable="true">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
      <div id="schoolName" class="school" contenteditable="true">Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</div>
    </div>
    <div class="header-tools">
      <button type="button" class="tools-pill" id="toolsBtn">
        <span class="icon">ğŸ”</span>
        <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDF</span>
      </button>
    </div>
  </header>

  <div class="page">
    <div class="content">
      <section class="card">

        <div class="top-strip">
          <span id="statusMessage">Ø§Ø¶ØºØ· Ø²Ø± Â«Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ / Ø·Ø¨Ø§Ø¹Ø© PDFÂ» Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</span>
        </div>

        <!-- Ø§Ù„Ø¹Ø¯Ø³Ø© -->
        <div class="overlay" id="overlay">
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
              <button type="button" class="panel-close" id="closeOverlay">âœ•</button>
            </div>

            <div class="grid">
              <div class="field">
                <label for="excelFile">ğŸ“‚ Ù…Ù„Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Excel)</label>
                <input id="excelFile" type="file" accept=".xlsx,.xls" />
              </div>

              <div class="field">
                <label for="subjectInput">Ø§Ù„Ù…Ø§Ø¯Ø© (Ù†Øµ Ø«Ø§Ø¨Øª Ù„Ù„ØªÙ‚Ø±ÙŠØ±)</label>
                <input id="subjectInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
              </div>

              <div class="field">
                <label for="stageInput">Ø§Ù„ØµÙ (Ù†Øµ Ø«Ø§Ø¨Øª Ù„Ù„ØªÙ‚Ø±ÙŠØ±)</label>
                <input id="stageInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ" />
              </div>

              <div class="field">
                <label for="sectionInput">ØªØ­Ø¯ÙŠØ¯ Ø´ÙØ¹Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="sectionInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 1 Ø£Ùˆ 1,2,3 (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´ÙŠØªØ§Øª)" />
              </div>

              <div class="field">
                <label for="periodInput">Ø§Ù„ÙØªØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="periodInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰" />
              </div>

              <div class="field">
                <label for="termInput">Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¹Ø§Ù…</label>
                <input id="termInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø§ÙˆÙ„ Ù¡Ù¤Ù¤Ù§Ù‡Ù€" />
              </div>

              <div class="field">
                <label for="teacherInput">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                <input id="teacherInput" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ" />
              </div>

              <div class="field">
                <label for="scaleMode">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                <select id="scaleMode">
                  <option value="auto">Ø¢Ù„ÙŠ (Ø°ÙƒÙŠ)</option>
                  <option value="period40">Ø§Ø®ØªØ¨Ø§Ø± (0â€“40)</option>
                  <option value="period60">Ø§Ø®ØªØ¨Ø§Ø± (0â€“60)</option>
                  <option value="final100">Ø§Ø®ØªØ¨Ø§Ø± (0â€“100)</option>
                </select>
              </div>

              <div class="field">
                <label for="eduInputField">Ù†Øµ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
                <input id="eduInputField" type="text" placeholder="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©" />
              </div>

              <div class="field">
                <label for="schoolInputField">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
                <input id="schoolInputField" type="text" placeholder="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±" />
              </div>

              <div class="field">
                <label for="principalInput">Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                <input id="principalInput" type="text" value="ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ" />
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn" id="analyzeBtn">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
              <button type="button" class="btn" id="printBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
              <button type="button" class="btn secondary" id="openWeakBtn">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡</button>
            </div>

            <div class="hint">
              <div class="ic">âš ï¸</div>
              <div class="tx">
                <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† Â«Ù†ÙˆØ±Â»:</strong><br/>
                Ù†Ø¸Ø§Ù… Ù†ÙˆØ± â†’ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± â†’ ØªÙ‚Ø§Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª â†’ ÙƒØ´Ù Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ø§Ø¯Ø© â†’ Â«ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ ExcelÂ».
              </div>
            </div>

            <div class="credit">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø© ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
          </div>
        </div>

        <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
        <div class="report-header">
          <div class="title-wrap">
            <div class="title">ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø© <span id="titleSubject">[Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©]</span></div>
          </div>

          <div class="header-row">
            <div class="header-main" id="headerMainText">
              Ø§Ù„ØµÙ: <strong id="stageField">â€”</strong>
              Â· Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="subjectField">â€”</strong>
              Â· Ø§Ù„ÙØµÙ„/Ø§Ù„ÙØªØ±Ø©: <strong id="termField">â€”</strong>
              Â· Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="teacherField">â€”</strong>
            </div>
            <div class="header-max">
              Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©: <strong id="maxScoreField">â€”</strong>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="mid">
          <div>
            <div class="details-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
            <div class="table">
              <div class="thead">
                <div>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div><div>Ø§Ù„Ù†Ø·Ø§Ù‚</div><div>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
              </div>

              <div class="trow">
                <div><span class="badge ex">Ù…Ù…ØªØ§Ø²</span></div>
                <div class="c2" id="rangeExcellent">â€”</div>
                <div class="c3" id="countExcellent">0</div>
              </div>
              <div class="trow">
                <div><span class="badge vg">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</span></div>
                <div class="c2" id="rangeVGood">â€”</div>
                <div class="c3" id="countVGood">0</div>
              </div>
              <div class="trow">
                <div><span class="badge gd">Ø¬ÙŠØ¯</span></div>
                <div class="c2" id="rangeGood">â€”</div>
                <div class="c3" id="countGood">0</div>
              </div>
              <div class="trow">
                <div><span class="badge ac">Ù…Ù‚Ø¨ÙˆÙ„</span></div>
                <div class="c2" id="rangeAcceptable">â€”</div>
                <div class="c3" id="countAcceptable">0</div>
              </div>
              <div class="trow">
                <div><span class="badge wk">Ø¶Ø¹ÙŠÙ</span></div>
                <div class="c2" id="rangeWeak">â€”</div>
                <div class="c3" id="countWeak">0</div>
              </div>
            </div>
          </div>

          <div class="stats">
            <div class="stat"><span class="lab">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨/Ø§Ù„Ø­Ø§Ù„Ø§Øª</span><span class="val" id="statN">0</span></div>
            <div class="stat"><span class="lab">Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</span><span class="val" id="statMax">0</span></div>
            <div class="stat"><span class="lab">Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©</span><span class="val" id="statMin">0</span></div>
            <div class="stat"><span class="lab">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="val" id="statAvg">0</span></div>
            <div class="stat"><span class="lab">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</span><span class="val" id="statPct">0%</span></div>
            <div class="stat"><span class="lab">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="val" id="statSum">0</span></div>
          </div>
        </div>

        <!-- Ø§Ù„Ø±Ø³ÙˆÙ… -->
        <div class="charts">
          <div class="ch-title">Ù†ÙØ³ÙØ¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±</div>

          <div class="dgrid">
            <div class="dcard" data-area="ex">
              <div class="dwrap"><canvas id="dEx" class="donut"></canvas></div>
              <div class="dlab">Ù…Ù…ØªØ§Ø²</div>
              <div class="dval" id="pEx">0% (0)</div>
            </div>

            <div class="dcard" data-area="vg">
              <div class="dwrap"><canvas id="dVGood" class="donut"></canvas></div>
              <div class="dlab">Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</div>
              <div class="dval" id="pVGood">0% (0)</div>
            </div>

            <div class="dcard" data-area="gd">
              <div class="dwrap"><canvas id="dGood" class="donut"></canvas></div>
              <div class="dlab">Ø¬ÙŠØ¯</div>
              <div class="dval" id="pGood">0% (0)</div>
            </div>

            <div class="dcard" data-area="ac">
              <div class="dwrap"><canvas id="dAcc" class="donut"></canvas></div>
              <div class="dlab">Ù…Ù‚Ø¨ÙˆÙ„</div>
              <div class="dval" id="pAcc">0% (0)</div>
            </div>

            <div class="dcard" data-area="wk">
              <div class="dwrap"><canvas id="dWeak" class="donut"></canvas></div>
              <div class="dlab">Ø¶Ø¹ÙŠÙ</div>
              <div class="dval" id="pWeak">0% (0)</div>
            </div>
          </div>

          <div class="ch-title" style="margin-top:10px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙ‚Ø¯ÙŠØ±</div>
          <div class="bar">
            <canvas id="barLevels"></canvas>
          </div>
        </div>

        <div class="footer">
          <p>Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / <strong id="ftTeacher">â€”</strong></p>
          <p>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / <strong id="ftPrincipal" contenteditable="true">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</strong></p>
        </div>

      </section>
    </div>
  </div>
</div>

<!-- =========================
     Ø§Ù„ØµÙØ­Ø© 2: Ø®Ø·Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø¶Ø¹ÙØ§Ø¡ (ØªØªÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¶Ø¹ÙØ§Ø¡)
     ========================= -->
<div class="sheet hidden" id="sheet2">
  <header class="header">
    <img src="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ .png" alt="Ù‡ÙŠØ¯Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„" />
    <div class="txt">
      <div id="eduName2" class="edu">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
      <div id="schoolName2" class="school">Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</div>
    </div>
  </header>

  <div class="page">
    <div class="content">
      <section class="card weak-card">

        <div class="report-header">
          <div class="title-wrap">
            <div class="title">
              Ø®Ø·Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø¶Ø¹ÙØ§Ø¡ Ù…Ø§Ø¯Ø© <span id="weakTitleSubject">[Ø§Ù„Ù…Ø§Ø¯Ø©]</span> â€” <span id="weakTitleStage">[Ø§Ù„ØµÙ]</span>
            </div>
          </div>

          <div class="header-row">
            <div class="header-main" id="headerMainText2">
              Ø§Ù„ØµÙ: <strong id="stageField2">â€”</strong>
              Â· Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="subjectField2">â€”</strong>
              Â· Ø§Ù„ÙØµÙ„/Ø§Ù„ÙØªØ±Ø©: <strong id="termField2">â€”</strong>
              Â· Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©: <strong id="teacherField2">â€”</strong>
            </div>
            <div class="header-max">
              Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©: <strong id="maxScoreField2">â€”</strong>
            </div>
          </div>
        </div>

        <div class="wkHead">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="pill mo" id="weakRulePill">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: â€”</span>
            <span class="pill red" id="weakCountPill">Ø¹Ø¯Ø¯ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: 0</span>
          </div>
          <div class="smallMuted" id="weakHint">
            ØªÙÙˆÙ„Ù‘ÙØ¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ ÙˆÙƒÙ„ ØµÙ ÙŠÙ…Ø«Ù„ Ø´Ø¹Ø¨Ø© (Sheet) â€” Ù…Ø¹ Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© ÙˆÙ…Ø¤Ø´Ø±Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø©.
          </div>
        </div>

        <table class="tbl" id="weakTbl">
          <thead>
            <tr>
              <th style="width:20%">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
              <th style="width:13%">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
              <th style="width:9%">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
              <th style="width:9%">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
              <th style="width:9%">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
              <th style="width:9%">Ø§Ù„ÙØ¬ÙˆØ©</th>
              <th style="width:22%">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
              <th style="width:9%">Ù…ØªØ§Ø¨Ø¹Ø©</th>
            </tr>
          </thead>
          <tbody id="weakBody">
            <tr><td colspan="8" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
          </tbody>
        </table>

        <div class="footer">
          <p>Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / <strong id="ftTeacher2">â€”</strong></p>
          <p>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / <strong id="ftPrincipal2">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</strong></p>
        </div>

      </section>
    </div>
  </div>
</div>

<script>
/* =========================
   Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
   ========================= */
const normalizeDigits = (str)=>{
  if(str == null) return "";
  str = String(str);
  const map = {'Ù ':0,'Ù¡':1,'Ù¢':2,'Ù£':3,'Ù¤':4,'Ù¥':5,'Ù¦':6,'Ù§':7,'Ù¨':8,'Ù©':9};
  return str.replace(/[Ù -Ù©]/g,d=>map[d]).replace(/,/g,".");
};
const clean = (s)=> (s||"").toString().replace(/\s+/g," ").trim();

const isNumeric = (val)=>{
  if(val === null || val === undefined) return false;
  if(typeof val === "number") return !isNaN(val);
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return !isNaN(n);
};
const toNumber = (val)=>{
  if(typeof val === "number") return val;
  const n = Number(normalizeDigits(val).replace(/[^\d.-]/g,""));
  return isNaN(n) ? NaN : n;
};
const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));

/* =========================
   DOM
   ========================= */
const toolsBtn = document.getElementById("toolsBtn");
const overlay = document.getElementById("overlay");
const closeOverlay = document.getElementById("closeOverlay");

const excelFile = document.getElementById("excelFile");
const subjectInput = document.getElementById("subjectInput");
const stageInput = document.getElementById("stageInput");
const sectionInput = document.getElementById("sectionInput");
const periodInput = document.getElementById("periodInput");
const termInput = document.getElementById("termInput");
const teacherInput = document.getElementById("teacherInput");
const scaleMode = document.getElementById("scaleMode");

const eduName = document.getElementById("eduName");
const schoolName = document.getElementById("schoolName");
const eduInputField = document.getElementById("eduInputField");
const schoolInputField = document.getElementById("schoolInputField");

const eduName2 = document.getElementById("eduName2");
const schoolName2 = document.getElementById("schoolName2");

const principalInput = document.getElementById("principalInput");
const ftPrincipal = document.getElementById("ftPrincipal");
const ftPrincipal2 = document.getElementById("ftPrincipal2");

const analyzeBtn = document.getElementById("analyzeBtn");
const printBtn = document.getElementById("printBtn");
const statusMessage = document.getElementById("statusMessage");

const titleSubject = document.getElementById("titleSubject");
const stageField = document.getElementById("stageField");
const subjectField = document.getElementById("subjectField");
const termField = document.getElementById("termField");
const teacherField = document.getElementById("teacherField");
const maxScoreField = document.getElementById("maxScoreField");

const rangeExcellent = document.getElementById("rangeExcellent");
const rangeVGood = document.getElementById("rangeVGood");
const rangeGood = document.getElementById("rangeGood");
const rangeAcceptable = document.getElementById("rangeAcceptable");
const rangeWeak = document.getElementById("rangeWeak");

const countExcellent = document.getElementById("countExcellent");
const countVGood = document.getElementById("countVGood");
const countGood = document.getElementById("countGood");
const countAcceptable = document.getElementById("countAcceptable");
const countWeak = document.getElementById("countWeak");

const statN = document.getElementById("statN");
const statMax = document.getElementById("statMax");
const statMin = document.getElementById("statMin");
const statAvg = document.getElementById("statAvg");
const statPct = document.getElementById("statPct");
const statSum = document.getElementById("statSum");

const pWeak = document.getElementById("pWeak");
const pAcc  = document.getElementById("pAcc");
const pGood = document.getElementById("pGood");
const pVGood= document.getElementById("pVGood");
const pEx   = document.getElementById("pEx");

const ftTeacher = document.getElementById("ftTeacher");
const ftTeacher2 = document.getElementById("ftTeacher2");

/* ØµÙØ­Ø© 2 */
const sheet2 = document.getElementById("sheet2");
const weakTitleSubject = document.getElementById("weakTitleSubject");
const weakTitleStage = document.getElementById("weakTitleStage");
const stageField2 = document.getElementById("stageField2");
const subjectField2 = document.getElementById("subjectField2");
const termField2 = document.getElementById("termField2");
const teacherField2 = document.getElementById("teacherField2");
const maxScoreField2 = document.getElementById("maxScoreField2");
const weakRulePill = document.getElementById("weakRulePill");
const weakCountPill = document.getElementById("weakCountPill");
const weakBody = document.getElementById("weakBody");
const openWeakBtn = document.getElementById("openWeakBtn");

/* =========================
   Ø­Ø§Ù„Ø©
   ========================= */
let selectedFile = null;
let records = [];
let donuts = {};
let bar = null;

function setStatus(t){ statusMessage.textContent = t; }

/* =========================
   Ø±Ø¨Ø· Ø§Ù„Ù‡ÙŠØ¯Ø±/Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª
   ========================= */
function syncInputsFromHeader(){
  eduInputField.value = clean(eduName.textContent);
  schoolInputField.value = clean(schoolName.textContent);
}
function syncHeaderFromInputs(){
  if(clean(eduInputField.value)) eduName.textContent = clean(eduInputField.value);
  if(clean(schoolInputField.value)) schoolName.textContent = clean(schoolInputField.value);

  eduName2.textContent = clean(eduName.textContent) || "â€”";
  schoolName2.textContent = clean(schoolName.textContent) || "â€”";
}
eduName.addEventListener("input", syncInputsFromHeader);
schoolName.addEventListener("input", syncInputsFromHeader);
eduInputField.addEventListener("input", syncHeaderFromInputs);
schoolInputField.addEventListener("input", syncHeaderFromInputs);
syncInputsFromHeader();
syncHeaderFromInputs();

/* Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± */
function syncPrincipalFromInput(){
  const v = clean(principalInput.value) || "ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ";
  ftPrincipal.textContent = v;
  ftPrincipal2.textContent = v;
}
function syncPrincipalToInput(){
  principalInput.value = clean(ftPrincipal.textContent) || "ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ";
  ftPrincipal2.textContent = clean(ftPrincipal.textContent) || "ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ";
}
principalInput.addEventListener("input", syncPrincipalFromInput);
ftPrincipal.addEventListener("input", syncPrincipalToInput);
syncPrincipalToInput();

/* =========================
   Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø¯Ø³Ø©
   ========================= */
toolsBtn.addEventListener("click", ()=>{
  syncInputsFromHeader();
  syncPrincipalToInput();
  overlay.classList.add("open");
});
closeOverlay.addEventListener("click", ()=> overlay.classList.remove("open"));

excelFile.addEventListener("change", (e)=>{
  selectedFile = e.target.files && e.target.files[0] ? e.target.files[0] : null;
});

openWeakBtn.addEventListener("click", ()=>{
  if(sheet2.classList.contains("hidden")){
    setStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø¶Ø¹ÙØ§Ø¡ Ø¨Ø¹Ø¯ â€” Ù†ÙÙ‘Ø° Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  overlay.classList.remove("open");
  sheet2.scrollIntoView({behavior:"smooth", block:"start"});
});

/* =========================
   Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø³Ù… Ø°ÙƒÙŠ
   ========================= */
let originalTitle = document.title;
function buildPrintTitle(){
  const subj = clean(subjectInput.value) || "Ù…Ø§Ø¯Ø©";
  const stage = clean(stageInput.value) || "";
  const sec = clean(sectionInput.value);
  const secLabel = sec ? ` Ø´Ø¹Ø¨Ø© ${sec}` : "";
  return `ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ ${subj} ${stage}${secLabel}`.replace(/\s+/g," ").trim();
}
function printSmart(){
  const t = buildPrintTitle();
  originalTitle = document.title;
  document.title = t;
  window.print();
  setTimeout(()=>{ document.title = originalTitle; }, 450);
}
printBtn.addEventListener("click", printSmart);

/* =========================
   Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´ÙŠØªØ§Øª (ÙƒÙ„ Ø´ÙŠØª = Ø´Ø¹Ø¨Ø©)
   ========================= */
function readWorkbookAllSheets(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data,{type:"array"});
        const sheets = wb.SheetNames.map(name=>{
          const ws = wb.Sheets[name];
          const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:null,raw:true});
          return {name, rows};
        });
        resolve({wb, sheets});
      }catch(err){reject(err);}
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

/* Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø´Ø¹Ø¨Ø© Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØª */
function inferSectionFromSheetName(name){
  const s = normalizeDigits(name||"").trim();
  const m = s.match(/(?:Ø´Ø¹Ø¨Ø©|Ø´Ø¹Ø¨Ù‡|Ø´|Ù‚Ø³Ù…|Ù‚)\s*([0-9]+)/) || s.match(/([0-9]{1,2})/);
  return m ? String(m[1]) : clean(name||"");
}

/* Ø¨Ù†Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø´ÙŠØª (Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© section = Ø±Ù‚Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØª) */
function buildRecordsFromRows(rows, sheetName){
  if(!rows || !rows.length) return [];
  const sheetSection = inferSectionFromSheetName(sheetName);

  // Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ù‡ÙŠØ¯Ø±
  let h=-1;
  for(let i=0;i<Math.min(rows.length,140);i++){
    const row = rows[i] || [];
    const joined = row.map(c=>c==null?"":String(c)).join(" ");
    if(/Ø§Ø³Ù…\s*Ø§Ù„Ø·Ø§Ù„Ø¨/.test(joined)) { h=i; break; }
  }

  // fallback: Ø£ÙŠ Ø£Ø±Ù‚Ø§Ù… Ø¯Ø±Ø¬Ø§Øª ÙÙ‚Ø·
  if(h===-1){
    const nums=[];
    for(const row of rows){
      if(!row) continue;
      for(const cell of row){
        if(isNumeric(cell)){
          const n=toNumber(cell);
          if(n>=0 && n<=200) nums.push(n);
        }
      }
    }
    return nums.map(v=>({student:"â€”", id:"â€”", grade:v, subject:"", section:sheetSection, sheet:sheetName}));
  }

  const headers = rows[h] || [];
  let nameCol=-1,idCol=-1,subCol=-1,secCol=-1,gradeCol=-1;

  headers.forEach((cell,idx)=>{
    if(cell==null) return;
    const s=String(cell);
    if(nameCol===-1 && /Ø§Ø³Ù…/.test(s) && /Ø·Ø§Ù„Ø¨/.test(s)) nameCol=idx;
    if(idCol===-1 && /Ù‡ÙˆÙŠØ©|Ø§Ù„Ø³Ø¬Ù„|Ø§Ù„Ù…Ø¯Ù†ÙŠ/.test(s)) idCol=idx;
    if(subCol===-1 && /Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„Ù…Ù‚Ø±Ø±/.test(s)) subCol=idx;
    if(secCol===-1 && /Ø§Ù„Ø´Ø¹Ø¨Ø©|Ø§Ù„Ø´Ø¹Ø¨Ù‡|Ø§Ù„Ù‚Ø³Ù…|Ø´Ø¹Ø¨Ø©/.test(s)) secCol=idx;
    if(gradeCol===-1 && /Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ø¯Ø±Ø¬Ø©|Ø§Ù„Ø¯Ø±Ø¬Ù‡|Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©|Ù†Ù‡Ø§Ø¦ÙŠ|final/i.test(s)) gradeCol=idx;
  });

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ ØµÙ ØªØ§Ù„ÙŠ
  if(gradeCol===-1){
    const r2 = rows[h+1] || [];
    r2.forEach((cell,idx)=>{
      if(cell==null) return;
      const s=String(cell);
      if(gradeCol===-1 && /Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ø§Ù„Ø¯Ø±Ø¬Ø©|Ø§Ù„Ø¯Ø±Ø¬Ù‡|Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©|Ù†Ù‡Ø§Ø¦ÙŠ|final/i.test(s)) gradeCol=idx;
    });
  }

  // Ø§Ø³ØªØ¯Ù„Ø§Ù„ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙØ¶Ù„ Ù„Ù„Ø¯Ø±Ø¬Ø§Øª
  if(gradeCol===-1){
    let best=-1,bScore=-1;
    const maxCols = Math.max(...rows.map(r=>r? r.length:0));
    for(let c=0;c<maxCols;c++){
      const vals=[];
      for(let r=h+1;r<rows.length;r++){
        const row=rows[r];
        if(!row || c>=row.length) continue;
        const v=row[c];
        if(isNumeric(v)){
          const n=toNumber(v);
          if(n>=0 && n<=200) vals.push(n);
        }
      }
      if(vals.length>=10){
        const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
        if(mean>bScore){bScore=mean;best=c;}
      }
    }
    gradeCol=best;
  }

  const out=[];
  for(let r=h+1;r<rows.length;r++){
    const row=rows[r];
    if(!row) continue;

    const nameRaw = nameCol>=0 ? row[nameCol] : null;
    const idRaw   = idCol>=0 ? row[idCol] : null;
    const gRaw    = gradeCol>=0 ? row[gradeCol] : null;
    const sRaw    = subCol>=0 ? row[subCol] : null;
    const secRaw  = secCol>=0 ? row[secCol] : null;

    const name = nameRaw ? String(nameRaw).trim() : "";
    const id   = idRaw ? normalizeDigits(idRaw).replace(/[^\d]/g,"") : "";
    const grade = isNumeric(gRaw) ? toNumber(gRaw) : NaN;
    const subject = sRaw ? String(sRaw).trim() : "";
    const section = clean(secRaw) ? normalizeDigits(String(secRaw)).trim() : sheetSection;

    if(!name && !id) continue;
    if(!isFinite(grade) || grade<0 || grade>200) continue;
    if(/Ø§Ù„ÙØµÙ„|Ø§Ù„Ø´Ø¹Ø¨Ø©|Ø§Ù„Ø´Ø¹Ø¨Ù‡|Ø§Ù„Ù…Ø§Ø¯Ø©|Ø§Ù„ØµÙ|ÙƒØ´Ù Ø±ØµØ¯|Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹|Ù…ØªÙˆØ³Ø·|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰|Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰/i.test(name)) continue;

    out.push({student:name||"Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…", id:id||"â€”", grade, subject, section:section||sheetSection, sheet:sheetName});
  }
  return out;
}

/* ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´ÙØ¹Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Ø¥Ù† ÙˆØ¬Ø¯) */
function parseSectionsInput(v){
  const s = normalizeDigits(v||"").trim();
  if(!s) return [];
  return s.split(/[,ØŒ/|]+/).map(x=>x.trim()).filter(Boolean);
}
function filterByWantedSections(list){
  const secs = parseSectionsInput(sectionInput.value);
  if(!secs.length) return list;
  const set = new Set(secs.map(String));
  return list.filter(r=> set.has(String(clean(r.section))) || set.has(String(inferSectionFromSheetName(r.sheet))));
}

/* Ø§Ø³ØªØ¯Ù„Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ù…Ù‡Ù… ÙˆØ¯Ù‚ÙŠÙ‚) */
function inferFullScoreSmart(list){
  // 1) Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø¯Ø¯Ù‡
  if(scaleMode.value==="period40") return 40;
  if(scaleMode.value==="period60") return 60;
  if(scaleMode.value==="final100") return 100;

  // 2) Ø§Ø³ØªØ¯Ù„Ø§Ù„ Ù…Ù† Ø£Ù‚ØµÙ‰ Ø¯Ø±Ø¬Ø© Ù…Ø¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§
  const maxGrade = Math.max(...list.map(r=>r.grade));
  const common = [40,60,100,50,30,20];
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙƒØ³ÙˆØ± Ø¨Ø³ÙŠØ·Ø© (Ù…Ø«Ù„ 39.5) Ù†Ù‚Ø±Ù‘Ø¨ Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø±Ø´Ø­
  let inferred = maxGrade;
  let best = Infinity;

  for(const c of common){
    if(c >= maxGrade && Math.abs(c-maxGrade) <= 8){
      const d = Math.abs(c-maxGrade);
      if(d < best){best=d; inferred=c;}
    }
  }

  // 3) fallback: Ø¥Ø°Ø§ ÙƒØ§Ù† maxGrade Ù‚Ø±ÙŠØ¨ Ù…Ù† Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© (Ù…Ø«Ù„ 39.8) Ù†Ø±ÙØ¹Ù‡Ø§ Ù„Ø£Ù‚Ø±Ø¨ 0.5 Ø«Ù… Ù†Ù‚Ø±Ù‘Ø¨
  if(!common.includes(inferred)){
    const round05 = Math.round(maxGrade*2)/2;
    for(const c of common){
      if(c >= round05 && Math.abs(c-round05) <= 8){
        const d = Math.abs(c-round05);
        if(d < best){best=d; inferred=c;}
      }
    }
  }

  // 4) fallback Ù†Ù‡Ø§Ø¦ÙŠ: Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ù…Ù‚Ø±Ø¨Ø© Ù„Ø£Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­
  if(!isFinite(inferred) || inferred<=0) inferred = Math.ceil(maxGrade);
  inferred = Math.max(1, Math.round(inferred));

  return inferred;
}

/* âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: Ø£Ù‚Ù„ Ù…Ù† 25% Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª) */
function weakThreshold(fullScore){
  // Ø£Ù‚Ù„ Ù…Ù† 25% (strictly less)
  return (fullScore * 0.25);
}

/* Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) */
function level(score, fullScore){
  const p = (score/fullScore)*100;
  if(p>=90) return "ex";
  if(p>=80) return "vg";
  if(p>=70) return "gd";
  if(p>=60) return "ac";
  return "wk";
}

/* Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª */
function setRanges(fullScore){
  const exMin=Math.round(fullScore*0.90);
  const vgMin=Math.round(fullScore*0.80);
  const gdMin=Math.round(fullScore*0.70);
  const acMin=Math.round(fullScore*0.60);

  rangeExcellent.textContent=`${exMin}-${fullScore}`;
  rangeVGood.textContent=`${vgMin}-${exMin-1}`;
  rangeGood.textContent=`${gdMin}-${vgMin-1}`;
  rangeAcceptable.textContent=`${acMin}-${gdMin-1}`;
  rangeWeak.textContent=`0-${acMin-1}`;
}

/* âœ… Ø¨Ù†Ùƒ Ø®Ø·Ø· Ø¹Ù„Ø§Ø¬ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© (Ù…Ø®ØªØµØ±Ø© ÙˆÙ…Ù‡Ù†ÙŠØ©) */
const planBank = [
  {key:"A", text:"Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ Ù…Ù‡Ø§Ø±ÙŠ: ØªØ­Ø¯ÙŠØ¯ Ù…Ù‡Ø§Ø±ØªÙŠÙ† Ø£Ø³Ø§Ø³ÙŠØªÙŠÙ† + ØªØ¯Ø±ÙŠØ¨ Ù…ÙˆØ¬Ù‡ + ØªÙ‚ÙˆÙŠÙ… Ù‚ØµÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ + Ø¥Ø¹Ø§Ø¯Ø© Ù‚ÙŠØ§Ø³."},
  {key:"B", text:"Ø¹Ù„Ø§Ø¬ Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©: ØªØ­Ù„ÙŠÙ„ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© + ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© ÙØ±Ø¯ÙŠØ© + ÙˆØ§Ø¬Ø¨ Ø¹Ù„Ø§Ø¬ÙŠ Ù‚ØµÙŠØ± + Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù…."},
  {key:"C", text:"ØªØ¹Ø²ÙŠØ² ØªØ¯Ø±ÙŠØ¬ÙŠ: Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ù…Ø®ØªØµØ± + Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ Ø¹Ù„Ø§Ø¬ÙŠØ© + Ø­ØµØµ Ø¯Ø¹Ù… + Ù‚ÙŠØ§Ø³ Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†."},
  {key:"D", text:"ØªØ¯Ø®Ù„ ÙØ±Ø¯ÙŠ: Ù‡Ø¯Ù Ù…Ø­Ø¯Ø¯ (SMART) + ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ù†Ù…Ø§Ø°Ø¬ Ù…Ø´Ø§Ø¨Ù‡Ø© + Ù…ØªØ§Ø¨Ø¹Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± + Ù‚ÙŠØ§Ø³ ØªØ­Ø³Ù†."},
  {key:"E", text:"Ø¯Ø¹Ù… Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ‚Øª + Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø­Ù„ + ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø¨Ù†ÙˆØ¯ Ù…ØªÙ†ÙˆØ¹Ø© + Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ± Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¯Ø±Ø³."},
  {key:"F", text:"Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙ‚ÙˆÙŠØ© Ù…Ø±ÙƒÙ‘Ø²: Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØµØºÙŠØ±Ø© + ØªØ¹Ù„Ù… ØªØ¹Ø§ÙˆÙ†ÙŠ + Ø£Ù†Ø´Ø·Ø© Ø¹Ù„Ø§Ø¬ + ØªÙ‚ÙˆÙŠÙ… Ù…Ø±Ø­Ù„ÙŠ + ØªÙˆØ«ÙŠÙ‚ Ø£Ø«Ø±."}
];

function pickPlan(rec, fullScore){
  // ØªÙ†ÙˆÙŠØ¹ Ø°ÙƒÙŠ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
  const pct = (rec.grade/fullScore)*100;
  if(pct < 10) return planBank[0].text;
  if(pct < 15) return planBank[1].text;
  if(pct < 20) return planBank[2].text;
  if(pct < 25) return planBank[3].text;
  return planBank[4].text;
}

/* =========================
   Chart plugins
   ========================= */
const centerLabelPlugin = {
  id:"centerLabel",
  afterDraw(chart, args, opts){
    const t = opts && opts.text;
    if(!t) return;
    const {ctx, chartArea:{left,right,top,bottom}} = chart;
    const x=(left+right)/2, y=(top+bottom)/2;
    ctx.save();
    ctx.font = "900 14px Tajawal, system-ui";
    ctx.fillStyle="#111827";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(t, x, y);
    ctx.restore();
  }
};
const barValuePlugin = {
  id:"barValue",
  afterDatasetsDraw(chart){
    if(chart.config.type!=="bar") return;
    const {ctx} = chart;
    const ds = chart.data.datasets[0];
    const meta = chart.getDatasetMeta(0);
    ctx.save();
    ctx.font="900 12px Tajawal, system-ui";
    ctx.fillStyle="#111827";
    ctx.textAlign="center";
    ds.data.forEach((v,i)=>{
      const el = meta.data[i];
      if(!el) return;
      const p = el.getProps(["x","y"], true);
      ctx.fillText(v, p.x, p.y + 16);
    });
    ctx.restore();
  }
};
Chart.register(centerLabelPlugin, barValuePlugin);

/* =========================
   Ø§Ù„Ø±Ø³ÙˆÙ…
   ========================= */
function setupCharts(){
  const donutCfg = [
    {id:"dWeak",  col:"#ef4444"},
    {id:"dAcc",   col:"#f59e0b"},
    {id:"dGood",  col:"#3b82f6"},
    {id:"dVGood", col:"#10b981"},
    {id:"dEx",    col:"#22c55e"}
  ];

  donutCfg.forEach(c=>{
    const ctx = document.getElementById(c.id).getContext("2d");
    donuts[c.id]=new Chart(ctx,{
      type:"doughnut",
      data:{
        labels:["Ø§Ù„Ù†Ø³Ø¨Ø©","Ø§Ù„Ø¨Ø§Ù‚ÙŠ"],
        datasets:[{data:[0,100],backgroundColor:[c.col,"#e5e7eb"],borderWidth:0}]
      },
      options:{
        responsive:true,
        maintainAspectRatio:true,
        aspectRatio:1,
        animation:false,
        plugins:{
          legend:{display:false},
          tooltip:{enabled:false},
          centerLabel:{text:"0%"}
        },
        cutout:"78%"
      }
    });
  });

  const bctx = document.getElementById("barLevels").getContext("2d");
  bar = new Chart(bctx,{
    type:"bar",
    data:{
      labels:["Ø¶Ø¹ÙŠÙ","Ù…Ù‚Ø¨ÙˆÙ„","Ø¬ÙŠØ¯","Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§","Ù…Ù…ØªØ§Ø²"],
      datasets:[{
        data:[0,0,0,0,0],
        backgroundColor:["#ef4444","#f59e0b","#3b82f6","#10b981","#22c55e"],
        borderRadius:14,
        maxBarThickness:72,
        categoryPercentage:0.68,
        barPercentage:0.88
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{legend:{display:false},barValue:{}},
      scales:{
        x:{ticks:{font:{family:"Tajawal",size:12,weight:"800"}}},
        y:{
          beginAtZero:true,
          ticks:{stepSize:1,font:{family:"Tajawal",size:11,weight:"800"}}
        }
      }
    }
  });
}
function updateDonut(id, pct){
  const ch = donuts[id]; if(!ch) return;
  const p = clamp(pct,0,100);
  ch.data.datasets[0].data=[p,100-p];
  ch.options.plugins.centerLabel.text = `${Math.round(p)}%`;
  ch.update();
}

/* =========================
   ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
   ========================= */
function fillHeader(fullScore){
  const stage = clean(stageInput.value) || "â€”";
  const subj  = clean(subjectInput.value) || "â€”";
  const term  = clean(termInput.value) || clean(periodInput.value) || "â€”";
  const teacher = clean(teacherInput.value) || "â€”";

  titleSubject.textContent = subj !== "â€”" ? subj : (stage !== "â€”" ? stage : "â€”");

  stageField.textContent = stage;
  subjectField.textContent = subj;
  termField.textContent = term;
  teacherField.textContent = teacher;
  maxScoreField.textContent = fullScore;

  ftTeacher.textContent = teacher;

  stageField2.textContent = stage;
  subjectField2.textContent = subj;
  termField2.textContent = term;
  teacherField2.textContent = teacher;
  maxScoreField2.textContent = fullScore;

  weakTitleSubject.textContent = subj !== "â€”" ? subj : "â€”";
  weakTitleStage.textContent = stage !== "â€”" ? stage : "â€”";
  ftTeacher2.textContent = teacher;

  syncHeaderFromInputs();
  syncPrincipalFromInput();
}

function computeStats(list, fullScore){
  const n=list.length;
  const sum = list.reduce((a,r)=>a+r.grade,0);
  const max = Math.max(...list.map(r=>r.grade));
  const min = Math.min(...list.map(r=>r.grade));
  const avg = n ? (sum/n) : 0;
  const avgPct = fullScore ? (avg/fullScore*100) : 0;

  const c = {ex:0,vg:0,gd:0,ac:0,wk:0};
  list.forEach(r=>{ c[level(r.grade, fullScore)]++; });

  return {n,sum,max,min,avg,avgPct,c};
}

function setCounts(stats){
  countExcellent.textContent = stats.c.ex;
  countVGood.textContent = stats.c.vg;
  countGood.textContent = stats.c.gd;
  countAcceptable.textContent = stats.c.ac;
  countWeak.textContent = stats.c.wk;

  statN.textContent = stats.n;
  statSum.textContent = stats.sum.toFixed(0);
  statMax.textContent = stats.max.toFixed(0);
  statMin.textContent = stats.min.toFixed(0);
  statAvg.textContent = stats.avg.toFixed(1);
  statPct.textContent = `${stats.avgPct.toFixed(1)}%`;
}

function setCharts(stats){
  const n = stats.n || 1;
  const pct = (x)=> (x/n)*100;

  updateDonut("dWeak",  pct(stats.c.wk));
  updateDonut("dAcc",   pct(stats.c.ac));
  updateDonut("dGood",  pct(stats.c.gd));
  updateDonut("dVGood", pct(stats.c.vg));
  updateDonut("dEx",    pct(stats.c.ex));

  pWeak.textContent  = `${pct(stats.c.wk).toFixed(1)}% (${stats.c.wk})`;
  pAcc.textContent   = `${pct(stats.c.ac).toFixed(1)}% (${stats.c.ac})`;
  pGood.textContent  = `${pct(stats.c.gd).toFixed(1)}% (${stats.c.gd})`;
  pVGood.textContent = `${pct(stats.c.vg).toFixed(1)}% (${stats.c.vg})`;
  pEx.textContent    = `${pct(stats.c.ex).toFixed(1)}% (${stats.c.ex})`;

  if(bar){
    bar.data.datasets[0].data=[stats.c.wk, stats.c.ac, stats.c.gd, stats.c.vg, stats.c.ex];
    bar.update();
  }
}

/* âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ (Ø±ÙŠØ§Ø¶ÙŠØ§Ù‹) + ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ */
function renderWeakPage(list, fullScore){
  const thr = weakThreshold(fullScore);                 // 25%
  const thrLabel = `${(thr).toFixed(2)}`.replace(/\.00$/,"");
  const note = `Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: Ø£Ù‚Ù„ Ù…Ù† 25% Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø£Ù‚Ù„ Ù…Ù† ${thrLabel} Ù…Ù† ${fullScore}).`;

  // Ø¶Ø¹ÙØ§Ø¡ = Ø£Ù‚Ù„ Ù…Ù† 25% (strict)
  const weakList = list
    .filter(r=> r.grade < thr)
    .sort((a,b)=> (a.grade-b.grade) || String(a.section).localeCompare(String(b.section)));

  weakRulePill.textContent = note;
  weakCountPill.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡: ${weakList.length}`;

  if(!weakList.length){
    weakBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¶Ù…Ù† ÙØ¦Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ ÙˆÙÙ‚ Ù‚Ø§Ø¹Ø¯Ø© 25%.</td></tr>`;
    sheet2.classList.add("hidden");
    return {weakCount:0, note};
  }

  sheet2.classList.remove("hidden");

  const rows = weakList.map((r)=>{
    const gap = Math.max(0, fullScore - r.grade);
    const pct = (r.grade/fullScore)*100;
    const plan = pickPlan(r, fullScore);
    const sec = clean(r.section) || inferSectionFromSheetName(r.sheet) || "â€”";

    return `
      <tr>
        <td class="name">${r.student}</td>
        <td class="id">${r.id || "â€”"}</td>
        <td style="text-align:center;font-weight:900;">${sec}</td>
        <td style="text-align:center;font-weight:900;">${r.grade.toFixed(0)}</td>
        <td style="text-align:center;font-weight:900;color:#0f172a;">${pct.toFixed(1)}%</td>
        <td style="text-align:center;font-weight:900;color:#991b1b;">${gap.toFixed(0)}</td>
        <td>${plan}</td>
        <td class="follow">
          <label><input type="checkbox" />1</label>
          <label><input type="checkbox" />2</label>
          <label><input type="checkbox" />3</label>
        </td>
      </tr>
    `;
  }).join("");

  weakBody.innerHTML = rows;
  return {weakCount:weakList.length, note};
}

/* =========================
   Ø§Ù„ØªØ­Ù„ÙŠÙ„: Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´ÙŠØªØ§Øª + ÙƒÙ„ Ø´ÙŠØª Ø´Ø¹Ø¨Ø©
   ========================= */
async function analyze(){
  if(!selectedFile){
    setStatus("ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹.");
    excelFile.classList.add("missing");
    return;
  }
  excelFile.classList.remove("missing");

  try{
    setStatus("Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´ÙŠØªØ§Øª (ÙƒÙ„ Ø´ÙŠØª = Ø´Ø¹Ø¨Ø©) ...");
    const {sheets} = await readWorkbookAllSheets(selectedFile);

    // Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† ÙƒÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª (ÙƒÙ„ Ø´ÙŠØª ÙŠÙ…Ø«Ù„ Ø´Ø¹Ø¨Ø©)
    let all = [];
    sheets.forEach(sh=>{
      const recs = buildRecordsFromRows(sh.rows, sh.name);
      all = all.concat(recs);
    });

    // Ø¥Ø²Ø§Ù„Ø© ØªÙƒØ±Ø§Ø±Ø§Øª (Ù‡ÙˆÙŠØ© + Ø¯Ø±Ø¬Ø© + Ø´Ø¹Ø¨Ø©) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
    const seen = new Set();
    all = all.filter(r=>{
      const k = `${clean(r.id)}|${r.grade}|${clean(r.section)}|${clean(r.sheet)}|${clean(r.student)}`;
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´ÙØ¹Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¥Ù† ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§
    all = filterByWantedSections(all);

    if(!all.length){
      setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´ÙØ¹Ø¨.");
      return;
    }

    records = all;

    // Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ù„Ù/Ø§Ù„ÙˆØ¶Ø¹
    const fullScore = inferFullScoreSmart(records);

    fillHeader(fullScore);
    setRanges(fullScore);

    const stats = computeStats(records, fullScore);
    setCounts(stats);
    setCharts(stats);

    // ØµÙØ­Ø© Ø§Ù„Ø¶Ø¹ÙØ§Ø¡ (25% Ø±ÙŠØ§Ø¶ÙŠØ§Ù‹)
    const weakInfo = renderWeakPage(records, fullScore);

    // Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© ØªØ´Ù…Ù„ Ø­Ù‚ÙŠÙ‚Ø© Ø£Ù† ÙƒÙ„ Ø´ÙŠØª = Ø´Ø¹Ø¨Ø©
    const sheetsInfo = sheets.map(s=>inferSectionFromSheetName(s.name)).filter(Boolean);
    const uniqueSecs = Array.from(new Set(records.map(r=>clean(r.section)).filter(Boolean))).slice(0,12);
    const secText = uniqueSecs.length ? `Ø§Ù„Ø´ÙØ¹Ø¨ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: ${uniqueSecs.join("ØŒ ")}.` : `ØªÙ…Øª Ù‚Ø±Ø§Ø¡Ø© ${sheets.length} Ø´ÙŠØª.`;

    setStatus(`ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${stats.n} Ø·Ø§Ù„Ø¨/Ø­Ø§Ù„Ø©. Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: ${fullScore}. ${weakInfo.note} ${secText}`);
    overlay.classList.remove("open");

    // ØªØ­Ø³ÙŠÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³ÙˆÙ… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„ (Ø®ØµÙˆØµÙ‹Ø§ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©)
    setTimeout(()=>{
      Object.values(donuts).forEach(ch=>ch && ch.resize());
      bar && bar.resize();
    }, 80);

  }catch(err){
    console.error(err);
    setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©/Ø§Ù„ØªØ­Ù„ÙŠÙ„. ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ ØµØ­ÙŠØ­ ÙˆÙ…Ù† Ù†ÙˆØ± Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
  }
}

/* =========================
   Ø£Ø­Ø¯Ø§Ø«
   ========================= */
analyzeBtn.addEventListener("click", analyze);

/* ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© */
setupCharts();

/* Ø¨Ø¯Ø§ÙŠØ© */
setStatus("Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù„ÙŠÙ„. Ø§ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø³Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ø«Ù… Â«Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„Â».");
</script>

</body>
</html>
