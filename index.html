<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø¯Ø¹Ù… ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© (Ø²ÙŠØ§Ø±Ø© Ù…Ø¹Ù„Ù…) Ù¡Ù¤Ù¤Ù§Ù‡Ù€</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{
  --moe-dark:#0c594e;--moe-green:#0f7a66;--moe-lite:#e8f4f1;--ink:#123b37;--line:#cfe1dd;--border:#e6efec;--bg:#fbfdfc;
  --good:#16a34a;--mid:#f59e0b;--bad:#ef4444;--base:clamp(14px,1.15vw + 10px,16.5px);
  --rowA:#f7fdfa; --rowB:#ffffff; --warn:#e11d48
}
*{box-sizing:border-box}
html,body{margin:0;background:#fff;color:var(--ink);font-family:"Tajawal",system-ui;font-size:var(--base);min-height:100%}
#page{width:min(1200px,100vw);margin-inline:auto}
.wrap{padding:clamp(8px,2vw,16px)}
.hidden{display:none}
.input-error{border-color:var(--warn)!important;background:#fff5f7!important;box-shadow:0 0 0 2px rgba(225,29,72,.12) inset}
.row-missing{box-shadow:0 0 0 2px rgba(225,29,72,.12) inset}
.section-error{box-shadow:0 0 0 2px #fde2e2 inset}

/* Ø±Ø£Ø³ */
.govern-head{display:flex;flex-direction:column;gap:4px;align-items:center;margin-top:6px}
.govern-head .hl{font-family:"Cairo";font-weight:700;color:var(--moe-dark);text-align:center}
.govern-head .hl.small{font-size:clamp(13px,1.1vw + 10px,16px)}
.govern-head .hl.big{font-size:clamp(14px,1.2vw + 10px,18px)}
.govern-head .editable{padding:2px 6px;border-radius:8px;background:var(--moe-lite);border:1px dashed transparent;cursor:text}
.inline-pen{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 6px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;color:var(--moe-dark)}
.inline-pen svg{width:14px;height:14px}

h1{margin:10px 0 8px;color:var(--moe-green);font-family:"Cairo","Tajawal";font-size:clamp(18px,1.6vw + 14px,26px);text-align:center}
.badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:10px;background:var(--moe-lite);color:var(--moe-dark);font-weight:700;font-size:12px}
.box{border:1px solid var(--border);border-radius:14px;background:var(--bg);margin-top:10px;overflow:hidden}
.box h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:15px;color:var(--moe-dark);display:flex;gap:10px;align-items:center;justify-content:space-between}

/* Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
.top-tools{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.top-tools .btn-ic{padding:7px 10px}

/* Ø¹Ø¯Ø³Ø© Ø£Ø³Ù…Ø§Ø¡ */
.lens-wrap{position:relative}
.lens-menu{position:absolute;top:calc(100% + 6px);inset-inline-end:0;min-width:min(460px,96vw);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 16px 48px rgba(0,0,0,.2);padding:10px;display:none;z-index:1700}
.lens-menu .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.lens-menu .row .fld{flex:1}
.lens-menu select{flex:1;height:38px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;font:inherit;text-align:center}

/* Ø´Ø¨ÙƒØ© Ø­Ù‚ÙˆÙ„ */
.grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px}
.fld{height:38px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;font:inherit;text-align:center;width:100%}
.col-3{grid-column:span 3/span 3}.col-12{grid-column:span 12/span 12}
.fld-inline{border:0;background:transparent;padding:6px 8px;text-align:center;border-radius:6px}
.fld-inline:focus{outline:2px solid rgba(15,122,102,0.06);background:#fff}

/* Ø£Ø²Ø±Ø§Ø± */
.btn-ic{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:12px;border:1px solid var(--moe-green);background:var(--moe-green);color:#fff;font-weight:800;cursor:pointer;font-size:clamp(12px,.6vw + 10px,14px);transition:all .12s ease;box-shadow:0 6px 18px rgba(15,122,102,0.08)}
.btn-ic:hover{background:var(--moe-dark);transform:translateY(-1px)}
.btn-ic svg{width:18px;height:18px}
.btn-ic.tiny{padding:6px 8px}
.bottom-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;padding:10px;border:1px solid var(--border);border-radius:14px;background:#fbfdfc;margin-top:12px}

/* Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª */
.visits{display:flex;gap:clamp(12px,2vw,24px);align-items:flex-start;justify-content:center;flex-wrap:nowrap;overflow:auto}
.visitCard{display:flex;flex-direction:column;align-items:center;gap:8px;position:relative;min-width:160px}
.donut{width:clamp(84px, 10vw + 40px, 140px);height:auto;cursor:pointer}
.donut .ring{transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dasharray .45s ease,stroke .3s ease}
.donut text{font-weight:800;fill:var(--moe-dark);font-size:13px}
.chip{background:var(--moe-lite);border:1px dashed var(--line);padding:4px 10px;border-radius:999px;font-size:clamp(11px,.6vw + 9px,12px);color:var(--moe-dark);cursor:pointer}
.visitLabel{font-family:"Cairo";font-weight:700;color:var(--moe-dark);font-size:clamp(13px,.8vw + 10px,16px)}
.hmeterTop{margin:8px auto 4px;text-align:center}
.globalInline{margin-inline-start:8px;font-family:"Cairo";font-size:clamp(14px,1vw + 11px,18px);font-weight:800}
.globalInline.good{color:var(--good)}.globalInline.mid{color:var(--mid)}.globalInline.bad{color:var(--bad)}
.hbar{position:relative;width:min(700px,95vw);height:14px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%);margin:4px auto 6px}
.hthumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--moe-dark)}
.hmeter{display:flex;flex-direction:column;gap:6px;align-items:center;margin:6px 0 8px}
.hbarSmall{position:relative;width:min(680px,95vw);height:12px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%)}
.hthumbSmall{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--moe-dark)}
.hlbl{display:flex;gap:8px;align-items:center;color:var(--moe-dark);font-weight:800}

/* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
.table-responsive{width:100%;overflow:auto}
.tbl{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px;background:#fff;vertical-align:middle;text-align:center;word-wrap:break-word;font-size:12px}
.tbl thead th{background:var(--moe-dark)!important;color:#fff!important}

/* ØªØ¨Ø§Ø¯Ù„ */
tbody tr:nth-child(odd) td{background:var(--rowA)}
tbody tr:nth-child(even) td{background:var(--rowB)}

/* Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… */
#learningHead th:nth-child(1){width:44px}
#learningHead th:nth-child(2){width:120px}
#learningHead th:nth-child(3){width:250px}
#learningHead th:nth-child(4){width:220px}
#learningHead th:nth-child(5){width:160px}
#learningHead th:nth-child(6){width:160px}
.tbl td.domain-cell{background:#f3faf8;text-align:center;vertical-align:middle;font-weight:800}
.item-cell{padding:6px 8px;text-align:center}
.item-title{display:block;font-weight:800;color:var(--moe-dark);font-size:13px}

/* Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ */
.level{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:stretch;width:100%}
.level button{
  --dot:#d1d5db;border:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#f8faf9);border-radius:999px;cursor:pointer;
  font-weight:800;display:inline-flex;align-items:center;justify-content:center;gap:10px;transition:.12s;width:100%;padding:10px 0;font-size:13.5px;box-shadow:0 4px 14px rgba(0,0,0,.06)
}
.level button::before{content:"";width:12px;height:12px;border-radius:50%;background:var(--dot)}
.level button:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,.1)}
.level button[data-v="1"]{--dot:#f87171}
.level button[data-v="2"]{--dot:#fbbf24}
.level button[data-v="3"]{--dot:#22c55e}
.level button.active{background:linear-gradient(180deg,#f7fffb,#ecfdf5);box-shadow:0 0 0 2px #cfe8df inset,0 8px 24px rgba(0,0,0,.06)}
.level button.active[data-v="1"]{background:linear-gradient(180deg,#fff8f8,#ffecec);border-color:#f2bcbc;color:#b42318}
.level button.active[data-v="2"]{background:linear-gradient(180deg,#fffaf0,#fff1cc);border-color:#f2d3a2;color:#a8620a}
.level button.active[data-v="3"]{background:linear-gradient(180deg,#f0fff6,#dcfce7);border-color:#b9e4c8;color:#0f6a3b}

/* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© */
#toolsTbl thead th:nth-child(1){width:44px}
#toolsTbl thead th:nth-child(2){width:220px}
#toolsTbl thead th:nth-child(3){width:70px}
#toolsTbl thead th:nth-child(4){width:230px}
#toolsTbl thead th:nth-child(5){width:230px}
.td-proof{text-align:center;width:1%}
.tool-reason{width:100%;min-height:56px;border:1px dashed var(--line);border-radius:10px;background:#fff;padding:6px 8px;font:inherit;font-size:11.5px;resize:vertical;white-space:pre-wrap}
.tool-title{font-weight:800;color:var(--moe-dark);font-size:13.2px;text-align:center}
.tool-brief{display:block;font-size:11.2px;opacity:.9;margin-top:3px;text-align:center}

/* Ø§Ù„Ø¯Ø¹Ù… */
#supportArea{width:100%;min-height:120px;border:1px solid #b9e4c8;background:#f9fefb;color:#0f6a3b;border-radius:12px;padding:10px 12px;resize:none;font:inherit;line-height:1.9}

/* Ø§Ù„Ø­Ø§ÙØ¸Ø© / Snackbar / Ø­Ù‚ÙˆÙ‚ */
#approvedPanel{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;min-width:min(520px,92vw);max-width:92vw;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.15);padding:0;display:none;z-index:1500}
.ap-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:10px}
.ap-close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 10px;cursor:pointer}
#approvedList{display:flex;flex-wrap:wrap;gap:6px;padding:12px;max-height:40vh;overflow:auto}
.name-chip{padding:6px 10px;border-radius:999px;border:1px dashed var(--line);background:#fafafa}

#snackbar{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;min-width:min(520px,92vw);border-radius:14px;padding:10px 14px;box-shadow:0 12px 34px rgba(0,0,0,.12);display:none;z-index:2000;text-align:center;font-weight:800}
.snack-ok{background:#eaffea;border:1px solid #b7e1b7;color:#146c2e}.snack-err{background:#fff0f0;border:1px solid #f1b7b7;color:#9c1d1d}

.footer-rights{margin:8px 0 14px;text-align:center;font-size:11px;color:var(--moe-dark)}

/* Ø£Ø³Ù‡Ù… ØµØ¹ÙˆØ¯/Ù‡Ø¨ÙˆØ· */
.float-arrows{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:1600}
.float-arrows button{border:none;border-radius:50%;width:44px;height:44px;background:#0f7a66;color:#fff;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.18);font-size:18px}
.float-arrows button:hover{background:#0c594e}
</style>
</head>
<body>
<div id="page"><div class="wrap" id="sheet">

  <!-- Ø±Ø£Ø³ -->
  <div class="govern-head">
    <div class="hl small" id="h-sa">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
    <div class="hl small" id="h-moed">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
    <div class="hl big">
      <span class="editable" id="h-dir" contenteditable="false">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</span>
      <button class="inline-pen no-print" id="penDir" title="ØªØ¹Ø¯ÙŠÙ„">âœ</button>
    </div>
    <div class="hl big">
      <span class="editable" id="h-school" contenteditable="false">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</span>
      <button class="inline-pen no-print" id="penSchool" title="ØªØ¹Ø¯ÙŠÙ„">âœ</button>
    </div>
  </div>

  <h1>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø¯Ø¹Ù… ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© (Ø²ÙŠØ§Ø±Ø© Ù…Ø¹Ù„Ù…) Ù¡Ù¤Ù¤Ù§Ù‡Ù€</h1>
  <div style="text-align:center"><span class="badge" id="hijriChip">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ: â€”</span></div>

  <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© + Ø£Ø¯ÙˆØ§Øª -->
  <div class="box" id="boxInfo">
    <h3>
      <span>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</span>
      <span class="top-tools no-print">
        <!-- Ø¹Ø¯Ø³Ø©: Ø£Ø³Ù…Ø§Ø¡ + Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙÙ‚Ø· -->
        <span class="lens-wrap">
          <button class="btn-ic tiny" id="btnLens" title="Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ / Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯">ğŸ” Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
          <div class="lens-menu" id="lensMenu">
            <div class="row">
              <input id="lensSearch" class="fld" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡ÙˆÙŠØ©">
              <button class="btn-ic tiny" id="lensImport">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
              <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none">
            </div>
            <div class="row">
              <select id="lensSelect" title="Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†">
                <option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…Ù‹Ø§ â€”</option>
              </select>
            </div>
          </div>
        </span>
        <!-- Ø§Ù„Ø­Ø§ÙØ¸Ø© -->
        <button class="btn-ic tiny" id="btnVault" title="Ø§Ù„Ø­Ø§ÙØ¸Ø© (Ø§Ù„Ù…ÙØ²Ø§Ø±ÙˆÙ†)">ğŸ—‚ï¸ Ø§Ù„Ø­Ø§ÙØ¸Ø©</button>
        <button class="btn-ic tiny" id="btnReport" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">ğŸ“„ ØªÙ‚Ø±ÙŠØ±</button>
      </span>
    </h3>
    <div class="grid" style="padding:10px">
      <input class="fld fld-inline col-3 req" id="tName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
      <input class="fld fld-inline col-3" id="tId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (10 Ø£Ø±Ù‚Ø§Ù…)" inputmode="numeric" maxlength="10">
      <input class="fld fld-inline col-3 req" id="tSpec" placeholder="Ø§Ù„ØªØ®ØµØµ / Ø§Ù„Ù…Ø§Ø¯Ø©">
      <input class="fld fld-inline col-3" id="lesson" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
      <input class="fld fld-inline col-3" id="degree" placeholder="Ø§Ù„Ù…Ø¤Ù‡Ù„">
      <input class="fld fld-inline col-3" id="exp" placeholder="Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©">
      <input class="fld fld-inline col-3" id="class" placeholder="Ø§Ù„ÙØµÙ„">
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø´Ø§Ù…Ù„ -->
  <div class="hmeterTop">
    <span>Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¯Ø§Ø¡ <b id="globalPctInline" class="globalInline">Ø¶Ø¹ÙŠÙ</b></span>
    <div class="globalRow"><div class="hbar"><div class="hthumb" id="globalThumb" style="left:0%"></div></div></div>
  </div>

  <!-- Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª -->
  <div class="visits">
    <div class="visitCard">
      <svg class="donut" id="v1" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle id="v1ring" cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v1t">â€”</text></svg>
      <div class="chip" id="v1h">â€”</div><div class="visitLabel">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</div>
    </div>
    <div class="visitCard">
      <svg class="donut" id="v2" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle id="v2ring" cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v2t">â€”</text></svg>
      <div class="chip" id="v2h">â€”</div><div class="visitLabel">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</div>
    </div>
    <div class="visitCard">
      <svg class="donut" id="v3" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle id="v3ring" cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v3t">â€”</text></svg>
      <div class="chip" id="v3h">â€”</div><div class="visitLabel">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø¯Ø¹Ù…)</div>
    </div>
  </div>

  <div class="hmeter">
    <div class="hbarSmall"><div class="hthumbSmall" id="hThumb" style="left:0%"></div></div>
    <div class="hlbl"><span>Ù…Ø¤Ø´Ø± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> <span id="kpiPct">Ø¶Ø¹ÙŠÙ</span></div>
  </div>

  <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… -->
  <div class="box" id="learningBox">
    <h3>Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…</h3>
    <div class="table-responsive">
      <table class="tbl" id="learningTbl">
        <thead id="learningHead">
          <tr><th>Ù…</th><th>Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª</th><th>Ø§Ù„Ø¹Ù†Ø§ØµØ±</th><th>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡</th><th>Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„ØªÙ…ÙŠÙ‘Ø²</th><th>Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© -->
  <div class="box" id="toolsBox">
    <h3><span>Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…</span><small id="toolsMeta" style="margin-inline-start:6px">â€”</small></h3>
    <div class="table-responsive">
      <table class="tbl" id="toolsTbl">
        <thead><tr><th>Ù…</th><th>Ø§Ù„Ø£Ø¯ÙˆØ§Øª</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th><th>Ø§Ù„ØªÙØ¹ÙŠÙ„</th><th>Ø£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„</th></tr></thead>
        <tbody id="toolsRows"></tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ø¯Ø¹Ù… -->
  <div class="box" id="supportBox">
    <h3>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù… Ù„Ù„Ù…Ø¹Ù„Ù…</h3>
    <div class="support-area"><textarea id="supportArea" placeholder="Ø³ÙŠÙÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: Ù¤ Ø£Ø³Ø·Ø± Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øªâ€¦"></textarea></div>
  </div>

  <!-- ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø« -->
  <div class="box" id="signsBox">
    <h3>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</h3>
    <div class="table-responsive">
      <table class="tbl">
        <thead><tr><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</th><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</th><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø¯Ø¹Ù…)</th></tr></thead>
        <tbody>
          <tr>
            <td>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b id="sn1">â€”</b><div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</td>
            <td>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b id="sn2">â€”</b><div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</td>
            <td>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b id="sn3">â€”</b><div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</td>
          </tr>
          <tr>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: <span id="sh1">â€”</span></td>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: <span id="sh2">â€”</span></td>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: <span id="sh3">â€”</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± -->
  <div class="bottom-actions no-print">
    <button class="btn-ic" id="btnFinalize">âœ… Ø§Ø¹ØªÙ…Ø¯</button>
    <button class="btn-ic" id="btnDeleteVisit">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø²ÙŠØ§Ø±Ø©</button>
    <button class="btn-ic" id="btnClearAll">â™»ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
  </div>

  <div class="footer-rights no-print">Ù…Ø¨Ø§Ø¯Ø±Ø© Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ø§Ù„Ø®Ø¨Ø± â€” ØªÙ†ÙÙŠØ° ÙˆØªØµÙ…ÙŠÙ…: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± v02</div>
</div></div>

<!-- Ø§Ù„Ø­Ø§ÙØ¸Ø© -->
<div id="approvedPanel" class="no-print">
  <div class="ap-head"><h4>Ø§Ù„Ø­Ø§ÙØ¸Ø© (Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„Ù…ÙØ²Ø§Ø±ÙˆÙ†)</h4><button class="ap-close" id="apClose" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button></div>
  <div id="approvedList">â€”</div>
</div>

<!-- Snackbar -->
<div id="snackbar"><span class="ic">âœ…</span><span id="snackText">ØªÙ…</span></div>

<!-- Ø£Ø³Ù‡Ù… -->
<div class="float-arrows no-print">
  <button id="toTop" title="Ø£Ø¹Ù„Ù‰">â†‘</button>
  <button id="toBottom" title="Ø£Ø³ÙÙ„">â†“</button>
</div>

<script>
/* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø®ØªØµØ±Ø© ===== */
const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
function showSnack(text,type='ok'){const bar=$('#snackbar');const tx=$('#snackText');bar.className='';bar.classList.add(type==='ok'?'snack-ok':'snack-err');tx.textContent=text;bar.style.display='block';clearTimeout(showSnack._t);showSnack._t=setTimeout(()=>bar.style.display='none',2800);}
function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }

/* ===== IndexedDB + Fallback ===== */
window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;
const hasIDB=!!window.indexedDB, LS_PREFIX='yaqfb_', DB_NAME='yaqoobi_observations', DB_VER=40, STORE='teachers';
let USE_LS=false, dbPromise=null;
const lsGet=k=>{try{return JSON.parse(localStorage.getItem(LS_PREFIX+k)||'null');}catch{return null;}};
const lsSet=(k,v)=>{try{localStorage.setItem(LS_PREFIX+k,JSON.stringify(v));}catch{}};
const lsDel=k=>{try{localStorage.removeItem(LS_PREFIX+k);}catch{}};
async function openDB(){ if(dbPromise) return dbPromise; dbPromise=new Promise(res=>{ if(!hasIDB){USE_LS=true;return res(null);} let req; try{req=indexedDB.open(DB_NAME,DB_VER);}catch{USE_LS=true;return res(null);} req.onupgradeneeded=e=>{try{const db=e.target.result; let os; if(!db.objectStoreNames.contains(STORE)){os=db.createObjectStore(STORE,{keyPath:'teacherId'});}else{os=req.transaction.objectStore(STORE);} if(os && !os.indexNames.contains('by_name')) os.createIndex('by_name','name',{unique:false});}catch{USE_LS=true;}}; req.onsuccess=()=>res(req.result); req.onerror=()=>{USE_LS=true;res(null);}; }); return dbPromise;}
async function dbPut(rec){ lsSet('t_'+rec.teacherId,rec); if(USE_LS){return true;} const db=await openDB(); if(!db) return true; return new Promise(r=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(rec).onsuccess=()=>r(true); tx.onerror=()=>r(true); });}
async function dbGet(key){ if(USE_LS) return lsGet('t_'+key)||null; const db=await openDB(); if(!db) return lsGet('t_'+key)||null; return new Promise(r=>{const tx=db.transaction(STORE,'readonly'); tx.objectStore(STORE).get(key).onsuccess=e=>r(e.target.result||lsGet('t_'+key)||null); tx.onerror=()=>r(lsGet('t_'+key)||null);});}
async function dbAll(){ if(USE_LS){ const out=[]; for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i); if(k&&k.startsWith(LS_PREFIX+'t_')){ const v=lsGet(k.replace(LS_PREFIX,'')); if(v) out.push(v);} } return out; } const db=await openDB(); if(!db) return []; return new Promise(r=>{ const a=[]; const tx=db.transaction(STORE,'readonly'); tx.objectStore(STORE).openCursor().onsuccess=e=>{const c=e.target.result; if(c){a.push(c.value); c.continue();}else r(a);}; tx.onerror=()=>r(a);});}
async function dbClear(){ if(USE_LS){ for(let i=localStorage.length-1;i>=0;i--){const k=localStorage.key(i); if(k&&k.startsWith(LS_PREFIX)) localStorage.removeItem(k);} return;} const db=await openDB(); if(!db) return; await new Promise(r=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).clear().onsuccess=()=>r(true); tx.onerror=()=>r(true); });}

/* ===== Ø±Ø£Ø³ Ù…Ø­ÙÙˆØ¸ + Ø§Ù„ØªØ§Ø±ÙŠØ® ===== */
const LS_HEAD='hdr_v1'; function saveHead(){const o={hsa:$('#h-sa').textContent,hmo:$('#h-moed').textContent,hdir:$('#h-dir').textContent,hschool:$('#h-school').textContent}; localStorage.setItem(LS_HEAD,JSON.stringify(o));}
(()=>{ try{const o=JSON.parse(localStorage.getItem(LS_HEAD)||'null'); if(o){$('#h-sa').textContent=o.hsa;$('#h-moed').textContent=o.hmo;$('#h-dir').textContent=o.hdir;$('#h-school').textContent=o.hschool;}}catch{} })();
$('#penDir').onclick=()=>toggleEdit('h-dir'); $('#penSchool').onclick=()=>toggleEdit('h-school');
function toggleEdit(id){const el=$('#'+id); const on=el.getAttribute('contenteditable')==='true'; el.setAttribute('contenteditable',!on); if(on) saveHead(); el.focus();}
function hijriNow(){ try{ return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date()); }catch{return 'â€”';} }
$('#hijriChip').textContent='Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ: '+hijriNow();

/* ===== Ø¨Ù†Ùƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… (ØªÙ…ÙŠÙ‘Ø²/Ø§Ø­ØªÙŠØ§Ø¬) ===== */
const learnBank={
 "Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ù„Ù„ØªØ¹Ù„Ù‘Ù…":{
  "ØµÙŠØ§ØºØ© Ø£Ù‡Ø¯Ø§Ù ØªØ¹Ù„Ù‘Ù… Ø³Ù„ÙˆÙƒÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³":{ok:"Ù‡Ø¯Ù ÙˆØ§Ø¶Ø­ Ø¨Ù…Ø¤Ø´Ø± Ø¥ØªÙ‚Ø§Ù† Ù…ÙØ¹Ù„Ù†.",need:"ØµÙŠØ§ØºØ© SMART ÙˆØ±Ø¨Ø· Ø§Ù„Ù‡Ø¯Ù Ø¨Ø£Ø¯Ø§Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…."},
  "Ù…ÙˆØ§Ø¡Ù…Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ø¹ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù":{ok:"ÙƒÙ„ Ù†Ø´Ø§Ø· ÙŠØ®Ø¯Ù… Ù‡Ø¯ÙÙ‹Ø§ Ù…ÙØ¹Ù„ÙÙ†Ù‹Ø§ Ø¨ØªØ³Ù„Ø³Ù„ Ù…Ù†Ø·Ù‚ÙŠ.",need:"Ø®Ø±ÙŠØ·Ø© Â«Ù†Ø´Ø§Ø·â†”Ù‡Ø¯ÙÂ» ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ù†Ø´Ø·Ø©."},
  "ØªÙ‡ÙŠØ¦Ø© ÙˆØ±Ø¨Ø· Ø§Ù„ØªØ¹Ù„Ù‘Ù… Ø¨Ø®Ø¨Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©":{ok:"Ø³Ø¤Ø§Ù„ ØªØ´Ø®ÙŠØµÙŠ ÙˆØ£Ù…Ø«Ù„Ø© Ø³ÙŠØ§Ù‚ÙŠØ© ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© ØªØµÙˆØ±Ø§Øª.",need:"Ø£Ø³Ø¦Ù„Ø© ØªÙ…Ù‡ÙŠØ¯ÙŠØ© ÙØ¹Ù‘Ø§Ù„Ø© ÙˆØ³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø±Ø¨Ø· Ø¨ØµØ±ÙŠ."}
 },
 "Ø§Ù„ØªÙ†ÙˆÙ‘Ø¹ ÙÙŠ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³":{
  "ØªÙˆØ¸ÙŠÙ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØªØ¹Ù„Ù‘Ù… Ù†Ø´Ø· ÙˆÙ…ØªÙ†ÙˆÙ‘Ø¹Ø©":{ok:"ØªÙ†ÙˆÙŠØ¹ ÙØ±Ø¯ÙŠ/Ø«Ù†Ø§Ø¦ÙŠ/Ø¬Ù…Ø§Ø¹ÙŠ Ø¨Ø£Ø¯ÙˆØ§Ø± ÙˆØ²Ù…Ù†.",need:"Ø­Ù‚ÙŠØ¨Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¯ÙˆØ§Ø± ÙˆÙ…Ø¤Ù‚Ù‘Øª."},
  "ØªÙ†Ù…ÙŠØ© Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„Ø­ÙˆØ§Ø± ÙˆØ§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©":{ok:"Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„ÙŠØ§ ÙˆØªÙˆØ²ÙŠØ¹ Ø¹Ø§Ø¯Ù„ ÙˆØªÙ„Ø®ÙŠØµ Ù…Ø±Ø­Ù„ÙŠ.",need:"Ù†Ù…Ø§Ø°Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø´ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡."},
  "ØªÙØ±ÙŠØ¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆÙÙ‚ Ø§Ù„ÙØ±ÙˆÙ‚ Ø§Ù„ÙØ±Ø¯ÙŠØ©":{ok:"Ù†Ø³Ø® Ù…ØªØ¯Ø±Ø¬Ø© ÙˆØ¯Ø¹Ù… Ù…ÙˆØ¬Ù‘Ù‡ ÙˆØ¥Ø«Ø±Ø§Ø¡.",need:"ØªØµÙ…ÙŠÙ… Ù…Ù‡Ø§Ù… Ù…ØªÙ…Ø§ÙŠØ²Ø© ÙˆØªÙˆØ«ÙŠÙ‚ Ø£Ø«Ø± Ø§Ù„ØªÙØ±ÙŠØ¯."}
 },
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ":{
  "ØªÙ†Ø¸ÙŠÙ… Ø§Ù„ÙˆÙ‚Øª ÙˆØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø­ØµØ© ÙˆØ§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø©":{ok:"ØªÙ‚Ø³ÙŠÙ… ÙˆØ§Ø¶Ø­ ÙˆÙ…Ø¤Ù‚Ù‘Øª ÙˆØ®Ø§ØªÙ…Ø©.",need:"Ø®Ø· Ø²Ù…Ù†ÙŠ ÙˆØªÙ‚Ù„ÙŠÙ„ ÙØ§Ù‚Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„."},
  "ÙˆØ¶ÙˆØ­ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ§Ù„ØªØ¯Ø±Ù‘Ø¬ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ":{ok:"Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¹Ù„Ù†Ø© ÙˆØ§Ø³ØªØ¬Ø§Ø¨Ø© Ù…ØªØ¯Ø±Ù‘Ø¬Ø©.",need:"Ù…ÙŠØ«Ø§Ù‚ ØµÙÙ‘ÙŠ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ."},
  "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª/Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„ØµÙÙŠØ©":{ok:"Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ø¶Ø­Ø© ÙˆØ­Ø±ÙƒØ© Ù…Ù†Ø¸Ù…Ø© ÙˆØªÙ‚Ø§Ø±ÙŠØ±.",need:"Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¯ÙˆØ§Ø±."}
 },
 "ØªÙˆØ¸ÙŠÙ Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„Ù‘Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©":{
  "ØªÙˆØ¸ÙŠÙ Ø§Ù„Ù…Ù†ØµØ§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø¨Ù…Ø§ ÙŠØ®Ø¯Ù… Ø§Ù„Ù‡Ø¯Ù":{ok:"Ù†Ø´Ø§Ø· Ø±Ù‚Ù…ÙŠ ÙŠÙ‚ÙŠØ³ Ø§Ù„Ù‡Ø¯Ù ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù….",need:"Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¯Ø§Ø© Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆÙ†Ø´Ø±/Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù†ØµØ©."},
  "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø®ØµÙˆØµÙŠØ©":{ok:"ØªØ°ÙƒÙŠØ± Ø£Ù…Ø§Ù† ÙˆØ¹Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª.",need:"Ø³ÙŠØ§Ø³Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¢Ù…Ù† ÙˆÙ‚Ø§Ø¦Ù…Ø© ØªØ­Ù‚Ù‚."}
 },
 "ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ¦Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©":{
  "Ù…Ù†Ø§Ø® ØªØ¹Ù„Ù‘Ù… Ø¯Ø§Ø¹Ù… ÙˆØ§Ø­ØªØ±Ø§Ù… Ù…ØªØ¨Ø§Ø¯Ù„":{ok:"ØªØ¹Ø²ÙŠØ² Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆÙ„ØºØ© Ø¬Ø³Ø¯ Ø¯Ø§Ø¹Ù…Ø©.",need:"Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØªØ¹Ø²ÙŠØ² ØºÙŠØ± Ù…Ø§Ø¯ÙŠ ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø«Ù‚Ø©."},
  "ØªÙ‡ÙŠØ¦Ø© Ù†ÙØ³ÙŠØ© ÙˆØ§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù…Ù„Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø±Ø­Ù„Ø©":{ok:"ØªÙƒÙŠÙŠÙ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆÙƒØ³Ø± Ø¬Ù„ÙŠØ¯ ÙˆØ¥Ø´Ø§Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø©.",need:"Ø®ØµØ§Ø¦Øµ Ù†Ù…Ùˆ ÙˆØ£Ù†Ø´Ø·Ø© ØªÙ‡ÙŠØ¦Ø© Ù‡Ø§Ø¯ÙØ©."},
  "Ø¥Ø«Ø§Ø±Ø© Ø§Ù„Ø¯Ø§ÙØ¹ÙŠØ© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©":{ok:"Ø£Ù‡Ø¯Ø§Ù Ù…ÙØ¹Ù„Ù†Ø© ÙˆÙ…Ù‡Ø§Ù… Ø°Ø§Øª Ù…Ø¹Ù†Ù‰ ÙˆØªØªØ¨Ø¹ Ù…Ø´Ø§Ø±ÙƒØ©.",need:"ØªØµÙ…ÙŠÙ… Ù…Ø­ÙÙ‘Ø²Ø§Øª ÙˆØ£Ø¯ÙˆØ§Øª Ù‚ÙŠØ§Ø³ Ù…Ø´Ø§Ø±ÙƒØ©."}
 },
 "ØªÙ†ÙˆÙ‘Ø¹ Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ…":{
  "ØªÙ‚ÙˆÙŠÙ… Ù‚Ø¨Ù„ÙŠ ØªØ´Ø®ÙŠØµÙŠ":{ok:"Ø³Ø¤Ø§Ù„ Ø§ÙØªØªØ§Ø­ÙŠ ÙˆØ§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØªÙˆØ«ÙŠÙ‚.",need:"Ø¨Ù†ÙˆÙƒ Ø£Ø³Ø¦Ù„Ø© ÙˆØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹."},
  "ØªÙ‚ÙˆÙŠÙ… Ø¨Ù†Ø§Ø¦ÙŠ Ù…Ø³ØªÙ…Ø±":{ok:"Ø£Ø³Ø¦Ù„Ø© ÙÙˆØ±ÙŠØ© + Ø¨Ø·Ø§Ù‚Ø© Ø®Ø±ÙˆØ¬ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±.",need:"Ø£Ø¯ÙˆØ§Øª Ù‚ØµÙŠØ±Ø© ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù†ÙˆØ¹ÙŠØ©."},
  "ØªÙ‚ÙˆÙŠÙ… Ø®ØªØ§Ù…ÙŠ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø£Ù‡Ø¯Ø§Ù":{ok:"Ù…Ù‡Ù…Ø© Ø£Ø¯Ø§Ø¡/Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Rubric Ù…ÙØ¹Ù„Ù†.",need:"Ù…Ù‡Ø§Ù… Ø£Ø¯Ø§Ø¡ Ø£ØµÙŠÙ„Ø© ÙˆRubrics ÙˆØ§Ø¶Ø­Ø©."},
  "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØªÙˆØ¸ÙŠÙ Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©":{ok:"Ù…Ø¤Ø´Ø±Ø§Øª ÙˆÙ‚Ø±Ø§Ø±Ø§Øª ØªØ­Ø³ÙŠÙ† ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø£Ø«Ø±.",need:"ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙÙ‘ÙŠØ© ÙˆØ®Ø·Ø· Ù‚ØµÙŠØ±Ø©."}
 },
 "Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ù‡Ù†ÙŠ ÙˆØ§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³":{
  "ØªØ£Ù…Ù‘Ù„ Ù…Ù‡Ù†ÙŠ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯":{ok:"ØªØ£Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø³ ÙˆØ±Ø¨Ø· Ø¨Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯.",need:"Ù†Ù…Ø§Ø°Ø¬ WWW/EBI ÙˆØªÙ†Ø¸ÙŠÙ… Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø²."},
  "Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ù‚ØµÙŠØ±Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª":{ok:"Ù‡Ø¯Ù Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¨Ù…Ø¤Ø´Ø± ÙˆØ¥Ø¬Ø±Ø§Ø¡ ÙˆØªÙ‚ÙˆÙŠÙ… Ø£Ø«Ø±.",need:"ØµÙŠØ§ØºØ© Ø£Ù‡Ø¯Ø§Ù Ù‚ØµÙŠØ±Ø© ÙˆØ¯ÙˆØ±Ø§Øª ØªØ­Ø³ÙŠÙ†."}
 }
};
const fields=Object.keys(learnBank).map(d=>({name:d,items:Object.keys(learnBank[d]).map(k=>[k,""])}));

/* ===== Ø¨Ù†Ùƒ Ø§Ù„Ø¯Ø¹Ù… (Ù…Ø®ØªØµØ± Ø¹Ø±Ø¨ÙŠ) ===== */
const supportBank = [
 "Ù‡Ø¯Ù Ø³Ù„ÙˆÙƒÙŠ Ù…ÙØ¹Ù„Ù† + Ø¨Ø·Ø§Ù‚Ø© Ø®Ø±ÙˆØ¬ â€” Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ â€” Ø¥ØªÙ‚Ø§Ù† â‰¥ Ù¨Ù Ùª.",
 "Ø´Ø±ÙŠØ­Ø© (Ù†Ø´Ø§Ø· â†” Ù‡Ø¯Ù) â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© â€” Ø§ØªØ³Ø§Ù‚ Ù¡Ù Ù Ùª.",
 "ØªØ­Ù„ÙŠÙ„ Ù†ØªÙŠØ¬ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ† â€” ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ† â€” ØªØ­Ø³Ù‘Ù† â‰¥ Ù¡Ù Ùª.",
 "ÙÙÙƒØ±â€“Ø²Ø§ÙˆÙØ¬â€“Ø´Ø§Ø±ÙÙƒ (Ù¦ Ø¯) Ø¨Ø£Ø¯ÙˆØ§Ø± â€” Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© â€” Ù…Ø´Ø§Ø±ÙƒØ© â‰¥ Ù§Ù Ùª.",
 "Ø³ÙÙ„Ù‘Ù… ØªÙ‚Ø¯ÙŠØ± Ù„Ù„Ø­ÙˆØ§Ø± (Ù¤ Ù…Ø³ØªÙˆÙŠØ§Øª) â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© â€” ØªØ­Ù‚ÙŠÙ‚ â‰¥ Ù£/Ù¤.",
 "ØªÙØ±ÙŠØ¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø³Ø®ØªÙŠÙ† Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†ØµÙ‘Ø© â€” Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ â€” Ø¥ÙƒÙ…Ø§Ù„ â‰¥ Ù©Ù Ùª.",
 "Ø®Ø·Ø© Ø²Ù…Ù†ÙŠØ© Ù¥â€“Ù¢Ù¥â€“Ù¡Ù  + Ù…Ø¤Ù‚Ù‘Øª â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ â€” ÙØ§Ù‚Ø¯ â‰¤ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†.",
 "Ù‚ÙˆØ§Ø¹Ø¯ Ù…ÙØ¹Ù„Ù†Ø© ÙˆØªØ¯Ø±Ù‘Ø¬ Ø§Ø³ØªØ¬Ø§Ø¨Ø© â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ â€” Ø®ÙØ¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª â‰¥ Ù¥Ù Ùª.",
 "Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¯ÙˆØ§Ø± ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ù‚ØµÙŠØ±Ø© â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ â€” ØªØ³Ù„ÙŠÙ… ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.",
 "ÙˆØ§Ø¬Ø¨ Ù‚ØµÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†ØµÙ‘Ø© â€” Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ â€” Ø¥ÙƒÙ…Ø§Ù„ â‰¥ Ù©Ù Ùª.",
 "Ø³Ù„Ø§Ù…Ø© Ø±Ù‚Ù…ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø§Ø· â€” Ø§Ù„Ø¹Ø±ÙˆØ¶ â€” Ù…Ø®Ø§Ù„ÙØ§Øª = ØµÙØ±.",
 "ØªÙ…Ù‡ÙŠØ¯ Ø¨ØµØ±ÙŠ (Ù¢ Ø¯) â€” Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø¦ÙŠ â€” Ù…Ø´Ø§Ø±ÙƒØ© Ø§ÙØªØªØ§Ø­ÙŠØ© â‰¥ Ù¦Ù Ùª.",
 "Ù…Ù‡Ù…Ø© Ù…Ù†ØªØ¬ Ù£â€“Ù¥ Ø¯ â€” Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© â€” Ø¥Ù†Ø¬Ø§Ø² â‰¥ Ù¨Ù Ùª.",
 "Ø³Ø¤Ø§Ù„ Ø§ÙØªØªØ§Ø­ÙŠ + Ø¨Ø·Ø§Ù‚Ø© Ø®Ø±ÙˆØ¬ â€” Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø³Ø±ÙŠØ¹ â€” Ø§ØªØ³Ø§Ù‚ Ù¡Ù Ù Ùª.",
 "Ù…Ù‡Ù…Ø© Ø£Ø¯Ø§Ø¡ + Ø³ÙÙ„Ù‘Ù… ØªÙ‚Ø¯ÙŠØ± Ù…ÙØ¹Ù„Ù† â€” Ø§Ù„Ø¹Ø±ÙˆØ¶/Ø§Ù„Ù…Ù†ØµØ© â€” Ø¥Ù†Ø¬Ø§Ø² â‰¥ Ù¨Ù Ùª.",
 "Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª (Ø¥ØªÙ‚Ø§Ù†/Ù…Ø´Ø§Ø±ÙƒØ©) â€” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ â€” Ù‚Ø±Ø§Ø±Ø§Øª Ù…Ø¤Ø±Ø®Ø©."
];

/* ===== Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© ===== */
let activeVisit=1, store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()}, loadedRecord=null, fixedKey=null;
function zeroMatrix(){ return fields.map(f=>Array(f.items.length).fill(0)); }

/* ===== Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© (Ù‚Ø§Ø¦Ù…Ø©) ===== */
const toolsData=[
  {title:'ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†',proof:'Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¥ØªÙ‚Ø§Ù† ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.'},
  {title:'ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù„Ù…ÙŠØ©',proof:'Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„.'},
  {title:'ØªÙØ¹ÙŠÙ„ Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³ØªÙŠ ÙˆÙ…ØªØ§Ø¨Ø¹ØªÙ‡Ø§',proof:'Ù†Ø´Ø± Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ±ØµØ¯ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… Ø±Ù‚Ù…ÙŠÙ‹Ø§.'},
  {title:'ØªÙØ¹ÙŠÙ„ ÙƒØªØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨',proof:'ØªÙˆØ¸ÙŠÙ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù…Ù‡Ø§Ù… Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø£Ù‡Ø¯Ø§Ù.'},
  {title:'Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹',proof:'Ø£Ø³Ø¦Ù„Ø© ÙÙˆØ±ÙŠØ© Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù….'},
  {title:'Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©',proof:'Ø´Ø±Ø§Ø¦Ø­ Ù…Ù†Ø¸Ù‘Ù…Ø© Ø¨Ø¹Ù†Ø§ØµØ± ØªÙØ§Ø¹Ù„ÙŠØ© Ø¯Ø§Ø¹Ù…Ø©.'},
  {title:'Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©',proof:'Ù…Ù‡Ø§Ù… Ø±Ù‚Ù…ÙŠØ© Ù‚ØµÙŠØ±Ø© Ù…ØªØ¯Ø±Ø¬Ø©.'},
  {title:'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø¦ÙŠ ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø©',proof:'ÙÙŠØ¯ÙŠÙˆ/Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ‚Ø±Ù‘Ø¨ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ….'},
  {title:'Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ù‡Ù†ÙŠ',proof:'ØªØ¨Ø§Ø¯Ù„ Ù…Ù…Ø§Ø±Ø³Ø§Øª ÙˆØ´ÙˆØ§Ù‡Ø¯.'},
  {title:'Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±',proof:'ØªÙˆØ§ØµÙ„ Ù…Ø®ØªØµØ± Ø¯Ø§Ø¹Ù… Ù„ØªØ¹Ù„Ù‘Ù… Ø§Ù„Ø·Ø§Ù„Ø¨.'}
];

/* ===== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ===== */
function buildLearning(){
  const tbody=$('#rows'); tbody.innerHTML='';
  fields.forEach((f,fi)=>{
    f.items.forEach((pair,ii)=>{
      const [label]=pair;
      const tr=document.createElement('tr'); tr.className='field-row';
      if(ii===0){
        tr.classList.add('field-start');
        tr.innerHTML+=`<td class="seq" rowspan="${f.items.length}">${fi+1}</td><td rowspan="${f.items.length}" class="domain-cell">${f.name}</td>`;
      }
      tr.innerHTML+=`
        <td class="item-cell"><span class="item-title">${label}</span></td>
        <td><div class="level">
            <button data-v="1">Ø¶Ø¹ÙŠÙ</button>
            <button data-v="2">Ù…ØªÙˆØ³Ø·</button>
            <button data-v="3">Ù…ØªÙ…ÙŠØ²</button>
        </div></td>
        <td class="sugg-cell" data-sugg="ok">â€”</td>
        <td class="sugg-cell" data-sugg="need">â€”</td>`;
      tbody.appendChild(tr);

      const btns=[...tr.querySelectorAll('.level button')];
      const saved=store[activeVisit][fi][ii];
      if(saved>0){ btns.forEach(b=>b.classList.toggle('active',+b.dataset.v===saved)); applyRowTexts(tr,fi,label,saved); }
      btns.forEach(b=>b.addEventListener('click',()=>{
        btns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const v=+b.dataset.v; store[activeVisit][fi][ii]=v;
        tr.classList.remove('row-missing');
        applyRowTexts(tr,fi,label,v);
        saveDraftActiveVisit(); recalc();
      }));
    });
  });
}
function applyRowTexts(tr,fi,label,lvl){
  const okCell=tr.querySelector('[data-sugg="ok"]'), needCell=tr.querySelector('[data-sugg="need"]');
  const domain=fields[fi].name;
  const bank=learnBank[domain]?.[label];
  okCell.textContent = (lvl===3 && bank?.ok) ? bank.ok : (lvl===2 ? 'ØªÙ‚Ø¯Ù… Ù…Ù„Ø­ÙˆØ¸ ÙŠØ­ØªØ§Ø¬ ØªØ«Ø¨ÙŠØªÙ‹Ø§.' : 'â€”');
  needCell.textContent = (lvl<3 && bank?.need) ? bank.need : (lvl===1 ? 'ØªØ¯Ø®Ù„ Ù‚ØµÙŠØ± Ø¨Ø®Ø·ÙˆØ§Øª ÙˆØ§Ø¶Ø­Ø©.' : 'â€”');
}
function buildTools(){
  const tb=$('#toolsRows'); tb.innerHTML='';
  toolsData.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="seq">${i+1}</td>
      <td><div class="tool-title">${t.title}</div><div class="tool-brief">${t.proof||''}</div></td>
      <td class="td-proof"><input type="checkbox" title="Ø´Ø§Ù‡Ø¯Øª Ø§Ù„Ø¯Ù„ÙŠÙ„ØŸ"></td>
      <td><div class="level tool-level">
            <button data-v="1" title="ØºÙŠØ± Ù…ÙÙØ¹Ù„">ØºÙŠØ± Ù…ÙÙØ¹Ù„</button>
            <button data-v="2" title="Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§">Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§</button>
            <button data-v="3" title="Ù…ÙÙØ¹Ù„">Ù…ÙÙØ¹Ù„</button>
          </div></td>
      <td><textarea class="tool-reason" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø²Ø¦ÙŠâ€¦"></textarea></td>`;
    tb.appendChild(tr);
    const set=tr.querySelector('.tool-level');
    set.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        set.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const v=+btn.dataset.v; const reason=tr.querySelector('.tool-reason');
        reason.disabled=(v===3); if(v===3) reason.value='';
        saveDraftActiveVisit(); recalc();
      });
    });
    tr.querySelector('.tool-reason').addEventListener('input',()=>{ saveDraftActiveVisit(); });
  });
}

/* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ===== */
function getToolsStateFromUI(){ return [...document.querySelectorAll('.tool-level')].map(set=>{ const act=set.querySelector('button.active'); if(!act) return null; const v=+act.dataset.v; return (v===3)?2:((v===2)?1:0); }); }
function setToolsStateToUI(arr){ const sets=[...document.querySelectorAll('.tool-level')]; sets.forEach((set,i)=>{ set.querySelectorAll('button').forEach(b=>b.classList.remove('active')); const s=(arr&&typeof arr[i]!=='undefined')?arr[i]:null; if(s===0||s===1||s===2){ const target=s===2?3:(s===1?2:1); (set.querySelector(`button[data-v="${target}"]`)||{}).classList?.add('active'); const reason=set.parentElement.nextElementSibling.querySelector('.tool-reason'); reason.disabled=(s===2); if(s===2) reason.value=''; } }); }
function getToolReasonsFromUI(){ return [...document.querySelectorAll('.tool-reason')].map(t=>(t.value||'').trim()); }

/* ===== Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ===== */
function levelLabelFromPct(v){ return v>=80?'Ù…ØªÙ…ÙŠØ²':(v>=50?'Ù…ØªÙˆØ³Ø·':'Ø¶Ø¹ÙŠÙ'); }
function levelColor(v){ return v>=80?'#16a34a':(v>=50?'#f59e0b':'#ef4444'); }
function visitScore(v){
  // 85% Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… + 15% Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Øª
  const area=store[v].flat().filter(Boolean);
  const areaPct=area.length? (area.reduce((a,b)=>a+b,0)/(area.length*3))*85:0;
  const states=getToolsArrayForVisit(v);
  const tScaled=((states.reduce((a,b)=>a+(b===2?1:(b===1?0.5:0)),0)/(states.length||1))*15);
  return Math.min(100,Math.round(areaPct+tScaled));
}
function setDonut(v,p){
  const svg=$('#v'+v), ring=svg.querySelector('.ring'), txt=$('#v'+v+'t');
  const per=Math.max(0,Math.min(100,Math.round(p||0)));
  const c=2*Math.PI*50; ring.setAttribute('stroke-dasharray',`${(per/100)*c} ${c}`); ring.setAttribute('stroke',levelColor(per));
  txt.textContent=levelLabelFromPct(per);
}
function setVisitPercents(){ setDonut(1,visitScore(1)); setDonut(2,visitScore(2)); setDonut(3,visitScore(3)); }
function computeGlobalScore(){
  const p1=visitScore(1),p2=visitScore(2),p3=visitScore(3);
  const exp=Number(($('#exp').value||'').replace(/\D+/g,''))||0;
  const isNew=(exp>0&&exp<=2);
  if(isNew || p1<50){ const arr=[p1,p2,p3].filter(x=>x>0); return arr.length?Math.round(arr.reduce((a,b)=>a+b,0)/arr.length):0;}
  const arr=[p1,p2].filter(x=>x>0); return arr.length?Math.round(arr.reduce((a,b)=>a+b,0)/arr.length):0;
}
function applyMeters(){
  const g=computeGlobalScore(); const v=Math.max(0,Math.min(100,g));
  $('#globalThumb').style.left=v+'%'; $('#globalThumb').style.borderColor=levelColor(v);
  const t=$('#globalPctInline'); t.textContent=levelLabelFromPct(v);
  t.className='globalInline '+(v>=80?'good':(v>=50?'mid':'bad'));
  const cur=visitScore(activeVisit);
  $('#hThumb').style.left=(Math.max(0,Math.min(100,cur)))+'%';
  $('#hThumb').style.borderColor=levelColor(cur);
  $('#kpiPct').textContent=levelLabelFromPct(cur);
}
function recalc(){ setVisitPercents(); applyMeters(); generateSupport(); }

/* ===== Ø¯Ø¹Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ + Ø§Ù„Ø£Ø¯ÙˆØ§Øª ===== */
function generateSupport(){
  // Ù¤ Ø£Ø³Ø·Ø±: Ø³Ø­Ø¨ Ø°ÙƒÙŠ Ù…Ù† supportBank Ø¨Ø­Ø³Ø¨ Ø£Ø¶Ø¹Ù Ù…Ø¬Ø§Ù„ + Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª
  const lines=[];
  // 1) Ø¨Ù†Ø§Ø¡ Ù…ØªÙˆØ³Ø· Ù„ÙƒÙ„ Ù…Ø¬Ø§Ù„ ÙÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const ranked=fields.map((f,fi)=>{ const arr=store[activeVisit][fi]||[]; const filled=arr.filter(v=>v>0); const avg=filled.length?(filled.reduce((a,b)=>a+b,0)/filled.length):0; return {fi,avg,name:f.name}; }).sort((a,b)=>a.avg-b.avg);
  ranked.slice(0,2).forEach(({avg})=>{
    if(avg<1.6){ lines.push(supportBank[0]); }
    else if(avg<2.3){ lines.push(supportBank[3]); }
    else{ lines.push(supportBank[1]); }
  });
  // 2) Ø§Ù„Ø£Ø¯ÙˆØ§Øª: Ø£ÙˆÙ„ Ø£Ø¯Ø§ØªÙŠÙ† Ø£Ù‚Ù„ ØªÙØ¹ÙŠÙ„Ù‹Ø§
  const states=getToolsStateFromUI(), reasons=getToolReasonsFromUI();
  const idxSorted=states.map((v,i)=>({i,v})).sort((a,b)=> (a.v??-1)-(b.v??-1));
  idxSorted.slice(0,2).forEach(({i,v})=>{
    let pick=(v===2)? 14 : (v===1? 10 : 9);
    let tip=supportBank[pick]||supportBank[0];
    const why=(reasons[i]||'').trim(); if(why) tip+=` (Ù…Ø§Ù†Ø¹: ${why.slice(0,40)})`;
    lines.push(tip);
  });
  const ta=$('#supportArea'); ta.value = lines.filter(Boolean).slice(0,4).join('\n'); autoGrow(ta);
}

/* ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø©/Ø§Ù„ØªØ§Ø±ÙŠØ® ===== */
['1','2','3'].forEach(v=>{
  $('#v'+v).addEventListener('click',()=>switchVisit(+v));
  $('#v'+v+'h').addEventListener('click',()=>{ const d=hijriNow(); setChip(+v,d); saveDraftActiveVisit(); });
});
function setChip(v,txt){ $('#v'+v+'h').textContent=txt||'â€”'; ['1','2','3'].forEach(n=>$('#sh'+n).textContent=$('#v'+n+'h').textContent||'â€”'); }
function allowedThirdVisit(){
  const exp=Number(($('#exp').value||'').replace(/\D+/g,''))||0;
  const isNew=(exp>0 && exp<=2);
  return isNew || visitScore(1)<50 || visitScore(2)<50;
}
function switchVisit(v){
  if(v===3 && !allowedThirdVisit()){ showSnack('Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© Ù„Ù„Ø¯Ø¹Ù… (Ø¬Ø¯ÙŠØ¯ â‰¤ Ø³Ù†ØªÙŠÙ† Ø£Ùˆ Ø¶Ø¹ÙŠÙ ÙÙŠ Ù¡/Ù¢).','err'); return; }
  activeVisit=v; buildLearning(); buildTools(); renderToolsForVisit(); renderSupportForVisit(); recalc();
}

/* ===== Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ ===== */
function keyFromInputs(){
  const id=($('#tId').value||'').replace(/\D+/g,'');
  if(/^\d{10}$/.test(id)) return id;
  const name=($('#tName').value||'').trim();
  return name?('name:'+name):'';
}
function updateSignNames(){
  const n=($('#tName').value||'â€”').trim();
  ['sn1','sn2','sn3'].forEach(id=>$('#'+id).textContent=n||'â€”');
}
function getToolsArrayForVisit(v){ const snap=loadedRecord?.visits?.[v]||null; return (snap?.draft?.tools||[])||[]; }
function renderToolsForVisit(){
  const snap=loadedRecord?.visits?.[activeVisit];
  const arr=snap?.draft?.tools||[]; const reasons=snap?.draft?.reasons||[];
  setToolsStateToUI(arr);
  $$('#toolsTbl .tool-reason').forEach((ta,i)=>{ ta.value=(reasons[i]||''); ta.disabled=(arr[i]===2); });
}
function renderSupportForVisit(){
  const snap=loadedRecord?.visits?.[activeVisit]; const lines=(snap?.draft?.support||[]);
  if(lines && lines.length){ const ta=$('#supportArea'); ta.value=lines.join('\n'); autoGrow(ta); } else { generateSupport(); }
}
async function saveDraftActiveVisit(){
  const key=currentKey(); if(!key) return;
  if(!loadedRecord){ loadedRecord = await dbGet(key) || {teacherId:key, name:($('#tName').value||'').trim(), nationalId:($('#tId').value||'').replace(/\D+/g,'').slice(0,10), spec:($('#tSpec').value||'').trim(), degree:($('#degree').value||'').trim(), exp:($('#exp').value||'').trim(), class:($('#class').value||'').trim(), lesson:($('#lesson').value||'').trim(), visits:{}}; [1,2,3].forEach(v=>loadedRecord.visits[v]??={finalized:false,draft:{ratings:zeroMatrix(),tools:[],reasons:[],support:[],date:''}}); fixedKey=key; }
  const v=activeVisit; loadedRecord.visits[v].draft.ratings=store[v];
  loadedRecord.visits[v].draft.tools=getToolsStateFromUI();
  loadedRecord.visits[v].draft.reasons=getToolReasonsFromUI();
  loadedRecord.visits[v].draft.support=($('#supportArea').value||'').split('\n').map(s=>s.trim()).filter(Boolean).slice(0,4);
  loadedRecord.visits[v].draft.date=$('#v'+v+'h').textContent||'';
  // Ø¹Ø§Ù…
  loadedRecord.name=($('#tName').value||'').trim();
  loadedRecord.nationalId=($('#tId').value||'').replace(/\D+/g,'').slice(0,10);
  loadedRecord.spec=($('#tSpec').value||'').trim();
  loadedRecord.degree=($('#degree').value||'').trim();
  loadedRecord.exp=($('#exp').value||'').trim();
  loadedRecord.class=($('#class').value||'').trim();
  loadedRecord.lesson=($('#lesson').value||'').trim();
  await dbPut(loadedRecord);
}
function currentKey(){ if(fixedKey) return fixedKey; return keyFromInputs(); }
async function loadRecord(){
  const key=currentKey(); if(!key) return;
  const rec=await dbGet(key);
  if(rec){
    loadedRecord=rec; fixedKey=rec.teacherId;
    $('#tName').value=rec.name||''; $('#tId').value=rec.nationalId||''; $('#tSpec').value=rec.spec||'';
    $('#degree').value=rec.degree||''; $('#exp').value=rec.exp||''; $('#class').value=rec.class||''; $('#lesson').value=rec.lesson||'';
    updateSignNames();
    [1,2,3].forEach(v=>{
      store[v]=rec.visits?.[v]?.draft?.ratings || zeroMatrix();
      const d=rec.visits?.[v]?.draft?.date||''; if(d) setChip(v,d);
    });
    buildLearning(); buildTools(); renderToolsForVisit(); renderSupportForVisit(); recalc();
  }else{
    loadedRecord={teacherId:key, name:($('#tName').value||'').trim(), nationalId:($('#tId').value||'').replace(/\D+/g,'').slice(0,10), spec:($('#tSpec').value||'').trim(), degree:($('#degree').value||'').trim(), exp:($('#exp').value||'').trim(), class:($('#class').value||'').trim(), lesson:($('#lesson').value||'').trim(), visits:{}};
    [1,2,3].forEach(v=>loadedRecord.visits[v]={finalized:false,draft:{ratings:zeroMatrix(),tools:[],reasons:[],support:[],date:''}});
    store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};
    ['1','2','3'].forEach(n=>setChip(+n,'â€”'));
    buildLearning(); buildTools(); renderToolsForVisit(); renderSupportForVisit(); recalc();
  }
}

/* ===== Ø¹Ø¯Ø³Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ + Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ===== */
const LS_TEACH='teachers_v1'; let teacherList=[];
function refreshLensOptions(){
  const sel=$('#lensSelect'); const q=($('#lensSearch').value||'').trim();
  sel.innerHTML=`<option value="">â€” Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…Ù‹Ø§ â€”</option>`;
  const rx=q? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i'):null;
  teacherList.filter(t=>!rx||rx.test(t.name)||rx.test(t.id)).forEach(t=>{
    const o=document.createElement('option'); o.value=t.id||('name:'+t.name);
    o.textContent=`${t.name} â€” ${t.id||'â€”'}`; sel.appendChild(o);
  });
}
function ensureTeacherListLoaded(){ if(!teacherList.length){ try{teacherList=JSON.parse(localStorage.getItem(LS_TEACH)||'[]')||[];}catch{teacherList=[];} } }
$('#btnLens').onclick=()=>{ ensureTeacherListLoaded(); refreshLensOptions(); $('#lensMenu').style.display = ($('#lensMenu').style.display==='block'?'none':'block'); };
$('#lensSearch').addEventListener('input', refreshLensOptions);
$('#lensSelect').addEventListener('change', async(e)=>{
  const val=e.target.value; if(!val) return;
  const t=teacherList.find(x=> (x.id && x.id===val) || ('name:'+x.name)===val ) || null;
  if(t){ $('#tName').value=t.name||''; $('#tId').value=(t.id||'').replace(/\D+/g,'').slice(0,10); $('#tSpec').value=t.spec||''; updateSignNames(); }
  await loadRecord();
  $('#lensMenu').style.display='none';
});
$('#lensImport').onclick=()=>$('#excelInput').click();
$('#excelInput').addEventListener('change',handleExcelImport);
function handleExcelImport(e){
  const file=e.target.files[0]; if(!file) return;
  file.arrayBuffer().then(data=>{
    const wb=XLSX.read(data,{type:'array'});
    const first=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(first,{header:1,defval:''});
    if(!rows.length){showSnack('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº.','err');return;}
    const headers=rows[0].map(h=>String(h).trim().toLowerCase());
    const norm=s=>s.replace(/\s+/g,' ').replace(/[^\u0600-\u06FFa-z0-9 ]/gi,'').trim();
    const find=(...ks)=>headers.findIndex(h=>{const n=norm(h); return ks.some(k=> n===norm(k) || n.includes(norm(k)));});
    const ixName=find('Ø§Ù„Ø§Ø³Ù…','Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…','name','full name','fullname');
    const ixId  =find('Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©','Ù‡ÙˆÙŠØ©','id','national id','Ø§Ù„Ø³Ø¬Ù„','Ø±Ù‚Ù…');
    const ixSpec=find('Ø§Ù„ØªØ®ØµØµ','Ø§Ù„Ù…Ø§Ø¯Ø©','subject','spec');
    function fallbackTen(row){for(const c of row){const s=String(c||'').replace(/\D+/g,''); if(/^\d{10}$/.test(s)) return s;} return '';}
    teacherList = rows.slice(1).filter(r=>r.some(x=>String(x).trim()!=='')).map(r=>{
      const name=(ixName>-1? r[ixName] : (r[0]||'')).toString().trim();
      let id  =(ixId>-1? String(r[ixId]) : '').replace(/\D+/g,''); if(!/^\d{10}$/.test(id)) id=fallbackTen(r);
      const spec=(ixSpec>-1? r[ixSpec] : (r[2]||'')).toString().trim();
      return {name,id:id.slice(0,10),spec};
    }).filter(x=>x.name);
    localStorage.setItem(LS_TEACH, JSON.stringify(teacherList));
    refreshLensOptions();
    showSnack('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¸Ù‡Ø±Øª Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙˆØ±Ù‹Ø§.','ok');
    e.target.value='';
  }).catch(()=>{ showSnack('ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.','err'); e.target.value=''; });
}

/* ===== Ø§Ù„Ø­Ø§ÙØ¸Ø© ===== */
$('#btnVault').onclick=async()=>{
  const list=await dbAll();
  const box=$('#approvedList'); box.innerHTML='';
  if(!list.length){ box.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ø¨Ø¹Ø¯.'; }
  list.forEach(rec=>{
    [1,2,3].forEach(v=>{
      if(rec.visits?.[v]?.finalized){
        const chip=document.createElement('span'); chip.className='name-chip';
        const tag=(v===1?'Ù¡': v===2?'Ù¢':'Ø¯Ø¹Ù…');
        chip.textContent=`${rec.name} â€” (${tag})`;
        chip.title = (rec.nationalId||'');
        box.appendChild(chip);
      }
    });
  });
  $('#approvedPanel').style.display='block';
};
$('#apClose').onclick=()=>$('#approvedPanel').style.display='none';

/* ===== ØªØ­Ù‚Ù‚ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ + Ø§Ø¹ØªÙ…Ø§Ø¯ ===== */
function validateBeforeFinalize(){
  let ok=true;
  $$('.input-error').forEach(el=>el.classList.remove('input-error'));
  $$('#rows tr').forEach(tr=>tr.classList.remove('row-missing'));

  // Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©
  ['tName','tSpec'].forEach(id=>{ const el=$('#'+id); if(!(el.value||'').trim()){ el.classList.add('input-error'); ok=false; } });

  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const d=$('#v'+activeVisit+'h').textContent||'';
  if(!d || d==='â€”'){ $('#v'+activeVisit+'h').classList.add('input-error'); ok=false; }

  // Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ù…ÙØ®ØªØ§Ø±
  let any=false;
  store[activeVisit].forEach(arr=>{ arr.forEach(v=>{ if(v>0) any=true; }); });
  if(!any){
    $$('#rows tr').forEach(tr=>{
      const active = tr.querySelector('.level button.active');
      if(!active) tr.classList.add('row-missing');
    });
    ok=false;
  }

  // Ø§Ù„Ø£Ø¯ÙˆØ§Øª: Ø¥Ù† ÙƒØ§Ù† "ØºÙŠØ± Ù…ÙÙØ¹Ù„" Ø£Ùˆ "Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§" Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ â†’ Ø¹Ù„Ù‘Ù… Ø§Ù„Ø³Ø¨Ø¨
  const states=getToolsStateFromUI(), reasons=getToolReasonsFromUI();
  states.forEach((s,i)=>{
    if((s===0||s===1) && !reasons[i]){
      const ta=$$('#toolsTbl .tool-reason')[i]; ta.classList.add('input-error'); ok=false;
    }
  });

  return ok;
}
$('#btnFinalize').onclick=async()=>{
  if(!validateBeforeFinalize()){ showSnack('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙØ¹Ù„Ù‘Ù…Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ø«Ù… Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯.','err'); return; }
  await saveDraftActiveVisit();
  loadedRecord.visits[activeVisit].finalized=true;
  await dbPut(loadedRecord);
  showSnack('ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ â€” ØªÙˆØ¬Ù‘Ù‡ Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.','ok');
};

/* ===== Ù…Ø³Ø­ Ø²ÙŠØ§Ø±Ø©/Ø§Ù„Ø¬Ù…ÙŠØ¹ ===== */
$('#btnDeleteVisit').onclick=async()=>{
  const key=currentKey(); if(!key||!loadedRecord) return;
  loadedRecord.visits[activeVisit]={finalized:false,draft:{ratings:zeroMatrix(),tools:[],reasons:[],support:[],date:''}};
  store[activeVisit]=zeroMatrix(); setChip(activeVisit,'â€”'); buildLearning(); buildTools(); renderToolsForVisit(); renderSupportForVisit(); recalc();
  await dbPut(loadedRecord); showSnack('ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©.','ok');
};
$('#btnClearAll').onclick=async()=>{ await dbClear(); teacherList=[]; localStorage.removeItem(LS_TEACH); refreshLensOptions(); showSnack('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡.','ok'); };

/* ===== ØªÙ‚Ø±ÙŠØ± (A4 Ø¹Ø±Ø¶ 190mm) ===== */
$('#btnReport').onclick=()=>{
  if(!loadedRecord){ showSnack('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ù„Ù‘Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.','err'); return; }
  const v=activeVisit;
  const td=(txt)=>`<td style="border:1px solid #cfe1dd;padding:6px;text-align:center;font-size:11px">${txt||'â€”'}</td>`;
  // Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…
  let learnRows='';
  fields.forEach((f,fi)=>{
    f.items.forEach((pair,ii)=>{
      const label=pair[0]; const val=store[v][fi][ii]||0;
      const ok = (val===3)? (learnBank[f.name]?.[label]?.ok || 'â€”') : (val===2?'ØªÙ‚Ø¯Ù… Ù…Ù„Ø­ÙˆØ¸ ÙŠØ­ØªØ§Ø¬ ØªØ«Ø¨ÙŠØªÙ‹Ø§.':'â€”');
      const need = (val<3)? (learnBank[f.name]?.[label]?.need || (val===1?'ØªØ¯Ø®Ù„ Ù‚ØµÙŠØ± Ø¨Ø®Ø·ÙˆØ§Øª ÙˆØ§Ø¶Ø­Ø©.':'â€”')) : 'â€”';
      let firstCols='';
      if(ii===0){
        firstCols = `<td rowspan="${f.items.length}" style="border:1px solid #cfe1dd;background:#f3faf8;font-weight:700;font-size:11px">${fi+1}</td>
                     <td rowspan="${f.items.length}" style="border:1px solid #cfe1dd;background:#f3faf8;font-weight:700">${f.name}</td>`;
      }
      learnRows += `<tr>${firstCols}${td(label)}${td(val? (val===1?'Ø¶Ø¹ÙŠÙ':(val===2?'Ù…ØªÙˆØ³Ø·':'Ù…ØªÙ…ÙŠØ²')):'â€”')}${td(ok)}${td(need)}</tr>`;
    });
  });
  // Ø§Ù„Ø£Ø¯ÙˆØ§Øª
  let toolRows=''; const states=getToolsStateFromUI(), reasons=getToolReasonsFromUI();
  toolsData.forEach((t,i)=>{
    const s=states[i]; const st=(s==null?'â€”': s===2?'Ù…ÙÙØ¹Ù„': s===1?'Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§':'ØºÙŠØ± Ù…ÙÙØ¹Ù„');
    toolRows += `<tr>${td(i+1)}${td(`<div style="font-weight:700">${t.title}</div><div style="opacity:.85">${t.proof||''}</div>`)}${td(`<input type="checkbox" disabled>`) }${td(st)}${td(reasons[i]||'â€”')}</tr>`;
  });

  const head=JSON.parse(localStorage.getItem(LS_HEAD)||'{}');
  const reportHTML=`
  <html dir="rtl" lang="ar"><head>
    <meta charset="utf-8">
    <title>ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø©</title>
    <style>
      @page{size:A4;margin:10mm}
      body{font-family:"Tajawal",system-ui;color:#123b37}
      .page{width:190mm;margin:0 auto}
      h1,h2,h3{margin:6px 0}
      .kli{font-family:"Cairo";font-weight:700;color:#0c594e;text-align:center}
      .badge{display:inline-block;padding:4px 8px;border:1px solid #e6efec;border-radius:10px;background:#e8f4f1;color:#0c594e;font-weight:700;font-size:12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #cfe1dd;padding:6px;text-align:center}
      thead th{background:#0c594e;color:#fff}
      .row{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:6px 0}
      .cell{border:1px solid #e6efec;border-radius:8px;padding:6px 8px;background:#fbfdfc}
      .small{font-size:12px}
    </style>
  </head>
  <body>
    <div class="page">
      <h2 class="kli">Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø¯Ø¹Ù… ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€” ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø©</h2>
      <div class="row small">
        <div class="cell">Ø§Ù„Ø¬Ù‡Ø©: ${head.hdir||'â€”'}</div>
        <div class="cell">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${head.hschool||'â€”'}</div>
        <div class="cell">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: ${loadedRecord.name||'â€”'}</div>
        <div class="cell">Ø§Ù„Ù‡ÙˆÙŠØ©: ${(loadedRecord.nationalId||'â€”')}</div>
        <div class="cell">Ø§Ù„ØªØ®ØµØµ: ${loadedRecord.spec||'â€”'}</div>
        <div class="cell">Ø§Ù„Ù…Ø¤Ù‡Ù„: ${loadedRecord.degree||'â€”'}</div>
        <div class="cell">Ø§Ù„Ø®Ø¨Ø±Ø©: ${loadedRecord.exp||'â€”'}</div>
        <div class="cell">Ø§Ù„ÙØµÙ„/Ø§Ù„Ø¯Ø±Ø³: ${(loadedRecord.class||'â€”')} / ${(loadedRecord.lesson||'â€”')}</div>
      </div>

      <h3 class="kli">Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…</h3>
      <table>
        <thead><tr><th>Ù…</th><th>Ø§Ù„Ù…Ø¬Ø§Ù„</th><th>Ø§Ù„Ø¹Ù†ØµØ±</th><th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th><th>Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„ØªÙ…ÙŠÙ‘Ø²</th><th>Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</th></tr></thead>
        <tbody>${learnRows}</tbody>
      </table>

      <h3 class="kli">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…</h3>
      <table>
        <thead><tr><th>Ù…</th><th>Ø§Ù„Ø£Ø¯Ø§Ø©</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th><th>Ø§Ù„ØªÙØ¹ÙŠÙ„</th><th>Ø³Ø¨Ø¨/Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
        <tbody>${toolRows}</tbody>
      </table>

      <h3 class="kli">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù… Ù„Ù„Ù…Ø¹Ù„Ù…</h3>
      <div class="cell small" style="line-height:1.9">      ${($('#supportArea').value||'').split('\n').map(s=>s.trim()).filter(Boolean).join('<br>')||'â€”'}</div>

      <h3 class="kli">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</h3>
      <table>
        <thead><tr><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</th><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</th><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø¯Ø¹Ù…)</th></tr></thead>
        <tbody>
          <tr>
            <td>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b>${$('#sn1').textContent||'â€”'}</b><div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</td>
            <td>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b>${$('#sn2').textContent||'â€”'}</b><div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</td>
            <td>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <b>${$('#sn3').textContent||'â€”'}</b><div style="height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px"></div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</td>
          </tr>
          <tr>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: ${$('#sh1').textContent||'â€”'}</td>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: ${$('#sh2').textContent||'â€”'}</td>
            <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©: ${$('#sh3').textContent||'â€”'}</td>
          </tr>
        </tbody>
      </table>

      <div style="margin-top:10px;text-align:center" class="small">
        <span class="badge">Ø£ÙÙ†Ø´Ø¦ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© â€” Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</span>
      </div>
    </div>
  </body>
  </html>`;

  const w=window.open('','_blank');
  w.document.open();
  w.document.write(reportHTML);
  w.document.close();
  try{ w.focus(); setTimeout(()=>w.print(), 400); }catch{}
};

/* ===== Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ ===== */
['tName','tId','tSpec','degree','exp','class','lesson'].forEach(id=>{
  const el=$('#'+id);
  el.addEventListener('input', ()=>{
    if(id==='tName') updateSignNames();
  });
  el.addEventListener('change', async ()=>{
    // Ø¥Ø°Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…ÙØªØ§Ø­ (Ù‡ÙˆÙŠØ© ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ø³Ù…) Ø­Ù…Ù‘Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø¬Ø¯ÙŠØ¯
    if(id==='tName' || id==='tId'){ fixedKey=null; await loadRecord(); }
    await saveDraftActiveVisit(); recalc();
  });
});

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø¹Ù… ØªÙƒØ¨Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ */
$('#supportArea').addEventListener('input', ()=>{
  autoGrow($('#supportArea'));
  saveDraftActiveVisit();
});

/* Ø£Ø³Ù‡Ù… Ø§Ù„ØµØ¹ÙˆØ¯ ÙˆØ§Ù„Ù‡Ø¨ÙˆØ· */
$('#toTop').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
$('#toBottom').onclick=()=>window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});

/* ===== ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© ===== */
(async function init(){
  try{ await openDB(); }catch{}
  buildLearning();
  buildTools();
  renderToolsForVisit();
  renderSupportForVisit();
  recalc();
  updateSignNames();
})();
</script>
</body>
</html>
