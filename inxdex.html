<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>استمارة دعم وتطوير الهيئة التعليمية (زيارة معلم) ١٤٤٧هـ</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --moe-dark:#0c594e; --moe-green:#0f7a66; --moe-lite:#e8f4f1;
  --ink:#123b37; --line:#cfe1dd; --border:#e6efec; --bg:#fbfdfc;
  --good:#16a34a; --mid:#f59e0b; --bad:#ef4444; --strip:#f1fbf7;
  --base: clamp(14px, 1.15vw + 10px, 16.5px);
  --soft-green:#e9f7ee; --soft-green-b:#b9e4c8; --soft-green-t:#0f6a3b;
}
*{box-sizing:border-box}
html,body{margin:0;background:#fff;color:var(--ink);font-family:"Tajawal",system-ui;font-size:var(--base);min-height:100%}
#page{width:min(1200px,100vw);margin-inline:auto}
.wrap{padding:clamp(8px,2vw,16px)}
.hidden{display:none}

/* إبراز النواقص */
.input-error{border-color:#ef4444 !important;background:#fff5f5 !important; box-shadow:0 0 0 2px #fde2e2 inset}
.section-error{box-shadow:0 0 0 2px #fde2e2 inset}

/* رأس */
.govern-head{display:flex;flex-direction:column;gap:4px;align-items:center;margin-top:6px}
.govern-head .hl{font-family:"Cairo";font-weight:700;color:#0a5b50;text-align:center;display:inline-flex;gap:6px;align-items:center}
.govern-head .hl.small{font-size:clamp(13px,1.1vw + 10px,16px)}
.govern-head .hl.big{font-size:clamp(14px,1.2vw + 10px,18px)}
.govern-head .editable{padding:2px 6px;border-radius:8px;background:var(--moe-lite);border:1px dashed transparent;cursor:text}
.govern-head .editable[contenteditable="true"]{border-color:#b6d8d1;background:#fffef5}
.inline-pen{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 6px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;color:#0b5e54}
.inline-pen svg{width:14px;height:14px}
h1{margin:10px 0 8px;color:#0f7a66;font-family:"Cairo","Tajawal";font-size:clamp(18px,1.6vw + 14px,26px);text-align:center}
.badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:10px;background:#eaf7f4;color:#0b6256;font-weight:700;font-size:12px}

/* صناديق */
.box{border:1px solid var(--border);border-radius:14px;background:var(--bg);margin-top:10px;overflow:hidden}
.box h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:15px;color:#0c594e;display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px}
.fld{height:38px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;font:inherit;text-align:center}
.col-3{grid-column:span 3/span 3}.col-12{grid-column:span 12/span 12}

/* أزرار عامة */
.btn-ic{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0b5e54;font-weight:800;cursor:pointer;font-size:clamp(12px,.6vw + 10px,14px);transition:transform .12s ease}
.btn-ic:hover{transform:translateY(-1px)}
.btn-ic svg{width:18px;height:18px}
.btn-ic.tiny{padding:6px 8px}

/* الأزرار السفلية */
.bottom-actions .btn-ic{background:var(--soft-green);border-color:var(--soft-green-b);color:#0f6a3b}

/* زيارات */
.visits{display:flex;gap:clamp(12px,2vw,24px);align-items:flex-start;justify-content:center;flex-wrap:wrap}
.visitCard{display:flex;flex-direction:column;align-items:center;gap:8px;position:relative}
.donut{width:clamp(84px, 10vw + 40px, 140px);height:auto;cursor:pointer}
.donut .ring{transform:rotate(-90deg);transform-origin:50% 50%}
.donut text{font-weight:800;fill:var(--moe-dark);font-size:14px}
.done-badge{position:absolute;top:-6px;right:-6px;background:#16a34a;color:#fff;border-radius:999px;padding:4px 6px;font-size:11px;display:none;box-shadow:0 2px 6px rgba(0,0,0,.15)}
.chip{background:#eaf7f4;border:1px dashed #cfe1dd;padding:4px 10px;border-radius:999px;font-size:clamp(11px,.6vw + 9px,12px);color:#0b6256;cursor:pointer}
.visitLabel{font-family:"Cairo";font-weight:700;color:#0f685a;font-size:clamp(13px,.8vw + 10px,16px)}

/* المؤشرات */
.hmeterTop{margin:8px auto 4px;text-align:center}
.tooltip{position:relative;display:inline-block;cursor:help;margin-bottom:6px;font-weight:700;color:#0b534a}
.tooltip .tiptext{visibility:hidden;width:290px;background:#0a5b50;color:#fff;text-align:center;border-radius:6px;padding:6px;position:absolute;z-index:2;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .3s}
.tooltip:hover .tiptext{visibility:visible;opacity:1}
.globalInline{margin-inline-start:8px;font-family:"Cairo";font-size:clamp(14px,1vw + 11px,18px);font-weight:800;transition:color .15s ease}
.globalInline.good{color:#0f6a3b}.globalInline.mid{color:#a8620a}.globalInline.bad{color:#b42318}
.visitPercents{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:4px}
.visitPercents .badge{background:#f0faf6}
.globalRow{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.hbar{position:relative;width:min(700px,95vw);height:14px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%);margin:4px auto 6px}
.hthumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #0a5b50}
.hmeter{display:flex;flex-direction:column;gap:6px;align-items:center;margin:6px 0 8px}
.hbarSmall{position:relative;width:min(680px,95vw);height:12px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#16a34a 100%)}
.hthumbSmall{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #0a5b50}
.hlbl{display:flex;gap:8px;align-items:center;color:#0a5b50;font-weight:800}

/* الجداول */
.table-responsive{width:100%;overflow:auto}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl th,.tbl td{border:1px solid var(--line);padding:6px 8px;background:#fff;vertical-align:middle;text-align:center;word-wrap:break-word}
.tbl thead th{background:var(--moe-dark)!important;color:#fff!important}
.tbl .w{width:clamp(280px,26vw,380px);text-align:center}
.tbl tbody td.seq{background:#f2fbf7;text-align:center;font-weight:700;color:#0c5e55}
.tbl tbody td.domain-cell{background:#f3faf8;text-align:center;vertical-align:middle;font-weight:800}
.group-colored td{background:var(--strip)!important}
.group-white   td{background:#fff!important}
.group-colored td.domain-cell{background:var(--strip)!important}
.group-white   td.domain-cell{background:#fff!important}

/* العنصر + التعريف */
.item-cell{display:flex;flex-direction:column;gap:3px;text-align:right}
.item-cell b{display:block}
.item-brief{display:block;margin-top:2px;padding-top:4px;border-top:1px dashed #dbe9e6;color:#2b5e57;opacity:.9;font-size:12px;line-height:1.55}

/* مستوى الأداء */
.level{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-items:stretch;width:100%}
.level button{--dot:#ddd;border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all .12s;width:100%;padding:10px 0}
.level button::before{content:"";width:10px;height:10px;border-radius:50%;background:var(--dot)}
.level button[data-v="1"]{--dot: var(--bad)}
.level button[data-v="2"]{--dot: var(--mid)}
.level button[data-v="3"]{--dot: var(--good)}
.level button.active{box-shadow:0 0 0 2px #cfe8df inset}
.level button.active[data-v="1"]{background:#ffe3e3;border-color:#f2bcbc;color:#b42318}
.level button.active[data-v="2"]{background:#fff1dc;border-color:#f2d3a2;color:#a8620a}
.level button.active[data-v="3"]{background:#e9f7ee;border-color:#b9e4c8;color:#0f6a3b}

/* الأدوات + الأسباب */
.bar-wrap{position:relative;margin:8px 12px 10px}
.gradbar{height:12px;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#eef3f2}
.bar-nums{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:700;color:#0a5ب50;padding:0 8px}

/* ✅ عمود التفعيل: توسيط كامل */
.td-activate{display:flex;align-items:center;justify-content:center}
.pills{display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;align-items:center;justify-items:center;width:100%;max-width:360px;margin-inline:auto}
.pill{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer;font-weight:700;font-size:12px;min-width:86px;text-align:center;white-space:nowrap}
.pill[data-v="2"].active{background:#e9f7ee;color:#0f6a3b;border-color:#b9e4c8}
.pill[data-v="1"].active{background:#fff1dc;color:#a8620a;border-color:#f2d3a2}
.pill[data-v="0"].active{background:#ffe3e3;color:#b42318;border-color:#f2bcbc}

.tool-desc{display:block;opacity:.9;font-size:11px;line-height:1.6;margin-top:2px;text-align:right}

/* عمود الشواهد */
.td-proof{width:100%; text-align:center}
.td-proof input{transform:scale(.95)}

/* عمود أسباب عدم التفعيل */
.td-reason .tool-reason{width:100%;min-height:52px;border:1px dashed var(--line);border-radius:10px;background:#fff;padding:6px 8px;font:inherit;font-size:11.5px;resize:vertical;white-space:pre-wrap}
.tool-reason:disabled{opacity:.55;background:#f7faf9}
.textarea-print{white-space:pre-wrap;border:1px dashed var(--line);border-radius:10px;background:#fff;padding:6px;font-size:11.5px;min-height:44px;text-align:right}

/* التوصيات */
.rec-wrap{padding:10px}
.recTbl{width:100%;border-collapse:collapse}
.recTbl th,.recTbl td{border:1px solid var(--line);padding:8px;background:#fff;vertical-align:top;text-align:right}
.recTbl thead th{background:var(--moe-dark)!important;color:#fff!important}

/* الدعم المقدم */
.support-area{padding:10px}
#supportArea{width:100%;min-height:130px;border:1px solid var(--soft-green-b);background:var(--soft-green);color:var(--soft-green-t);border-radius:12px;padding:10px 12px;resize:none;font:inherit;line-height:1.8;overflow:hidden}
#supportArea::placeholder{color:#0f6a3b;opacity:.7}
#supportMeta{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.chip-mini{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--soft-green-b);background:#f6fff9;color:#0f6a3b;border-radius:999px;padding:3px 8px;font-size:11.5px}

/* إشعار أصفر */
.toast{position:fixed;right:12px;bottom:12px;z-index:1400;width:min(520px,92vw);min-height:36px;background:rgba(255,244,178,.96);border:1px solid #f5d565;color:#7a6400;border-radius:16px;padding:6px 10px;box-shadow:0 10px 28px rgba(0,0,0,.12);display:flex;align-items:center;gap:8px;direction:rtl;-webkit-backdrop-filter: blur(1px);backdrop-filter: blur(1px)}
.toast .dot{width:6px;height:6px;border-radius:50%;background:#a07800;opacity:.9}
.toast .line{flex:1;text-align:center;overflow:hidden;text-overflow:ellipsis;font-size:11.5px;font-weight:700;white-space:nowrap}
.toast .close{border:none;background:#fff;color:#a07800;border:1px solid #f0d98b;border-radius:999px;padding:0 8px;cursor:pointer;font-size:12px;line-height:20px}

/* بقية التنسيقات */
.bottom-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;padding:10px;border:1px solid var(--border);border-radius:14px;background:var(--bg);margin-top:12px}
.signs{margin:10px 0}
.signs table{width:100%;border-collapse:collapse}
.signs th,.signs td{border:1px solid var(--line);padding:8px;background:#fff}
.sign-line{display:block;height:1px;border-bottom:1px dashed #9fb5b1;margin:8px 24px}

/* لوحة المعتمدين */
#approvedPanel{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;min-width:min(520px,92vw);max-width:92vw;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.15);padding:0;display:none;z-index:1500}
.ap-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:10px}
.ap-head h4{margin:0;color:#0c594e;font-family:"Cairo"}
.ap-close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 10px;cursor:pointer}
#approvedList{display:flex;flex-wrap:wrap;gap:6px;padding:12px;max-height:40vh;overflow:auto}
.name-chip{padding:6px 10px;border-radius:999px;border:1px dashed var(--line);background:#fafafa}

/* لوحة الأسماء */
#teachersPanel{position:fixed;inset:auto 0 0 0;margin:auto;max-width:min(780px,96vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 16px 48px rgba(0,0,0,.2);display:none;z-index:1600}
.tp-head{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border)}
.tp-body{padding:10px;max-height:60vh;overflow:auto}
.tp-search{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.tp-list{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.tp-item{padding:8px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.tp-item b{color:#0ب5e54}
.tp-close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.printMark{display:none;text-align:center;margin:6px 0 2px;color:#184b44;font-size:10px}

/* أزرار الصعود/الهبوط */
#toTop,#toBottom{position:fixed;bottom:20px;padding:12px;border:none;border-radius:50%;background:#0f7a66;color:#fff;font-size:18px;cursor:pointer;display:none;z-index:999;box-shadow:0 8px 20px rgba(0,0,0,.18);transition:transform .18s ease, box-shadow .18s ease, opacity .18s ease;opacity:.95}
#toTop{left:20px} #toBottom{right:20px}
#toTop:hover,#toBottom:hover{transform:translateY(-2px) scale(1.04); box-shadow:0 12px 28px rgba(0,0,0,.22)}

/* فوتر */
.footer-rights{margin:8px 0 14px;text-align:center;font-size:11.5px;color:#0b534a}
body.snapshot .no-print{ display:none !important }

/* تجاوب */
@media (max-width:980px){ .tbl .w{width:auto} .grid{gap:6px} }
@media (max-width:540px){ .fld{height:40px} }
@media (max-width: 420px){ .pills{ grid-template-columns:1fr; max-width:260px } .tp-list{ grid-template-columns:1fr } .donut{ width:110px; height:auto } .tbl .w{ width:auto } .level{ grid-template-columns:1fr } }

/* طباعة */
@page{ size:A4 portrait; margin:8mm }
@media print{
  :root{--base:12px}
  *{-webkit-print-color-adjust:exact; print-color-adjust:exact; color:#111 !important; text-shadow:none !important; filter:none !important}
  h1{font-size:16px}
  .donut{width:92px;height:auto}
  .tbl th,.tbl td{padding:5px;font-size:11.5px;border-color:#333 !important}
  .tbl thead th{background:#111 !important;color:#fff !important}
  .item-brief{font-size:10.5px}
  .no-print, .bottom-actions, #approvedPanel, #teachersPanel, .footer-rights, .toast { display:none !important }
  .table-responsive{ overflow:visible !important }
  .printMark{display:block !important}
  #page{width:210mm}
}

/* نسخة الالتقاط للطباعة وPDF */
.for-print, .for-print *{background:#fff !important; color:#111 !important; box-shadow:none !important; filter:none !important}
.for-print .tbl th{background:#000 !important; color:#fff !important; border-color:#333 !important}
.for-print .tbl td{border-color:#444 !important}
.for-print .badge{background:#fff !important; border-color:#444 !important; color:#111 !important}
.for-print .hbar, .for-print .hbarSmall{background:#ddd !important}
.for-print .ring{stroke:#000 !important}
.for-print .globalInline{color:#000 !important}
.for-print .table-responsive{overflow:visible !important}
.for-print .chip{border-color:#888 !important}
.for-print .tool-desc{color:#222 !important}
</style>
</head>
<body>
<div id="page"><div class="wrap" id="sheet">

  <!-- رأس -->
  <div class="govern-head">
    <div class="hl small" id="h-sa">المملكة العربية السعودية</div>
    <div class="hl small" id="h-moed">وزارة التعليم</div>
    <div class="hl big">
      <span class="editable" id="h-dir" contenteditable="false">الإدارة العامة للتعليم بالمنطقة الشرقية</span>
      <button class="inline-pen no-print" id="penDir" title="تعديل"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button>
    </div>
    <div class="hl big">
      <span class="editable" id="h-school" contenteditable="false">مدرسة اليعقوبي الثانوية</span>
      <button class="inline-pen no-print" id="penSchool" title="تعديل"><svg viewBox="0 0 24 24"  fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button>
    </div>
  </div>

  <h1>استمارة دعم وتطوير الهيئة التعليمية (زيارة معلم) ١٤٤٧هـ</h1>
  <div style="text-align:center"><span class="badge" id="hijriChip">التاريخ الهجري: —</span></div>

  <!-- معلومات عامة -->
  <div class="box" id="boxInfo">
    <h3>المعلومات العامة</h3>
    <div class="grid" style="padding:10px">
      <input class="fld col-3" id="tName" placeholder="اسم المعلم">
      <input class="fld col-3" id="tId" placeholder="رقم الهوية (10 أرقام)" inputmode="numeric" maxlength="10">
      <input class="fld col-3" id="tSpec" placeholder="التخصص / المادة">
      <input class="fld col-3" id="lesson" placeholder="عنوان الدرس">
      <input class="fld col-3" id="degree" placeholder="المؤهل">
      <input class="fld col-3" id="exp" placeholder="سنوات الخبرة">
      <input class="fld col-3" id="class" placeholder="الفصل">

      <div class="col-3" style="display:flex;gap:6px;align-items:center;justify-content:center">
        <button class="btn-ic tiny no-print" id="btnShowList" title="كشف الأسماء">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </button>
        <button class="btn-ic tiny no-print" id="btnExportTemplate" title="تصدير قالب Excel">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="14" height="16" rx="2"/><path d="M7 8h6M7 12h6M7 16h6"/>
            <path d="M17 12l4 4m0-4-4 4"/>
          </svg>قوالب
        </button>
      </div>
    </div>
  </div>

  <!-- المؤشرات الشاملة -->
  <div class="hmeterTop">
    <div class="tooltip">المؤشر الشامل للأداء <b id="globalPctInline" class="globalInline">0%</b>
      <span class="tiptext">مقياس تجميعي يُلخص نتائج الزيارات الثلاث (يشمل 15% لتفعيل الأدوات).</span>
    </div>
    <div class="visitPercents">
      <span class="badge">الأولى: <b id="p1">0%</b></span>
      <span class="badge">الثانية: <b id="p2">0%</b></span>
      <span class="badge">الثالثة: <b id="p3">0%</b></span>
    </div>
    <div class="globalRow">
      <div class="hbar"><div class="hthumb" id="globalThumb" style="left:0%"></div></div>
    </div>
  </div>

  <!-- دوائر الزيارات -->
  <div class="visits">
    <div class="visitCard">
      <span id="done1" class="done-badge">منتهية</span>
      <svg class="donut" id="v1" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v1t">0%</text></svg>
      <div class="chip" id="v1h">—</div><div class="visitLabel">الزيارة الأولى</div>
    </div>
    <div class="visitCard">
      <span id="done2" class="done-badge">منتهية</span>
      <svg class="donut" id="v2" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v2t">0%</text></svg>
      <div class="chip" id="v2h">—</div><div class="visitLabel">الزيارة الثانية</div>
    </div>
    <div class="visitCard">
      <span id="done3" class="done-badge">منتهية</span>
      <svg class="donut" id="v3" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#eef3f2" stroke-width="12"/><circle cx="60" cy="60" r="50" fill="none" stroke="#16a34a" stroke-width="12" stroke-dasharray="0 314" stroke-linecap="round" class="ring"/><text x="60" y="64" text-anchor="middle" id="v3t">0%</text></svg>
      <div class="chip" id="v3h">—</div><div class="visitLabel">الزيارة الثالثة</div>
    </div>
  </div>

  <!-- مؤشر الزيارة -->
  <div class="hmeter">
    <div class="hbarSmall"><div class="hthumbSmall" id="hThumb" style="left:0%"></div></div>
    <div class="hlbl"><span>مؤشر أداء الزيارة الحالية:</span> <span id="kpiPct">0%</span></div>
  </div>

  <!-- عملية التعليم والتعلّم -->
  <div class="box" id="learningBox">
    <h3>عملية التعليم والتعلّم</h3>
    <div class="table-responsive">
      <table class="tbl" id="learningTbl">
        <colgroup>
          <col style="width:44px">
          <col style="width:260px">
          <col>
          <col style="width:340px">
        </colgroup>
        <thead>
          <tr><th>م</th><th>المجالات</th><th>العناصر</th><th class="w">مستوى الأداء</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- الأدوات المساندة -->
  <div class="box" id="toolsBox">
    <h3><span>الأدوات المساندة لعملية التعليم والتعلّم</span><small id="toolsMeta" style="margin-inline-start:8px;opacity:.8">—</small></h3>
    <div class="bar-wrap"><div class="gradbar" id="gradbar"></div><div class="bar-nums"><span id="tU">غير محدد: 0</span><span id="tR">غير مُفعل: 0</span><span id="tA">إلى حد ما: 0</span><span id="tG">مُفعل: 0</span></div></div>
    <div class="table-responsive">
      <table class="tbl" id="toolsTbl">
        <colgroup>
          <col style="width:44px">
          <col style="width:260px">
          <col style="width:110px">
          <col style="width:260px">
          <col style="width:170px">
        </colgroup>
        <thead>
          <tr>
            <th>م</th><th>الأدوات</th><th>الشواهد</th>
            <th>التفعيل</th>
            <th>أسباب عدم التفعيل</th>
          </tr>
        </thead>
        <tbody id="toolsRows"></tbody>
      </table>
    </div>
  </div>

  <!-- التوصيات -->
  <div class="box">
    <h3>التوصيات المقدّمة</h3>
    <div class="rec-wrap">
      <table class="recTbl">
        <thead><tr><th>جوانب التميّز</th><th>احتياجات التنمية المهنية</th></tr></thead>
        <tbody><tr><td id="strengthBox">—</td><td id="devBox">—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- الدعم المقدم -->
  <div class="box" id="supportBox">
    <h3>الدعم المقدّم للمعلم</h3>
    <div class="support-area">
      <textarea id="supportArea" placeholder="حتى ٤ أسطر مقترحة — قابلة للتعديل…"></textarea>
      <div id="supportMeta" class="no-print"></div>
    </div>
  </div>

  <!-- التوقيعات -->
  <div class="signs">
    <table>
      <tr><th>الزيارة الأولى</th><th>الزيارة الثانية</th><th>الزيارة الثالثة</th></tr>
      <tr>
        <td>اسم المعلم: <span id="sn1">—</span><span class="sign-line"></span>توقيع المعلم:</td>
        <td>اسم المعلم: <span id="sn2">—</span><span class="sign-line"></span>توقيع المعلم:</td>
        <td>اسم المعلم: <span id="sn3">—</span><span class="sign-line"></span>توقيع المعلم:</td>
      </tr>
      <tr>
        <td>تاريخ الزيارة: <span id="sh1">—</span></td>
        <td>تاريخ الزيارة: <span id="sh2">—</span></td>
        <td>تاريخ الزيارة: <span id="sh3">—</span></td>
      </tr>
      <tr>
        <td>اسم مدير المدرسة: <span id="pn1">فهد حامد علي الزهراني</span><button class="inline-pen no-print" id="penPrin1" title="تعديل" style="margin-inline-start:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button></td>
        <td>اسم مدير المدرسة: <span id="pn2">فهد حامد علي الزهراني</span><button class="inline-pen no-print" id="penPrin2" title="تعديل" style="margin-inline-start:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button></td>
        <td>اسم مدير المدرسة: <span id="pn3">فهد حامد علي الزهراني</span><button class="inline-pen no-print" id="penPrin3" title="تعديل" style="margin-inline-start:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button></td>
      </tr>
    </table>
  </div>

  <!-- لوحة المعتمدين -->
  <div id="approvedPanel" class="no-print">
    <div class="ap-head">
      <h4>زيارات المعلمين المعتمدة</h4>
      <button class="ap-close" id="apClose" title="إغلاق">✕</button>
    </div>
    <div id="approvedList">—</div>
  </div>

  <!-- الأزرار السفلية -->
  <div class="bottom-actions no-print">
    <button class="btn-ic" id="finishVisitBtn" title="اعتماد"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>اعتماد</button>
    <button class="btn-ic" id="printBtn" title="طباعة A4"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1 2 2h-2"/><path d="M6 14h12v8H6z"/></svg>طباعة</button>
    <button class="btn-ic" id="saveBtn" title="حفظ PDF"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2Z"/><path d="M17 21V13H7v8"/><path d="M7 3v4h8"/></svg>حفظ PDF</button>

    <span style="display:inline-flex;align-items:center;gap:6px">
      <button class="btn-ic" id="waBtn" title="واتساب">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 12.1A9.5 9.5 0 1 1 12 2.5a9.5 9.5 0 0 1 9.5 9.6Z"/><path d="m3.5 20.5 1.6-5.6"/><path d="M8.5 8.5c1 2.5 3.5 4.5 6 5l1.5-1.5"/></svg>
      </button>
      <button class="inline-pen" id="waEdit" title="تعديل رقم واتساب">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
      </button>
    </span>

    <!-- تحكم -->
    <button class="btn-ic" id="btnSaveManual" title="حفظ البيانات">حفظ البيانات</button>
    <button class="btn-ic" id="btnLoadLast" title="تحميل تقرير آخر معلم">تحميل الأخير (تقرير)</button>

    <button class="btn-ic" id="btnApproved" title="المعتمدون"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-8 0v2"/><circle cx="12" cy="7" r="4"/><path d="M20 8v6m3-3h-6"/></svg>المعتمدون</button>
    <button class="btn-ic" id="btnDeleteVisit" title="حذف هذه الزيارة لهذا المعلم"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4h8v2"/></svg>حذف زيارة (لهذا المعلم)</button>
    <button class="btn-ic" id="btnClearAll" title="مسح الجميع">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4h8v2"/><path d="M10 11v6M14 11v6"/></svg>
      مسح الجميع
    </button>
  </div>

  <div class="printMark" id="printMark">مبادرة دعم اليعقوبي الثانوي — تاريخ الطباعة: <span id="printHijri">—</span></div>
  <div class="footer-rights no-print">مبادرة مدرسة اليعقوبي الثانوية بالخبر — تنفيذ وتصميم: فهد حامد الزهراني</div>

</div></div>

<!-- لوحة الأسماء -->
<div id="teachersPanel" class="no-print">
  <div class="tp-head">
    <b>كشف أسماء المعلمين</b>
    <div style="display:flex;gap:6px;align-items:center">
      <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none">
      <button class="btn-ic tiny" id="btnImportInPanel" title="استيراد Excel/CSV">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 16v3a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-3"/><path d="M8 12l4 4 4-4M12 4v12"/></svg>
        استيراد
      </button>
      <button class="tp-close" id="tpClose">إغلاق</button>
    </div>
  </div>
  <div class="tp-body">
    <div class="tp-search">
      <input id="tpQuery" class="fld" style="flex:1" placeholder="ابحث بالاسم أو الهوية">
    </div>
    <div id="tpList" class="tp-list"></div>
  </div>
</div>

<button id="toTop" class="no-print" title="أعلى">↑</button>
<button id="toBottom" class="no-print" title="أسفل">↓</button>

<!-- إشعار أصفر -->
<div class="toast no-print" id="toast">
  <div class="dot"></div>
  <div class="line" id="toastText">رحلة تطوير حيّة… حيث يتحوّل التقييم من أرقام جامدة إلى دعم تفاعلي يضيء مسار المعلّم.</div>
  <button class="close" id="toastClose" title="إغلاق">×</button>
</div>

<script>
/* ========= أدوات عامة ========= */
function autoGrow(ta){ if(!ta) return; ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight, 440)+'px'; }
function showToast(msg){ const t=document.getElementById('toast'); document.getElementById('toastText').textContent=msg; t.style.display='flex'; setTimeout(()=>t.style.display='none', 3500); }
document.getElementById('toastClose').onclick=()=>document.getElementById('toast').style.display='none';

/* ========= رأس قابل للتحرير ========= */
const LS_HEAD='moe_header_v14';
function saveHead(){
  const o={hsa:document.getElementById('h-sa').textContent.trim(),
           hmo:document.getElementById('h-moed').textContent.trim(),
           hdir:document.getElementById('h-dir').textContent.trim(),
           hschool:document.getElementById('h-school').textContent.trim()};
  try{ localStorage.setItem(LS_HEAD,JSON.stringify(o)); }catch{}
}
(function loadHead(){
  const raw=localStorage.getItem(LS_HEAD); if(!raw) return;
  try{ const o=JSON.parse(raw);
    if(o.hsa)document.getElementById('h-sa').textContent=o.hsa;
    if(o.hmo)document.getElementById('h-moed').textContent=o.hmo;
    if(o.hdir)document.getElementById('h-dir').textContent=o.hdir;
    if(o.hschool)document.getElementById('h-school').textContent=o.hschool;
  }catch{}
})();
document.getElementById('penDir').addEventListener('click',()=>toggleEdit('h-dir'));
document.getElementById('penSchool').addEventListener('click',()=>toggleEdit('h-school'));
['penPrin1','penPrin2','penPrin3'].forEach(id=>{
  const btn=document.getElementById(id);
  if(btn) btn.addEventListener('click',()=>{
    const idx=id==='penPrin1'?1:(id==='penPrin2'?2:3);
    const el=document.getElementById('pn'+idx);
    const v=prompt('اسم مدير المدرسة:', el.textContent.trim());
    if(v){ el.textContent=v; }
  });
});
function toggleEdit(id){ const el=document.getElementById(id); const on=el.getAttribute('contenteditable')==='true'; el.setAttribute('contenteditable', on?'false':'true'); if(on) saveHead(); el.focus(); }

/* ========= التاريخ الهجري ========= */
function hijriNow(){ try{const opt={weekday:'long',day:'numeric',month:'long',year:'numeric'}; return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',opt).format(new Date());}catch{return '—';} }
function hijriDateStr(d){ try{const opt={weekday:'long',day:'numeric',month:'long',year:'numeric'}; return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',opt).format(d);}catch{return '—';} }
document.getElementById('hijriChip').textContent='التاريخ الهجري: '+hijriNow();

/* ========= أيقونات ========= */
function icon(name, size=14){
  const common=`width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"`;
  if(name==='plan')return `<svg ${common}><path d="M3 4h18M3 8h18M7 8v12m5-12v12m5-12v12"/></svg>`;
  if(name==='method')return `<svg ${common}><path d="M4 7h16M4 12h10M4 17h16"/></svg>`;
  if(name==='class')return `<svg ${common}><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 20v-2a4 4 0 0 1 4-4h2"/></svg>`;
  if(name==='tech')return `<svg ${common}><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M8 20h8"/></svg>`;
  if(name==='env')return `<svg ${common}><path d="M12 2v20M5 9c0 7 7 7 7 7s7 0 7-7"/></svg>`;
  if(name==='assessment')return `<svg ${common}><path d="M3 3h18v18H3z"/><path d="M7 12h10M7 8h10M7 16h6"/></svg>`;
  if(name==='bad')return `<svg ${common}><circle cx="12" cy="12" r="10"/><path d="M8 8l8 8"/></svg>`;
  if(name==='mid')return `<svg ${common}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>`;
  if(name==='good')return `<svg ${common}><circle cx="12" cy="12" r="10"/><path d="M8 12l2 2 6-6"/></svg>`;
  return '';
}

/* ========= البيانات (مجالات/عناصر) ========= */
const fields=[
 {name:'إعداد وتنفيذ خطة للتعلّم',icon:'plan',items:[
  ['تخطيط محكم','تحويل المنهج إلى خطة دروس واضحة بمخرجات قابلة للقياس.'],
  ['استراتيجيات مبتكرة','توظيف أساليب تدريس حديثة تعزز الإبداع وحل المشكلات.'],
  ['التزام زمني منظم','تنظيم زمن التعلم بما يحقق التوازن بين الخطة الدراسية واحتياجات الطلاب.'],
  ['تقويم هادف','استخدام أدوات تقييم مرتبطة بالأهداف لتوجيه التحسين المستمر.']
 ]},
 {name:'التنوع في استراتيجيات التدريس',icon:'method',items:[
  ['تنويع الأساليب','اختيار طرق تدريس متنوعة تلائم المحتوى وأهداف الدرس.'],
  ['مراعاة الفروق','تكييف الأنشطة لمستويات وسرعات تعلم مختلفة.'],
  ['دمج التعليم المباشر والرقمي','التكامل بين التدريس الوجاهي والأدوات الرقمية الحديثة.'],
  ['تحفيز التفاعل','توظيف أساليب تشاركية وأسئلة مثيرة للتفكير لتنمية الحوار.']
 ]},
 {name:'إدارة الفصل',icon:'class',items:[
  ['تنظيم البيئة','تهيئة مكان تعليمي محفز وآمن يسهّل التعلم.'],
  ['ضبط السلوك','وضع قواعد واضحة وتطبيقها بعدالة لتحقيق الانضباط.'],
  ['تعزيز المشاركة','إشراك جميع الطلاب في الأنشطة الصفية بفاعلية.'],
  ['توظيف الوقت','استثمار زمن الحصة بكفاءة واستمرارية دون هدر.']
 ]},
 {name:'توظيف التقنية',icon:'tech',items:[
  ['أدوات رقمية','استخدام منصات وموارد تفاعلية مناسبة للتعلم.'],
  ['دمج التقنية','توظيف الوسائل الرقمية لدعم تنفيذ الأنشطة التعليمية.'],
  ['دعم الفروق','الاستفادة من التقنية لتخصيص التعليم وفق احتياجات الطلاب.'],
  ['تعزيز النواتج','متابعة تقدم الطلاب وتحسين مخرجات التعلم عبر أدوات رقمية.']
 ]},
 {name:'البيئة التعليمية',icon:'env',items:[
  ['تهيئة مكان آمن','توفير بيئة صفية آمنة تعزز الطمأنينة والانتماء.'],
  ['موارد تعلم','توفير مواد وأنشطة متنوعة تسهّل الفهم.'],
  ['علاقات إيجابية','بناء تواصل فعّال واحترام متبادل بين المعلم والمتعلم.'],
  ['دافعية المتعلمين','تحفيز الطلاب بالأنشطة والإنجازات لبذل أقصى جهد.']
 ]},
 {name:'أساليب وأدوات التقويم',icon:'assessment',items:[
  ['تنويع أدوات','استخدام اختبارات تحريرية وشفهية وعملية ورقمية.'],
  ['مراعاة الفروق','تصميم مهام تقييم تناسب مستويات متعددة.'],
  ['التقويم البنائي والنهائي','متابعة تقدم مستمر واختبارات ختامية معيارية.'],
  ['استثمار النتائج','تحليل النتائج لتطوير التدريس وتحسين مخرجات التعلم.']
 ]}
];

/* ========= الأدوات ========= */
const toolsData=[
  {title:'تحسين نواتج التعلم باستراتيجيات مبنية على الأدلة',desc:'رفع تحصيل الطلاب بأساليب متنوعة تراعي الفروق.'},
  {title:'تفعيل منصة مدرستي بفاعلية',desc:'إدارة التعلم ومتابعة الواجبات والتواصل.'},
  {title:'الشراكة مع المجتمع المهني',desc:'برامج تدريبية ورخص مهنية لتطوير الأداء.'},
  {title:'التواصل مع أولياء الأمور',desc:'قنوات فعّالة للدعم الأكاديمي والسلوكي.'},
  {title:'تحليل نواتج التعلم',desc:'قراءة البيانات لاتخاذ قرارات علاجية.'},
  {title:'توظيف كتاب الطالب',desc:'ربط الكتاب بالأنشطة والواجبات.'}
];

/* ========= التخزين لكل معلّم ========= */
const LS_PREFIX='teach_';
const LS_APPROVED='approved_visits_v1';
let activeVisit=1;
let loadedRecord=null;             // { teacherId, name, spec, etc..., visits:{1:{draft,finalized,...},2:{},3:{}} }
let store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};

function zeroMatrix(){ return fields.map(f=>Array(f.items.length).fill(0)); }
function currentKey(){
  const id=(document.getElementById('tId').value||'').replace(/\D+/g,'');
  if(/^\d{10}$/.test(id)) return id;
  const name=(document.getElementById('tName').value||'').trim();
  return name?('name:'+name):'';
}
function saveRecord(){
  if(!loadedRecord) return;
  try{ localStorage.setItem(LS_PREFIX+loadedRecord.teacherId, JSON.stringify(loadedRecord)); }catch{}
}
function loadRecordByKey(key){
  try{
    const raw=localStorage.getItem(LS_PREFIX+key);
    return raw?JSON.parse(raw):null;
  }catch{ return null; }
}
function clearAllUIForNewTeacher(){
  store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};
  loadedRecord={teacherId:currentKey(), name:document.getElementById('tName').value||'', spec:document.getElementById('tSpec').value||'', id:(document.getElementById('tId').value||'').replace(/\D+/g,''), visits:{1:{draft:{}},2:{draft:{}},3:{draft:{}}}};
  renderVisit(1);
  setChip(1,'—'); setChip(2,'—'); setChip(3,'—');
  setDonut(1,0); setDonut(2,0); setDonut(3,0);
  setVisitPercents(0,0,0); setGlobalMeter(0); setVisitMeter(0);
  ['sn1','sn2','sn3'].forEach(id=>document.getElementById(id).textContent=loadedRecord.name||'—');
  saveRecord();
}
function fillTeacher(t){
  document.getElementById('tName').value=t.name||'';
  document.getElementById('tId').value=t.id||'';
  document.getElementById('tSpec').value=t.spec||'';
  document.getElementById('degree').value=t.degree||'';
  document.getElementById('exp').value=t.exp||'';
  ['sn1','sn2','sn3'].forEach(id=>document.getElementById(id).textContent=t.name||'—');

  const key=currentKey();
  const rec=loadRecordByKey(key);
  if(rec){           // معلّم مزار سابقًا → حمل بياناته
    loadedRecord=rec;
    // استرجاع مصفوفات المستويات
    [1,2,3].forEach(v=>{ const lv=rec.visits?.[v]?.draft?.levels; store[v]=lv?lv:zeroMatrix(); });
    renderVisit(1); calcAll(); showToast('تم تحميل مؤشرات المعلّم المحفوظة.');
  }else{             // معلّم جديد → تصفير
    clearAllUIForNewTeacher();
    showToast('جديد: تم تصفير المؤشرات لهذا المعلم.');
  }
}

/* ========= بناء الجداول ========= */
function buildTable(){
  const tbody=document.getElementById('rows'); tbody.innerHTML='';
  fields.forEach((f,fi)=>{
    const groupClass=(fi%2===0)?'group-colored':'group-white';
    f.items.forEach((pair,ii)=>{
      const [label,brief]=pair;
      const tr=document.createElement('tr'); tr.classList.add(groupClass);
      if(ii===0){
        tr.innerHTML+=`
          <td class="seq" rowspan="${f.items.length}">${fi+1}</td>
          <td rowspan="${f.items.length}" class="domain-cell">
            <div style="display:flex;gap:6px;align-items:center;justify-content:center">
              <span>${icon(f.icon,16)}</span><span>${f.name}</span>
            </div>
          </td>`;
      }
      tr.innerHTML+=`
        <td class="item-cell">
          <b>${label}</b>
          <span class="item-brief">${brief}</span>
        </td>
        <td class="w">
          <div class="level" dir="rtl">
            <button data-v="1" title="ضعيف">${icon('bad',14)} ضعيف</button>
            <button data-v="2" title="متوسط">${icon('mid',14)} متوسط</button>
            <button data-v="3" title="متميز">${icon('good',14)} متميز</button>
          </div>
        </td>`;
      tbody.appendChild(tr);

      const btns=[...tr.querySelectorAll('button')];
      const saved=store[activeVisit][fi][ii];
      if(saved>0) btns.forEach(b=>b.classList.toggle('active', Number(b.dataset.v)===saved));
      btns.forEach(b=>b.addEventListener('click',()=>{
        btns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        store[activeVisit][fi][ii]=Number(b.dataset.v);
        saveDraftActiveVisit();
        calcAll();
      }));
    });
  });
}
function buildTools(){
  const tBody=document.getElementById('toolsRows'); tBody.innerHTML='';
  toolsData.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="seq">${i+1}</td>
      <td style="text-align:right">
        <span class="tool-name" style="font-weight:800">${t.title}</span>
        <span class="tool-desc">${t.desc}</span>
      </td>
      <td class="td-proof">
        <label style="display:inline-flex;gap:6px;align-items:center;cursor:pointer">
          <input type="checkbox" class="tool-proof" title="يوجد شاهد؟"><span>يوجد شاهد</span>
        </label>
      </td>
      <td class="td-activate">
        <div class="pills" dir="rtl">
          <div class="pill" data-v="2" title="مُفعل"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>&nbsp;مُفعل</div>
          <div class="pill" data-v="1" title="إلى حد ما"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>&nbsp;إلى حد ما</div>
          <div class="pill" data-v="0" title="غير مُفعل"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>&nbsp;غير مُفعل</div>
        </div>
      </td>
      <td class="td-reason"><textarea class="tool-reason" placeholder="اكتب السبب عند (غير مُفعل/إلى حد ما)"></textarea></td>`;
    tBody.appendChild(tr);
  });

  [...document.querySelectorAll('.pills')].forEach(set=>{
    const pills=set.querySelectorAll('.pill');
    const reason=set.parentElement.nextElementSibling.querySelector('.tool-reason');
    const enableReason=v=>{ reason.disabled=(v===2); if(v===2) reason.value=''; };

    pills.forEach(p=>p.addEventListener('click',()=>{
      const was=p.classList.contains('active');
      pills.forEach(x=>x.classList.remove('active'));
      if(!was){ p.classList.add('active'); enableReason(Number(p.dataset.v)); } else { enableReason(null); }
      updateToolsSummary(); saveDraftActiveVisit(); calcAll();
    }));
    reason.addEventListener('input',()=>saveDraftActiveVisit());
  });

  updateToolsSummary();
}

/* ========= أدوات/ملخص ========= */
const gradbar=document.getElementById('gradbar'),
      tU=document.getElementById('tU'), tR=document.getElementById('tR'),
      tA=document.getElementById('tA'), tG=document.getElementById('tG'),
      toolsMeta=document.getElementById('toolsMeta');

function getToolsStateFromUI(){ return [...document.querySelectorAll('.pills')].map(set=>{const a=set.querySelector('.pill.active'); return a?Number(a.dataset.v):null;}); }
function getToolReasonsFromUI(){ return [...document.querySelectorAll('.tool-reason')].map(t=>(t.value||'').trim()); }
function setToolsStateToUI(arr){
  const sets=[...document.querySelectorAll('.pills')];
  sets.forEach((set,i)=>{
    set.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
    const v=(arr&&typeof arr[i]!=='undefined')?arr[i]:null;
    if(v===0||v===1||v===2){ (set.querySelector(`.pill[data-v="${v}"]`)||null)?.classList.add('active'); }
    const reason=set.parentElement.nextElementSibling.querySelector('.tool-reason');
    reason.disabled=(v===2); if(v===2) reason.value='';
  });
  updateToolsSummary();
}

/* ملخص الأدوات (شريط التدرّج + أرقام) */
function updateToolsSummary(){
  const sets=[...document.querySelectorAll('.pills')];
  let g=0,a=0,r=0,u=0;
  sets.forEach(set=>{
    const act=set.querySelector('.pill.active');
    if(!act){u++;return;}
    const v=Number(act.dataset.v);
    if(v===2) g++; else if(v===1) a++; else r++;
  });
  const total=toolsData.length||1;
  const pg=(g/total)*100, pa=(a/total)*100, pr=(r/total)*100, pu=(u/total)*100;

  gradbar.style.background=
    `linear-gradient(90deg,
      #e5e7eb 0% ${pu}%,
      #fecaca ${pu}% ${pu+pr}%,
      #fde68a ${pu+pr}% ${pu+pr+pa}%,
      #bbf7d0 ${pu+pr+pa}% 100%)`;

  tU.textContent = `غير محدد: ${u}`;
  tR.textContent = `غير مُفعل: ${r}`;
  tA.textContent = `إلى حد ما: ${a}`;
  tG.textContent = `مُفعل: ${g}`;
  toolsMeta.textContent = `${total} أداة • محدد: ${total-u} • غير محدد: ${u}`;
}

/* ========== حساب المؤشرات ========== */
function visitPctLevels(v){
  const flat=store[v].flat();
  const rated=flat.filter(x=>x>0);
  if(!rated.length) return 0;
  const s=rated.reduce((a,b)=>a+(b-1),0); // 1→0, 2→1, 3→2
  return Math.round((s/(rated.length*2))*100);
}
function toolPctFromArray(arr){
  if(!arr || !arr.length) return 0;
  const score = arr.reduce((acc,v)=>acc+(v===2?1:(v===1?0.5:0)),0) / arr.length;
  return Math.round(score*100);
}
function getToolsArrayForVisit(v){
  const snap=loadedRecord?.visits?.[v];
  if(snap?.finalized && Array.isArray(snap.tools)) return snap.tools.slice();
  if(snap?.draft?.tools) return snap.draft.tools.slice();
  if(v===activeVisit) return getToolsStateFromUI();
  return Array(toolsData.length).fill(null);
}
function getToolReasonsForVisit(v){
  const snap=loadedRecord?.visits?.[v];
  if(snap?.finalized && Array.isArray(snap.toolReasons)) return snap.toolReasons.slice();
  if(snap?.draft?.toolReasons) return snap.draft.toolReasons.slice();
  if(v===activeVisit) return getToolReasonsFromUI();
  return Array(toolsData.length).fill('');
}
function toolPctForVisit(v){ return toolPctFromArray(getToolsArrayForVisit(v)); }
function visitPctAdjusted(v){
  const L=visitPctLevels(v), T=toolPctForVisit(v);
  return Math.round(L*0.85 + T*0.15);
}

/* ========== مؤشرات الواجهة ========== */
function setVisitMeter(p){
  document.getElementById('kpiPct').textContent = p+'%';
  document.getElementById('hThumb').style.left = p+'%';
}
function setDonut(v,p){
  const C=314;
  const ring=document.querySelector(`#v${v} .ring`);
  const txt =document.getElementById(`v${v}t`);
  ring.setAttribute('stroke', p>=80?'#16a34a':(p>=50?'#f59e0b':'#ef4444'));
  ring.setAttribute('stroke-dasharray', `${(p/100)*C} ${C}`);
  txt.textContent=p+'%';
}
function setGlobalMeter(p){
  document.getElementById('globalThumb').style.left=p+'%';
  const gi=document.getElementById('globalPctInline');
  gi.textContent=p+'%';
  gi.className='globalInline '+(p>=80?'good':(p>=50?'mid':'bad'));
}
function setVisitPercents(p1,p2,p3){
  document.getElementById('p1').textContent=p1+'%';
  document.getElementById('p2').textContent=p2+'%';
  document.getElementById('p3').textContent=p3+'%';
}

/* ========== بنك دعم مختصر + توليد خوارزمي ========== */
const supportLib={
  'إعداد وتنفيذ خطة للتعلّم':{
    1:['صياغة نواتج قابلة للقياس مع نقطة تحقق ختامية.'],
    2:['تثبيت روتين افتتاحي ونقطة فحص وسطية.'],
    3:['خطة بأدوار طلابية وخيارات إنجاز متعددة.']
  },
  'التنوع في استراتيجيات التدريس':{
    1:['إضافة (فكر–زاوج–شارك) لسؤال مركزي.'],
    2:['تدوير أدوار المجموعات واستقصاء موجّه.'],
    3:['نقاش سقراطي ودعم تعليم الأقران.']
  },
  'إدارة الفصل':{
    1:['قواعد إيجابية مع مؤقت مرئي للانتقال.'],
    2:['بطاقة متابعة سلوكية وتعزيز فوري.'],
    3:['روتين دخول/خروج ونقل إدارة الزمن للطلاب.']
  },
  'توظيف التقنية':{
    1:['سؤال فوري رقمي لقياس الفهم.'],
    2:['ربط المحتوى بمقطع قصير وبنك أسئلة.'],
    3:['لوحة بيانات تقدم ومشروع قصير متعدد الوسائط.']
  },
  'البيئة التعليمية':{
    1:['ركن موارد بصري ومسارات حركة واضحة.'],
    2:['لوحة تقدم وزاوية انعكاس.'],
    3:['عروض طلابية قصيرة ومسؤولية تنظيم المواد.']
  },
  'أساليب وأدوات التقويم':{
    1:['سؤال ختامي وبطاقة ملاحظة مختصرة.'],
    2:['تصحيح ذاتي بمعيار وتنويع أدوات التقييم.'],
    3:['بنك أدلة مبسط وتنسيق نتائج للدرس التالي.']
  }
};
const toolPhrases={
  2:['استدامة «{tool}» ضمن روتين الدرس تعمّق الأثر.','مواءمة «{tool}» مع نواتج التعلم ترفع الاتساق.'],
  1:['ترقية «{tool}» تدريجيًّا بمهام دقيقة.','تحديد توقيت ثابت لـ«{tool}» يرفع الجودة.'],
  0:['بدء «{tool}» بنشاط تجريبي قصير.','دمج «{tool}» بسؤال انعكاسي واحد كبداية.']
};
let supportSources=[];
function autoPick(arr){ return arr[Math.floor(Math.random()*arr.length)]||''; }
function domainLevelForVisit(visit,fi){
  const arr=store[visit][fi]||[];
  const filled=arr.filter(v=>v>0);
  if(!filled.length) return 0;
  const avg=filled.reduce((a,b)=>a+b,0)/filled.length;
  if(avg>=2.5) return 3; if(avg>=1.5) return 2; return 1;
}
function generateUnifiedSupport(){
  const lines=[]; supportSources=[];
  // أضعف مجال وأقواه
  let weakIdx=0, weakLvl=4, strongIdx=0, strongLvl=0;
  fields.forEach((f,fi)=>{
    const lvl=domainLevelForVisit(activeVisit,fi)||0;
    if(lvl>0 && lvl<weakLvl){weakLvl=lvl; weakIdx=fi;}
    if(lvl>strongLvl){strongLvl=lvl; strongIdx=fi;}
  });
  const wName=fields[weakIdx].name, sName=fields[strongIdx].name;

  const wLine=autoPick((supportLib[wName]||{})[weakLvl]||[]);
  if(wLine){ lines.push(wLine); supportSources.push({type:'مجال',name:wName}); }

  const sLine=autoPick((supportLib[sName]||{})[Math.max(1,strongLvl)]||[]);
  if(sLine){ lines.push(sLine); supportSources.push({type:'مجال',name:sName}); }

  // ربط الأدوات بالحالة مع السبب
  const tools=getToolsStateFromUI();
  const reasons=getToolReasonsFromUI();
  let idx=tools.findIndex(v=>v===0||v===1);
  if(idx===-1) idx=tools.findIndex(v=>v===2);
  if(idx>-1){
    const t=toolsData[idx]?.title||'أداة';
    const kind=tools[idx]??0;
    let l = autoPick(toolPhrases[kind]||[]).replace('{tool}',t);
    const why=(reasons[idx]||'').trim(); if(why) l+=` (مانع: ${why.slice(0,40)})`;
    lines.push(l);
    supportSources.push({type:'أداة',name:t});
  }

  // سطر موجّه بحسب مؤشر الزيارة
  const k=visitPctAdjusted(activeVisit);
  lines.push( k>=80 ? 'تثبيت الممارسات الفاعلة بخطة انتشار مصغّرة.'
                    : (k>=50 ? 'تحسين متتابع مع نقطة فحص أسبوعية.'
                             : 'تدخل قصير المدى بمؤشرات نجاح واضحة.') );

  setSupportToUI(lines.slice(0,4));
  renderSupportMeta();
}
function setSupportToUI(lines){
  const ta=document.getElementById('supportArea');
  ta.value=(lines||[]).slice(0,4).join('\n');
  autoGrow(ta);
}
function getSupportFromUI(){
  return (document.getElementById('supportArea').value||'')
    .split('\n').map(s=>s.trim()).filter(Boolean).slice(0,4);
}
function renderSupportMeta(){
  const box=document.getElementById('supportMeta'); box.innerHTML='';
  supportSources.slice(0,4).forEach((s,i)=>{
    const span=document.createElement('span');
    span.className='chip-mini';
    span.textContent=`سطر ${i+1}: ${s.type} — ${s.name}`;
    box.appendChild(span);
  });
}

/* ========== توصيات (قائمة التميّز/الاحتياج) ========== */
function buildRecommendationsFor(visit){
  const ok=new Set(), dev=new Set();
  fields.forEach((f,fi)=>{
    const vals=store[visit][fi]||[];
    const filled=vals.filter(v=>v>0);
    if(!filled.length) return;
    const avg=filled.reduce((a,b)=>a+b,0)/filled.length;
    if(avg>=2.5) ok.add(`تماسك في «${f.name}» ينعكس على تعلم الطلبة.`);
    else if(avg>=1.5) ok.add(`تقدّم في «${f.name}» يحتاج تثبيت الاستمرارية.`);
    else dev.add(`تطوير عناصر «${f.name}» بخطوات قصيرة متتابعة.`);
  });

  const tVals=getToolsArrayForVisit(visit), tWhy=getToolReasonsForVisit(visit);
  (tVals||[]).forEach((v,i)=>{
    const name=toolsData[i]?.title||'أداة';
    const why=(tWhy[i]||'').trim();
    if(v===2) ok.add(`مواءمة «${name}» مع الأهداف تعمّق الأثر.`);
    if(v===1) dev.add(`ترقية «${name}» بزيادات وجيزة.`);
    if(v===0) dev.add(`بدء «${name}» تجريبيًا${why?` (مانع: ${why.slice(0,40)})`:''}.`);
  });

  document.getElementById('strengthBox').textContent = ok.size?([...ok].join(' • ')):'—';
  document.getElementById('devBox').textContent      = dev.size?([...dev].join(' • ')):'—';
}

/* ========== شرائح الزيارات والتواريخ ========== */
function setChip(v,txt){
  document.getElementById('v'+v+'h').textContent=txt;
  document.getElementById('sh'+v).textContent=txt;
}
function activeVisitHijri(){
  const lbl = activeVisit===1?'الأولى':(activeVisit===2?'الثانية':'الثالثة');
  let d = (document.getElementById('v'+activeVisit+'h').textContent||'').trim();
  if(!d) d = hijriDateStr(new Date());
  return {lbl,d};
}
['v1h','v2h','v3h'].forEach((id,i)=>{
  document.getElementById(id).addEventListener('click',()=>{
    setChip(i+1, hijriDateStr(new Date()));
    saveDraftActiveVisit();
  });
});
['v1','v2','v3'].forEach((id,i)=>{
  document.getElementById(id).addEventListener('click',()=>{
    saveDraftActiveVisit();
    renderVisit(i+1);
  });
});

/* ========== حفظ المسودة وقراءة الزيارة ========== */
function saveDraftActiveVisit(){
  if(!loadedRecord) return;
  const v=activeVisit;
  if(!loadedRecord.visits) loadedRecord.visits={1:{},2:{},3:{}};
  const snap = loadedRecord.visits[v] = loadedRecord.visits[v]||{};
  snap.draft = snap.draft||{};
  snap.draft.levels = JSON.parse(JSON.stringify(store[v]));
  snap.draft.tools  = getToolsStateFromUI();
  snap.draft.toolReasons = getToolReasonsFromUI();
  snap.draft.supportUnified = (document.getElementById('supportArea').value||'').trim();
  // بيانات عامة أيضًا
  loadedRecord.name  = (document.getElementById('tName').value||'').trim();
  loadedRecord.id    = (document.getElementById('tId').value||'').replace(/\D+/g,'');
  loadedRecord.spec  = (document.getElementById('tSpec').value||'').trim();
  loadedRecord.lesson= (document.getElementById('lesson').value||'').trim();
  loadedRecord.degree= (document.getElementById('degree').value||'').trim();
  loadedRecord.exp   = (document.getElementById('exp').value||'').trim();
  loadedRecord.class = (document.getElementById('class').value||'').trim();
  saveRecord();
}
function renderVisit(v){
  activeVisit=v;
  // إبراز الشيب الحالية فقط
  [1,2,3].forEach(n=>{
    document.getElementById('v'+n+'h').classList.toggle('hidden', n!==v);
  });
  buildTable();
  buildTools();

  // إعادة تحميل مستويات الزيارة
  const snap=loadedRecord?.visits?.[v];
  const levels = snap?.finalized ? (snap.levels||zeroMatrix()) : (snap?.draft?.levels||zeroMatrix());
  store[v] = JSON.parse(JSON.stringify(levels));

  // تطبيق المستويات على الأزرار
  const tbody = document.getElementById('rows');
  fields.forEach((f,fi)=>{
    f.items.forEach((it,ii)=>{
      const chosen = store[v][fi][ii];
      if(chosen>0){
        const row = tbody.querySelectorAll('tr')[ fields.slice(0,fi).reduce((a,x)=>a+x.items.length,0) + ii ];
        const btns=[...row.querySelectorAll('button')];
        btns.forEach(b=>b.classList.toggle('active', Number(b.dataset.v)===chosen));
      }
    });
  });

  // الأدوات + الأسباب
  const st = snap?.finalized ? (snap.tools||[]) : (snap?.draft?.tools||[]);
  const rs = snap?.finalized ? (snap.toolReasons||[]) : (snap?.draft?.toolReasons||[]);
  setToolsStateToUI(st||[]);
  const areas=[...document.querySelectorAll('.tool-reason')];
  areas.forEach((t,i)=>{ t.value = (rs && typeof rs[i]!=='undefined')?rs[i]:''; });

  // الدعم
  const sup = snap?.finalized ? (snap.supportUnified||'') : (snap?.draft?.supportUnified||'');
  if(sup){ setSupportToUI(sup.split('\n')); } else { generateUnifiedSupport(); }

  calcAll();
}

/* ========== حساب شامل وتحديث الواجهات ========== */
function calcAll(){
  const p1=visitPctAdjusted(1), p2=visitPctAdjusted(2), p3=visitPctAdjusted(3);
  setDonut(1,p1); setDonut(2,p2); setDonut(3,p3);
  setVisitPercents(p1,p2,p3);
  const global = Math.round((p1+p2+p3)/3);
  setGlobalMeter(global);
  const kpi = visitPctAdjusted(activeVisit);
  setVisitMeter(kpi);
  buildRecommendationsFor(activeVisit);
  ['sn1','sn2','sn3'].forEach(id=>document.getElementById(id).textContent=(document.getElementById('tName').value||'—'));
}

/* ========== واتساب ========== */
const LS_WA='moe_wa_num_v1';
let waNumber=localStorage.getItem(LS_WA)||'9665XXXXXXXX';
document.getElementById('waEdit').addEventListener('click',()=>{
  const v=prompt('رقم واتساب الافتراضي (مع مفتاح الدولة):', waNumber);
  if(v && /^\d{8,15}$/.test(v)){ waNumber=v; localStorage.setItem(LS_WA,waNumber); showToast('تم حفظ رقم واتساب.'); }
});
document.getElementById('waBtn').addEventListener('click',()=>{
  const name=(tName.value||'—').trim(), spec=(tSpec.value||'—').trim(), id=(tId.value||'—').trim(), klass=(document.getElementById('class').value||'—').trim();
  const p1=visitPctAdjusted(1), p2=visitPctAdjusted(2), p3=visitPctAdjusted(3);
  const school=document.getElementById('h-school').textContent.trim();
  const {lbl,d}=activeVisitHijri();
  const ok=(document.getElementById('strengthBox').innerText||'—').trim();
  const dv=(document.getElementById('devBox').innerText||'—').trim();
  const supportLines=getSupportFromUI();
  const reasons = getToolReasonsFromUI().filter(Boolean);
  const supportBlock = supportLines.length?('\nالدعم المقترح:\n- '+supportLines.join('\n- ')):'';
  const reasonsBlock = reasons.length?('\nأسباب عدم التفعيل:\n- '+reasons.join('\n- ')):'';
  const msg=`السلام عليكم،
${school}
الاسم: ${name} | الهوية: ${id} | التخصص: ${spec} | الصف/الشعبة: ${klass}
الزيارة ${lbl}: بتاريخ ${d}
نِسب الزيارات:
- الأولى %${p1}
- الثانية %${p2}
- الثالثة %${p3}
جوانب التميز: ${ok}
احتياجات التنمية المهنية: ${dv}${supportBlock}${reasonsBlock}`;
  window.open('https://api.whatsapp.com/send?phone='+waNumber+'&text='+encodeURIComponent(msg),'_blank');
});

/* ========== اعتماد الزيارة + قائمة المعتمدين ========== */
const approvedKey=LS_APPROVED; // مصفوفة عناصر: {teacherId,name,visit,whenHijri}
function readApproved(){ try{ return JSON.parse(localStorage.getItem(approvedKey)||'[]'); }catch{return [];} }
function writeApproved(arr){ try{ localStorage.setItem(approvedKey, JSON.stringify(arr||[])); }catch{} }
function renderApprovedPanel(){
  const list=document.getElementById('approvedList'); list.innerHTML='';
  const arr=readApproved();
  if(!arr.length){ list.textContent='—'; return; }
  arr.forEach(x=>{
    const chip=document.createElement('div');
    chip.className='name-chip';
    chip.textContent=`${x.name} — زيارة ${x.visit} — ${x.whenHijri||'—'}`;
    list.appendChild(chip);
  });
}
document.getElementById('btnApproved').addEventListener('click',()=>{
  renderApprovedPanel();
  document.getElementById('approvedPanel').style.display='block';
});
document.getElementById('apClose').addEventListener('click',()=>{
  document.getElementById('approvedPanel').style.display='none';
});

document.getElementById('finishVisitBtn').addEventListener('click',()=>{
  // تحقق من بيانات المعلم
  const missing=[];
  if(!(tName.value||'').trim()) missing.push('اسم المعلم');
  if(!/^\d{10}$/.test((tId.value||'').replace(/\D+/g,''))) missing.push('رقم الهوية');
  if(!(tSpec.value||'').trim()) missing.push('التخصص/المادة');

  // تحقق من عناصر التعليم والتعلم
  const unselected=[];
  store[activeVisit].forEach((row,fi)=>{
    row.forEach((v,ii)=>{
      if(!v) unselected.push(`«${fields[fi].name} / ${fields[fi].items[ii][0]}»`);
    });
  });

  // تحقق من الأدوات
  const tStates=getToolsStateFromUI(), tReasons=getToolReasonsFromUI();
  const toolsMissing=[];
  tStates.forEach((v,i)=>{
    if(v===null) toolsMissing.push(`تحديد تفعيل: «${toolsData[i].title}»`);
    if((v===0||v===1) && !tReasons[i]) toolsMissing.push(`سبب عدم/ضعف التفعيل: «${toolsData[i].title}»`);
  });

  if(missing.length || unselected.length || toolsMissing.length){
    let txt='';
    if(missing.length) txt += `بيانات المعلم الناقصة: ${missing.join('، ')}.\n`;
    if(unselected.length) txt += `عناصر لم تُقيَّم: ${unselected.slice(0,6).join('، ')}${unselected.length>6?'…':''}\n`;
    if(toolsMissing.length) txt += `نواقص الأدوات: ${toolsMissing.slice(0,6).join('، ')}${toolsMissing.length>6?'…':''}`;
    alert(txt||'يرجى استكمال المدخلات.');
    return;
  }

  // توليد دعم خوارزمي إن لم يُكتب
  if(!(document.getElementById('supportArea').value||'').trim()){
    generateUnifiedSupport();
  }

  // وسم الزيارة «منتهية»
  document.getElementById('done'+activeVisit).style.display='inline-block';
  // حفظ نهائي
  const snap = (loadedRecord.visits[activeVisit]=loadedRecord.visits[activeVisit]||{});
  snap.finalized=true;
  snap.levels = JSON.parse(JSON.stringify(store[activeVisit]));
  snap.tools  = getToolsStateFromUI();
  snap.toolReasons = getToolReasonsFromUI();
  snap.supportUnified = (document.getElementById('supportArea').value||'').trim();

  // ختم التاريخ إن كان فارغًا
  if(!(document.getElementById('v'+activeVisit+'h').textContent||'').trim()){
    setChip(activeVisit, hijriDateStr(new Date()));
  }

  // إضافة إلى قائمة المعتمدين (مع رقم الزيارة)
  const arr=readApproved();
  const when = (document.getElementById('v'+activeVisit+'h').textContent||'—').trim();
  const exist = arr.find(x=>x.teacherId===loadedRecord.teacherId && x.visit===activeVisit);
  if(!exist){
    arr.push({teacherId:loadedRecord.teacherId, name:loadedRecord.name||'—', visit:activeVisit, whenHijri:when});
    writeApproved(arr);
  }
  saveRecord();
  renderApprovedPanel();
  showToast('تم اعتماد الزيارة وحفظ جميع البيانات.');
});

/* ========== طباعة و PDF (تحجيم مناسب A4) ========== */
document.getElementById('printBtn').addEventListener('click',()=>{
  // تخفيف الأحجام للطباعة (يتم عبر @media print) + عرض كامل
  window.print();
});

document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const root=document.getElementById('page');
  const oldClass=document.body.className;
  document.body.classList.add('for-print');
  document.body.classList.add('snapshot'); // إخفاء العناصر التشغيلية
  // عرض إلى صورة عالية الدقة ثم PDF A4
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(root, {scale:2, background:'#ffffff', useCORS:true, windowWidth: root.scrollWidth});
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const pdf = new jsPDF('p','mm','a4');
  const pageWidth  = 210;
  const pageHeight = 297;
  // حساب تحجيم الصورة داخل A4
  const imgWidth = pageWidth-10;
  const imgHeight = canvas.height * imgWidth / canvas.width;
  let y=5;
  if(imgHeight <= pageHeight-10){
    pdf.addImage(imgData,'JPEG',5,y,imgWidth,imgHeight,'','FAST');
  }else{
    // تقسيم على صفحات
    let h = imgHeight, s=0;
    while(h>0){
      pdf.addImage(imgData,'JPEG',5,y,imgWidth,imgHeight,'','FAST', 0, s);
      s += (pageHeight-10) * (canvas.width/imgWidth);
      h -= (pageHeight-10);
      if(h>0) pdf.addPage();
    }
  }
  const nm = (loadedRecord?.name||'معلم') + ' - زيارة ' + (activeVisit) + '.pdf';
  pdf.save(nm);
  document.body.className=oldClass;
});

/* ========== أزرار المساعدة: حفظ يدوي/تحميل آخر تقرير/حذف/مسح ========== */
document.getElementById('btnSaveManual').addEventListener('click',()=>{
  saveDraftActiveVisit();
  showToast('تم الحفظ.');
});

document.getElementById('btnLoadLast').addEventListener('click',()=>{
  // يبحث آخر عنصر معتمد ويعرض تقريرًا بسيطًا في نافذة جديدة
  const arr=readApproved(); if(!arr.length){ showToast('لا توجد تقارير معتمدة.'); return; }
  const last=arr[arr.length-1];
  const rec=loadRecordByKey(last.teacherId);
  if(!rec){ showToast('تعذر فتح التقرير.'); return; }
  const v=last.visit;
  const p = (k)=> (rec?.visits?.[k]? Math.round( (visitPctFromSaved(rec.visits[k]) * 0.85) + (toolPctFromArray(rec.visits[k].tools||[]) * 0.15) ) : 0);
  const html = makeReportHTML(rec, v, {p1:p(1),p2:p(2),p3:p(3)}, last.whenHijri||'—');
  const w=window.open('','_blank');
  w.document.write(html); w.document.close();
});
function visitPctFromSaved(snap){
  const arr=(snap?.levels||[]).flat();
  const rated=arr.filter(x=>x>0);
  if(!rated.length) return 0;
  const s=rated.reduce((a,b)=>a+(b-1),0);
  return Math.round((s/(rated.length*2))*100);
}
function makeReportHTML(rec, v, ps, when){
  const name=rec.name||'—', id=rec.id||'—', spec=rec.spec||'—', cls=rec.class||'—';
  const ok = rec.visits?.[v]?.supportUnified ? '' : '';
  const okTxt = (()=>{
    // نص التوصيات من الحقول الحالية (لنفس الزيارة)
    const tmpStore = store[v];
    return (document.getElementById('strengthBox').textContent||'—');
  })();
  const devTxt = (document.getElementById('devBox').textContent||'—');
  const supTxt = (rec.visits?.[v]?.supportUnified||getSupportFromUI().join('\n')||'—').replace(/\n/g,'<br/>');
  return `
  <html dir="rtl" lang="ar"><head><meta charset="utf-8"/>
  <title>تقرير زيارة — ${name}</title>
  <style>
    body{font-family:Tajawal,system-ui;margin:20px;color:#123b37}
    h2{margin:0 0 8px;color:#0f7a66}
    .b{font-weight:700}
    .box{border:1px solid #e6efec;border-radius:12px;padding:10px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .chip{display:inline-block;padding:4px 8px;border:1px dashed #cfe1dd;border-radius:999px;background:#f6fffb}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #cfe1dd;padding:6px;text-align:center}
    .sign{height:44px;border-bottom:1px dashed #9fb5b1;margin:10px 40px}
  </style>
  </head><body>
    <h2>تقرير زيارة — ${name}</h2>
    <div class="box">
      <div class="row">
        <span class="chip">الاسم: <span class="b">${name}</span></span>
        <span class="chip">الهوية: <span class="b">${id}</span></span>
        <span class="chip">التخصص: <span class="b">${spec}</span></span>
        <span class="chip">الصف/الشعبة: <span class="b">${cls}</span></span>
        <span class="chip">تاريخ الزيارة (هجري): <span class="b">${when}</span></span>
      </div>
      <div class="row" style="margin-top:6px">
        <span class="chip">الأولى: %${ps.p1}</span>
        <span class="chip">الثانية: %${ps.p2}</span>
        <span class="chip">الثالثة: %${ps.p3}</span>
      </div>
    </div>
    <div class="box"><b>جوانب التميّز:</b><div>${okTxt}</div></div>
    <div class="box"><b>احتياجات التنمية المهنية:</b><div>${devTxt}</div></div>
    <div class="box"><b>الدعم المقدم:</b><div>${supTxt}</div></div>
    <div class="box">
      <table>
        <tr><th>اسم المعلم</th><th>توقيع المعلم</th><th>اسم مدير المدرسة</th><th>توقيع المدير</th></tr>
        <tr><td>${name}</td><td class="sign"></td><td>${document.getElementById('pn'+v).textContent||'—'}</td><td class="sign"></td></tr>
      </table>
    </div>
  </body></html>`;
}

/* حذف زيارة للمعلم الحالي (الزيارة النشطة) */
document.getElementById('btnDeleteVisit').addEventListener('click',()=>{
  if(!loadedRecord){ showToast('لا يوجد معلّم محمّل.'); return; }
  if(!confirm('تأكيد حذف بيانات هذه الزيارة لهذا المعلم؟')) return;
  const v=activeVisit;
  store[v]=zeroMatrix();
  const snap=loadedRecord.visits?.[v];
  if(snap){
    delete snap.finalized; delete snap.levels; delete snap.tools; delete snap.toolReasons; delete snap.supportUnified;
    snap.draft={};
  }
  saveRecord();
  renderVisit(v);
  showToast('تم حذف بيانات الزيارة الحالية.');
});

/* مسح جميع البيانات (كل المعلمين) */
document.getElementById('btnClearAll').addEventListener('click',()=>{
  if(!confirm('تنبيه: سيُمسح جميع ما تم حفظه لكل المعلمين. متابعة؟')) return;
  // مسح مفاتيح التخزين الخاصة
  const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && (k.startsWith(LS_PREFIX)||k===approvedKey)) keys.push(k); }
  keys.forEach(k=>localStorage.removeItem(k));
  store={1:zeroMatrix(),2:zeroMatrix(),3:zeroMatrix()};
  loadedRecord=null;
  // تصفير الواجهة
  document.getElementById('rows').innerHTML='';
  document.getElementById('toolsRows').innerHTML='';
  setDonut(1,0); setDonut(2,0); setDonut(3,0);
  setVisitPercents(0,0,0); setGlobalMeter(0); setVisitMeter(0);
  ['v1h','v2h','v3h','sn1','sn2','sn3','sh1','sh2','sh3'].forEach(id=>document.getElementById(id).textContent='—');
  document.getElementById('supportArea').value='';
  renderApprovedPanel();
  showToast('تم مسح كافة البيانات.');
});

/* ========== كشف المعلمين (تحميل/بحث) ========== */
const LS_TEACHERS='moe_teacher_list_v1';
let teacherList=[];
function loadTeacherList(){ try{ teacherList = JSON.parse(localStorage.getItem(LS_TEACHERS)||'[]'); if(!Array.isArray(teacherList)) teacherList=[]; }catch{ teacherList=[]; } }
function renderTeachers(q){
  const tpList=document.getElementById('tpList'); tpList.innerHTML='';
  const rx=(q||'').trim()? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i'):null;
  const data = teacherList.filter(t=>!rx || rx.test(t.name||'') || rx.test(t.id||''));
  if(!data.length){ tpList.innerHTML='<div style="grid-column:1/-1;text-align:center;opacity:.7">لا نتائج.</div>'; return; }
  data.forEach(t=>{
    const div=document.createElement('div'); div.className='tp-item';
    div.innerHTML=`<b>${t.name||''}</b><span style="opacity:.8">${t.id||'—'}</span>`;
    div.addEventListener('click',()=>{
      document.getElementById('teachersPanel').style.display='none';
      fillTeacher(t);
    });
    tpList.appendChild(div);
  });
}
document.getElementById('btnShowList').addEventListener('click',()=>{
  loadTeacherList(); renderTeachers('');
  document.getElementById('tpQuery').value='';
  document.getElementById('teachersPanel').style.display='block';
});
document.getElementById('tpClose').addEventListener('click',()=>document.getElementById('teachersPanel').style.display='none');
document.getElementById('tpQuery').addEventListener('input',e=>renderTeachers(e.target.value));

/* استيراد من Excel/CSV */
document.getElementById('btnImportInPanel').addEventListener('click',()=>document.getElementById('excelInput').click());
document.getElementById('excelInput').addEventListener('change', (e)=>{
  const file=e.target.files[0]; if(!file) return;
  file.arrayBuffer().then(buf=>{
    const wb=XLSX.read(buf,{type:'array'}); const sh=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sh,{header:1,defval:''}); if(!rows.length){ alert('الملف فارغ.'); return; }
    const headers=rows[0].map(h=>String(h).trim().toLowerCase());
    const idx = (names)=> headers.findIndex(h=>names.map(x=>x.toLowerCase()).some(n=>h.includes(n)));
    const ixName=idx(['الاسم','اسم','name']), ixId=idx(['الهوية','id']), ixSpec=idx(['التخصص','المادة','spec','subject']), ixDeg=idx(['المؤهل','degree']), ixExp=idx(['سنوات','خبرة','experience']);
    function tenDigitsFallback(row){ for(const c of row){ const s=String(c||'').replace(/\D+/g,''); if(/^\d{10}$/.test(s)) return s; } return ''; }
    teacherList = rows.slice(1).filter(r=>r.some(x=>String(x).trim()!=='')).map(r=>{
      const name=(ixName>-1? r[ixName] : (r[0]||'')).toString().trim();
      let id=(ixId>-1? String(r[ixId]) : '').replace(/\D+/g,''); if(!/^\d{10}$/.test(id)) id=tenDigitsFallback(r);
      const spec=(ixSpec>-1? r[ixSpec] : '').toString().trim();
      const degree=(ixDeg>-1? r[ixDeg] : '').toString().trim();
      const exp=(ixExp>-1? r[ixExp] : '').toString().trim();
      return {name,id:id.slice(0,10),spec,degree,exp};
    }).filter(x=>x.name);
    localStorage.setItem(LS_TEACHERS, JSON.stringify(teacherList));
    renderTeachers('');
    showToast('تم استيراد القائمة.');
    e.target.value='';
  }).catch(()=>{ alert('فشل استيراد الملف.'); e.target.value=''; });
});

/* ========== ربط إدخالات الهوية/الاسم مع سجل المعلّم ========== */
['tName','tId','tSpec','lesson','degree','exp','class'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('change',()=>{
    if(!loadedRecord){ // إنشاء سجل جديد إذا لم يوجد
      const key=currentKey(); if(!key){ return; }
      loadedRecord={teacherId:key,name:tName.value||'',id:(tId.value||'').replace(/\D+/g,''),spec:tSpec.value||'',lesson:lesson.value||'',degree:degree.value||'',exp:exp.value||'',class:class_.value||'',visits:{1:{draft:{}},2:{draft:{}},3:{draft:{}}}};
    }
    saveDraftActiveVisit();
  });
});
const class_ = document.getElementById('class');

/* ========== أزرار الصعود/الهبوط ==========
   (تظهر عند التمرير) */
const toTop=document.getElementById('toTop'), toBottom=document.getElementById('toBottom');
window.addEventListener('scroll',()=>{
  const y=window.scrollY, h=document.body.scrollHeight - window.innerHeight;
  toTop.style.display = y>200 ? 'block':'none';
  toBottom.style.display = (h-y)>200 ? 'block':'none';
});
toTop.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));
toBottom.addEventListener('click',()=>window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}));

/* ========== تهيئة أولية ========== */
(function init(){
  // تفعيل حقول التوقيع بالاسم مباشرة
  ['sn1','sn2','sn3'].forEach(id=>document.getElementById(id).textContent=(tName.value||'—'));
  // بناء أولي
  buildTable(); buildTools(); generateUnifiedSupport(); calcAll();
  // رقم المدير قابل للتحرير تم أعلاه
})();
</script>
</body>
</html>
