<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>تقرير تنفيذ برنامج — وزارة التعليم</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --line:#e6eef2;
  --paper:#ffffff; --bg:#f6f8fb;
  --accent:#2f7f79; --accentDeep:#0e3b46; --footer:#0e3b46;
  --base:14px; --title:19px; --name:17px;
  --gap-top:4mm; --gap-mid:4mm; --gap-gallery:4.5mm; --gap-sign:5mm;
}

*{box-sizing:border-box}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font-family:"Tajawal",system-ui,sans-serif; font-size:var(--base); line-height:1.6;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  text-rendering:optimizeLegibility;
}

/* ورقة */
.sheet{
  width:210mm; height:297mm; margin:12px auto; background:var(--paper);
  border:1px solid #e5e7eb; box-shadow:0 10px 28px rgba(0,0,0,.08);
  display:grid; grid-template-rows:30mm auto 6mm; overflow:hidden; position:relative;
}
.sheet:before{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(1200px 400px at 50% -10%, rgba(47,127,121,.10), transparent 60%);
}

/* الهيدر + زر PDF داخل الهيدر */
.header-img{position:relative; height:30mm; overflow:hidden; background:var(--accentDeep)}
.header-img img{width:100%; height:100%; object-fit:cover; display:block}
.header-fallback{position:absolute; inset:0; background:linear-gradient(90deg,#0b7e88,#15a3ad); display:none}

/* نص الهيدر في الوسط (قابل للتعديل) */
.header-center{
  position:absolute; inset:0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center; color:#fff;
  font-weight:800; font-size:18px; line-height:1.6;
  z-index:10;
}

/* زر PDF داخل الهيدر (لا يُطبع) */
.header-action{
  position:absolute; top:10px; left:12px; z-index:20;
}
.header-action [data-nopdf]{/* just to make sure */ }
.pdf-chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 14px; border-radius:14px;
  background:linear-gradient(180deg, var(--accent), var(--accentDeep));
  color:#fff; font-weight:800; letter-spacing:.6px;
  border:1px solid rgba(255,255,255,.25);
  box-shadow:0 10px 22px rgba(14,59,70,.25), inset 0 1px 0 rgba(255,255,255,.18);
  cursor:pointer; user-select:none;
  transition:transform .08s ease, filter .2s ease, box-shadow .2s ease;
}
.pdf-chip svg{width:18px; height:18px; flex:0 0 18px; filter:drop-shadow(0 1px 0 rgba(0,0,0,.2))}
.pdf-chip:hover{filter:brightness(1.05); box-shadow:0 12px 26px rgba(14,59,70,.35);}
.pdf-chip:active{transform:translateY(1px)}
/* نبضة ضوئية خفيفة */
.pdf-chip::after{
  content:""; position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
  background:radial-gradient(24px 24px at 85% 30%, rgba(255,255,255,.35), transparent 60%);
}

/* المحتوى */
.main{padding:0 10mm; display:flex; flex-direction:column; min-height:0}

/* الجدول */
.table{
  margin-top:var(--gap-top);
  width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; background:#fff;
  border:1px solid var(--line); border-top:4px solid var(--accentDeep);
  box-shadow:0 4px 14px rgba(0,0,0,.05); border-radius:14px; overflow:hidden;
}
.table th,.table td{
  border-right:1px solid var(--line); border-bottom:1px solid var(--line);
  padding:2.4mm 2.6mm;
  vertical-align:middle; text-align:center; font-size:13.4px; line-height:1.35;
  word-break:break-word; overflow-wrap:anywhere;
}
.table td:last-child,.table th:last-child{border-right:0}
.table tr:last-child td,.table tr:last-child th{border-bottom:0}

/* صف العنوان */
.table .title-row th{
  padding:4mm 5mm;
  background:linear-gradient(180deg,rgba(47,127,121,.97),rgba(14,59,70,.98));
  color:#fff; font-weight:800; font-size:var(--title); line-height:1.2; position:relative;
}
.table .title-row th::after{
  content:""; position:absolute; inset-inline:0; bottom:0; height:3px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.28),transparent);
}
.table .title-row [contenteditable]:focus{outline:2px dashed rgba(255,255,255,.85); outline-offset:4px}

/* رؤوس */
.table .label{
  width:23.5%;
  background:linear-gradient(180deg,#f1fafb,#ecf7f8);
  color:#1d6a65; font-weight:800;
}

/* الأهداف والنبذة */
.split{
  margin-top:var(--gap-mid);
  display:grid; grid-template-columns:1fr 1fr; gap:4mm;
  height:66mm;
}
.card{
  border:1px solid var(--line); border-radius:14px; background:#fff;
  display:grid; grid-template-rows:12mm 1fr; overflow:hidden;
  box-shadow:0 8px 18px rgba(0,0,0,.06); position:relative;
}
.card .head{
  padding:0 4mm; display:flex; align-items:center;
  background:linear-gradient(180deg,#f6fbfc,#eef7f8);
  color:#0b7e88; font-weight:800; border-bottom:1px solid var(--line)
}
.card .body{padding:3mm 4mm; overflow:hidden; display:flex; position:relative}
.fittext{width:100%; height:100%; white-space:pre-wrap; word-break:break-word; overflow:hidden; line-height:1.6; font-size:15px}

/* شريط أدوات الكتابة داخل المربع */
.tools{
  position:absolute; top:8px; inset-inline-end:8px; z-index:6;
  display:flex; gap:6px; background:rgba(255,255,255,.85);
  border:1px solid var(--line); border-radius:10px; padding:3px 6px;
  box-shadow:0 4px 12px rgba(0,0,0,.08); backdrop-filter:saturate(140%) blur(4px);
}
.toolbtn{min-width:34px; height:28px; border:1px solid var(--line); background:#fff;
  font-weight:800; font-size:12px; border-radius:8px; cursor:pointer}
.toolbtn:active{transform:scale(.98)}
.card:hover{box-shadow:0 10px 22px rgba(0,0,0,.08)}

/* الشواهد — 4 صور */
.gallery{
  margin-top:var(--gap-gallery);
  display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;
  gap:4mm; height:116mm; margin-top:auto;
}
.photo{
  position:relative; background:#fff; border:1px solid var(--line); border-radius:14px;
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  box-shadow:0 8px 18px rgba(0,0,0,.06);
}
.photo input{position:absolute; inset:0; opacity:0; cursor:pointer; z-index:3}
.photo .hint{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  color:#b91c1c; font-size:11px; z-index:2;
  text-align:center; padding:4px 8px;
}
.photo::before{content:""; position:absolute; inset:0; pointer-events:none; background:linear-gradient(180deg,transparent,rgba(47,127,121,.05)); z-index:1;}
.photo img{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:2; display:block}

/* التواقيع */
.signatures{margin-top:var(--gap-sign); height:22mm; display:grid; grid-template-columns:1fr 1fr; gap:4mm}
.sig{background:#fff; border:1px solid var(--line); border-radius:12px; display:grid; grid-template-rows:9mm 1fr; text-align:center; box-shadow:0 6px 14px rgba(0,0,0,.06)}
.sig h4{margin:0; display:grid; place-items:center; color:#1597a0; font-weight:800; font-size:var(--name); border-bottom:1px solid var(--line)}
.sig .name{display:grid; place-items:center; font-weight:800; font-size:var(--name)}

/* شريط سفلي */
.footer-bar{height:6mm; background:var(--footer)}

/* توافق الشاشات الصغيرة: تصغير الورقة مع الحفاظ على A4 للطباعة */
@media screen and (max-width:900px){
  body{overflow-x:auto;}
  .sheet{
    transform:scale(.8);
    transform-origin:top center;
    margin:8px auto 16px;
  }
}
@media screen and (max-width:600px){
  .sheet{
    transform:scale(.7);
    transform-origin:top center;
  }
}
@media print{
  .sheet{
    transform:none !important;
    width:210mm;
    height:297mm;
    margin:0;
    box-shadow:none;
    border:none;
  }
  .header-action{display:none !important;}
}
</style>
</head>
<body>

<div class="sheet" id="sheet">
  <!-- الهيدر -->
  <div class="header-img">
    <img id="headerPic" src="header.jpg" alt="هيدر وزارة التعليم" crossOrigin="anonymous">

    <!-- نص الهيدر وسط فوق بعض (قابل للتعديل) -->
    <div class="header-center">
      <div contenteditable="true">الإدارة العامة للتعليم بـ ....</div>
      <div contenteditable="true">قطاع التعليم بـ ....</div>
      <div contenteditable="true">اسم المدرسة ....</div>
    </div>

    <!-- زر PDF داخل الهيدر (لا يُطبع) -->
    <div class="header-action" data-nopdf="true">
      <button id="btnPdf" class="pdf-chip" type="button" title="Save as PDF">
        <!-- أيقونة ملف -->
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Zm0 2.5L19.5 10H14V4.5ZM8.5 14H10a2 2 0 1 0 0-4H8v6h.5v-2Zm1-3.5H10a1 1 0 1 1 0 2H9.5v-2ZM12 16h1.5c1.38 0 2.5-1.12 2.5-2.5S14.88 11 13.5 11H12v5Zm1-4h.5a1.5 1.5 0 0 1 0 3H13v-3Zm-4.5 6H16v1H8.5v-1Z"/>
        </svg>
        الحفظ والطباعة
      </button>
    </div>

    <div class="header-fallback" id="headerFallback"></div>
  </div>

  <div class="main">
    <!-- الجدول (العنوان داخل الصف الأول) -->
    <table class="table" id="infoTable" role="table" aria-label="بيانات البرنامج">
      <tr class="title-row">
        <th colspan="4">
          <div id="reportTitle" contenteditable="true">تقرير تنفيذ برنامج (قابل للتعديل)</div>
        </th>
      </tr>
      <tr>
        <th class="label" contenteditable="true">مقدّم البرنامج</th>
        <td contenteditable="true">اسم الجهة المنفذة</td>
        <th class="label" contenteditable="true">المكان</th>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <th class="label" contenteditable="true">التاريخ (هجري أم القرى)</th>
        <td id="hijriDate" contenteditable="true"></td>
        <th class="label" contenteditable="true">المستفيدون</th>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <th class="label" contenteditable="true">عدد الحضور</th>
        <td contenteditable="true"></td>
        <th class="label" contenteditable="true">مدة البرنامج</th>
        <td contenteditable="true"></td>
      </tr>
    </table>

    <!-- الأهداف + النبذة -->
    <div class="split">
      <div class="card">
        <div class="head">الأهداف</div>
        <div class="body">
          <div class="tools" data-nopdf="true">
            <button class="toolbtn" onclick="adjText('goals',+1)">+A</button>
            <button class="toolbtn" onclick="adjText('goals',-1)">−A</button>
            <button class="toolbtn" onclick="toggleBold('goals')">B</button>
          </div>
          <div id="goals" class="fittext" contenteditable="true">اكتب الأهداف هنا…</div>
        </div>
      </div>
      <div class="card">
        <div class="head">نبذة عن البرنامج</div>
        <div class="body">
          <div class="tools" data-nopdf="true">
            <button class="toolbtn" onclick="adjText('about',+1)">+A</button>
            <button class="toolbtn" onclick="adjText('about',-1)">−A</button>
            <button class="toolbtn" onclick="toggleBold('about')">B</button>
          </div>
          <div id="about" class="fittext" contenteditable="true">اكتب النبذة هنا…</div>
        </div>
      </div>
    </div>

    <!-- الشواهد (4 صور) -->
    <div class="gallery" id="gallery">
      <div class="photo">
        <input type="file" accept="image/*">
        <div class="hint" data-nopdf="true">تنبيه: يُفضّل استخدام صور بصيغة JPG للحصول على أفضل جودة في التقرير</div>
      </div>
      <div class="photo">
        <input type="file" accept="image/*">
        <div class="hint" data-nopdf="true">تنبيه: يُفضّل استخدام صور بصيغة JPG للحصول على أفضل جودة في التقرير</div>
      </div>
      <div class="photo">
        <input type="file" accept="image/*">
        <div class="hint" data-nopdf="true">تنبيه: يُفضّل استخدام صور بصيغة JPG للحصول على أفضل جودة في التقرير</div>
      </div>
      <div class="photo">
        <input type="file" accept="image/*">
        <div class="hint" data-nopdf="true">تنبيه: يُفضّل استخدام صور بصيغة JPG للحصول على أفضل جودة في التقرير</div>
      </div>
    </div>

    <!-- التواقيع -->
    <div class="signatures">
      <div class="sig">
        <h4 contenteditable="true">رائد النشاط</h4>
        <div class="name" contenteditable="true">اسم المعلم</div>
      </div>
      <div class="sig">
        <h4>مدير المدرسة</h4>
        <div class="name" contenteditable="true">فهد ....</div>
      </div>
    </div>
  </div>

  <div class="footer-bar" aria-hidden="true"></div>
</div>

<script>
const STORAGE_KEY='report_v15_headerPDF_chip';
function setBusy(b){const el=document.getElementById('btnPdf'); if(el) el.disabled=!!b;}
function fitBox(id){
  const el=document.getElementById(id); if(!el) return;
  const p=el.parentElement; let s=parseFloat(getComputedStyle(el).fontSize)||15;
  const set=v=>{el.style.fontSize=v+'px'; el.style.lineHeight=Math.max(1.25,Math.min(1.6,1.3+(v-12)*0.05));};
  set(s);
  let i=0; while(i++<80 && el.scrollHeight>p.clientHeight && s>12){ s-=.5; set(s); }
  i=0; while(i++<40 && el.scrollHeight<p.clientHeight*.9 && s<20){ s+=.5; set(s); if(el.scrollHeight>p.clientHeight){ s-=.5; set(s); break; } }
}
function adjText(id,dir){const el=document.getElementById(id); if(!el) return; const cur=parseFloat(getComputedStyle(el).fontSize)||15; const next=Math.max(12,Math.min(20,cur+(dir>0?1:-1))); el.style.fontSize=next+'px'; fitBox(id);}
function toggleBold(id){const el=document.getElementById(id); if(!el) return; el.style.fontWeight=(getComputedStyle(el).fontWeight>='600')?'400':'700'; fitBox(id);}

async function toDataURL(img,{maxSide=2400,q=0.95}={}){
  await (img.decode?.().catch(()=>{}) || new Promise(r=>{if(img.complete&&img.naturalWidth)r();else{img.addEventListener('load',r,{once:true});img.addEventListener('error',r,{once:true});}}));
  const w=img.naturalWidth,h=img.naturalHeight,s=Math.min(1,maxSide/Math.max(w,h));
  const cw=Math.max(1,Math.floor(w*s)),ch=Math.max(1,Math.floor(h*s));
  const c=document.createElement('canvas'); c.width=cw; c.height=ch;
  c.getContext('2d',{alpha:false}).drawImage(img,0,0,cw,ch);
  return c.toDataURL('image/jpeg',q);
}
async function renderFillNoDistortion(file,box){
  return new Promise((resolve,reject)=>{
    const url=URL.createObjectURL(file);
    const img=new Image();
    img.onload=async()=>{
      try{
        const dpr=Math.min(window.devicePixelRatio||1,2.5);
        const W=Math.max(1,Math.floor(box.clientWidth*dpr));
        const H=Math.max(1,Math.floor(box.clientHeight*dpr));
        const c=document.createElement('canvas'); c.width=W; c.height=H;
        const ctx=c.getContext('2d',{alpha:false});
        ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H);
        const ratioContain=Math.min(W/img.naturalWidth,H/img.naturalHeight);
        const newW=Math.floor(img.naturalWidth*ratioContain);
        const newH=Math.floor(img.naturalHeight*ratioContain);
        const x=Math.floor((W-newW)/2), y=Math.floor((H-newH)/2);
        const cover=Math.max(W/img.naturalWidth,H/img.naturalHeight);
        const bgW=Math.floor(img.naturalWidth*cover), bgH=Math.floor(img.naturalHeight*cover);
        const bgX=Math.floor((W-bgW)/2), bgY=Math.floor((H-bgH)/2);
        ctx.filter='blur(16px) brightness(1.02)'; ctx.drawImage(img,bgX,bgY,bgW,bgH);
        ctx.filter='none'; ctx.globalAlpha=0.12; ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H); ctx.globalAlpha=1;
        ctx.drawImage(img,x,y,newW,newH);
        const data=c.toDataURL('image/jpeg',0.92);
        URL.revokeObjectURL(url);
        resolve(data);
      }catch(e){URL.revokeObjectURL(url); reject(e);}
    };
    img.onerror=()=>{URL.revokeObjectURL(url); reject(new Error('تعذّر قراءة الصورة'));};
    img.src=url;
  });
}
function bindPhotoBox(box){
  const input=box.querySelector('input[type=file]'); const hint=box.querySelector('.hint');
  const setImage=(src)=>{ let img=box.querySelector('img'); if(!img){img=document.createElement('img'); box.appendChild(img);} img.src=src; hint?.remove(); save(); };
  input.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{ setImage(await renderFillNoDistortion(f, box)); }catch{ alert('تعذّر معالجة الصورة'); }
  });
  box.addEventListener('click', ()=> input.click());
  ['dragover','dragenter'].forEach(ev=> box.addEventListener(ev, e=>{e.preventDefault(); box.style.outline='2px dashed #2f7f79';}));
  ['dragleave','drop'].forEach(ev=> box.addEventListener(ev, e=>{e.preventDefault(); box.style.outline='none';}));
  box.addEventListener('drop', async e=>{
    const f=e.dataTransfer?.files?.[0]; if(!f) return;
    try{ setImage(await renderFillNoDistortion(f, box)); }catch{ alert('تعذّر معالجة الصورة'); }
  });
  box.addEventListener('paste', async e=>{
    const item=[...(e.clipboardData?.items||[])].find(it=>it.type.startsWith('image/'));
    if(!item) return;
    try{ setImage(await renderFillNoDistortion(item.getAsFile(), box)); }catch{ alert('تعذّر معالجة الصورة'); }
  });
}

/* التاريخ الهجري الافتراضي */
(function(){try{const h=document.getElementById('hijriDate'); if(h && !h.textContent.trim()){ h.textContent=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{day:'2-digit',month:'long',year:'numeric'}).format(new Date()); }}catch{}})();

/* حفظ/استرجاع */
function snap(){
  const cells=[...document.querySelectorAll('#infoTable th,#infoTable td')].map(c=>c.innerHTML);
  const photos=[...document.querySelectorAll('.gallery .photo img')].map(i=>i?.src||'');
  return {
    title:document.getElementById('reportTitle').innerHTML,
    h:document.getElementById('hijriDate').innerHTML,
    g:document.getElementById('goals').innerHTML,
    a:document.getElementById('about').innerHTML,
    cells, photos
  };
}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(snap()));}
(function restore(){
  try{
    const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(!s) return;
    document.getElementById('reportTitle').innerHTML=s.title;
    document.getElementById('hijriDate').innerHTML=s.h;
    document.getElementById('goals').innerHTML=s.g;
    document.getElementById('about').innerHTML=s.a;
    const cells=[...document.querySelectorAll('#infoTable th,#infoTable td')];
    s.cells?.forEach((v,i)=>{ if(cells[i]) cells[i].innerHTML=v; });
    const boxes=[...document.querySelectorAll('.gallery .photo')];
    s.photos?.forEach((src,i)=>{ if(!src||!boxes[i]) return; let img=boxes[i].querySelector('img'); if(!img){img=document.createElement('img');boxes[i].appendChild(img);} img.src=src; boxes[i].querySelector('.hint')?.remove(); });
    ['goals','about'].forEach(fitBox);
  }catch{}
})();

/* PDF — يعمل ويدمج الصور */
async function makePdf(){
  const imgs=[...document.querySelectorAll('#sheet img')];
  for(const im of imgs){ if(!im.src.startsWith('data:image')){ try{ im.src=await toDataURL(im); }catch{} } }
  const canvas=await html2canvas(document.getElementById('sheet'),{
    scale:Math.min(window.devicePixelRatio||2,2.4),
    backgroundColor:'#ffffff',useCORS:true,allowTaint:false,scrollX:0,scrollY:-window.scrollY,
    ignoreElements:(el)=>el?.dataset?.nopdf==='true'||el?.tagName==='INPUT'
  });
  const img=canvas.toDataURL('image/jpeg',0.96);
  const {jsPDF}=window.jspdf; const pdf=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
  const W=pdf.internal.pageSize.getWidth(),H=pdf.internal.pageSize.getHeight();
  const w=W,h=(canvas.height*W)/canvas.width,fit=h<=H,drawW=fit?w:(canvas.width*H)/canvas.height,drawH=fit?h:H;
  pdf.addImage(img,'JPEG',(W-drawW)/2,(H-drawH)/2,drawW,drawH,'','FAST');
  const title=(document.getElementById('reportTitle').innerText||'Report').replace(/[\\\/:*?"<>|]+/g,' ').trim();
  const hijri=(document.getElementById('hijriDate').innerText||'').replace(/\s+/g,' ').trim();
  pdf.save(`${title} - ${hijri}.pdf`);
}

/* تشغيل */
document.addEventListener('DOMContentLoaded', ()=>{
  ['goals','about'].forEach(id=>{
    const el=document.getElementById(id);
    ['input','keyup','blur'].forEach(evt=> el.addEventListener(evt, ()=>{fitBox(id); save();}));
    fitBox(id);
  });
  document.querySelectorAll('.gallery .photo').forEach(bindPhotoBox);
  document.getElementById('btnPdf')?.addEventListener('click', async ()=>{
    try{ setBusy(true); save(); await makePdf(); }
    catch(e){ console.error(e); alert('تعذّر إنشاء PDF.'); }
    finally{ setBusy(false); }
  });
});
</script>
</body>
</html>
